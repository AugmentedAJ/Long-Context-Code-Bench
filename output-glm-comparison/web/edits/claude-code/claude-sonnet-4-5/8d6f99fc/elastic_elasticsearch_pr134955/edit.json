{
  "repo_url": "https://github.com/elastic/elasticsearch.git",
  "pr_number": 134955,
  "base_commit": "8272fc895484bdcf635a3828616e03183cac283d",
  "runner": "claude-code",
  "model": "claude-sonnet-4-5",
  "timeout_s": 1800,
  "status": "success",
  "elapsed_ms": 313153,
  "patch_unified": "diff --git a/x-pack/plugin/transform/src/main/java/org/elasticsearch/xpack/transform/transforms/ClientTransformIndexer.java b/x-pack/plugin/transform/src/main/java/org/elasticsearch/xpack/transform/transforms/ClientTransformIndexer.java\nindex c7fd6df4..fede7937 100644\n--- a/x-pack/plugin/transform/src/main/java/org/elasticsearch/xpack/transform/transforms/ClientTransformIndexer.java\n+++ b/x-pack/plugin/transform/src/main/java/org/elasticsearch/xpack/transform/transforms/ClientTransformIndexer.java\n@@ -25,6 +25,7 @@ import org.elasticsearch.action.search.SearchResponse;\n import org.elasticsearch.action.search.TransportClosePointInTimeAction;\n import org.elasticsearch.action.search.TransportOpenPointInTimeAction;\n import org.elasticsearch.action.search.TransportSearchAction;\n+import org.elasticsearch.action.support.GroupedActionListener;\n import org.elasticsearch.action.support.IndicesOptions;\n import org.elasticsearch.action.support.master.AcknowledgedRequest;\n import org.elasticsearch.client.internal.ParentTaskAssigningClient;\n@@ -70,10 +71,14 @@ import org.elasticsearch.xpack.transform.persistence.TransformIndex;\n import org.elasticsearch.xpack.transform.transforms.pivot.SchemaUtil;\n import org.elasticsearch.xpack.transform.utils.ExceptionRootCauseFinder;\n \n+import java.util.HashSet;\n import java.util.LinkedHashMap;\n import java.util.Map;\n import java.util.Map.Entry;\n+import java.util.Set;\n import java.util.concurrent.ConcurrentHashMap;\n+import java.util.concurrent.CountDownLatch;\n+import java.util.concurrent.TimeUnit;\n import java.util.concurrent.atomic.AtomicBoolean;\n import java.util.concurrent.atomic.AtomicReference;\n \n@@ -482,15 +487,44 @@ class ClientTransformIndexer extends TransformIndexer {\n     }\n \n     private void closePointInTime() {\n-        for (String name : namedPits.keySet()) {\n-            closePointInTime(name);\n+        // Collect all PIT names to close\n+        Set<String> pitNamesToClose = new HashSet<>(namedPits.keySet());\n+\n+        if (pitNamesToClose.isEmpty()) {\n+            return;\n+        }\n+\n+        // Use CountDownLatch to wait for all PIT close operations to complete\n+        CountDownLatch latch = new CountDownLatch(pitNamesToClose.size());\n+\n+        for (String name : pitNamesToClose) {\n+            closePointInTime(name, ActionListener.wrap(\n+                response -> latch.countDown(),\n+                e -> latch.countDown()  // Count down even on failure to avoid blocking indefinitely\n+            ));\n+        }\n+\n+        try {\n+            // Wait for all PIT close operations to complete, with a timeout to prevent indefinite blocking\n+            // Use a generous timeout since PIT close operations should be fast\n+            if (latch.await(30, TimeUnit.SECONDS) == false) {\n+                logger.warn(\n+                    \"[{}] Timed out waiting for {} PIT close operations to complete during checkpoint finalization\",\n+                    getJobId(),\n+                    pitNamesToClose.size()\n+                );\n+            }\n+        } catch (InterruptedException e) {\n+            Thread.currentThread().interrupt();\n+            logger.warn(\"[{}] Interrupted while waiting for PIT close operations to complete\", getJobId(), e);\n         }\n     }\n \n-    private void closePointInTime(String name) {\n+    private void closePointInTime(String name, ActionListener<Void> listener) {\n         PointInTimeBuilder pit = namedPits.remove(name);\n \n         if (pit == null) {\n+            listener.onResponse(null);\n             return;\n         }\n \n@@ -505,9 +539,11 @@ class ClientTransformIndexer extends TransformIndexer {\n             closePitRequest,\n             ActionListener.wrap(response -> {\n                 logger.trace(\"[{}] closed pit search context [{}]\", getJobId(), oldPit);\n+                listener.onResponse(null);\n             }, e -> {\n                 // note: closing the pit should never throw, even if the pit is invalid\n                 logger.error(() -> \"[\" + getJobId() + \"] Failed to close point in time reader\", e);\n+                listener.onFailure(e);\n             })\n         );\n     }",
  "logs_path": "claude-code/claude-sonnet-4-5/8d6f99fc/elastic_elasticsearch_pr134955/logs.jsonl",
  "errors": [],
  "edit_run_id": "8d6f99fc",
  "test_label": "v1-rollouts-1-3-sonnet4.5"
}