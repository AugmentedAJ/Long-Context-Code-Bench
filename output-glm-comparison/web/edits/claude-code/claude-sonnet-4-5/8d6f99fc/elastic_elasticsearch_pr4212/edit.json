{
  "repo_url": "https://github.com/elastic/elasticsearch.git",
  "pr_number": 4212,
  "base_commit": "22852d8040df7c789e0cdbb32d33ef1e5cc76435",
  "runner": "claude-code",
  "model": "claude-sonnet-4-5",
  "timeout_s": 1800,
  "status": "success",
  "elapsed_ms": 268662,
  "patch_unified": "diff --git a/src/main/java/org/elasticsearch/repositories/RepositoriesService.java b/src/main/java/org/elasticsearch/repositories/RepositoriesService.java\nindex 0f9d59d..d88b547 100644\n--- a/src/main/java/org/elasticsearch/repositories/RepositoriesService.java\n+++ b/src/main/java/org/elasticsearch/repositories/RepositoriesService.java\n@@ -27,6 +27,8 @@ import org.elasticsearch.cluster.ack.ClusterStateUpdateResponse;\n import org.elasticsearch.cluster.metadata.MetaData;\n import org.elasticsearch.cluster.metadata.RepositoriesMetaData;\n import org.elasticsearch.cluster.metadata.RepositoryMetaData;\n+import org.elasticsearch.cluster.metadata.RestoreMetaData;\n+import org.elasticsearch.cluster.metadata.SnapshotMetaData;\n import org.elasticsearch.cluster.node.DiscoveryNode;\n import org.elasticsearch.common.Nullable;\n import org.elasticsearch.common.component.AbstractComponent;\n@@ -72,6 +74,37 @@ public class RepositoriesService extends AbstractComponent implements ClusterSta\n         }\n     }\n \n+    /**\n+     * Checks if a repository is currently in use by any snapshot or restore operations\n+     *\n+     * @param repository repository name to check\n+     * @param state      current cluster state\n+     * @return true if repository is in use, false otherwise\n+     */\n+    private boolean isRepositoryInUse(String repository, ClusterState state) {\n+        // Check for active snapshots\n+        SnapshotMetaData snapshotMetaData = state.metaData().custom(SnapshotMetaData.TYPE);\n+        if (snapshotMetaData != null && !snapshotMetaData.entries().isEmpty()) {\n+            for (SnapshotMetaData.Entry entry : snapshotMetaData.entries()) {\n+                if (repository.equals(entry.snapshotId().getRepository())) {\n+                    return true;\n+                }\n+            }\n+        }\n+\n+        // Check for active restores\n+        RestoreMetaData restoreMetaData = state.metaData().custom(RestoreMetaData.TYPE);\n+        if (restoreMetaData != null && !restoreMetaData.entries().isEmpty()) {\n+            for (RestoreMetaData.Entry entry : restoreMetaData.entries()) {\n+                if (repository.equals(entry.snapshotId().getRepository())) {\n+                    return true;\n+                }\n+            }\n+        }\n+\n+        return false;\n+    }\n+\n     /**\n      * Registers new repository in the cluster\n      * <p/>\n@@ -105,6 +138,13 @@ public class RepositoriesService extends AbstractComponent implements ClusterSta\n                     for (RepositoryMetaData repositoryMetaData : repositories.repositories()) {\n                         if (repositoryMetaData.name().equals(newRepositoryMetaData.name())) {\n                             found = true;\n+                            // Check if repository is being updated (different settings)\n+                            boolean settingsChanged = !repositoryMetaData.type().equals(newRepositoryMetaData.type())\n+                                || !repositoryMetaData.settings().equals(newRepositoryMetaData.settings());\n+                            if (settingsChanged && isRepositoryInUse(repositoryMetaData.name(), currentState)) {\n+                                throw new RepositoryInUseException(repositoryMetaData.name(),\n+                                    \"trying to modify or delete repository that is currently used by snapshot or restore operations\");\n+                            }\n                             repositoriesMetaData.add(newRepositoryMetaData);\n                         } else {\n                             repositoriesMetaData.add(repositoryMetaData);\n@@ -180,6 +220,11 @@ public class RepositoriesService extends AbstractComponent implements ClusterSta\n                     boolean changed = false;\n                     for (RepositoryMetaData repositoryMetaData : repositories.repositories()) {\n                         if (Regex.simpleMatch(request.name, repositoryMetaData.name())) {\n+                            // Check if repository is in use before allowing deletion\n+                            if (isRepositoryInUse(repositoryMetaData.name(), currentState)) {\n+                                throw new RepositoryInUseException(repositoryMetaData.name(),\n+                                    \"trying to modify or delete repository that is currently used by snapshot or restore operations\");\n+                            }\n                             logger.info(\"delete repository [{}]\", repositoryMetaData.name());\n                             changed = true;\n                         } else {",
  "logs_path": "claude-code/claude-sonnet-4-5/8d6f99fc/elastic_elasticsearch_pr4212/logs.jsonl",
  "errors": [],
  "edit_run_id": "8d6f99fc",
  "test_label": "v1-rollouts-1-3-sonnet4.5"
}