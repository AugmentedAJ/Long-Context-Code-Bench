{
  "repo_url": "https://github.com/elastic/elasticsearch.git",
  "pr_number": 1600,
  "base_commit": "ed8a46ce09ccf43adec55af91a72fc9c5dc1ec05",
  "runner": "claude-code",
  "model": "claude-sonnet-4-5",
  "timeout_s": 1800,
  "status": "success",
  "elapsed_ms": 195802,
  "patch_unified": "diff --git a/src/main/java/org/elasticsearch/action/update/TransportUpdateAction.java b/src/main/java/org/elasticsearch/action/update/TransportUpdateAction.java\nindex 5a296cd..bc34e36 100644\n--- a/src/main/java/org/elasticsearch/action/update/TransportUpdateAction.java\n+++ b/src/main/java/org/elasticsearch/action/update/TransportUpdateAction.java\n@@ -52,6 +52,7 @@ import org.elasticsearch.index.get.GetResult;\n import org.elasticsearch.index.mapper.internal.ParentFieldMapper;\n import org.elasticsearch.index.mapper.internal.RoutingFieldMapper;\n import org.elasticsearch.index.mapper.internal.SourceFieldMapper;\n+import org.elasticsearch.index.mapper.internal.TTLFieldMapper;\n import org.elasticsearch.index.mapper.internal.TimestampFieldMapper;\n import org.elasticsearch.index.service.IndexService;\n import org.elasticsearch.index.shard.IllegalIndexShardStateException;\n@@ -153,7 +154,7 @@ public class TransportUpdateAction extends TransportInstanceSingleOperationActio\n         IndexShard indexShard = indexService.shardSafe(request.shardId());\n \n         GetResult getResult = indexShard.getService().get(request.type(), request.id(),\n-                new String[]{SourceFieldMapper.NAME, RoutingFieldMapper.NAME, ParentFieldMapper.NAME, TimestampFieldMapper.NAME}, true);\n+                new String[]{SourceFieldMapper.NAME, RoutingFieldMapper.NAME, ParentFieldMapper.NAME, TimestampFieldMapper.NAME, TTLFieldMapper.NAME}, true);\n \n         // no doc, what to do, what to do...\n         if (!getResult.exists()) {\n@@ -188,7 +189,26 @@ public class TransportUpdateAction extends TransportInstanceSingleOperationActio\n         // apply script to update the source\n         String routing = getResult.fields().containsKey(RoutingFieldMapper.NAME) ? getResult.field(RoutingFieldMapper.NAME).value().toString() : null;\n         String parent = getResult.fields().containsKey(ParentFieldMapper.NAME) ? getResult.field(ParentFieldMapper.NAME).value().toString() : null;\n-        // TODO ttl/timestamp\n+\n+        // Extract timestamp and TTL from existing document or use values from request\n+        String timestamp = null;\n+        long ttl = -1;\n+\n+        if (request.timestamp() != null) {\n+            // Use timestamp from request if provided\n+            timestamp = request.timestamp();\n+        } else if (getResult.fields().containsKey(TimestampFieldMapper.NAME)) {\n+            // Otherwise preserve existing timestamp\n+            timestamp = getResult.field(TimestampFieldMapper.NAME).value().toString();\n+        }\n+\n+        if (request.ttl() > 0) {\n+            // Use TTL from request if provided\n+            ttl = request.ttl();\n+        } else if (getResult.fields().containsKey(TTLFieldMapper.NAME)) {\n+            // Otherwise preserve existing TTL\n+            ttl = getResult.field(TTLFieldMapper.NAME).value();\n+        }\n \n         // TODO percolate?\n \n@@ -197,7 +217,8 @@ public class TransportUpdateAction extends TransportInstanceSingleOperationActio\n         if (operation == null || \"index\".equals(operation)) {\n             IndexRequest indexRequest = Requests.indexRequest(request.index()).type(request.type()).id(request.id()).routing(routing).parent(parent)\n                     .source(source, sourceAndContent.v1())\n-                    .version(getResult.version()).replicationType(request.replicationType()).consistencyLevel(request.consistencyLevel());\n+                    .version(getResult.version()).replicationType(request.replicationType()).consistencyLevel(request.consistencyLevel())\n+                    .timestamp(timestamp).ttl(ttl);\n             indexRequest.operationThreaded(false);\n             indexAction.execute(indexRequest, new ActionListener<IndexResponse>() {\n                 @Override\ndiff --git a/src/main/java/org/elasticsearch/action/update/UpdateRequest.java b/src/main/java/org/elasticsearch/action/update/UpdateRequest.java\nindex 05e39ce..34bd7d6 100644\n--- a/src/main/java/org/elasticsearch/action/update/UpdateRequest.java\n+++ b/src/main/java/org/elasticsearch/action/update/UpdateRequest.java\n@@ -42,6 +42,9 @@ public class UpdateRequest extends InstanceShardOperationRequest {\n     private String id;\n     @Nullable\n     private String routing;\n+    @Nullable\n+    private String timestamp;\n+    private long ttl = -1;\n \n     String script;\n     @Nullable\n@@ -149,6 +152,41 @@ public class UpdateRequest extends InstanceShardOperationRequest {\n         return this.routing;\n     }\n \n+    /**\n+     * Sets the timestamp for the indexed document.\n+     */\n+    public UpdateRequest timestamp(String timestamp) {\n+        this.timestamp = timestamp;\n+        return this;\n+    }\n+\n+    /**\n+     * The timestamp to use for the indexed document.\n+     */\n+    public String timestamp() {\n+        return this.timestamp;\n+    }\n+\n+    /**\n+     * Sets the relative ttl value. It musts be {@literal >} 0 as it makes little sense otherwise. Setting it\n+     * to <tt>null</tt> will reset to have no ttl.\n+     */\n+    public UpdateRequest ttl(Long ttl) {\n+        if (ttl == null) {\n+            this.ttl = -1;\n+            return this;\n+        }\n+        this.ttl = ttl;\n+        return this;\n+    }\n+\n+    /**\n+     * The ttl of the document.\n+     */\n+    public long ttl() {\n+        return this.ttl;\n+    }\n+\n     int shardId() {\n         return this.shardId;\n     }\n@@ -291,6 +329,10 @@ public class UpdateRequest extends InstanceShardOperationRequest {\n         if (in.readBoolean()) {\n             routing = in.readUTF();\n         }\n+        if (in.readBoolean()) {\n+            timestamp = in.readUTF();\n+        }\n+        ttl = in.readLong();\n         script = in.readUTF();\n         if (in.readBoolean()) {\n             scriptLang = in.readUTF();\n@@ -312,6 +354,13 @@ public class UpdateRequest extends InstanceShardOperationRequest {\n             out.writeBoolean(true);\n             out.writeUTF(routing);\n         }\n+        if (timestamp == null) {\n+            out.writeBoolean(false);\n+        } else {\n+            out.writeBoolean(true);\n+            out.writeUTF(timestamp);\n+        }\n+        out.writeLong(ttl);\n         out.writeUTF(script);\n         if (scriptLang == null) {\n             out.writeBoolean(false);\ndiff --git a/src/main/java/org/elasticsearch/rest/action/update/RestUpdateAction.java b/src/main/java/org/elasticsearch/rest/action/update/RestUpdateAction.java\nindex e6bef60..ba388ec 100644\n--- a/src/main/java/org/elasticsearch/rest/action/update/RestUpdateAction.java\n+++ b/src/main/java/org/elasticsearch/rest/action/update/RestUpdateAction.java\n@@ -57,6 +57,10 @@ public class RestUpdateAction extends BaseRestHandler {\n         updateRequest.routing(request.param(\"routing\"));\n         updateRequest.parent(request.param(\"parent\")); // order is important, set it after routing, so it will set the routing\n         updateRequest.timeout(request.paramAsTime(\"timeout\", updateRequest.timeout()));\n+        updateRequest.timestamp(request.param(\"timestamp\"));\n+        if (request.hasParam(\"ttl\")) {\n+            updateRequest.ttl(request.paramAsTime(\"ttl\", null).millis());\n+        }\n         String replicationType = request.param(\"replication\");\n         if (replicationType != null) {\n             updateRequest.replicationType(ReplicationType.fromString(replicationType));",
  "logs_path": "claude-code/claude-sonnet-4-5/8d6f99fc/elastic_elasticsearch_pr1600/logs.jsonl",
  "errors": [],
  "edit_run_id": "8d6f99fc",
  "test_label": "v1-rollouts-1-3-sonnet4.5"
}