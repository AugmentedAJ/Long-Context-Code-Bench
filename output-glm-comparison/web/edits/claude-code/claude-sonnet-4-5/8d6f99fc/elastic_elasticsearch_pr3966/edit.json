{
  "repo_url": "https://github.com/elastic/elasticsearch.git",
  "pr_number": 3966,
  "base_commit": "c9dab6991eff5c01c7b0c36aecaf0f061267e030",
  "runner": "claude-code",
  "model": "claude-sonnet-4-5",
  "timeout_s": 1800,
  "status": "success",
  "elapsed_ms": 701933,
  "patch_unified": "diff --git a/src/main/java/org/elasticsearch/index/analysis/AnalysisService.java b/src/main/java/org/elasticsearch/index/analysis/AnalysisService.java\nindex 7698020..bd87884 100644\n--- a/src/main/java/org/elasticsearch/index/analysis/AnalysisService.java\n+++ b/src/main/java/org/elasticsearch/index/analysis/AnalysisService.java\n@@ -189,12 +189,14 @@ public class AnalysisService extends AbstractIndexComponent implements Closeable\n             for (Map.Entry<String, PreBuiltAnalyzerProviderFactory> entry : indicesAnalysisService.analyzerProviderFactories().entrySet()) {\n                 String name = entry.getKey();\n                 if (!analyzerProviders.containsKey(name)) {\n-                    analyzerProviders.put(name, entry.getValue().create(name, ImmutableSettings.Builder.EMPTY_SETTINGS));\n+                    // Pass index settings to allow version-aware analyzer creation\n+                    analyzerProviders.put(name, entry.getValue().create(name, indexSettings));\n                 }\n                 name = Strings.toCamelCase(entry.getKey());\n                 if (!name.equals(entry.getKey())) {\n                     if (!analyzerProviders.containsKey(name)) {\n-                        analyzerProviders.put(name, entry.getValue().create(name, ImmutableSettings.Builder.EMPTY_SETTINGS));\n+                        // Pass index settings to allow version-aware analyzer creation\n+                        analyzerProviders.put(name, entry.getValue().create(name, indexSettings));\n                     }\n                 }\n             }\ndiff --git a/src/main/java/org/elasticsearch/index/analysis/PreBuiltAnalyzerProviderFactory.java b/src/main/java/org/elasticsearch/index/analysis/PreBuiltAnalyzerProviderFactory.java\nindex 1cf698d..630a664 100644\n--- a/src/main/java/org/elasticsearch/index/analysis/PreBuiltAnalyzerProviderFactory.java\n+++ b/src/main/java/org/elasticsearch/index/analysis/PreBuiltAnalyzerProviderFactory.java\n@@ -20,29 +20,108 @@\n package org.elasticsearch.index.analysis;\n \n import org.apache.lucene.analysis.Analyzer;\n+import org.apache.lucene.util.Version;\n+import org.elasticsearch.cluster.metadata.IndexMetaData;\n+import org.elasticsearch.common.logging.ESLogger;\n+import org.elasticsearch.common.logging.Loggers;\n import org.elasticsearch.common.settings.Settings;\n \n /**\n- *\n+ * Version-aware prebuilt analyzer provider factory.\n+ * <p>\n+ * This factory can either hold a fixed analyzer (for backwards compatibility) or\n+ * a reference to a {@link PreBuiltAnalyzers} enum that creates version-specific analyzers.\n+ * <p>\n+ * When the factory is configured with a PreBuiltAnalyzers enum, it will create\n+ * an analyzer with the appropriate Lucene version based on when the index was created.\n  */\n public class PreBuiltAnalyzerProviderFactory implements AnalyzerProviderFactory {\n \n-    private final PreBuiltAnalyzerProvider analyzerProvider;\n+    private final PreBuiltAnalyzerProvider fixedAnalyzerProvider;\n+    private final PreBuiltAnalyzers preBuiltAnalyzer;\n+    private final String name;\n+    private final AnalyzerScope scope;\n+\n+    private static final ESLogger logger = Loggers.getLogger(PreBuiltAnalyzerProviderFactory.class);\n \n+    /**\n+     * Creates a factory with a fixed analyzer (backwards compatibility).\n+     */\n     public PreBuiltAnalyzerProviderFactory(String name, AnalyzerScope scope, Analyzer analyzer) {\n-        this(new PreBuiltAnalyzerProvider(name, scope, analyzer));\n+        this.name = name;\n+        this.scope = scope;\n+        this.fixedAnalyzerProvider = new PreBuiltAnalyzerProvider(name, scope, analyzer);\n+        this.preBuiltAnalyzer = null;\n     }\n \n+    /**\n+     * Creates a factory with a PreBuiltAnalyzers enum for version-aware creation.\n+     */\n+    public PreBuiltAnalyzerProviderFactory(String name, AnalyzerScope scope, PreBuiltAnalyzers preBuiltAnalyzer) {\n+        this.name = name;\n+        this.scope = scope;\n+        this.preBuiltAnalyzer = preBuiltAnalyzer;\n+        this.fixedAnalyzerProvider = null;\n+    }\n+\n+    /**\n+     * Backwards compatibility constructor.\n+     */\n     public PreBuiltAnalyzerProviderFactory(PreBuiltAnalyzerProvider analyzerProvider) {\n-        this.analyzerProvider = analyzerProvider;\n+        this.name = analyzerProvider.name();\n+        this.scope = analyzerProvider.scope();\n+        this.fixedAnalyzerProvider = analyzerProvider;\n+        this.preBuiltAnalyzer = null;\n     }\n \n     @Override\n     public AnalyzerProvider create(String name, Settings settings) {\n-        return analyzerProvider;\n+        // If using a fixed analyzer, return it directly (backwards compatibility)\n+        if (fixedAnalyzerProvider != null) {\n+            return fixedAnalyzerProvider;\n+        }\n+\n+        // Otherwise, create a version-specific analyzer based on index settings\n+        Version version = extractVersion(settings);\n+        Analyzer analyzer = preBuiltAnalyzer.create(version);\n+        return new PreBuiltAnalyzerProvider(name, scope, analyzer);\n+    }\n+\n+    /**\n+     * Extracts the Lucene version to use for the analyzer from the settings.\n+     * The version is determined by:\n+     * 1. Explicit version setting on the analyzer\n+     * 2. Index-level analysis version setting\n+     * 3. The version when the index was created (from index.version.created)\n+     */\n+    private Version extractVersion(Settings settings) {\n+        // First check for explicit version on the analyzer\n+        String versionString = settings.get(\"version\");\n+        if (versionString != null) {\n+            return org.elasticsearch.common.lucene.Lucene.parseVersion(versionString,\n+                org.elasticsearch.common.lucene.Lucene.ANALYZER_VERSION, logger);\n+        }\n+\n+        // Check for index-level analysis version\n+        versionString = settings.get(\"index.analysis.version\");\n+        if (versionString != null) {\n+            return org.elasticsearch.common.lucene.Lucene.parseVersion(versionString,\n+                org.elasticsearch.common.lucene.Lucene.ANALYZER_VERSION, logger);\n+        }\n+\n+        // Fall back to the version from when the index was created\n+        org.elasticsearch.Version indexVersion = settings.getAsVersion(\n+            IndexMetaData.SETTING_VERSION_CREATED,\n+            org.elasticsearch.Version.CURRENT\n+        );\n+        return indexVersion.luceneVersion;\n     }\n \n     public Analyzer analyzer() {\n-        return analyzerProvider.get();\n+        if (fixedAnalyzerProvider != null) {\n+            return fixedAnalyzerProvider.get();\n+        }\n+        // For version-aware analyzers, return the latest version\n+        return preBuiltAnalyzer.create(org.elasticsearch.common.lucene.Lucene.ANALYZER_VERSION);\n     }\n }",
  "logs_path": "claude-code/claude-sonnet-4-5/8d6f99fc/elastic_elasticsearch_pr3966/logs.jsonl",
  "errors": [],
  "edit_run_id": "8d6f99fc",
  "test_label": "v1-rollouts-1-3-sonnet4.5"
}