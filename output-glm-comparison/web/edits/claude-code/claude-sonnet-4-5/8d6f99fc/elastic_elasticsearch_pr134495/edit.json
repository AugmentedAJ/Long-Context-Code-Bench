{
  "repo_url": "https://github.com/elastic/elasticsearch.git",
  "pr_number": 134495,
  "base_commit": "36181aa6f726d08d5c9c779f2d6e99b732de0ccc",
  "runner": "claude-code",
  "model": "claude-sonnet-4-5",
  "timeout_s": 1800,
  "status": "success",
  "elapsed_ms": 351054,
  "patch_unified": "diff --git a/server/src/internalClusterTest/java/org/elasticsearch/search/ccs/CCSUsageTelemetryIT.java b/server/src/internalClusterTest/java/org/elasticsearch/search/ccs/CCSUsageTelemetryIT.java\nindex ab79fd7b..a3269d19 100644\n--- a/server/src/internalClusterTest/java/org/elasticsearch/search/ccs/CCSUsageTelemetryIT.java\n+++ b/server/src/internalClusterTest/java/org/elasticsearch/search/ccs/CCSUsageTelemetryIT.java\n@@ -80,6 +80,54 @@ public class CCSUsageTelemetryIT extends AbstractMultiClustersTestCase {\n     @Rule\n     public SkipUnavailableRule skipOverride = new SkipUnavailableRule(REMOTE1, REMOTE2);\n \n+    private void assertBasicCounts(CCSTelemetrySnapshot snapshot, long expectedTotal, long expectedSuccess) {\n+        assertThat(snapshot.getTotalCount(), equalTo(expectedTotal));\n+        assertThat(snapshot.getSuccessCount(), equalTo(expectedSuccess));\n+    }\n+\n+    private void assertMrtMetrics(CCSTelemetrySnapshot snapshot, boolean minimizeRoundtrips, long expectedCount) {\n+        assertThat(snapshot.getTookMrtTrue().count(), equalTo(minimizeRoundtrips ? expectedCount : 0L));\n+        assertThat(snapshot.getTookMrtFalse().count(), equalTo(minimizeRoundtrips ? 0L : expectedCount));\n+    }\n+\n+    private void assertRemoteSearchMetrics(\n+        CCSTelemetrySnapshot snapshot,\n+        long expectedSkippedRemotes,\n+        double expectedAvg,\n+        long expectedMax\n+    ) {\n+        assertThat(snapshot.getSearchCountWithSkippedRemotes(), equalTo(expectedSkippedRemotes));\n+        assertThat(snapshot.getRemotesPerSearchAvg(), equalTo(expectedAvg));\n+        assertThat(snapshot.getRemotesPerSearchMax(), equalTo(expectedMax));\n+    }\n+\n+    private void assertFeatureCount(CCSTelemetrySnapshot snapshot, String feature, Long expectedCount) {\n+        assertThat(snapshot.getFeatureCounts().get(feature), equalTo(expectedCount));\n+    }\n+\n+    private void assertPerClusterTelemetry(\n+        CCSTelemetrySnapshot.PerClusterCCSTelemetry telemetry,\n+        long expectedCount,\n+        long expectedSkippedCount,\n+        long expectedTookCount\n+    ) {\n+        assertThat(telemetry.getCount(), equalTo(expectedCount));\n+        assertThat(telemetry.getSkippedCount(), equalTo(expectedSkippedCount));\n+        assertThat(telemetry.getTook().count(), equalTo(expectedTookCount));\n+    }\n+\n+    private void assertFailedSearch(\n+        CCSTelemetrySnapshot telemetry,\n+        long expectedRemotesMax,\n+        Map<String, Long> expectedFailures\n+    ) {\n+        assertBasicCounts(telemetry, 1L, 0L);\n+        assertThat(telemetry.getTook().count(), equalTo(0L));\n+        assertMrtMetrics(telemetry, false, 0L);\n+        assertThat(telemetry.getRemotesPerSearchMax(), equalTo(expectedRemotesMax));\n+        assertThat(telemetry.getFailureReasons(), equalTo(expectedFailures));\n+    }\n+\n     @Override\n     protected Map<String, Boolean> skipUnavailableForRemoteClusters() {\n         var map = skipOverride.getMap();\n@@ -156,54 +204,36 @@ public class CCSUsageTelemetryIT extends AbstractMultiClustersTestCase {\n         );\n         CCSTelemetrySnapshot telemetry = getTelemetrySnapshot(nodeName);\n \n-        assertThat(telemetry.getTotalCount(), equalTo(1L));\n-        assertThat(telemetry.getSuccessCount(), equalTo(1L));\n+        assertBasicCounts(telemetry, 1L, 1L);\n         assertThat(telemetry.getFailureReasons().size(), equalTo(0));\n         assertThat(telemetry.getTook().count(), equalTo(1L));\n-        assertThat(telemetry.getTookMrtTrue().count(), equalTo(minimizeRoundtrips ? 1L : 0L));\n-        assertThat(telemetry.getTookMrtFalse().count(), equalTo(minimizeRoundtrips ? 0L : 1L));\n-        assertThat(telemetry.getRemotesPerSearchAvg(), equalTo(2.0));\n-        assertThat(telemetry.getRemotesPerSearchMax(), equalTo(2L));\n-        assertThat(telemetry.getSearchCountWithSkippedRemotes(), equalTo(0L));\n+        assertMrtMetrics(telemetry, minimizeRoundtrips, 1L);\n+        assertRemoteSearchMetrics(telemetry, 0L, 2.0, 2L);\n         assertThat(telemetry.getClientCounts().size(), equalTo(1));\n         assertThat(telemetry.getClientCounts().get(\"kibana\"), equalTo(1L));\n-        if (minimizeRoundtrips) {\n-            assertThat(telemetry.getFeatureCounts().get(MRT_FEATURE), equalTo(1L));\n-        } else {\n-            assertThat(telemetry.getFeatureCounts().get(MRT_FEATURE), equalTo(null));\n-        }\n-        assertThat(telemetry.getFeatureCounts().get(ASYNC_FEATURE), equalTo(null));\n+        assertFeatureCount(telemetry, MRT_FEATURE, minimizeRoundtrips ? 1L : null);\n+        assertFeatureCount(telemetry, ASYNC_FEATURE, null);\n \n         var perCluster = telemetry.getByRemoteCluster();\n         assertThat(perCluster.size(), equalTo(3));\n         for (String clusterAlias : remoteClusterAlias()) {\n-            var clusterTelemetry = perCluster.get(clusterAlias);\n-            assertThat(clusterTelemetry.getCount(), equalTo(1L));\n-            assertThat(clusterTelemetry.getSkippedCount(), equalTo(0L));\n-            assertThat(clusterTelemetry.getTook().count(), equalTo(1L));\n+            assertPerClusterTelemetry(perCluster.get(clusterAlias), 1L, 0L, 1L);\n         }\n \n         // another search\n         assertResponse(cluster(LOCAL_CLUSTER).client(nodeName).search(searchRequest), Assert::assertNotNull);\n         telemetry = getTelemetrySnapshot(nodeName);\n-        assertThat(telemetry.getTotalCount(), equalTo(2L));\n-        assertThat(telemetry.getSuccessCount(), equalTo(2L));\n+        assertBasicCounts(telemetry, 2L, 2L);\n         assertThat(telemetry.getFailureReasons().size(), equalTo(0));\n         assertThat(telemetry.getTook().count(), equalTo(2L));\n-        assertThat(telemetry.getTookMrtTrue().count(), equalTo(minimizeRoundtrips ? 2L : 0L));\n-        assertThat(telemetry.getTookMrtFalse().count(), equalTo(minimizeRoundtrips ? 0L : 2L));\n-        assertThat(telemetry.getRemotesPerSearchAvg(), equalTo(2.0));\n-        assertThat(telemetry.getRemotesPerSearchMax(), equalTo(2L));\n-        assertThat(telemetry.getSearchCountWithSkippedRemotes(), equalTo(0L));\n+        assertMrtMetrics(telemetry, minimizeRoundtrips, 2L);\n+        assertRemoteSearchMetrics(telemetry, 0L, 2.0, 2L);\n         assertThat(telemetry.getClientCounts().size(), equalTo(1));\n         assertThat(telemetry.getClientCounts().get(\"kibana\"), equalTo(1L));\n         perCluster = telemetry.getByRemoteCluster();\n         assertThat(perCluster.size(), equalTo(3));\n         for (String clusterAlias : remoteClusterAlias()) {\n-            var clusterTelemetry = perCluster.get(clusterAlias);\n-            assertThat(clusterTelemetry.getCount(), equalTo(2L));\n-            assertThat(clusterTelemetry.getSkippedCount(), equalTo(0L));\n-            assertThat(clusterTelemetry.getTook().count(), equalTo(2L));\n+            assertPerClusterTelemetry(perCluster.get(clusterAlias), 2L, 0L, 2L);\n         }\n     }\n \n@@ -261,18 +291,13 @@ public class CCSUsageTelemetryIT extends AbstractMultiClustersTestCase {\n \n         CCSTelemetrySnapshot telemetry = getTelemetryFromSearch(\"*:\" + remoteIndex);\n         var perCluster = telemetry.getByRemoteCluster();\n-        assertThat(telemetry.getTotalCount(), equalTo(1L));\n-        assertThat(telemetry.getSuccessCount(), equalTo(1L));\n+        assertBasicCounts(telemetry, 1L, 1L);\n         assertThat(telemetry.getFailureReasons().size(), equalTo(0));\n         assertThat(telemetry.getTook().count(), equalTo(1L));\n         assertThat(perCluster.size(), equalTo(2));\n         assertThat(telemetry.getClientCounts().size(), equalTo(0));\n-        assertThat(perCluster.get(REMOTE1).getCount(), equalTo(1L));\n-        assertThat(perCluster.get(REMOTE1).getSkippedCount(), equalTo(0L));\n-        assertThat(perCluster.get(REMOTE1).getTook().count(), equalTo(1L));\n-        assertThat(perCluster.get(REMOTE2).getCount(), equalTo(1L));\n-        assertThat(perCluster.get(REMOTE2).getSkippedCount(), equalTo(0L));\n-        assertThat(perCluster.get(REMOTE2).getTook().count(), equalTo(1L));\n+        assertPerClusterTelemetry(perCluster.get(REMOTE1), 1L, 0L, 1L);\n+        assertPerClusterTelemetry(perCluster.get(REMOTE2), 1L, 0L, 1L);\n     }\n \n     /**\n@@ -339,13 +364,8 @@ public class CCSUsageTelemetryIT extends AbstractMultiClustersTestCase {\n         searchRequest.allowPartialSearchResults(true);\n \n         CCSTelemetrySnapshot telemetry = getTelemetryFromFailedSearch(searchRequest);\n-        assertThat(telemetry.getTotalCount(), equalTo(1L));\n-        assertThat(telemetry.getSuccessCount(), equalTo(0L));\n-        assertThat(telemetry.getTook().count(), equalTo(0L));\n-        assertThat(telemetry.getTookMrtTrue().count(), equalTo(0L));\n-        assertThat(telemetry.getTookMrtFalse().count(), equalTo(0L));\n         Map<String, Long> expectedFailures = Map.of(Result.UNKNOWN.getName(), 1L);\n-        assertThat(telemetry.getFailureReasons(), equalTo(expectedFailures));\n+        assertFailedSearch(telemetry, 2L, expectedFailures);\n     }\n \n     /**\n@@ -370,20 +390,15 @@ public class CCSUsageTelemetryIT extends AbstractMultiClustersTestCase {\n         assertResponse(cluster(LOCAL_CLUSTER).client(nodeName).search(searchRequest), Assert::assertNotNull);\n \n         CCSTelemetrySnapshot telemetry = getTelemetrySnapshot(nodeName);\n-        assertThat(telemetry.getTotalCount(), equalTo(1L));\n-        assertThat(telemetry.getSuccessCount(), equalTo(1L));\n+        assertBasicCounts(telemetry, 1L, 1L);\n         // Note that this counts how many searches had skipped remotes, not how many remotes are skipped\n-        assertThat(telemetry.getSearchCountWithSkippedRemotes(), equalTo(1L));\n-        // Still count the remote that failed\n-        assertThat(telemetry.getRemotesPerSearchMax(), equalTo(2L));\n+        assertRemoteSearchMetrics(telemetry, 1L, 2.0, 2L);\n         assertThat(telemetry.getTook().count(), equalTo(1L));\n         // Each remote will have its skipped count bumped\n         var perCluster = telemetry.getByRemoteCluster();\n         assertThat(perCluster.size(), equalTo(3));\n         for (String remote : remoteClusterAlias()) {\n-            assertThat(perCluster.get(remote).getCount(), equalTo(0L));\n-            assertThat(perCluster.get(remote).getSkippedCount(), equalTo(1L));\n-            assertThat(perCluster.get(remote).getTook().count(), equalTo(0L));\n+            assertPerClusterTelemetry(perCluster.get(remote), 0L, 1L, 0L);\n         }\n     }\n \n@@ -407,24 +422,17 @@ public class CCSUsageTelemetryIT extends AbstractMultiClustersTestCase {\n         assertResponse(cluster(LOCAL_CLUSTER).client(nodeName).search(searchRequest), Assert::assertNotNull);\n \n         CCSTelemetrySnapshot telemetry = getTelemetrySnapshot(nodeName);\n-        assertThat(telemetry.getTotalCount(), equalTo(1L));\n-        assertThat(telemetry.getSuccessCount(), equalTo(1L));\n+        assertBasicCounts(telemetry, 1L, 1L);\n         // Note that this counts how many searches had skipped remotes, not how many remotes are skipped\n-        assertThat(telemetry.getSearchCountWithSkippedRemotes(), equalTo(1L));\n-        // Still count the remote that failed\n-        assertThat(telemetry.getRemotesPerSearchMax(), equalTo(2L));\n+        assertRemoteSearchMetrics(telemetry, 1L, 2.0, 2L);\n         assertThat(telemetry.getTook().count(), equalTo(1L));\n         // Each remote will have its skipped count bumped\n         var perCluster = telemetry.getByRemoteCluster();\n         assertThat(perCluster.size(), equalTo(3));\n         // This one is skipped\n-        assertThat(perCluster.get(REMOTE1).getCount(), equalTo(0L));\n-        assertThat(perCluster.get(REMOTE1).getSkippedCount(), equalTo(1L));\n-        assertThat(perCluster.get(REMOTE1).getTook().count(), equalTo(0L));\n+        assertPerClusterTelemetry(perCluster.get(REMOTE1), 0L, 1L, 0L);\n         // This one is OK\n-        assertThat(perCluster.get(REMOTE2).getCount(), equalTo(1L));\n-        assertThat(perCluster.get(REMOTE2).getSkippedCount(), equalTo(0L));\n-        assertThat(perCluster.get(REMOTE2).getTook().count(), equalTo(1L));\n+        assertPerClusterTelemetry(perCluster.get(REMOTE2), 1L, 0L, 1L);\n     }\n \n     /**\n@@ -447,15 +455,11 @@ public class CCSUsageTelemetryIT extends AbstractMultiClustersTestCase {\n         searchRequest.source(sourceBuilder);\n \n         CCSTelemetrySnapshot telemetry = getTelemetryFromSearch(searchRequest);\n-        assertThat(telemetry.getTotalCount(), equalTo(1L));\n-        assertThat(telemetry.getSuccessCount(), equalTo(1L));\n-        assertThat(telemetry.getSearchCountWithSkippedRemotes(), equalTo(1L));\n-        assertThat(telemetry.getRemotesPerSearchMax(), equalTo(1L));\n+        assertBasicCounts(telemetry, 1L, 1L);\n+        assertRemoteSearchMetrics(telemetry, 1L, 1.0, 1L);\n         var perCluster = telemetry.getByRemoteCluster();\n         assertThat(perCluster.size(), equalTo(2));\n-        assertThat(perCluster.get(REMOTE1).getCount(), equalTo(0L));\n-        assertThat(perCluster.get(REMOTE1).getSkippedCount(), equalTo(1L));\n-        assertThat(perCluster.get(REMOTE1).getTook().count(), equalTo(0L));\n+        assertPerClusterTelemetry(perCluster.get(REMOTE1), 0L, 1L, 0L);\n         assertThat(perCluster.get(REMOTE2), equalTo(null));\n     }\n \n@@ -478,15 +482,11 @@ public class CCSUsageTelemetryIT extends AbstractMultiClustersTestCase {\n         searchRequest.source(sourceBuilder);\n \n         CCSTelemetrySnapshot telemetry = getTelemetryFromSearch(searchRequest);\n-        assertThat(telemetry.getTotalCount(), equalTo(1L));\n-        assertThat(telemetry.getSuccessCount(), equalTo(1L));\n-        assertThat(telemetry.getSearchCountWithSkippedRemotes(), equalTo(1L));\n-        assertThat(telemetry.getRemotesPerSearchMax(), equalTo(1L));\n+        assertBasicCounts(telemetry, 1L, 1L);\n+        assertRemoteSearchMetrics(telemetry, 1L, 1.0, 1L);\n         var perCluster = telemetry.getByRemoteCluster();\n         assertThat(perCluster.size(), equalTo(1));\n-        assertThat(perCluster.get(REMOTE1).getCount(), equalTo(0L));\n-        assertThat(perCluster.get(REMOTE1).getSkippedCount(), equalTo(1L));\n-        assertThat(perCluster.get(REMOTE1).getTook().count(), equalTo(0L));\n+        assertPerClusterTelemetry(perCluster.get(REMOTE1), 0L, 1L, 0L);\n         assertThat(perCluster.get(REMOTE2), equalTo(null));\n     }\n \n@@ -504,15 +504,10 @@ public class CCSUsageTelemetryIT extends AbstractMultiClustersTestCase {\n         searchRequest.source(sourceBuilder);\n \n         CCSTelemetrySnapshot telemetry = getTelemetryFromFailedSearch(searchRequest);\n-        assertThat(telemetry.getTotalCount(), equalTo(1L));\n-        assertThat(telemetry.getSuccessCount(), equalTo(0L));\n+        Map<String, Long> expectedFailure = Map.of(Result.TIMEOUT.getName(), 1L);\n+        assertFailedSearch(telemetry, 1L, expectedFailure);\n         // Failure is not skipping\n         assertThat(telemetry.getSearchCountWithSkippedRemotes(), equalTo(0L));\n-        // Still count the remote that failed\n-        assertThat(telemetry.getRemotesPerSearchMax(), equalTo(1L));\n-        assertThat(telemetry.getTook().count(), equalTo(0L));\n-        Map<String, Long> expectedFailure = Map.of(Result.TIMEOUT.getName(), 1L);\n-        assertThat(telemetry.getFailureReasons(), equalTo(expectedFailure));\n         // No per-cluster data on total failure\n         assertThat(telemetry.getByRemoteCluster().size(), equalTo(0));\n     }\n@@ -536,15 +531,10 @@ public class CCSUsageTelemetryIT extends AbstractMultiClustersTestCase {\n         searchRequest.source(new SearchSourceBuilder().query(queryBuilder).size(10));\n \n         CCSTelemetrySnapshot telemetry = getTelemetryFromFailedSearch(searchRequest);\n-        assertThat(telemetry.getTotalCount(), equalTo(1L));\n-        assertThat(telemetry.getSuccessCount(), equalTo(0L));\n+        Map<String, Long> expectedFailure = Map.of(Result.REMOTES_UNAVAILABLE.getName(), 1L);\n+        assertFailedSearch(telemetry, 2L, expectedFailure);\n         // Failure is not skipping\n         assertThat(telemetry.getSearchCountWithSkippedRemotes(), equalTo(0L));\n-        // Still count the remote that failed\n-        assertThat(telemetry.getRemotesPerSearchMax(), equalTo(2L));\n-        assertThat(telemetry.getTook().count(), equalTo(0L));\n-        Map<String, Long> expectedFailure = Map.of(Result.REMOTES_UNAVAILABLE.getName(), 1L);\n-        assertThat(telemetry.getFailureReasons(), equalTo(expectedFailure));\n         // No per-cluster data on total failure\n         assertThat(telemetry.getByRemoteCluster().size(), equalTo(0));\n     }\n@@ -557,12 +547,10 @@ public class CCSUsageTelemetryIT extends AbstractMultiClustersTestCase {\n         String localIndex = (String) testClusterInfo.get(\"local.index\");\n \n         CCSTelemetrySnapshot telemetry = getTelemetryFromSearch(localIndex, REMOTE1 + \":\" + \"no_such_index*\");\n-        assertThat(telemetry.getTotalCount(), equalTo(1L));\n-        assertThat(telemetry.getSuccessCount(), equalTo(1L));\n+        assertBasicCounts(telemetry, 1L, 1L);\n         var perCluster = telemetry.getByRemoteCluster();\n         assertThat(perCluster.size(), equalTo(2));\n-        assertThat(perCluster.get(REMOTE1).getCount(), equalTo(1L));\n-        assertThat(perCluster.get(REMOTE1).getTook().count(), equalTo(1L));\n+        assertPerClusterTelemetry(perCluster.get(REMOTE1), 1L, 0L, 1L);\n         assertThat(perCluster.get(REMOTE2), equalTo(null));\n     }\n \n@@ -573,12 +561,10 @@ public class CCSUsageTelemetryIT extends AbstractMultiClustersTestCase {\n     public void testRemoteHasNoIndexFailure() throws Exception {\n         SearchRequest searchRequest = makeSearchRequest(REMOTE1 + \":no_such_index\");\n         CCSTelemetrySnapshot telemetry = getTelemetryFromFailedSearch(searchRequest);\n-        assertThat(telemetry.getTotalCount(), equalTo(1L));\n-        assertThat(telemetry.getSuccessCount(), equalTo(0L));\n+        Map<String, Long> expectedFailure = Map.of(Result.NOT_FOUND.getName(), 1L);\n+        assertFailedSearch(telemetry, 1L, expectedFailure);\n         var perCluster = telemetry.getByRemoteCluster();\n         assertThat(perCluster.size(), equalTo(0));\n-        Map<String, Long> expectedFailure = Map.of(Result.NOT_FOUND.getName(), 1L);\n-        assertThat(telemetry.getFailureReasons(), equalTo(expectedFailure));\n     }\n \n     public void testPITSearch() throws ExecutionException, InterruptedException {\n@@ -605,9 +591,8 @@ public class CCSUsageTelemetryIT extends AbstractMultiClustersTestCase {\n         client.execute(TransportClosePointInTimeAction.TYPE, new ClosePointInTimeRequest(pitID)).actionGet();\n         CCSTelemetrySnapshot telemetry = getTelemetrySnapshot(nodeName);\n \n-        assertThat(telemetry.getTotalCount(), equalTo(2L));\n-        assertThat(telemetry.getSuccessCount(), equalTo(2L));\n-        assertThat(telemetry.getFeatureCounts().get(PIT_FEATURE), equalTo(2L));\n+        assertBasicCounts(telemetry, 2L, 2L);\n+        assertFeatureCount(telemetry, PIT_FEATURE, 2L);\n     }\n \n     public void testCompoundRetrieverSearch() throws ExecutionException, InterruptedException {\n@@ -620,8 +605,7 @@ public class CCSUsageTelemetryIT extends AbstractMultiClustersTestCase {\n         searchRequest.source(new SearchSourceBuilder().retriever(compoundRetriever));\n \n         CCSTelemetrySnapshot telemetry = getTelemetryFromSearch(searchRequest);\n-        assertThat(telemetry.getTotalCount(), equalTo(1L));\n-        assertThat(telemetry.getSuccessCount(), equalTo(1L));\n+        assertBasicCounts(telemetry, 1L, 1L);\n     }\n \n     private CCSTelemetrySnapshot getTelemetrySnapshot(String nodeName) {\ndiff --git a/server/src/test/java/org/elasticsearch/action/admin/cluster/stats/CCSTelemetrySnapshotTests.java b/server/src/test/java/org/elasticsearch/action/admin/cluster/stats/CCSTelemetrySnapshotTests.java\nindex 156bff93..3e3fdd78 100644\n--- a/server/src/test/java/org/elasticsearch/action/admin/cluster/stats/CCSTelemetrySnapshotTests.java\n+++ b/server/src/test/java/org/elasticsearch/action/admin/cluster/stats/CCSTelemetrySnapshotTests.java\n@@ -180,6 +180,73 @@ public class CCSTelemetrySnapshotTests extends AbstractWireSerializingTestCase<C\n         );\n     }\n \n+    private void assertBasicCounts(CCSTelemetrySnapshot snapshot, long expectedTotal, long expectedSuccess) {\n+        assertThat(snapshot.getTotalCount(), equalTo(expectedTotal));\n+        assertThat(snapshot.getSuccessCount(), equalTo(expectedSuccess));\n+    }\n+\n+    private void assertTookMetrics(CCSTelemetrySnapshot snapshot, long expectedCount) {\n+        assertThat(snapshot.getTook().count(), equalTo(expectedCount));\n+        assertThat(snapshot.getTookMrtTrue().count(), equalTo(expectedCount));\n+        assertThat(snapshot.getTookMrtFalse().count(), equalTo(expectedCount));\n+    }\n+\n+    private void assertMapValuesDoubled(Map<String, Long> actual, Map<String, Long> original) {\n+        actual.forEach((k, v) -> assertThat(v, equalTo(original.get(k) * 2)));\n+    }\n+\n+    private void assertPerClusterTelemetryDoubled(\n+        Map<String, PerClusterCCSTelemetry> actual,\n+        Map<String, PerClusterCCSTelemetry> original\n+    ) {\n+        actual.forEach((k, v) -> {\n+            assertThat(v.getCount(), equalTo(original.get(k).getCount() * 2));\n+            assertThat(v.getSkippedCount(), equalTo(original.get(k).getSkippedCount() * 2));\n+            assertThat(v.getTook().count(), equalTo(original.get(k).getTook().count() * 2));\n+        });\n+    }\n+\n+    private void assertMapValuesAdded(\n+        Map<String, Long> actual,\n+        Map<String, Long> first,\n+        Map<String, Long> second\n+    ) {\n+        actual.forEach(\n+            (k, v) -> assertThat(\n+                v,\n+                equalTo(first.getOrDefault(k, 0L) + second.getOrDefault(k, 0L))\n+            )\n+        );\n+    }\n+\n+    private void assertPerClusterTelemetryAdded(\n+        Map<String, PerClusterCCSTelemetry> actual,\n+        Map<String, PerClusterCCSTelemetry> first,\n+        Map<String, PerClusterCCSTelemetry> second\n+    ) {\n+        PerClusterCCSTelemetry zeroDummy = new PerClusterCCSTelemetry();\n+        actual.forEach((k, v) -> {\n+            assertThat(\n+                v.getCount(),\n+                equalTo(\n+                    first.getOrDefault(k, zeroDummy).getCount() + second.getOrDefault(k, zeroDummy).getCount()\n+                )\n+            );\n+            assertThat(\n+                v.getSkippedCount(),\n+                equalTo(\n+                    first.getOrDefault(k, zeroDummy).getSkippedCount() + second.getOrDefault(k, zeroDummy).getSkippedCount()\n+                )\n+            );\n+            assertThat(\n+                v.getTook().count(),\n+                equalTo(\n+                    first.getOrDefault(k, zeroDummy).getTook().count() + second.getOrDefault(k, zeroDummy).getTook().count()\n+                )\n+            );\n+        });\n+    }\n+\n     public void testAdd() {\n         CCSTelemetrySnapshot empty = new CCSTelemetrySnapshot();\n         CCSTelemetrySnapshot full = randomCCSTelemetrySnapshot();\n@@ -187,23 +254,15 @@ public class CCSTelemetrySnapshotTests extends AbstractWireSerializingTestCase<C\n         assertThat(empty, equalTo(full));\n         // Add again\n         empty.add(full);\n-        assertThat(empty.getTotalCount(), equalTo(full.getTotalCount() * 2));\n-        assertThat(empty.getSuccessCount(), equalTo(full.getSuccessCount() * 2));\n-        // check that each element of the map is doubled\n-        empty.getFailureReasons().forEach((k, v) -> assertThat(v, equalTo(full.getFailureReasons().get(k) * 2)));\n-        assertThat(empty.getTook().count(), equalTo(full.getTook().count() * 2));\n-        assertThat(empty.getTookMrtTrue().count(), equalTo(full.getTookMrtTrue().count() * 2));\n-        assertThat(empty.getTookMrtFalse().count(), equalTo(full.getTookMrtFalse().count() * 2));\n+        assertBasicCounts(empty, full.getTotalCount() * 2, full.getSuccessCount() * 2);\n+        assertMapValuesDoubled(empty.getFailureReasons(), full.getFailureReasons());\n+        assertTookMetrics(empty, full.getTook().count() * 2);\n         assertThat(empty.getSearchCountWithSkippedRemotes(), equalTo(full.getSearchCountWithSkippedRemotes() * 2));\n         assertThat(empty.getRemotesPerSearchMax(), equalTo(full.getRemotesPerSearchMax()));\n         assertThat(empty.getRemotesPerSearchAvg(), closeTo(full.getRemotesPerSearchAvg(), 0.01));\n-        empty.getFeatureCounts().forEach((k, v) -> assertThat(v, equalTo(full.getFeatureCounts().get(k) * 2)));\n-        empty.getClientCounts().forEach((k, v) -> assertThat(v, equalTo(full.getClientCounts().get(k) * 2)));\n-        empty.getByRemoteCluster().forEach((k, v) -> {\n-            assertThat(v.getCount(), equalTo(full.getByRemoteCluster().get(k).getCount() * 2));\n-            assertThat(v.getSkippedCount(), equalTo(full.getByRemoteCluster().get(k).getSkippedCount() * 2));\n-            assertThat(v.getTook().count(), equalTo(full.getByRemoteCluster().get(k).getTook().count() * 2));\n-        });\n+        assertMapValuesDoubled(empty.getFeatureCounts(), full.getFeatureCounts());\n+        assertMapValuesDoubled(empty.getClientCounts(), full.getClientCounts());\n+        assertPerClusterTelemetryDoubled(empty.getByRemoteCluster(), full.getByRemoteCluster());\n     }\n \n     public void testAddTwo() {\n@@ -213,15 +272,8 @@ public class CCSTelemetrySnapshotTests extends AbstractWireSerializingTestCase<C\n \n         empty.add(full);\n         empty.add(full2);\n-        assertThat(empty.getTotalCount(), equalTo(full.getTotalCount() + full2.getTotalCount()));\n-        assertThat(empty.getSuccessCount(), equalTo(full.getSuccessCount() + full2.getSuccessCount()));\n-        empty.getFailureReasons()\n-            .forEach(\n-                (k, v) -> assertThat(\n-                    v,\n-                    equalTo(full.getFailureReasons().getOrDefault(k, 0L) + full2.getFailureReasons().getOrDefault(k, 0L))\n-                )\n-            );\n+        assertBasicCounts(empty, full.getTotalCount() + full2.getTotalCount(), full.getSuccessCount() + full2.getSuccessCount());\n+        assertMapValuesAdded(empty.getFailureReasons(), full.getFailureReasons(), full2.getFailureReasons());\n         assertThat(empty.getTook().count(), equalTo(full.getTook().count() + full2.getTook().count()));\n         assertThat(empty.getTookMrtTrue().count(), equalTo(full.getTookMrtTrue().count() + full2.getTookMrtTrue().count()));\n         assertThat(empty.getTookMrtFalse().count(), equalTo(full.getTookMrtFalse().count() + full2.getTookMrtFalse().count()));\n@@ -233,42 +285,9 @@ public class CCSTelemetrySnapshotTests extends AbstractWireSerializingTestCase<C\n         double expectedAvg = (full.getRemotesPerSearchAvg() * full.getTotalCount() + full2.getRemotesPerSearchAvg() * full2.getTotalCount())\n             / empty.getTotalCount();\n         assertThat(empty.getRemotesPerSearchAvg(), closeTo(expectedAvg, 0.01));\n-        empty.getFeatureCounts()\n-            .forEach(\n-                (k, v) -> assertThat(v, equalTo(full.getFeatureCounts().getOrDefault(k, 0L) + full2.getFeatureCounts().getOrDefault(k, 0L)))\n-            );\n-        empty.getClientCounts()\n-            .forEach(\n-                (k, v) -> assertThat(v, equalTo(full.getClientCounts().getOrDefault(k, 0L) + full2.getClientCounts().getOrDefault(k, 0L)))\n-            );\n-        PerClusterCCSTelemetry zeroDummy = new PerClusterCCSTelemetry();\n-        empty.getByRemoteCluster().forEach((k, v) -> {\n-            assertThat(\n-                v.getCount(),\n-                equalTo(\n-                    full.getByRemoteCluster().getOrDefault(k, zeroDummy).getCount() + full2.getByRemoteCluster()\n-                        .getOrDefault(k, zeroDummy)\n-                        .getCount()\n-                )\n-            );\n-            assertThat(\n-                v.getSkippedCount(),\n-                equalTo(\n-                    full.getByRemoteCluster().getOrDefault(k, zeroDummy).getSkippedCount() + full2.getByRemoteCluster()\n-                        .getOrDefault(k, zeroDummy)\n-                        .getSkippedCount()\n-                )\n-            );\n-            assertThat(\n-                v.getTook().count(),\n-                equalTo(\n-                    full.getByRemoteCluster().getOrDefault(k, zeroDummy).getTook().count() + full2.getByRemoteCluster()\n-                        .getOrDefault(k, zeroDummy)\n-                        .getTook()\n-                        .count()\n-                )\n-            );\n-        });\n+        assertMapValuesAdded(empty.getFeatureCounts(), full.getFeatureCounts(), full2.getFeatureCounts());\n+        assertMapValuesAdded(empty.getClientCounts(), full.getClientCounts(), full2.getClientCounts());\n+        assertPerClusterTelemetryAdded(empty.getByRemoteCluster(), full.getByRemoteCluster(), full2.getByRemoteCluster());\n     }\n \n     private LongMetricValue manyValuesHistogram(long startingWith) {\ndiff --git a/server/src/test/java/org/elasticsearch/action/admin/cluster/stats/CCSUsageTelemetryTests.java b/server/src/test/java/org/elasticsearch/action/admin/cluster/stats/CCSUsageTelemetryTests.java\nindex 5eb2224e..622d843d 100644\n--- a/server/src/test/java/org/elasticsearch/action/admin/cluster/stats/CCSUsageTelemetryTests.java\n+++ b/server/src/test/java/org/elasticsearch/action/admin/cluster/stats/CCSUsageTelemetryTests.java\n@@ -23,6 +23,51 @@ import static org.hamcrest.Matchers.greaterThan;\n \n public class CCSUsageTelemetryTests extends ESTestCase {\n \n+    private void assertBasicCounts(CCSTelemetrySnapshot snapshot, long expectedTotal, long expectedSuccess) {\n+        assertThat(snapshot.getTotalCount(), equalTo(expectedTotal));\n+        assertThat(snapshot.getSuccessCount(), equalTo(expectedSuccess));\n+    }\n+\n+    private void assertFeatureCounts(CCSTelemetrySnapshot snapshot, long expectedAsyncCount, long expectedMrtCount) {\n+        assertThat(snapshot.getFeatureCounts().getOrDefault(ASYNC_FEATURE, 0L), equalTo(expectedAsyncCount));\n+        assertThat(snapshot.getFeatureCounts().getOrDefault(MRT_FEATURE, 0L), equalTo(expectedMrtCount));\n+    }\n+\n+    private void assertMrtMetrics(CCSTelemetrySnapshot snapshot, boolean minimizeRoundTrips, long took) {\n+        if (minimizeRoundTrips) {\n+            assertThat(snapshot.getTookMrtTrue().count(), equalTo(1L));\n+            assertThat(snapshot.getTookMrtTrue().avg(), greaterThan(0L));\n+            assertThat(snapshot.getTookMrtTrue().avg(), closeTo(took));\n+            assertThat(snapshot.getTookMrtFalse().count(), equalTo(0L));\n+            assertThat(snapshot.getTookMrtFalse().max(), equalTo(0L));\n+        } else {\n+            assertThat(snapshot.getTookMrtFalse().count(), equalTo(1L));\n+            assertThat(snapshot.getTookMrtFalse().avg(), greaterThan(0L));\n+            assertThat(snapshot.getTookMrtFalse().avg(), closeTo(took));\n+            assertThat(snapshot.getTookMrtTrue().count(), equalTo(0L));\n+            assertThat(snapshot.getTookMrtTrue().max(), equalTo(0L));\n+        }\n+    }\n+\n+    private void assertPerClusterTelemetry(\n+        CCSTelemetrySnapshot.PerClusterCCSTelemetry telemetry,\n+        long expectedCount,\n+        long expectedSkippedCount,\n+        long tookValue\n+    ) {\n+        assertNotNull(telemetry);\n+        assertThat(telemetry.getCount(), equalTo(expectedCount));\n+        assertThat(telemetry.getSkippedCount(), equalTo(expectedSkippedCount));\n+        assertThat(telemetry.getTook().count(), equalTo(expectedCount));\n+        assertThat(telemetry.getTook().avg(), greaterThan(0L));\n+        assertThat(telemetry.getTook().avg(), closeTo(tookValue));\n+    }\n+\n+    private void assertFailureReasons(CCSTelemetrySnapshot snapshot, CCSUsageTelemetry.Result result, long expectedCount) {\n+        assertThat(snapshot.getFailureReasons().size(), equalTo(1));\n+        assertThat(snapshot.getFailureReasons().get(result.getName()), equalTo(expectedCount));\n+    }\n+\n     public void testSuccessfulSearchResults() {\n         CCSUsageTelemetry ccsUsageHolder = new CCSUsageTelemetry();\n \n@@ -65,53 +110,22 @@ public class CCSUsageTelemetryTests extends ESTestCase {\n \n             CCSTelemetrySnapshot snapshot = ccsUsageHolder.getCCSTelemetrySnapshot();\n \n-            assertThat(snapshot.getTotalCount(), equalTo(1L));\n-            assertThat(snapshot.getSuccessCount(), equalTo(1L));\n-            assertThat(snapshot.getFeatureCounts().getOrDefault(ASYNC_FEATURE, 0L), equalTo(expectedAsyncCount));\n-            assertThat(snapshot.getFeatureCounts().getOrDefault(MRT_FEATURE, 0L), equalTo(expectedMinRTCount));\n+            assertBasicCounts(snapshot, 1L, 1L);\n+            assertFeatureCounts(snapshot, expectedAsyncCount, expectedMinRTCount);\n             assertThat(snapshot.getSearchCountWithSkippedRemotes(), equalTo(expectedSearchesWithSkippedRemotes));\n             assertThat(snapshot.getTook().avg(), greaterThan(0L));\n             // Expect it to be within 1% of the actual value\n             assertThat(snapshot.getTook().avg(), closeTo(took1));\n             assertThat(snapshot.getTook().max(), closeTo(took1));\n-            if (minimizeRoundTrips) {\n-                assertThat(snapshot.getTookMrtTrue().count(), equalTo(1L));\n-                assertThat(snapshot.getTookMrtTrue().avg(), greaterThan(0L));\n-                assertThat(snapshot.getTookMrtTrue().avg(), closeTo(took1));\n-                assertThat(snapshot.getTookMrtFalse().count(), equalTo(0L));\n-                assertThat(snapshot.getTookMrtFalse().max(), equalTo(0L));\n-            } else {\n-                assertThat(snapshot.getTookMrtFalse().count(), equalTo(1L));\n-                assertThat(snapshot.getTookMrtFalse().avg(), greaterThan(0L));\n-                assertThat(snapshot.getTookMrtFalse().avg(), closeTo(took1));\n-                assertThat(snapshot.getTookMrtTrue().count(), equalTo(0L));\n-                assertThat(snapshot.getTookMrtTrue().max(), equalTo(0L));\n-            }\n+            assertMrtMetrics(snapshot, minimizeRoundTrips, took1);\n             // We currently don't count unknown clients\n             assertThat(snapshot.getClientCounts().size(), equalTo(0));\n \n             // per cluster telemetry asserts\n-\n             var telemetryByCluster = snapshot.getByRemoteCluster();\n             assertThat(telemetryByCluster.size(), equalTo(2));\n-            var localClusterTelemetry = telemetryByCluster.get(\"(local)\");\n-            assertNotNull(localClusterTelemetry);\n-            assertThat(localClusterTelemetry.getCount(), equalTo(1L));\n-            assertThat(localClusterTelemetry.getSkippedCount(), equalTo(0L));\n-            assertThat(localClusterTelemetry.getTook().count(), equalTo(1L));\n-            assertThat(localClusterTelemetry.getTook().avg(), greaterThan(0L));\n-            assertThat(localClusterTelemetry.getTook().avg(), closeTo(tookLocal));\n-            // assertThat(localClusterTelemetry.getTook().max(), greaterThanOrEqualTo(tookLocal));\n-\n-            var remote1ClusterTelemetry = telemetryByCluster.get(\"remote1\");\n-            assertNotNull(remote1ClusterTelemetry);\n-            assertThat(remote1ClusterTelemetry.getCount(), equalTo(1L));\n-            assertThat(remote1ClusterTelemetry.getSkippedCount(), equalTo(expectedSearchesWithSkippedRemotes));\n-            assertThat(remote1ClusterTelemetry.getTook().avg(), greaterThan(0L));\n-            assertThat(remote1ClusterTelemetry.getTook().count(), equalTo(1L));\n-            assertThat(remote1ClusterTelemetry.getTook().avg(), greaterThan(0L));\n-            assertThat(remote1ClusterTelemetry.getTook().avg(), closeTo(took1Remote1));\n-            // assertThat(remote1ClusterTelemetry.getTook().max(), greaterThanOrEqualTo(took1Remote1));\n+            assertPerClusterTelemetry(telemetryByCluster.get(\"(local)\"), 1L, 0L, tookLocal);\n+            assertPerClusterTelemetry(telemetryByCluster.get(\"remote1\"), 1L, expectedSearchesWithSkippedRemotes, took1Remote1);\n         }\n \n         // second search\n@@ -143,21 +157,17 @@ public class CCSUsageTelemetryTests extends ESTestCase {\n \n             CCSTelemetrySnapshot snapshot = ccsUsageHolder.getCCSTelemetrySnapshot();\n \n-            assertThat(snapshot.getTotalCount(), equalTo(2L));\n-            assertThat(snapshot.getSuccessCount(), equalTo(2L));\n-            assertThat(snapshot.getFeatureCounts().getOrDefault(ASYNC_FEATURE, 0L), equalTo(expectedAsyncCount));\n-            assertThat(snapshot.getFeatureCounts().getOrDefault(MRT_FEATURE, 0L), equalTo(expectedMinRTCount));\n+            assertBasicCounts(snapshot, 2L, 2L);\n+            assertFeatureCounts(snapshot, expectedAsyncCount, expectedMinRTCount);\n             assertThat(snapshot.getSearchCountWithSkippedRemotes(), equalTo(expectedSearchesWithSkippedRemotes));\n             assertThat(snapshot.getTook().avg(), greaterThan(0L));\n             assertThat(snapshot.getTook().avg(), closeTo((took1 + took2) / 2));\n-            // assertThat(snapshot.getTook().max(), greaterThanOrEqualTo(Math.max(took1, took2)));\n \n             // Counting only known clients\n             assertThat(snapshot.getClientCounts().get(\"kibana\"), equalTo(1L));\n             assertThat(snapshot.getClientCounts().size(), equalTo(1));\n \n             // per cluster telemetry asserts\n-\n             var telemetryByCluster = snapshot.getByRemoteCluster();\n             assertThat(telemetryByCluster.size(), equalTo(2));\n             var localClusterTelemetry = telemetryByCluster.get(\"(local)\");\n@@ -174,7 +184,6 @@ public class CCSUsageTelemetryTests extends ESTestCase {\n             assertThat(remote1ClusterTelemetry.getTook().count(), equalTo(2L));\n             assertThat(remote1ClusterTelemetry.getTook().avg(), greaterThan(0L));\n             assertThat(remote1ClusterTelemetry.getTook().avg(), closeTo((took1Remote1 + took2Remote1) / 2));\n-            // assertThat(remote1ClusterTelemetry.getTook().max(), greaterThanOrEqualTo(Math.max(took1Remote1, took2Remote1)));\n         }\n     }\n \n@@ -241,15 +250,12 @@ public class CCSUsageTelemetryTests extends ESTestCase {\n \n             CCSTelemetrySnapshot snapshot = ccsUsageHolder.getCCSTelemetrySnapshot();\n \n-            assertThat(snapshot.getTotalCount(), equalTo(1L));\n-            assertThat(snapshot.getSuccessCount(), equalTo(0L));\n+            assertBasicCounts(snapshot, 1L, 0L);\n             assertThat(snapshot.getSearchCountWithSkippedRemotes(), equalTo(skippedRemote ? 1L : 0L));\n             assertThat(snapshot.getTook().count(), equalTo(0L));\n-            assertThat(snapshot.getFailureReasons().size(), equalTo(1));\n-            assertThat(snapshot.getFailureReasons().get(CANCELED.getName()), equalTo(1L));\n+            assertFailureReasons(snapshot, CANCELED, 1L);\n             // still counting features on failure\n-            assertThat(snapshot.getFeatureCounts().getOrDefault(ASYNC_FEATURE, 0L), equalTo(async ? 1L : 0L));\n-            assertThat(snapshot.getFeatureCounts().getOrDefault(MRT_FEATURE, 0L), equalTo(minimizeRoundTrips ? 1L : 0L));\n+            assertFeatureCounts(snapshot, async ? 1L : 0L, minimizeRoundTrips ? 1L : 0L);\n         }\n \n         // second search\n@@ -267,11 +273,9 @@ public class CCSUsageTelemetryTests extends ESTestCase {\n \n             CCSTelemetrySnapshot snapshot = ccsUsageHolder.getCCSTelemetrySnapshot();\n \n-            assertThat(snapshot.getTotalCount(), equalTo(2L));\n-            assertThat(snapshot.getSuccessCount(), equalTo(0L));\n+            assertBasicCounts(snapshot, 2L, 0L);\n             assertThat(snapshot.getTook().count(), equalTo(0L));\n-            assertThat(snapshot.getFailureReasons().size(), equalTo(1));\n-            assertThat(snapshot.getFailureReasons().get(CANCELED.getName()), equalTo(2L));\n+            assertFailureReasons(snapshot, CANCELED, 2L);\n             assertThat(snapshot.getClientCounts().get(\"kibana\"), equalTo(1L));\n         }\n     }",
  "logs_path": "claude-code/claude-sonnet-4-5/8d6f99fc/elastic_elasticsearch_pr134495/logs.jsonl",
  "errors": [],
  "edit_run_id": "8d6f99fc",
  "test_label": "v1-rollouts-1-3-sonnet4.5"
}