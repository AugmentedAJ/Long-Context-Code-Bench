{
  "repo_url": "https://github.com/elastic/elasticsearch.git",
  "pr_number": 1587,
  "base_commit": "df4a3bfd379fd90b3667bbcd7ca2ed4619fee025",
  "runner": "claude-code",
  "model": "claude-sonnet-4-5",
  "timeout_s": 1800,
  "status": "success",
  "elapsed_ms": 222774,
  "patch_unified": "diff --git a/src/test/java/org/elasticsearch/test/integration/ttl/SimpleTTLTests.java b/src/test/java/org/elasticsearch/test/integration/ttl/SimpleTTLTests.java\nindex 89f4ab7..3ddd02e 100644\n--- a/src/test/java/org/elasticsearch/test/integration/ttl/SimpleTTLTests.java\n+++ b/src/test/java/org/elasticsearch/test/integration/ttl/SimpleTTLTests.java\n@@ -19,8 +19,11 @@\n \n package org.elasticsearch.test.integration.ttl;\n \n+import org.elasticsearch.action.admin.cluster.state.ClusterStateResponse;\n import org.elasticsearch.action.get.GetResponse;\n import org.elasticsearch.client.Client;\n+import org.elasticsearch.cluster.routing.IndexRoutingTable;\n+import org.elasticsearch.cluster.routing.IndexShardRoutingTable;\n import org.elasticsearch.common.settings.Settings;\n import org.elasticsearch.common.xcontent.XContentFactory;\n import org.elasticsearch.test.integration.AbstractNodesTests;\n@@ -119,4 +122,262 @@ public class SimpleTTLTests extends AbstractNodesTests {\n         getResponse = client.prepareGet(\"test\", \"type1\", \"1\").setFields(\"_ttl\").setRealtime(false).execute().actionGet();\n         assertThat(getResponse.exists(), equalTo(false));\n     }\n+\n+    @Test\n+    public void testTTLWithRouting() throws Exception {\n+        client.admin().indices().prepareDelete().execute().actionGet();\n+\n+        client.admin().indices().prepareCreate(\"test\")\n+                .setSettings(settingsBuilder()\n+                        .put(\"index.number_of_shards\", 5)\n+                        .put(\"index.number_of_replicas\", 1))\n+                .addMapping(\"type1\", XContentFactory.jsonBuilder()\n+                        .startObject()\n+                        .startObject(\"type1\")\n+                        .startObject(\"_timestamp\").field(\"enabled\", true).field(\"store\", \"yes\").endObject()\n+                        .startObject(\"_ttl\").field(\"enabled\", true).field(\"store\", \"yes\").endObject()\n+                        .endObject()\n+                        .endObject())\n+                .execute().actionGet();\n+        client.admin().cluster().prepareHealth().setWaitForGreenStatus().execute().actionGet();\n+\n+        long providedTTLValue = 3000;\n+        logger.info(\"--> indexing with routing [0]\");\n+        client.prepareIndex(\"test\", \"type1\", \"1\").setRouting(\"0\").setSource(\"field1\", \"value1\").setTTL(providedTTLValue).setRefresh(true).execute().actionGet();\n+        logger.info(\"--> indexing with routing [1]\");\n+        client.prepareIndex(\"test\", \"type1\", \"2\").setRouting(\"1\").setSource(\"field1\", \"value2\").setTTL(providedTTLValue).setRefresh(true).execute().actionGet();\n+        logger.info(\"--> indexing with routing [2]\");\n+        client.prepareIndex(\"test\", \"type1\", \"3\").setRouting(\"2\").setSource(\"field1\", \"value3\").setTTL(providedTTLValue).setRefresh(true).execute().actionGet();\n+\n+        long now = System.currentTimeMillis();\n+\n+        // verify documents exist with correct routing\n+        logger.info(\"--> verifying documents exist with routing\");\n+        GetResponse getResponse = client.prepareGet(\"test\", \"type1\", \"1\").setRouting(\"0\").setFields(\"_ttl\").execute().actionGet();\n+        assertThat(getResponse.exists(), equalTo(true));\n+        getResponse = client.prepareGet(\"test\", \"type1\", \"2\").setRouting(\"1\").setFields(\"_ttl\").execute().actionGet();\n+        assertThat(getResponse.exists(), equalTo(true));\n+        getResponse = client.prepareGet(\"test\", \"type1\", \"3\").setRouting(\"2\").setFields(\"_ttl\").execute().actionGet();\n+        assertThat(getResponse.exists(), equalTo(true));\n+\n+        // verify documents don't exist without routing (unless they happen to hash to the same shard)\n+        logger.info(\"--> verifying documents may not be found without routing\");\n+        getResponse = client.prepareGet(\"test\", \"type1\", \"1\").setFields(\"_ttl\").execute().actionGet();\n+        // Note: document might be found without routing if ID \"1\" hashes to same shard as routing \"0\"\n+        // but most likely will not be found\n+\n+        logger.info(\"--> waiting for expiration and purge\");\n+        // wait for expiration\n+        long shouldBeExpiredDate = now + providedTTLValue + purgeInterval + 2000;\n+        long now1 = System.currentTimeMillis();\n+        if (shouldBeExpiredDate - now1 > 0) {\n+            Thread.sleep(shouldBeExpiredDate - now1);\n+        }\n+\n+        // verify all documents are deleted from all shards\n+        logger.info(\"--> verifying all routed documents are purged\");\n+        getResponse = client.prepareGet(\"test\", \"type1\", \"1\").setRouting(\"0\").setFields(\"_ttl\").execute().actionGet();\n+        assertThat(getResponse.exists(), equalTo(false));\n+        getResponse = client.prepareGet(\"test\", \"type1\", \"2\").setRouting(\"1\").setFields(\"_ttl\").execute().actionGet();\n+        assertThat(getResponse.exists(), equalTo(false));\n+        getResponse = client.prepareGet(\"test\", \"type1\", \"3\").setRouting(\"2\").setFields(\"_ttl\").execute().actionGet();\n+        assertThat(getResponse.exists(), equalTo(false));\n+    }\n+\n+    @Test\n+    public void testTTLWithRequiredRouting() throws Exception {\n+        client.admin().indices().prepareDelete().execute().actionGet();\n+\n+        client.admin().indices().prepareCreate(\"test\")\n+                .setSettings(settingsBuilder()\n+                        .put(\"index.number_of_shards\", 5)\n+                        .put(\"index.number_of_replicas\", 1))\n+                .addMapping(\"type1\", XContentFactory.jsonBuilder()\n+                        .startObject()\n+                        .startObject(\"type1\")\n+                        .startObject(\"_timestamp\").field(\"enabled\", true).field(\"store\", \"yes\").endObject()\n+                        .startObject(\"_ttl\").field(\"enabled\", true).field(\"store\", \"yes\").endObject()\n+                        .startObject(\"_routing\").field(\"required\", true).endObject()\n+                        .endObject()\n+                        .endObject())\n+                .execute().actionGet();\n+        client.admin().cluster().prepareHealth().setWaitForGreenStatus().execute().actionGet();\n+\n+        long providedTTLValue = 3000;\n+        logger.info(\"--> indexing documents with required routing\");\n+        client.prepareIndex(\"test\", \"type1\", \"1\").setRouting(\"routing_value_1\").setSource(\"field1\", \"value1\").setTTL(providedTTLValue).setRefresh(true).execute().actionGet();\n+        client.prepareIndex(\"test\", \"type1\", \"2\").setRouting(\"routing_value_2\").setSource(\"field1\", \"value2\").setTTL(providedTTLValue).setRefresh(true).execute().actionGet();\n+\n+        long now = System.currentTimeMillis();\n+\n+        // verify documents exist with routing\n+        logger.info(\"--> verifying documents exist with correct routing\");\n+        GetResponse getResponse = client.prepareGet(\"test\", \"type1\", \"1\").setRouting(\"routing_value_1\").setFields(\"_ttl\").execute().actionGet();\n+        assertThat(getResponse.exists(), equalTo(true));\n+        long ttl = ((Number) getResponse.field(\"_ttl\").value()).longValue();\n+        assertThat(ttl, greaterThan(0L));\n+        assertThat(ttl, lessThanOrEqualTo(providedTTLValue));\n+\n+        getResponse = client.prepareGet(\"test\", \"type1\", \"2\").setRouting(\"routing_value_2\").setFields(\"_ttl\").execute().actionGet();\n+        assertThat(getResponse.exists(), equalTo(true));\n+        ttl = ((Number) getResponse.field(\"_ttl\").value()).longValue();\n+        assertThat(ttl, greaterThan(0L));\n+        assertThat(ttl, lessThanOrEqualTo(providedTTLValue));\n+\n+        logger.info(\"--> waiting for expiration and purge\");\n+        // wait for expiration\n+        long shouldBeExpiredDate = now + providedTTLValue + purgeInterval + 2000;\n+        long now1 = System.currentTimeMillis();\n+        if (shouldBeExpiredDate - now1 > 0) {\n+            Thread.sleep(shouldBeExpiredDate - now1);\n+        }\n+\n+        // verify documents are deleted even with required routing\n+        logger.info(\"--> verifying documents with required routing are purged\");\n+        getResponse = client.prepareGet(\"test\", \"type1\", \"1\").setRouting(\"routing_value_1\").setFields(\"_ttl\").execute().actionGet();\n+        assertThat(getResponse.exists(), equalTo(false));\n+        getResponse = client.prepareGet(\"test\", \"type1\", \"2\").setRouting(\"routing_value_2\").setFields(\"_ttl\").execute().actionGet();\n+        assertThat(getResponse.exists(), equalTo(false));\n+    }\n+\n+    @Test\n+    public void testTTLWithPathBasedRouting() throws Exception {\n+        client.admin().indices().prepareDelete().execute().actionGet();\n+\n+        client.admin().indices().prepareCreate(\"test\")\n+                .setSettings(settingsBuilder()\n+                        .put(\"index.number_of_shards\", 5)\n+                        .put(\"index.number_of_replicas\", 1))\n+                .addMapping(\"type1\", XContentFactory.jsonBuilder()\n+                        .startObject()\n+                        .startObject(\"type1\")\n+                        .startObject(\"_timestamp\").field(\"enabled\", true).field(\"store\", \"yes\").endObject()\n+                        .startObject(\"_ttl\").field(\"enabled\", true).field(\"store\", \"yes\").endObject()\n+                        .startObject(\"_routing\").field(\"required\", true).field(\"path\", \"routing_field\").endObject()\n+                        .endObject()\n+                        .endObject())\n+                .execute().actionGet();\n+        client.admin().cluster().prepareHealth().setWaitForGreenStatus().execute().actionGet();\n+\n+        long providedTTLValue = 3000;\n+        logger.info(\"--> indexing documents with path-based routing\");\n+        client.prepareIndex(\"test\", \"type1\", \"1\")\n+                .setSource(\"field1\", \"value1\", \"routing_field\", \"route_a\")\n+                .setTTL(providedTTLValue)\n+                .setRefresh(true)\n+                .execute().actionGet();\n+        client.prepareIndex(\"test\", \"type1\", \"2\")\n+                .setSource(\"field1\", \"value2\", \"routing_field\", \"route_b\")\n+                .setTTL(providedTTLValue)\n+                .setRefresh(true)\n+                .execute().actionGet();\n+\n+        long now = System.currentTimeMillis();\n+\n+        // verify documents exist with path-based routing\n+        logger.info(\"--> verifying documents exist with path-based routing\");\n+        GetResponse getResponse = client.prepareGet(\"test\", \"type1\", \"1\").setRouting(\"route_a\").setFields(\"_ttl\").execute().actionGet();\n+        assertThat(getResponse.exists(), equalTo(true));\n+        long ttl = ((Number) getResponse.field(\"_ttl\").value()).longValue();\n+        assertThat(ttl, greaterThan(0L));\n+        assertThat(ttl, lessThanOrEqualTo(providedTTLValue));\n+\n+        getResponse = client.prepareGet(\"test\", \"type1\", \"2\").setRouting(\"route_b\").setFields(\"_ttl\").execute().actionGet();\n+        assertThat(getResponse.exists(), equalTo(true));\n+        ttl = ((Number) getResponse.field(\"_ttl\").value()).longValue();\n+        assertThat(ttl, greaterThan(0L));\n+        assertThat(ttl, lessThanOrEqualTo(providedTTLValue));\n+\n+        logger.info(\"--> waiting for expiration and purge\");\n+        // wait for expiration\n+        long shouldBeExpiredDate = now + providedTTLValue + purgeInterval + 2000;\n+        long now1 = System.currentTimeMillis();\n+        if (shouldBeExpiredDate - now1 > 0) {\n+            Thread.sleep(shouldBeExpiredDate - now1);\n+        }\n+\n+        // verify documents are deleted with path-based routing\n+        logger.info(\"--> verifying documents with path-based routing are purged\");\n+        getResponse = client.prepareGet(\"test\", \"type1\", \"1\").setRouting(\"route_a\").setFields(\"_ttl\").execute().actionGet();\n+        assertThat(getResponse.exists(), equalTo(false));\n+        getResponse = client.prepareGet(\"test\", \"type1\", \"2\").setRouting(\"route_b\").setFields(\"_ttl\").execute().actionGet();\n+        assertThat(getResponse.exists(), equalTo(false));\n+    }\n+\n+    @Test\n+    public void testTTLWithMultipleShards() throws Exception {\n+        client.admin().indices().prepareDelete().execute().actionGet();\n+\n+        client.admin().indices().prepareCreate(\"test\")\n+                .setSettings(settingsBuilder()\n+                        .put(\"index.number_of_shards\", 5)\n+                        .put(\"index.number_of_replicas\", 1))\n+                .addMapping(\"type1\", XContentFactory.jsonBuilder()\n+                        .startObject()\n+                        .startObject(\"type1\")\n+                        .startObject(\"_timestamp\").field(\"enabled\", true).field(\"store\", \"yes\").endObject()\n+                        .startObject(\"_ttl\").field(\"enabled\", true).field(\"store\", \"yes\").endObject()\n+                        .endObject()\n+                        .endObject())\n+                .execute().actionGet();\n+        client.admin().cluster().prepareHealth().setWaitForGreenStatus().execute().actionGet();\n+\n+        long providedTTLValue = 3000;\n+        logger.info(\"--> indexing multiple documents to ensure distribution across shards\");\n+\n+        // Index enough documents to ensure they're distributed across multiple shards\n+        for (int i = 0; i < 25; i++) {\n+            client.prepareIndex(\"test\", \"type1\", String.valueOf(i))\n+                    .setSource(\"field1\", \"value\" + i)\n+                    .setTTL(providedTTLValue)\n+                    .execute().actionGet();\n+        }\n+        client.admin().indices().prepareRefresh().execute().actionGet();\n+\n+        long now = System.currentTimeMillis();\n+\n+        // Verify documents are distributed across shards\n+        logger.info(\"--> verifying documents are distributed across shards\");\n+        ClusterStateResponse clusterState = client.admin().cluster().prepareState().execute().actionGet();\n+        IndexRoutingTable indexRouting = clusterState.state().routingTable().index(\"test\");\n+        int shardsWithDocs = 0;\n+        for (IndexShardRoutingTable shardRouting : indexRouting) {\n+            // Check if this shard has any documents by attempting a search\n+            long count = client.prepareCount(\"test\")\n+                    .setPreference(\"_shards:\" + shardRouting.shardId().id())\n+                    .execute().actionGet().count();\n+            if (count > 0) {\n+                shardsWithDocs++;\n+                logger.info(\"--> shard [{}] has [{}] documents\", shardRouting.shardId().id(), count);\n+            }\n+        }\n+        assertThat(\"Documents should be distributed across multiple shards\", shardsWithDocs, greaterThan(1));\n+\n+        // Verify all documents exist\n+        logger.info(\"--> verifying all documents exist\");\n+        for (int i = 0; i < 25; i++) {\n+            GetResponse getResponse = client.prepareGet(\"test\", \"type1\", String.valueOf(i)).execute().actionGet();\n+            assertThat(\"Document \" + i + \" should exist\", getResponse.exists(), equalTo(true));\n+        }\n+\n+        logger.info(\"--> waiting for expiration and purge across all shards\");\n+        // wait for expiration\n+        long shouldBeExpiredDate = now + providedTTLValue + purgeInterval + 2000;\n+        long now1 = System.currentTimeMillis();\n+        if (shouldBeExpiredDate - now1 > 0) {\n+            Thread.sleep(shouldBeExpiredDate - now1);\n+        }\n+\n+        // verify all documents are deleted from all shards\n+        logger.info(\"--> verifying all documents are purged from all shards\");\n+        for (int i = 0; i < 25; i++) {\n+            GetResponse getResponse = client.prepareGet(\"test\", \"type1\", String.valueOf(i)).execute().actionGet();\n+            assertThat(\"Document \" + i + \" should be purged\", getResponse.exists(), equalTo(false));\n+        }\n+\n+        // Verify all shards have been purged\n+        logger.info(\"--> verifying all shards have been purged\");\n+        long totalCount = client.prepareCount(\"test\").execute().actionGet().count();\n+        assertThat(\"All documents should be purged from all shards\", totalCount, equalTo(0L));\n+    }\n }",
  "logs_path": "claude-code/claude-sonnet-4-5/8d6f99fc/elastic_elasticsearch_pr1587/logs.jsonl",
  "errors": [],
  "edit_run_id": "8d6f99fc",
  "test_label": "v1-rollouts-1-3-sonnet4.5"
}