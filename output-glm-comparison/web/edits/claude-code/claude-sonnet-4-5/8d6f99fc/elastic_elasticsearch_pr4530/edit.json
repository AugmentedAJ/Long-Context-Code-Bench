{
  "repo_url": "https://github.com/elastic/elasticsearch.git",
  "pr_number": 4530,
  "base_commit": "bbffeb1b39b864a8bf6c9844dfa23869e44c8639",
  "runner": "claude-code",
  "model": "claude-sonnet-4-5",
  "timeout_s": 1800,
  "status": "success",
  "elapsed_ms": 389015,
  "patch_unified": "diff --git a/src/main/java/org/elasticsearch/cluster/metadata/MetaDataCreateIndexService.java b/src/main/java/org/elasticsearch/cluster/metadata/MetaDataCreateIndexService.java\nindex a394166..1a221a0 100644\n--- a/src/main/java/org/elasticsearch/cluster/metadata/MetaDataCreateIndexService.java\n+++ b/src/main/java/org/elasticsearch/cluster/metadata/MetaDataCreateIndexService.java\n@@ -26,7 +26,6 @@ import com.google.common.collect.Lists;\n import com.google.common.collect.Maps;\n import com.google.common.collect.Sets;\n import org.apache.lucene.util.CollectionUtil;\n-import org.apache.lucene.util.IOUtils;\n import org.elasticsearch.ElasticSearchException;\n import org.elasticsearch.Version;\n import org.elasticsearch.action.support.master.MasterNodeOperationRequest;\n@@ -472,29 +471,6 @@ public class MetaDataCreateIndexService extends AbstractComponent {\n             }\n         }\n \n-        // see if we have templates defined under config\n-        File templatesDir = new File(environment.configFile(), \"templates\");\n-        if (templatesDir.exists() && templatesDir.isDirectory()) {\n-            File[] templatesFiles = templatesDir.listFiles();\n-            if (templatesFiles != null) {\n-                for (File templatesFile : templatesFiles) {\n-                    XContentParser parser = null;\n-                    try {\n-                        byte[] templatesData = Streams.copyToByteArray(templatesFile);\n-                        parser = XContentHelper.createParser(templatesData, 0, templatesData.length);\n-                        IndexTemplateMetaData template = IndexTemplateMetaData.Builder.fromXContent(parser);\n-                        if (Regex.simpleMatch(template.template(), request.index)) {\n-                            templates.add(template);\n-                        }\n-                    } catch (Exception e) {\n-                        logger.warn(\"[{}] failed to read template [{}] from config\", e, request.index, templatesFile.getAbsolutePath());\n-                    } finally {\n-                        IOUtils.closeWhileHandlingException(parser);\n-                    }\n-                }\n-            }\n-        }\n-\n         CollectionUtil.timSort(templates, new Comparator<IndexTemplateMetaData>() {\n             @Override\n             public int compare(IndexTemplateMetaData o1, IndexTemplateMetaData o2) {\ndiff --git a/src/main/java/org/elasticsearch/gateway/local/state/meta/LocalGatewayMetaState.java b/src/main/java/org/elasticsearch/gateway/local/state/meta/LocalGatewayMetaState.java\nindex 4b6fced..99607fa 100644\n--- a/src/main/java/org/elasticsearch/gateway/local/state/meta/LocalGatewayMetaState.java\n+++ b/src/main/java/org/elasticsearch/gateway/local/state/meta/LocalGatewayMetaState.java\n@@ -28,6 +28,7 @@ import org.elasticsearch.cluster.ClusterChangedEvent;\n import org.elasticsearch.cluster.ClusterStateListener;\n import org.elasticsearch.cluster.action.index.NodeIndexDeletedAction;\n import org.elasticsearch.cluster.metadata.IndexMetaData;\n+import org.elasticsearch.cluster.metadata.IndexTemplateMetaData;\n import org.elasticsearch.cluster.metadata.MetaData;\n import org.elasticsearch.cluster.node.DiscoveryNode;\n import org.elasticsearch.common.Nullable;\n@@ -42,6 +43,7 @@ import org.elasticsearch.common.settings.Settings;\n import org.elasticsearch.common.unit.TimeValue;\n import org.elasticsearch.common.util.concurrent.ConcurrentCollections;\n import org.elasticsearch.common.xcontent.*;\n+import org.elasticsearch.env.Environment;\n import org.elasticsearch.env.NodeEnvironment;\n import org.elasticsearch.index.Index;\n import org.elasticsearch.threadpool.ThreadPool;\n@@ -97,6 +99,7 @@ public class LocalGatewayMetaState extends AbstractComponent implements ClusterS\n \n     private final NodeEnvironment nodeEnv;\n     private final ThreadPool threadPool;\n+    private final Environment environment;\n \n     private final LocalAllocateDangledIndices allocateDangledIndices;\n     private final NodeIndexDeletedAction nodeIndexDeletedAction;\n@@ -115,12 +118,13 @@ public class LocalGatewayMetaState extends AbstractComponent implements ClusterS\n     private final Object danglingMutex = new Object();\n \n     @Inject\n-    public LocalGatewayMetaState(Settings settings, ThreadPool threadPool, NodeEnvironment nodeEnv,\n+    public LocalGatewayMetaState(Settings settings, ThreadPool threadPool, NodeEnvironment nodeEnv, Environment environment,\n                                  TransportNodesListGatewayMetaState nodesListGatewayMetaState, LocalAllocateDangledIndices allocateDangledIndices,\n                                  NodeIndexDeletedAction nodeIndexDeletedAction) throws Exception {\n         super(settings);\n         this.nodeEnv = nodeEnv;\n         this.threadPool = threadPool;\n+        this.environment = environment;\n         this.format = XContentType.fromRestContentType(settings.get(\"format\", \"smile\"));\n         this.allocateDangledIndices = allocateDangledIndices;\n         this.nodeIndexDeletedAction = nodeIndexDeletedAction;\n@@ -464,9 +468,44 @@ public class LocalGatewayMetaState extends AbstractComponent implements ClusterS\n                 metaDataBuilder.put(indexMetaData, false);\n             }\n         }\n+\n+        // load templates from config/templates directory\n+        loadTemplates(metaDataBuilder);\n+\n         return metaDataBuilder.build();\n     }\n \n+    private void loadTemplates(MetaData.Builder metaDataBuilder) {\n+        File templatesDir = new File(environment.configFile(), \"templates\");\n+        if (!templatesDir.exists() || !templatesDir.isDirectory()) {\n+            return;\n+        }\n+\n+        File[] templatesFiles = templatesDir.listFiles();\n+        if (templatesFiles == null) {\n+            return;\n+        }\n+\n+        for (File templatesFile : templatesFiles) {\n+            if (templatesFile.isDirectory()) {\n+                continue;\n+            }\n+\n+            XContentParser parser = null;\n+            try {\n+                byte[] templatesData = Streams.copyToByteArray(templatesFile);\n+                parser = XContentHelper.createParser(templatesData, 0, templatesData.length);\n+                IndexTemplateMetaData template = IndexTemplateMetaData.Builder.fromXContent(parser);\n+                metaDataBuilder.put(template);\n+                logger.info(\"loaded template [{}] from [{}]\", template.name(), templatesFile.getAbsolutePath());\n+            } catch (Exception e) {\n+                logger.warn(\"failed to load template from [{}], ignoring...\", e, templatesFile.getAbsolutePath());\n+            } finally {\n+                IOUtils.closeWhileHandlingException(parser);\n+            }\n+        }\n+    }\n+\n     @Nullable\n     private IndexMetaData loadIndex(String index) {\n         long highestVersion = -1;",
  "logs_path": "claude-code/claude-sonnet-4-5/8d6f99fc/elastic_elasticsearch_pr4530/logs.jsonl",
  "errors": [],
  "edit_run_id": "8d6f99fc",
  "test_label": "v1-rollouts-1-3-sonnet4.5"
}