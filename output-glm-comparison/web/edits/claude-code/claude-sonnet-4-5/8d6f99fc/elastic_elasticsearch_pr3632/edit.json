{
  "repo_url": "https://github.com/elastic/elasticsearch.git",
  "pr_number": 3632,
  "base_commit": "9e7b3963d81afc74907a130533738cb90e6f993b",
  "runner": "claude-code",
  "model": "claude-sonnet-4-5",
  "timeout_s": 1800,
  "status": "success",
  "elapsed_ms": 287906,
  "patch_unified": "diff --git a/src/main/java/org/elasticsearch/search/highlight/FastVectorHighlighter.java b/src/main/java/org/elasticsearch/search/highlight/FastVectorHighlighter.java\nindex 7763753..496678b 100644\n--- a/src/main/java/org/elasticsearch/search/highlight/FastVectorHighlighter.java\n+++ b/src/main/java/org/elasticsearch/search/highlight/FastVectorHighlighter.java\n@@ -121,7 +121,15 @@ public class FastVectorHighlighter implements Highlighter {\n                     // fragment builders are used explicitly\n                     cache.fvh = new org.apache.lucene.search.vectorhighlight.FastVectorHighlighter();\n                 }\n-                CustomFieldQuery.highlightFilters.set(field.highlightFilter());\n+                cache.mappers.put(mapper, entry);\n+            }\n+\n+            // Set up the FieldQuery - use custom highlight query if provided, otherwise use cached query\n+            CustomFieldQuery.highlightFilters.set(field.highlightFilter());\n+            if (field.highlightQuery() != null) {\n+                // If a custom highlight query is provided, create a new FieldQuery instead of using cached one\n+                fieldQuery = new CustomFieldQuery(field.highlightQuery(), hitContext.topLevelReader(), true, field.requireFieldMatch());\n+            } else {\n                 if (field.requireFieldMatch()) {\n                     if (cache.fieldMatchFieldQuery == null) {\n                         // we use top level reader to rewrite the query against all readers, with use caching it across hits (and across readers...)\n@@ -135,7 +143,6 @@ public class FastVectorHighlighter implements Highlighter {\n                     }\n                     fieldQuery = cache.noFieldMatchFieldQuery;\n                 }\n-                cache.mappers.put(mapper, entry);\n             }\n \n             String[] fragments;\ndiff --git a/src/main/java/org/elasticsearch/search/highlight/HighlightBuilder.java b/src/main/java/org/elasticsearch/search/highlight/HighlightBuilder.java\nindex 4e0ccc6..ad7b975 100644\n--- a/src/main/java/org/elasticsearch/search/highlight/HighlightBuilder.java\n+++ b/src/main/java/org/elasticsearch/search/highlight/HighlightBuilder.java\n@@ -21,6 +21,7 @@ package org.elasticsearch.search.highlight;\n \n import org.elasticsearch.common.xcontent.ToXContent;\n import org.elasticsearch.common.xcontent.XContentBuilder;\n+import org.elasticsearch.index.query.QueryBuilder;\n \n import java.io.IOException;\n import java.util.List;\n@@ -282,6 +283,10 @@ public class HighlightBuilder implements ToXContent {\n                 if (field.options != null && field.options.size() > 0) {\n                     builder.field(\"options\", field.options);\n                 }\n+                if (field.highlightQuery != null) {\n+                    builder.field(\"highlight_query\");\n+                    field.highlightQuery.toXContent(builder, params);\n+                }\n \n                 builder.endObject();\n             }\n@@ -307,6 +312,7 @@ public class HighlightBuilder implements ToXContent {\n         String highlighterType;\n         String fragmenter;\n         Map<String, Object> options;\n+        QueryBuilder highlightQuery;\n \n         public Field(String name) {\n             this.name = name;\n@@ -408,5 +414,14 @@ public class HighlightBuilder implements ToXContent {\n             this.options = options;\n             return this;\n         }\n+\n+        /**\n+         * Sets a query to be used for highlighting instead of the search query.\n+         * This is useful when you want to highlight different terms than those used in the search.\n+         */\n+        public Field highlightQuery(QueryBuilder highlightQuery) {\n+            this.highlightQuery = highlightQuery;\n+            return this;\n+        }\n     }\n }\ndiff --git a/src/main/java/org/elasticsearch/search/highlight/HighlighterParseElement.java b/src/main/java/org/elasticsearch/search/highlight/HighlighterParseElement.java\nindex edceffc..31f5a68 100644\n--- a/src/main/java/org/elasticsearch/search/highlight/HighlighterParseElement.java\n+++ b/src/main/java/org/elasticsearch/search/highlight/HighlighterParseElement.java\n@@ -20,6 +20,7 @@\n package org.elasticsearch.search.highlight;\n \n import com.google.common.collect.Lists;\n+import org.apache.lucene.search.Query;\n import org.apache.lucene.search.vectorhighlight.SimpleBoundaryScanner;\n import org.elasticsearch.common.xcontent.XContentParser;\n import org.elasticsearch.search.SearchParseElement;\n@@ -185,8 +186,13 @@ public class HighlighterParseElement implements SearchParseElement {\n                                     } else if (\"fragmenter\".equals(fieldName)) {\n                                         field.fragmenter(parser.text());\n                                     }\n-                                } else if (fieldName.equals(\"options\")) {\n-                                    field.options(parser.map());\n+                                } else if (token == XContentParser.Token.START_OBJECT) {\n+                                    if (\"highlight_query\".equals(fieldName) || \"highlightQuery\".equals(fieldName)) {\n+                                        Query highlightQuery = context.queryParserService().parse(parser).query();\n+                                        field.highlightQuery(highlightQuery);\n+                                    } else if (\"options\".equals(fieldName)) {\n+                                        field.options(parser.map());\n+                                    }\n                                 }\n                             }\n                             fields.add(field);\ndiff --git a/src/main/java/org/elasticsearch/search/highlight/PlainHighlighter.java b/src/main/java/org/elasticsearch/search/highlight/PlainHighlighter.java\nindex ff1d0f8..d4eae3b 100644\n--- a/src/main/java/org/elasticsearch/search/highlight/PlainHighlighter.java\n+++ b/src/main/java/org/elasticsearch/search/highlight/PlainHighlighter.java\n@@ -62,17 +62,24 @@ public class PlainHighlighter implements Highlighter {\n \n         Encoder encoder = field.encoder().equals(\"html\") ? Encoders.HTML : Encoders.DEFAULT;\n \n-        if (!hitContext.cache().containsKey(CACHE_KEY)) {\n-            Map<FieldMapper<?>, org.apache.lucene.search.highlight.Highlighter> mappers = Maps.newHashMap();\n-            hitContext.cache().put(CACHE_KEY, mappers);\n+        org.apache.lucene.search.highlight.Highlighter entry;\n+        // Don't use cache if a custom highlight query is provided, since the query is part of the highlighter state\n+        if (field.highlightQuery() == null) {\n+            if (!hitContext.cache().containsKey(CACHE_KEY)) {\n+                Map<FieldMapper<?>, org.apache.lucene.search.highlight.Highlighter> mappers = Maps.newHashMap();\n+                hitContext.cache().put(CACHE_KEY, mappers);\n+            }\n+            Map<FieldMapper<?>, org.apache.lucene.search.highlight.Highlighter> cache = (Map<FieldMapper<?>, org.apache.lucene.search.highlight.Highlighter>) hitContext.cache().get(CACHE_KEY);\n+            entry = cache.get(mapper);\n+        } else {\n+            entry = null;\n         }\n-        Map<FieldMapper<?>, org.apache.lucene.search.highlight.Highlighter> cache = (Map<FieldMapper<?>, org.apache.lucene.search.highlight.Highlighter>) hitContext.cache().get(CACHE_KEY);\n \n-        org.apache.lucene.search.highlight.Highlighter entry = cache.get(mapper);\n         if (entry == null) {\n             // Don't use the context.query() since it might be rewritten, and we need to pass the non rewritten queries to\n             // let the highlighter handle MultiTerm ones\n-            Query query = context.parsedQuery().query();\n+            // Use custom highlight query if provided, otherwise use the search query\n+            Query query = field.highlightQuery() != null ? field.highlightQuery() : context.parsedQuery().query();\n             QueryScorer queryScorer = new CustomQueryScorer(query, field.requireFieldMatch() ? mapper.names().indexName() : null);\n             queryScorer.setExpandMultiTermQuery(true);\n             Fragmenter fragmenter;\n@@ -94,7 +101,11 @@ public class PlainHighlighter implements Highlighter {\n             // always highlight across all data\n             entry.setMaxDocCharsToAnalyze(Integer.MAX_VALUE);\n \n-            cache.put(mapper, entry);\n+            // Only cache if not using a custom highlight query\n+            if (field.highlightQuery() == null) {\n+                Map<FieldMapper<?>, org.apache.lucene.search.highlight.Highlighter> cache = (Map<FieldMapper<?>, org.apache.lucene.search.highlight.Highlighter>) hitContext.cache().get(CACHE_KEY);\n+                cache.put(mapper, entry);\n+            }\n         }\n \n         List<Object> textsToHighlight;\ndiff --git a/src/main/java/org/elasticsearch/search/highlight/SearchContextHighlight.java b/src/main/java/org/elasticsearch/search/highlight/SearchContextHighlight.java\nindex 04e71d2..c88f198 100644\n--- a/src/main/java/org/elasticsearch/search/highlight/SearchContextHighlight.java\n+++ b/src/main/java/org/elasticsearch/search/highlight/SearchContextHighlight.java\n@@ -19,6 +19,8 @@\n \n package org.elasticsearch.search.highlight;\n \n+import org.apache.lucene.search.Query;\n+\n import java.util.List;\n import java.util.Map;\n \n@@ -68,6 +70,8 @@ public class SearchContextHighlight {\n \n         private Map<String, Object> options;\n \n+        private Query highlightQuery;\n+\n         public Field(String field) {\n             this.field = field;\n         }\n@@ -187,5 +191,13 @@ public class SearchContextHighlight {\n         public void options(Map<String, Object> options) {\n             this.options = options;\n         }\n+\n+        public Query highlightQuery() {\n+            return highlightQuery;\n+        }\n+\n+        public void highlightQuery(Query highlightQuery) {\n+            this.highlightQuery = highlightQuery;\n+        }\n     }\n }",
  "logs_path": "claude-code/claude-sonnet-4-5/8d6f99fc/elastic_elasticsearch_pr3632/logs.jsonl",
  "errors": [],
  "edit_run_id": "8d6f99fc",
  "test_label": "v1-rollouts-1-3-sonnet4.5"
}