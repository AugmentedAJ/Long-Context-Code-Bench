{
  "repo_url": "https://github.com/elastic/elasticsearch.git",
  "pr_number": 134477,
  "base_commit": "1ccb58a8b2b9b38bad0506c49d455dbfcbea9224",
  "runner": "factory",
  "model": "glm-4.6",
  "timeout_s": 1800,
  "status": "success",
  "elapsed_ms": 484394,
  "patch_unified": "diff --git a/server/src/main/java/org/elasticsearch/search/SearchService.java b/server/src/main/java/org/elasticsearch/search/SearchService.java\nindex 9a101d83..b0e65b07 100644\n--- a/server/src/main/java/org/elasticsearch/search/SearchService.java\n+++ b/server/src/main/java/org/elasticsearch/search/SearchService.java\n@@ -597,6 +597,35 @@ public class SearchService extends AbstractLifecycleComponent implements IndexEv\n         ShardId shardId,\n         long taskId,\n         ThreadPool threadPool\n+    ) {\n+        return wrapListenerForErrorHandling(listener, version, nodeId, shardId, taskId, threadPool, null);\n+    }\n+\n+    /**\n+     * Wraps the listener to ensure errors are logged and to avoid sending\n+     * StackTraces back to the coordinating node if the `error_trace` header is\n+     * set to {@code false}. Upon reading, we default to {@code true} to maintain\n+     * the same behavior as before the change, due to older nodes not being able\n+     * to specify whether they need stack traces.\n+     *\n+     * @param <T>            the type of the response\n+     * @param listener       the action listener to be wrapped\n+     * @param version        channel version of the request\n+     * @param nodeId         id of the current node\n+     * @param shardId        id of the shard being searched\n+     * @param taskId         id of the task being executed\n+     * @param threadPool     with context where to write the new header\n+     * @param searchService   the search service to check lifecycle state (optional)\n+     * @return the wrapped action listener\n+     */\n+    static <T> ActionListener<T> wrapListenerForErrorHandling(\n+        ActionListener<T> listener,\n+        TransportVersion version,\n+        String nodeId,\n+        ShardId shardId,\n+        long taskId,\n+        ThreadPool threadPool,\n+        SearchService searchService\n     ) {\n         final boolean header;\n         if (version.onOrAfter(ERROR_TRACE_IN_TRANSPORT_HEADER) && threadPool.getThreadContext() != null) {\n@@ -615,7 +644,12 @@ public class SearchService extends AbstractLifecycleComponent implements IndexEv\n             if (ExceptionsHelper.status(e).getStatus() < 500 || ExceptionsHelper.isNodeOrShardUnavailableTypeException(e)) {\n                 logger.debug(messageSupplier, e);\n             } else {\n-                logger.warn(messageSupplier, e);\n+                // Check if the SearchService is stopped or closed to avoid unnecessary warnings during shutdown\n+                if (searchService != null && searchService.lifecycle.stoppedOrClosed()) {\n+                    logger.debug(messageSupplier + \" (service is stopped/closed)\", e);\n+                } else {\n+                    logger.warn(messageSupplier, e);\n+                }\n             }\n \n             if (header == false) {\n@@ -643,7 +677,8 @@ public class SearchService extends AbstractLifecycleComponent implements IndexEv\n             clusterService.localNode().getId(),\n             request.shardId(),\n             task.getId(),\n-            threadPool\n+            threadPool,\n+            this\n         );\n         final IndexShard shard = getShard(request);\n         rewriteAndFetchShardRequest(shard, request, listener.delegateFailure((l, rewritten) -> {\n@@ -705,7 +740,8 @@ public class SearchService extends AbstractLifecycleComponent implements IndexEv\n                 clusterService.localNode().getId(),\n                 request.shardId(),\n                 task.getId(),\n-                threadPool\n+                threadPool,\n+                this\n             ).delegateFailure((l, orig) -> {\n                 // check if we can shortcut the query phase entirely.\n                 if (orig.canReturnNullResponseIfMatchNoDocs()) {\n@@ -953,7 +989,8 @@ public class SearchService extends AbstractLifecycleComponent implements IndexEv\n             clusterService.localNode().getId(),\n             shardSearchRequest.shardId(),\n             task.getId(),\n-            threadPool\n+            threadPool,\n+            this\n         );\n         final Releasable markAsUsed = readerContext.markAsUsed(getKeepAlive(shardSearchRequest));\n         runAsync(getExecutor(readerContext.indexShard()), () -> {\n@@ -1010,7 +1047,8 @@ public class SearchService extends AbstractLifecycleComponent implements IndexEv\n             clusterService.localNode().getId(),\n             readerContext.indexShard().shardId(),\n             task.getId(),\n-            threadPool\n+            threadPool,\n+            this\n         );\n         final Releasable markAsUsed;\n         try {\n@@ -1072,7 +1110,8 @@ public class SearchService extends AbstractLifecycleComponent implements IndexEv\n             clusterService.localNode().getId(),\n             shardSearchRequest.shardId(),\n             task.getId(),\n-            threadPool\n+            threadPool,\n+            this\n         );\n         final Releasable markAsUsed = readerContext.markAsUsed(getKeepAlive(shardSearchRequest));\n         rewriteAndFetchShardRequest(readerContext.indexShard(), shardSearchRequest, listener.delegateFailure((l, rewritten) -> {\ndiff --git a/server/src/test/java/org/elasticsearch/search/SearchServiceTests.java b/server/src/test/java/org/elasticsearch/search/SearchServiceTests.java\nindex 29380a05..4270e882 100644\n--- a/server/src/test/java/org/elasticsearch/search/SearchServiceTests.java\n+++ b/server/src/test/java/org/elasticsearch/search/SearchServiceTests.java\n@@ -160,7 +160,7 @@ public class SearchServiceTests extends IndexShardTestCase {\n         e.fillInStackTrace();\n         assertThat(e.getStackTrace().length, is(not(0)));\n         listener.onFailure(e);\n-        listener = wrapListenerForErrorHandling(listener, TransportVersion.current(), \"node\", shardId, 123L, threadPool);\n+        listener = wrapListenerForErrorHandling(listener, TransportVersion.current(), \"node\", shardId, 123L, threadPool, null);\n         isWrapped.set(true);\n         listener.onFailure(e);\n     }\n@@ -198,7 +198,7 @@ public class SearchServiceTests extends IndexShardTestCase {\n                 }\n             };\n             IllegalArgumentException e = new IllegalArgumentException(exceptionMessage); // 400-level exception\n-            listener = wrapListenerForErrorHandling(listener, TransportVersion.current(), nodeId, shardId, taskId, threadPool);\n+            listener = wrapListenerForErrorHandling(listener, TransportVersion.current(), nodeId, shardId, taskId, threadPool, null);\n             listener.onFailure(e);\n         }\n     }\n@@ -235,7 +235,7 @@ public class SearchServiceTests extends IndexShardTestCase {\n                 }\n             };\n             IllegalStateException e = new IllegalStateException(exceptionMessage); // 500-level exception\n-            listener = wrapListenerForErrorHandling(listener, TransportVersion.current(), nodeId, shardId, taskId, threadPool);\n+            listener = wrapListenerForErrorHandling(listener, TransportVersion.current(), nodeId, shardId, taskId, threadPool, null);\n             listener.onFailure(e);\n         }\n     }",
  "logs_path": "factory/glm-4.6/24634b85/elastic_elasticsearch_pr134477/logs.jsonl",
  "errors": [],
  "edit_run_id": "24634b85",
  "test_label": null
}