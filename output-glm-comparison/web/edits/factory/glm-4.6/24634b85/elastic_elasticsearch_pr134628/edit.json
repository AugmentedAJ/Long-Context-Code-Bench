{
  "repo_url": "https://github.com/elastic/elasticsearch.git",
  "pr_number": 134628,
  "base_commit": "630d52976d3fb951f6ea52a3d0e5fb492921df87",
  "runner": "factory",
  "model": "glm-4.6",
  "timeout_s": 1800,
  "status": "success",
  "elapsed_ms": 179967,
  "patch_unified": "diff --git a/server/src/main/java/org/elasticsearch/search/aggregations/bucket/filter/QueryToFilterAdapter.java b/server/src/main/java/org/elasticsearch/search/aggregations/bucket/filter/QueryToFilterAdapter.java\nindex 9c6f7ddd..dacb88fa 100644\n--- a/server/src/main/java/org/elasticsearch/search/aggregations/bucket/filter/QueryToFilterAdapter.java\n+++ b/server/src/main/java/org/elasticsearch/search/aggregations/bucket/filter/QueryToFilterAdapter.java\n@@ -51,15 +51,10 @@ public class QueryToFilterAdapter {\n         // Wrapping with a ConstantScoreQuery enables a few more rewrite\n         // rules as of Lucene 9.2\n         query = searcher.rewrite(new ConstantScoreQuery(query));\n-        if (query instanceof ConstantScoreQuery) {\n-            /*\n-             * Unwrap constant score because it gets in the way of us\n-             * understanding what the queries are trying to do and we\n-             * don't use the score at all anyway. Effectively we always\n-             * run in constant score mode.\n-             */\n-            query = ((ConstantScoreQuery) query).getQuery();\n-        }\n+        query = switch (query) {\n+            case ConstantScoreQuery constantScoreQuery -> constantScoreQuery.getQuery();\n+            default -> query;\n+        };\n         return new QueryToFilterAdapter(searcher, key, query);\n     }\n \n@@ -132,8 +127,9 @@ public class QueryToFilterAdapter {\n         extraQuery = searcher().rewrite(new ConstantScoreQuery(extraQuery));\n         Query unwrappedExtraQuery = unwrap(extraQuery);\n         Query unwrappedQuery = unwrap(query);\n-        if (unwrappedQuery instanceof PointRangeQuery && unwrappedExtraQuery instanceof PointRangeQuery) {\n-            Query merged = MergedPointRangeQuery.merge((PointRangeQuery) unwrappedQuery, (PointRangeQuery) unwrappedExtraQuery);\n+        \n+        if (unwrappedQuery instanceof PointRangeQuery queryRange && unwrappedExtraQuery instanceof PointRangeQuery extraRange) {\n+            Query merged = MergedPointRangeQuery.merge(queryRange, extraRange);\n             if (merged != null) {\n                 // Should we rewrap here?\n                 return new QueryToFilterAdapter(searcher(), key(), merged);\n@@ -143,9 +139,10 @@ public class QueryToFilterAdapter {\n         builder.add(query, BooleanClause.Occur.FILTER);\n         builder.add(extraQuery, BooleanClause.Occur.FILTER);\n         Query rewrittenUnion = searcher().rewrite(new ConstantScoreQuery(builder.build()));\n-        if (rewrittenUnion instanceof ConstantScoreQuery) {\n-            rewrittenUnion = ((ConstantScoreQuery) rewrittenUnion).getQuery();\n-        }\n+        rewrittenUnion = switch (rewrittenUnion) {\n+            case ConstantScoreQuery constantScoreQuery -> constantScoreQuery.getQuery();\n+            default -> rewrittenUnion;\n+        };\n         // This union is inefficient if Lucene cannot merge clauses of the boolean query through a rewrite.\n         final boolean inefficientUnion = rewrittenUnion instanceof BooleanQuery;\n         return new QueryToFilterAdapter(searcher(), key(), rewrittenUnion) {\n@@ -156,21 +153,12 @@ public class QueryToFilterAdapter {\n     }\n \n     private static Query unwrap(Query query) {\n-        while (true) {\n-            if (query instanceof ConstantScoreQuery) {\n-                query = ((ConstantScoreQuery) query).getQuery();\n-                continue;\n-            }\n-            if (query instanceof IndexSortSortedNumericDocValuesRangeQuery) {\n-                query = ((IndexSortSortedNumericDocValuesRangeQuery) query).getFallbackQuery();\n-                continue;\n-            }\n-            if (query instanceof IndexOrDocValuesQuery) {\n-                query = ((IndexOrDocValuesQuery) query).getIndexQuery();\n-                continue;\n-            }\n-            return query;\n-        }\n+        return switch (query) {\n+            case ConstantScoreQuery constantScoreQuery -> unwrap(constantScoreQuery.getQuery());\n+            case IndexSortSortedNumericDocValuesRangeQuery rangeQuery -> unwrap(rangeQuery.getFallbackQuery());\n+            case IndexOrDocValuesQuery docValuesQuery -> unwrap(docValuesQuery.getIndexQuery());\n+            default -> query;\n+        };\n     }\n \n     /**\n@@ -265,11 +253,6 @@ public class QueryToFilterAdapter {\n      * @return true if all filters match no docs, otherwise false\n      */\n     static boolean matchesNoDocs(List<QueryToFilterAdapter> filters) {\n-        for (QueryToFilterAdapter filter : filters) {\n-            if (filter.query() instanceof MatchNoDocsQuery == false) {\n-                return false;\n-            }\n-        }\n-        return true;\n+        return filters.stream().allMatch(filter -> filter.query() instanceof MatchNoDocsQuery);\n     }\n }",
  "logs_path": "factory/glm-4.6/24634b85/elastic_elasticsearch_pr134628/logs.jsonl",
  "errors": [],
  "edit_run_id": "24634b85",
  "test_label": null
}