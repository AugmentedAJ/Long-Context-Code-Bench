{
  "repo_url": "https://github.com/elastic/elasticsearch.git",
  "pr_number": 4419,
  "base_commit": "4e7ce4ee02a85ca02b8a07a27ae4e82341e2db39",
  "runner": "factory",
  "model": "glm-4.6",
  "timeout_s": 1800,
  "status": "success",
  "elapsed_ms": 116423,
  "patch_unified": "diff --git a/src/main/java/org/elasticsearch/index/shard/service/InternalIndexShard.java b/src/main/java/org/elasticsearch/index/shard/service/InternalIndexShard.java\nindex 1eaf50f..e7315a2 100644\n--- a/src/main/java/org/elasticsearch/index/shard/service/InternalIndexShard.java\n+++ b/src/main/java/org/elasticsearch/index/shard/service/InternalIndexShard.java\n@@ -286,6 +286,7 @@ public class InternalIndexShard extends AbstractIndexShardComponent implements I\n                 }\n \n                 boolean movedToStarted = false;\n+                IndexShardState oldState = state;\n                 synchronized (mutex) {\n                     // do the check under a mutex, so we make sure to only change to STARTED if in POST_RECOVERY\n                     if (state == IndexShardState.POST_RECOVERY) {\n@@ -297,6 +298,7 @@ public class InternalIndexShard extends AbstractIndexShardComponent implements I\n                     }\n                 }\n                 if (movedToStarted) {\n+                    indicesLifecycle.shardStateChanged(this, oldState, IndexShardState.STARTED, \"cluster state is \" + newRouting.state());\n                     indicesLifecycle.afterIndexShardStarted(this);\n                 }\n             }\n@@ -330,8 +332,10 @@ public class InternalIndexShard extends AbstractIndexShardComponent implements I\n             if (state == IndexShardState.POST_RECOVERY) {\n                 throw new IndexShardRecoveringException(shardId);\n             }\n+            IndexShardState oldState = state;\n             logger.debug(\"state: [{}]->[{}], reason [{}]\", state, IndexShardState.RECOVERING, reason);\n             state = IndexShardState.RECOVERING;\n+            indicesLifecycle.shardStateChanged(this, oldState, IndexShardState.RECOVERING, reason);\n             return returnValue;\n         }\n     }\n@@ -341,8 +345,10 @@ public class InternalIndexShard extends AbstractIndexShardComponent implements I\n             if (state != IndexShardState.STARTED) {\n                 throw new IndexShardNotStartedException(shardId, state);\n             }\n+            IndexShardState oldState = state;\n             logger.debug(\"state: [{}]->[{}], reason [{}]\", state, IndexShardState.RELOCATED, reason);\n             state = IndexShardState.RELOCATED;\n+            indicesLifecycle.shardStateChanged(this, oldState, IndexShardState.RELOCATED, reason);\n         }\n         return this;\n     }\n@@ -653,10 +659,12 @@ public class InternalIndexShard extends AbstractIndexShardComponent implements I\n                     mergeScheduleFuture = null;\n                 }\n             }\n+            IndexShardState oldState = state;\n             if (logger.isDebugEnabled()) {\n                 logger.debug(\"state: [{}]->[{}], reason [{}]\", state, IndexShardState.CLOSED, reason);\n             }\n             state = IndexShardState.CLOSED;\n+            indicesLifecycle.shardStateChanged(this, oldState, IndexShardState.CLOSED, reason);\n         }\n     }\n \n@@ -681,8 +689,10 @@ public class InternalIndexShard extends AbstractIndexShardComponent implements I\n             }\n             engine.start();\n             startScheduledTasksIfNeeded();\n+            IndexShardState oldState = state;\n             logger.debug(\"state: [{}]->[{}], reason [{}]\", state, IndexShardState.POST_RECOVERY, reason);\n             state = IndexShardState.POST_RECOVERY;\n+            indicesLifecycle.shardStateChanged(this, oldState, IndexShardState.POST_RECOVERY, reason);\n         }\n         indicesLifecycle.afterIndexShardPostRecovery(this);\n         return this;\n@@ -725,8 +735,10 @@ public class InternalIndexShard extends AbstractIndexShardComponent implements I\n         translog.clearUnreferenced();\n         engine.refresh(new Engine.Refresh(\"recovery_finalization\").force(true));\n         synchronized (mutex) {\n+            IndexShardState oldState = state;\n             logger.debug(\"state: [{}]->[{}], reason [post recovery]\", state, IndexShardState.POST_RECOVERY);\n             state = IndexShardState.POST_RECOVERY;\n+            indicesLifecycle.shardStateChanged(this, oldState, IndexShardState.POST_RECOVERY, \"post recovery\");\n         }\n         indicesLifecycle.afterIndexShardPostRecovery(this);\n         startScheduledTasksIfNeeded();\ndiff --git a/src/main/java/org/elasticsearch/indices/IndicesLifecycle.java b/src/main/java/org/elasticsearch/indices/IndicesLifecycle.java\nindex 9c95dd5..4b17059 100644\n--- a/src/main/java/org/elasticsearch/indices/IndicesLifecycle.java\n+++ b/src/main/java/org/elasticsearch/indices/IndicesLifecycle.java\n@@ -23,6 +23,7 @@ import org.elasticsearch.cluster.routing.ShardRouting;\n import org.elasticsearch.common.Nullable;\n import org.elasticsearch.index.Index;\n import org.elasticsearch.index.service.IndexService;\n+import org.elasticsearch.index.shard.IndexShardState;\n import org.elasticsearch.index.shard.ShardId;\n import org.elasticsearch.index.shard.service.IndexShard;\n \n@@ -58,6 +59,18 @@ public interface IndicesLifecycle {\n \n         }\n \n+        /**\n+         * Called when the shard state has changed.\n+         *\n+         * @param indexShard The index shard\n+         * @param oldState The previous shard state (can be null)\n+         * @param newState The new shard state\n+         * @param reason The reason for the state change\n+         */\n+        public void shardStateChanged(IndexShard indexShard, @Nullable IndexShardState oldState, IndexShardState newState, String reason) {\n+\n+        }\n+\n         /**\n          * Called before the index gets created.\n          */\ndiff --git a/src/main/java/org/elasticsearch/indices/InternalIndicesLifecycle.java b/src/main/java/org/elasticsearch/indices/InternalIndicesLifecycle.java\nindex b196f9e..54c81b8 100644\n--- a/src/main/java/org/elasticsearch/indices/InternalIndicesLifecycle.java\n+++ b/src/main/java/org/elasticsearch/indices/InternalIndicesLifecycle.java\n@@ -26,6 +26,7 @@ import org.elasticsearch.common.inject.Inject;\n import org.elasticsearch.common.settings.Settings;\n import org.elasticsearch.index.Index;\n import org.elasticsearch.index.service.IndexService;\n+import org.elasticsearch.index.shard.IndexShardState;\n import org.elasticsearch.index.shard.ShardId;\n import org.elasticsearch.index.shard.service.IndexShard;\n \n@@ -61,6 +62,16 @@ public class InternalIndicesLifecycle extends AbstractComponent implements Indic\n         }\n     }\n \n+    public void shardStateChanged(IndexShard indexShard, @Nullable IndexShardState oldState, IndexShardState newState, String reason) {\n+        for (Listener listener : listeners) {\n+            try {\n+                listener.shardStateChanged(indexShard, oldState, newState, reason);\n+            } catch (Throwable t) {\n+                logger.warn(\"{} failed to invoke shard state changed callback\", t, indexShard.shardId());\n+            }\n+        }\n+    }\n+\n     public void beforeIndexCreated(Index index) {\n         for (Listener listener : listeners) {\n             try {",
  "logs_path": "factory/glm-4.6/24634b85/elastic_elasticsearch_pr4419/logs.jsonl",
  "errors": [],
  "edit_run_id": "24634b85",
  "test_label": null
}