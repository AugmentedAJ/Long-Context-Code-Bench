{
  "repo_url": "https://github.com/elastic/elasticsearch.git",
  "pr_number": 134495,
  "base_commit": "36181aa6f726d08d5c9c779f2d6e99b732de0ccc",
  "runner": "factory",
  "model": "glm-4.6",
  "timeout_s": 1800,
  "status": "success",
  "elapsed_ms": 341491,
  "patch_unified": "diff --git a/server/src/internalClusterTest/java/org/elasticsearch/search/ccs/CCSUsageTelemetryIT.java b/server/src/internalClusterTest/java/org/elasticsearch/search/ccs/CCSUsageTelemetryIT.java\nindex ab79fd7b..ae83b886 100644\n--- a/server/src/internalClusterTest/java/org/elasticsearch/search/ccs/CCSUsageTelemetryIT.java\n+++ b/server/src/internalClusterTest/java/org/elasticsearch/search/ccs/CCSUsageTelemetryIT.java\n@@ -58,6 +58,7 @@ import static org.elasticsearch.action.admin.cluster.stats.CCSUsageTelemetry.ASY\n import static org.elasticsearch.action.admin.cluster.stats.CCSUsageTelemetry.MRT_FEATURE;\n import static org.elasticsearch.action.admin.cluster.stats.CCSUsageTelemetry.PIT_FEATURE;\n import static org.elasticsearch.action.admin.cluster.stats.CCSUsageTelemetry.WILDCARD_FEATURE;\n+import static org.elasticsearch.action.admin.cluster.stats.CCSTelemetryAssertions.*;\n import static org.elasticsearch.test.hamcrest.ElasticsearchAssertions.assertAcked;\n import static org.elasticsearch.test.hamcrest.ElasticsearchAssertions.assertResponse;\n import static org.hamcrest.Matchers.equalTo;\n@@ -156,54 +157,36 @@ public class CCSUsageTelemetryIT extends AbstractMultiClustersTestCase {\n         );\n         CCSTelemetrySnapshot telemetry = getTelemetrySnapshot(nodeName);\n \n-        assertThat(telemetry.getTotalCount(), equalTo(1L));\n-        assertThat(telemetry.getSuccessCount(), equalTo(1L));\n-        assertThat(telemetry.getFailureReasons().size(), equalTo(0));\n-        assertThat(telemetry.getTook().count(), equalTo(1L));\n-        assertThat(telemetry.getTookMrtTrue().count(), equalTo(minimizeRoundtrips ? 1L : 0L));\n-        assertThat(telemetry.getTookMrtFalse().count(), equalTo(minimizeRoundtrips ? 0L : 1L));\n-        assertThat(telemetry.getRemotesPerSearchAvg(), equalTo(2.0));\n-        assertThat(telemetry.getRemotesPerSearchMax(), equalTo(2L));\n-        assertThat(telemetry.getSearchCountWithSkippedRemotes(), equalTo(0L));\n-        assertThat(telemetry.getClientCounts().size(), equalTo(1));\n-        assertThat(telemetry.getClientCounts().get(\"kibana\"), equalTo(1L));\n-        if (minimizeRoundtrips) {\n-            assertThat(telemetry.getFeatureCounts().get(MRT_FEATURE), equalTo(1L));\n-        } else {\n-            assertThat(telemetry.getFeatureCounts().get(MRT_FEATURE), equalTo(null));\n-        }\n-        assertThat(telemetry.getFeatureCounts().get(ASYNC_FEATURE), equalTo(null));\n+        assertBasicTelemetryMetrics(telemetry, 1L, 1L, 0);\n+        assertTookMetrics(telemetry, 1L, null, null);\n+        assertMRTTelemetryCounts(telemetry, minimizeRoundtrips ? 1L : 0L, minimizeRoundtrips ? 0L : 1L);\n+        assertRemotesPerSearch(telemetry, 2L, 2.0);\n+        assertSkippedRemotesCount(telemetry, 0L);\n+        assertClientCounts(telemetry, 1, Map.of(\"kibana\", 1L));\n+        assertMRTFeatureCount(telemetry, minimizeRoundtrips);\n+        assertNoAsyncFeature(telemetry);\n \n         var perCluster = telemetry.getByRemoteCluster();\n         assertThat(perCluster.size(), equalTo(3));\n         for (String clusterAlias : remoteClusterAlias()) {\n             var clusterTelemetry = perCluster.get(clusterAlias);\n-            assertThat(clusterTelemetry.getCount(), equalTo(1L));\n-            assertThat(clusterTelemetry.getSkippedCount(), equalTo(0L));\n-            assertThat(clusterTelemetry.getTook().count(), equalTo(1L));\n+            assertPerClusterTelemetry(clusterTelemetry, 1L, 0L, 1L);\n         }\n \n         // another search\n         assertResponse(cluster(LOCAL_CLUSTER).client(nodeName).search(searchRequest), Assert::assertNotNull);\n         telemetry = getTelemetrySnapshot(nodeName);\n-        assertThat(telemetry.getTotalCount(), equalTo(2L));\n-        assertThat(telemetry.getSuccessCount(), equalTo(2L));\n-        assertThat(telemetry.getFailureReasons().size(), equalTo(0));\n-        assertThat(telemetry.getTook().count(), equalTo(2L));\n-        assertThat(telemetry.getTookMrtTrue().count(), equalTo(minimizeRoundtrips ? 2L : 0L));\n-        assertThat(telemetry.getTookMrtFalse().count(), equalTo(minimizeRoundtrips ? 0L : 2L));\n-        assertThat(telemetry.getRemotesPerSearchAvg(), equalTo(2.0));\n-        assertThat(telemetry.getRemotesPerSearchMax(), equalTo(2L));\n-        assertThat(telemetry.getSearchCountWithSkippedRemotes(), equalTo(0L));\n-        assertThat(telemetry.getClientCounts().size(), equalTo(1));\n-        assertThat(telemetry.getClientCounts().get(\"kibana\"), equalTo(1L));\n+        assertBasicTelemetryMetrics(telemetry, 2L, 2L, 0);\n+        assertTookMetrics(telemetry, 2L, null, null);\n+        assertMRTTelemetryCounts(telemetry, minimizeRoundtrips ? 2L : 0L, minimizeRoundtrips ? 0L : 2L);\n+        assertRemotesPerSearch(telemetry, 2L, 2.0);\n+        assertSkippedRemotesCount(telemetry, 0L);\n+        assertClientCounts(telemetry, 1, Map.of(\"kibana\", 1L));\n         perCluster = telemetry.getByRemoteCluster();\n         assertThat(perCluster.size(), equalTo(3));\n         for (String clusterAlias : remoteClusterAlias()) {\n             var clusterTelemetry = perCluster.get(clusterAlias);\n-            assertThat(clusterTelemetry.getCount(), equalTo(2L));\n-            assertThat(clusterTelemetry.getSkippedCount(), equalTo(0L));\n-            assertThat(clusterTelemetry.getTook().count(), equalTo(2L));\n+            assertPerClusterTelemetry(clusterTelemetry, 2L, 0L, 2L);\n         }\n     }\n \n@@ -260,19 +243,15 @@ public class CCSUsageTelemetryIT extends AbstractMultiClustersTestCase {\n         String remoteIndex = (String) testClusterInfo.get(\"remote.index\");\n \n         CCSTelemetrySnapshot telemetry = getTelemetryFromSearch(\"*:\" + remoteIndex);\n-        var perCluster = telemetry.getByRemoteCluster();\n-        assertThat(telemetry.getTotalCount(), equalTo(1L));\n-        assertThat(telemetry.getSuccessCount(), equalTo(1L));\n-        assertThat(telemetry.getFailureReasons().size(), equalTo(0));\n-        assertThat(telemetry.getTook().count(), equalTo(1L));\n-        assertThat(perCluster.size(), equalTo(2));\n-        assertThat(telemetry.getClientCounts().size(), equalTo(0));\n-        assertThat(perCluster.get(REMOTE1).getCount(), equalTo(1L));\n-        assertThat(perCluster.get(REMOTE1).getSkippedCount(), equalTo(0L));\n-        assertThat(perCluster.get(REMOTE1).getTook().count(), equalTo(1L));\n-        assertThat(perCluster.get(REMOTE2).getCount(), equalTo(1L));\n-        assertThat(perCluster.get(REMOTE2).getSkippedCount(), equalTo(0L));\n-        assertThat(perCluster.get(REMOTE2).getTook().count(), equalTo(1L));\n+        \n+        assertBasicTelemetryMetrics(telemetry, 1L, 1L, 0);\n+        assertTookMetrics(telemetry, 1L, null, null);\n+        assertClientCounts(telemetry, 0, null);\n+        \n+        assertPerClusterTelemetryMap(telemetry, 2, Map.of(\n+            REMOTE1, PerClusterTelemetryExpectation.exists(1L, 0L, 1L, null),\n+            REMOTE2, PerClusterTelemetryExpectation.exists(1L, 0L, 1L, null)\n+        ));\n     }\n \n     /**\n@@ -339,13 +318,7 @@ public class CCSUsageTelemetryIT extends AbstractMultiClustersTestCase {\n         searchRequest.allowPartialSearchResults(true);\n \n         CCSTelemetrySnapshot telemetry = getTelemetryFromFailedSearch(searchRequest);\n-        assertThat(telemetry.getTotalCount(), equalTo(1L));\n-        assertThat(telemetry.getSuccessCount(), equalTo(0L));\n-        assertThat(telemetry.getTook().count(), equalTo(0L));\n-        assertThat(telemetry.getTookMrtTrue().count(), equalTo(0L));\n-        assertThat(telemetry.getTookMrtFalse().count(), equalTo(0L));\n-        Map<String, Long> expectedFailures = Map.of(Result.UNKNOWN.getName(), 1L);\n-        assertThat(telemetry.getFailureReasons(), equalTo(expectedFailures));\n+        assertFailedSearchMetrics(telemetry, Result.UNKNOWN);\n     }\n \n     /**\ndiff --git a/server/src/test/java/org/elasticsearch/action/admin/cluster/stats/CCSUsageTelemetryTests.java b/server/src/test/java/org/elasticsearch/action/admin/cluster/stats/CCSUsageTelemetryTests.java\nindex 5eb2224e..fe4efcab 100644\n--- a/server/src/test/java/org/elasticsearch/action/admin/cluster/stats/CCSUsageTelemetryTests.java\n+++ b/server/src/test/java/org/elasticsearch/action/admin/cluster/stats/CCSUsageTelemetryTests.java\n@@ -12,12 +12,15 @@ package org.elasticsearch.action.admin.cluster.stats;\n import org.elasticsearch.core.TimeValue;\n import org.elasticsearch.test.ESTestCase;\n \n+import java.util.Map;\n+\n import static org.elasticsearch.action.admin.cluster.stats.ApproximateMatcher.closeTo;\n import static org.elasticsearch.action.admin.cluster.stats.CCSUsageTelemetry.ASYNC_FEATURE;\n import static org.elasticsearch.action.admin.cluster.stats.CCSUsageTelemetry.KNOWN_CLIENTS;\n import static org.elasticsearch.action.admin.cluster.stats.CCSUsageTelemetry.MRT_FEATURE;\n import static org.elasticsearch.action.admin.cluster.stats.CCSUsageTelemetry.Result.CANCELED;\n import static org.elasticsearch.action.admin.cluster.stats.CCSUsageTelemetry.WILDCARD_FEATURE;\n+import static org.elasticsearch.action.admin.cluster.stats.CCSTelemetryAssertions.*;\n import static org.hamcrest.Matchers.equalTo;\n import static org.hamcrest.Matchers.greaterThan;\n \n@@ -65,53 +68,21 @@ public class CCSUsageTelemetryTests extends ESTestCase {\n \n             CCSTelemetrySnapshot snapshot = ccsUsageHolder.getCCSTelemetrySnapshot();\n \n-            assertThat(snapshot.getTotalCount(), equalTo(1L));\n-            assertThat(snapshot.getSuccessCount(), equalTo(1L));\n-            assertThat(snapshot.getFeatureCounts().getOrDefault(ASYNC_FEATURE, 0L), equalTo(expectedAsyncCount));\n-            assertThat(snapshot.getFeatureCounts().getOrDefault(MRT_FEATURE, 0L), equalTo(expectedMinRTCount));\n-            assertThat(snapshot.getSearchCountWithSkippedRemotes(), equalTo(expectedSearchesWithSkippedRemotes));\n-            assertThat(snapshot.getTook().avg(), greaterThan(0L));\n-            // Expect it to be within 1% of the actual value\n-            assertThat(snapshot.getTook().avg(), closeTo(took1));\n-            assertThat(snapshot.getTook().max(), closeTo(took1));\n-            if (minimizeRoundTrips) {\n-                assertThat(snapshot.getTookMrtTrue().count(), equalTo(1L));\n-                assertThat(snapshot.getTookMrtTrue().avg(), greaterThan(0L));\n-                assertThat(snapshot.getTookMrtTrue().avg(), closeTo(took1));\n-                assertThat(snapshot.getTookMrtFalse().count(), equalTo(0L));\n-                assertThat(snapshot.getTookMrtFalse().max(), equalTo(0L));\n-            } else {\n-                assertThat(snapshot.getTookMrtFalse().count(), equalTo(1L));\n-                assertThat(snapshot.getTookMrtFalse().avg(), greaterThan(0L));\n-                assertThat(snapshot.getTookMrtFalse().avg(), closeTo(took1));\n-                assertThat(snapshot.getTookMrtTrue().count(), equalTo(0L));\n-                assertThat(snapshot.getTookMrtTrue().max(), equalTo(0L));\n-            }\n+            assertBasicTelemetryMetrics(snapshot, 1L, 1L);\n+            assertFeatureCount(snapshot, ASYNC_FEATURE, expectedAsyncCount);\n+            assertFeatureCount(snapshot, MRT_FEATURE, expectedMinRTCount);\n+            assertSkippedRemotesCount(snapshot, expectedSearchesWithSkippedRemotes);\n+            assertTookMetrics(snapshot, 1L, took1, took1);\n+            assertMRTTelemetry(snapshot, minimizeRoundTrips, took1);\n+            \n             // We currently don't count unknown clients\n-            assertThat(snapshot.getClientCounts().size(), equalTo(0));\n+            assertClientCounts(snapshot, 0, null);\n \n             // per cluster telemetry asserts\n-\n-            var telemetryByCluster = snapshot.getByRemoteCluster();\n-            assertThat(telemetryByCluster.size(), equalTo(2));\n-            var localClusterTelemetry = telemetryByCluster.get(\"(local)\");\n-            assertNotNull(localClusterTelemetry);\n-            assertThat(localClusterTelemetry.getCount(), equalTo(1L));\n-            assertThat(localClusterTelemetry.getSkippedCount(), equalTo(0L));\n-            assertThat(localClusterTelemetry.getTook().count(), equalTo(1L));\n-            assertThat(localClusterTelemetry.getTook().avg(), greaterThan(0L));\n-            assertThat(localClusterTelemetry.getTook().avg(), closeTo(tookLocal));\n-            // assertThat(localClusterTelemetry.getTook().max(), greaterThanOrEqualTo(tookLocal));\n-\n-            var remote1ClusterTelemetry = telemetryByCluster.get(\"remote1\");\n-            assertNotNull(remote1ClusterTelemetry);\n-            assertThat(remote1ClusterTelemetry.getCount(), equalTo(1L));\n-            assertThat(remote1ClusterTelemetry.getSkippedCount(), equalTo(expectedSearchesWithSkippedRemotes));\n-            assertThat(remote1ClusterTelemetry.getTook().avg(), greaterThan(0L));\n-            assertThat(remote1ClusterTelemetry.getTook().count(), equalTo(1L));\n-            assertThat(remote1ClusterTelemetry.getTook().avg(), greaterThan(0L));\n-            assertThat(remote1ClusterTelemetry.getTook().avg(), closeTo(took1Remote1));\n-            // assertThat(remote1ClusterTelemetry.getTook().max(), greaterThanOrEqualTo(took1Remote1));\n+            assertPerClusterTelemetryMap(snapshot, 2, Map.of(\n+                \"(local)\", PerClusterTelemetryExpectation.exists(1L, 0L, 1L, tookLocal),\n+                \"remote1\", PerClusterTelemetryExpectation.exists(1L, expectedSearchesWithSkippedRemotes, 1L, took1Remote1)\n+            ));\n         }\n \n         // second search\n@@ -143,38 +114,20 @@ public class CCSUsageTelemetryTests extends ESTestCase {\n \n             CCSTelemetrySnapshot snapshot = ccsUsageHolder.getCCSTelemetrySnapshot();\n \n-            assertThat(snapshot.getTotalCount(), equalTo(2L));\n-            assertThat(snapshot.getSuccessCount(), equalTo(2L));\n-            assertThat(snapshot.getFeatureCounts().getOrDefault(ASYNC_FEATURE, 0L), equalTo(expectedAsyncCount));\n-            assertThat(snapshot.getFeatureCounts().getOrDefault(MRT_FEATURE, 0L), equalTo(expectedMinRTCount));\n-            assertThat(snapshot.getSearchCountWithSkippedRemotes(), equalTo(expectedSearchesWithSkippedRemotes));\n-            assertThat(snapshot.getTook().avg(), greaterThan(0L));\n-            assertThat(snapshot.getTook().avg(), closeTo((took1 + took2) / 2));\n-            // assertThat(snapshot.getTook().max(), greaterThanOrEqualTo(Math.max(took1, took2)));\n+            assertBasicTelemetryMetrics(snapshot, 2L, 2L);\n+            assertFeatureCount(snapshot, ASYNC_FEATURE, expectedAsyncCount);\n+            assertFeatureCount(snapshot, MRT_FEATURE, expectedMinRTCount);\n+            assertSkippedRemotesCount(snapshot, expectedSearchesWithSkippedRemotes);\n+            assertTookMetrics(snapshot, 2L, (took1 + took2) / 2, null);\n \n             // Counting only known clients\n-            assertThat(snapshot.getClientCounts().get(\"kibana\"), equalTo(1L));\n-            assertThat(snapshot.getClientCounts().size(), equalTo(1));\n+            assertClientCounts(snapshot, 1, Map.of(\"kibana\", 1L));\n \n             // per cluster telemetry asserts\n-\n-            var telemetryByCluster = snapshot.getByRemoteCluster();\n-            assertThat(telemetryByCluster.size(), equalTo(2));\n-            var localClusterTelemetry = telemetryByCluster.get(\"(local)\");\n-            assertNotNull(localClusterTelemetry);\n-            assertThat(localClusterTelemetry.getCount(), equalTo(1L));\n-            assertThat(localClusterTelemetry.getSkippedCount(), equalTo(0L));\n-            assertThat(localClusterTelemetry.getTook().count(), equalTo(1L));\n-\n-            var remote1ClusterTelemetry = telemetryByCluster.get(\"remote1\");\n-            assertNotNull(remote1ClusterTelemetry);\n-            assertThat(remote1ClusterTelemetry.getCount(), equalTo(2L));\n-            assertThat(remote1ClusterTelemetry.getSkippedCount(), equalTo(expectedSearchesWithSkippedRemotes));\n-            assertThat(remote1ClusterTelemetry.getTook().avg(), greaterThan(0L));\n-            assertThat(remote1ClusterTelemetry.getTook().count(), equalTo(2L));\n-            assertThat(remote1ClusterTelemetry.getTook().avg(), greaterThan(0L));\n-            assertThat(remote1ClusterTelemetry.getTook().avg(), closeTo((took1Remote1 + took2Remote1) / 2));\n-            // assertThat(remote1ClusterTelemetry.getTook().max(), greaterThanOrEqualTo(Math.max(took1Remote1, took2Remote1)));\n+            assertPerClusterTelemetryMap(snapshot, 2, Map.of(\n+                \"(local)\", PerClusterTelemetryExpectation.exists(1L, 0L, 1L, null),\n+                \"remote1\", PerClusterTelemetryExpectation.exists(2L, expectedSearchesWithSkippedRemotes, 2L, (took1Remote1 + took2Remote1) / 2)\n+            ));\n         }\n     }\n \n@@ -241,15 +194,13 @@ public class CCSUsageTelemetryTests extends ESTestCase {\n \n             CCSTelemetrySnapshot snapshot = ccsUsageHolder.getCCSTelemetrySnapshot();\n \n-            assertThat(snapshot.getTotalCount(), equalTo(1L));\n-            assertThat(snapshot.getSuccessCount(), equalTo(0L));\n-            assertThat(snapshot.getSearchCountWithSkippedRemotes(), equalTo(skippedRemote ? 1L : 0L));\n-            assertThat(snapshot.getTook().count(), equalTo(0L));\n-            assertThat(snapshot.getFailureReasons().size(), equalTo(1));\n-            assertThat(snapshot.getFailureReasons().get(CANCELED.getName()), equalTo(1L));\n+            assertBasicTelemetryMetrics(snapshot, 1L, 0L);\n+            assertSkippedRemotesCount(snapshot, skippedRemote ? 1L : 0L);\n+            assertTookMetrics(snapshot, 0L, null, null);\n+            assertFailureReasons(snapshot, Map.of(CANCELED.getName(), 1L));\n             // still counting features on failure\n-            assertThat(snapshot.getFeatureCounts().getOrDefault(ASYNC_FEATURE, 0L), equalTo(async ? 1L : 0L));\n-            assertThat(snapshot.getFeatureCounts().getOrDefault(MRT_FEATURE, 0L), equalTo(minimizeRoundTrips ? 1L : 0L));\n+            assertFeatureCount(snapshot, ASYNC_FEATURE, async ? 1L : 0L);\n+            assertFeatureCount(snapshot, MRT_FEATURE, minimizeRoundTrips ? 1L : 0L);\n         }\n \n         // second search\n@@ -267,12 +218,10 @@ public class CCSUsageTelemetryTests extends ESTestCase {\n \n             CCSTelemetrySnapshot snapshot = ccsUsageHolder.getCCSTelemetrySnapshot();\n \n-            assertThat(snapshot.getTotalCount(), equalTo(2L));\n-            assertThat(snapshot.getSuccessCount(), equalTo(0L));\n-            assertThat(snapshot.getTook().count(), equalTo(0L));\n-            assertThat(snapshot.getFailureReasons().size(), equalTo(1));\n-            assertThat(snapshot.getFailureReasons().get(CANCELED.getName()), equalTo(2L));\n-            assertThat(snapshot.getClientCounts().get(\"kibana\"), equalTo(1L));\n+            assertBasicTelemetryMetrics(snapshot, 2L, 0L);\n+            assertTookMetrics(snapshot, 0L, null, null);\n+            assertFailureReasons(snapshot, Map.of(CANCELED.getName(), 2L));\n+            assertClientCounts(snapshot, 1, Map.of(\"kibana\", 1L));\n         }\n     }\n \n@@ -355,8 +304,7 @@ public class CCSUsageTelemetryTests extends ESTestCase {\n         ccsUsageHolder.updateUsage(builder.build());\n \n         CCSTelemetrySnapshot snapshot = ccsUsageHolder.getCCSTelemetrySnapshot();\n-        assertThat(snapshot.getTook().count(), equalTo(2L));\n-        assertThat(snapshot.getTookMrtFalse().count(), equalTo(0L));\n-        assertThat(snapshot.getTookMrtTrue().count(), equalTo(0L));\n+        assertTookMetrics(snapshot, 2L, null, null);\n+        assertMRTTelemetryCounts(snapshot, 0L, 0L);\n     }\n }",
  "logs_path": "factory/glm-4.6/24634b85/elastic_elasticsearch_pr134495/logs.jsonl",
  "errors": [],
  "edit_run_id": "24634b85",
  "test_label": null
}