{
  "repo_url": "https://github.com/elastic/elasticsearch.git",
  "pr_number": 3947,
  "base_commit": "e79f714b4b066f9238ff6313aad9a854c37a8c3d",
  "runner": "factory",
  "model": "glm-4.6",
  "timeout_s": 1800,
  "status": "success",
  "elapsed_ms": 108719,
  "patch_unified": "diff --git a/src/main/java/org/elasticsearch/index/mapper/core/CompletionFieldMapper.java b/src/main/java/org/elasticsearch/index/mapper/core/CompletionFieldMapper.java\nindex bc4c097..b562448 100644\n--- a/src/main/java/org/elasticsearch/index/mapper/core/CompletionFieldMapper.java\n+++ b/src/main/java/org/elasticsearch/index/mapper/core/CompletionFieldMapper.java\n@@ -248,6 +248,11 @@ public class CompletionFieldMapper extends AbstractFieldMapper<String> {\n                     }\n                 } else if (token == XContentParser.Token.VALUE_NUMBER) {\n                     if (Fields.CONTENT_FIELD_NAME_WEIGHT.equals(currentFieldName)) {\n+                        // Check if the weight is a float or double and reject it\n+                        XContentParser.NumberType numberType = parser.numberType();\n+                        if (numberType == XContentParser.NumberType.FLOAT || numberType == XContentParser.NumberType.DOUBLE) {\n+                            throw new ElasticSearchIllegalArgumentException(\"Weight must be an integer, but was [\" + parser.numberValue() + \"] of type [\" + numberType + \"]\");\n+                        }\n                         weight = parser.longValue(); // always parse a long to make sure we don't get the overflow value\n                         if (weight < 0 || weight > Integer.MAX_VALUE) {\n                             throw new ElasticSearchIllegalArgumentException(\"Weight must be in the interval [0..2147483647] but was \" + weight);\ndiff --git a/src/test/java/org/elasticsearch/index/mapper/completion/CompletionFieldMapperTests.java b/src/test/java/org/elasticsearch/index/mapper/completion/CompletionFieldMapperTests.java\nindex 61f4883..c4718b3 100644\n--- a/src/test/java/org/elasticsearch/index/mapper/completion/CompletionFieldMapperTests.java\n+++ b/src/test/java/org/elasticsearch/index/mapper/completion/CompletionFieldMapperTests.java\n@@ -18,10 +18,12 @@\n  */\n package org.elasticsearch.index.mapper.completion;\n \n+import org.elasticsearch.ElasticSearchIllegalArgumentException;\n import org.elasticsearch.common.xcontent.XContentBuilder;\n import org.elasticsearch.common.xcontent.json.JsonXContent;\n import org.elasticsearch.index.mapper.DocumentMapper;\n import org.elasticsearch.index.mapper.FieldMapper;\n+import org.elasticsearch.index.mapper.MapperException;\n import org.elasticsearch.index.mapper.MapperTestUtils;\n import org.elasticsearch.index.mapper.core.CompletionFieldMapper;\n import org.elasticsearch.test.ElasticsearchTestCase;\n@@ -112,4 +114,49 @@ public class CompletionFieldMapperTests extends ElasticsearchTestCase {\n         assertThat(configMap.get(\"analyzer\").toString(), is(\"simple\"));\n     }\n \n+    @Test\n+    public void testFloatWeightRejection() throws Exception {\n+        String mapping = jsonBuilder().startObject().startObject(\"type1\")\n+                .startObject(\"properties\").startObject(\"completion\")\n+                .field(\"type\", \"completion\")\n+                .endObject().endObject()\n+                .endObject().endObject().string();\n+\n+        DocumentMapper defaultMapper = MapperTestUtils.newParser().parse(mapping);\n+\n+        // Test that float weight is rejected\n+        try {\n+            defaultMapper.parse(\"{\\\"completion\\\":{\\\"input\\\":\\\"test\\\",\\\"weight\\\":1.5}}\");\n+            fail(\"Expected ElasticSearchIllegalArgumentException for float weight\");\n+        } catch (MapperException e) {\n+            assertTrue(\"Exception should mention that weight must be an integer\",\n+                    e.getCause().getMessage().contains(\"Weight must be an integer\"));\n+        }\n+\n+        // Test that double weight is rejected\n+        try {\n+            defaultMapper.parse(\"{\\\"completion\\\":{\\\"input\\\":\\\"test\\\",\\\"weight\\\":2.0}}\");\n+            fail(\"Expected ElasticSearchIllegalArgumentException for double weight\");\n+        } catch (MapperException e) {\n+            assertTrue(\"Exception should mention that weight must be an integer\",\n+                    e.getCause().getMessage().contains(\"Weight must be an integer\"));\n+        }\n+    }\n+\n+    @Test\n+    public void testIntegerWeightAcceptance() throws Exception {\n+        String mapping = jsonBuilder().startObject().startObject(\"type1\")\n+                .startObject(\"properties\").startObject(\"completion\")\n+                .field(\"type\", \"completion\")\n+                .endObject().endObject()\n+                .endObject().endObject().string();\n+\n+        DocumentMapper defaultMapper = MapperTestUtils.newParser().parse(mapping);\n+\n+        // Test that integer weights are accepted\n+        defaultMapper.parse(\"{\\\"completion\\\":{\\\"input\\\":\\\"test\\\",\\\"weight\\\":1}}\");\n+        defaultMapper.parse(\"{\\\"completion\\\":{\\\"input\\\":\\\"test\\\",\\\"weight\\\":0}}\");\n+        defaultMapper.parse(\"{\\\"completion\\\":{\\\"input\\\":\\\"test\\\",\\\"weight\\\":2147483647}}\");\n+    }\n+\n }",
  "logs_path": "factory/glm-4.6/24634b85/elastic_elasticsearch_pr3947/logs.jsonl",
  "errors": [],
  "edit_run_id": "24634b85",
  "test_label": null
}