{
  "repo_url": "https://github.com/elastic/elasticsearch.git",
  "pr_number": 1616,
  "base_commit": "56a9c66df183ea4e9e2cfb8861877283d4048304",
  "runner": "factory",
  "model": "glm-4.6",
  "timeout_s": 1800,
  "status": "success",
  "elapsed_ms": 114923,
  "patch_unified": "diff --git a/src/main/java/org/elasticsearch/index/mapper/internal/TTLFieldMapper.java b/src/main/java/org/elasticsearch/index/mapper/internal/TTLFieldMapper.java\nindex aa179f1..c5acc6c 100644\n--- a/src/main/java/org/elasticsearch/index/mapper/internal/TTLFieldMapper.java\n+++ b/src/main/java/org/elasticsearch/index/mapper/internal/TTLFieldMapper.java\n@@ -182,6 +182,8 @@ public class TTLFieldMapper extends LongFieldMapper implements InternalMapper, R\n             long ttl = context.sourceToParse().ttl();\n             if (ttl <= 0 && defaultTTL > 0) { // no ttl provided so we use the default value\n                 ttl = defaultTTL;\n+                // Update the source context to reflect that default TTL is being used\n+                context.sourceToParse().ttl(ttl);\n             }\n             if (ttl > 0) { // a ttl has been provided either externally or in the _source\n                 long timestamp = context.sourceToParse().timestamp();\ndiff --git a/src/test/java/org/elasticsearch/test/unit/index/mapper/ttl/TTLMappingTests.java b/src/test/java/org/elasticsearch/test/unit/index/mapper/ttl/TTLMappingTests.java\nindex e3c02f6..c79487c 100644\n--- a/src/test/java/org/elasticsearch/test/unit/index/mapper/ttl/TTLMappingTests.java\n+++ b/src/test/java/org/elasticsearch/test/unit/index/mapper/ttl/TTLMappingTests.java\n@@ -88,4 +88,71 @@ public class TTLMappingTests {\n         assertThat(docMapper.TTLFieldMapper().store(), equalTo(Field.Store.NO));\n         assertThat(docMapper.TTLFieldMapper().index(), equalTo(Field.Index.NO));\n     }\n+\n+    @Test\n+    public void testDefaultTTLSetInSourceContext() throws Exception {\n+        long defaultTTLValue = 5000; // 5 seconds\n+        String mapping = XContentFactory.jsonBuilder().startObject().startObject(\"type\")\n+                .startObject(\"_ttl\")\n+                .field(\"enabled\", true)\n+                .field(\"default\", defaultTTLValue + \"ms\")\n+                .endObject()\n+                .endObject().endObject().string();\n+        \n+        DocumentMapper docMapper = MapperTests.newParser().parse(mapping);\n+        \n+        // Verify default TTL is configured in the mapper\n+        assertThat(docMapper.TTLFieldMapper().enabled(), equalTo(true));\n+        assertThat(docMapper.TTLFieldMapper().defaultTTL(), equalTo(defaultTTLValue));\n+        \n+        // Create source document without TTL\n+        byte[] source = XContentFactory.jsonBuilder()\n+                .startObject()\n+                .field(\"field\", \"value\")\n+                .endObject()\n+                .copiedBytes();\n+        \n+        // Parse document without providing TTL externally (ttl < 0)\n+        SourceToParse sourceToParse = SourceToParse.source(source).type(\"type\").id(\"1\").ttl(-1);\n+        ParsedDocument doc = docMapper.parse(sourceToParse);\n+        \n+        // Verify that the TTL field is created with default value\n+        assertThat(doc.rootDoc().getFieldable(\"_ttl\"), notNullValue());\n+        \n+        // Most importantly, verify that the source context TTL has been updated to reflect default TTL usage\n+        assertThat(sourceToParse.ttl(), equalTo(defaultTTLValue));\n+    }\n+\n+    @Test\n+    public void testProvidedTTLOverridesDefault() throws Exception {\n+        long defaultTTLValue = 5000; // 5 seconds\n+        long providedTTLValue = 10000; // 10 seconds\n+        String mapping = XContentFactory.jsonBuilder().startObject().startObject(\"type\")\n+                .startObject(\"_ttl\")\n+                .field(\"enabled\", true)\n+                .field(\"default\", defaultTTLValue + \"ms\")\n+                .endObject()\n+                .endObject().endObject().string();\n+        \n+        DocumentMapper docMapper = MapperTests.newParser().parse(mapping);\n+        \n+        // Create source document with explicit TTL in source\n+        byte[] source = XContentFactory.jsonBuilder()\n+                .startObject()\n+                .field(\"field\", \"value\")\n+                .field(\"_ttl\", providedTTLValue)\n+                .endObject()\n+                .copiedBytes();\n+        \n+        // Parse document without providing TTL externally (ttl < 0)\n+        SourceToParse sourceToParse = SourceToParse.source(source).type(\"type\").id(\"1\").ttl(-1);\n+        ParsedDocument doc = docMapper.parse(sourceToParse);\n+        \n+        // Verify that the TTL field is created with provided value, not default\n+        assertThat(doc.rootDoc().getFieldable(\"_ttl\"), notNullValue());\n+        \n+        // Verify that the source context TTL reflects the provided value, not the default\n+        assertThat(sourceToParse.ttl(), equalTo(providedTTLValue));\n+        assertThat(sourceToParse.ttl(), not(equalTo(defaultTTLValue)));\n+    }\n }\n\\ No newline at end of file",
  "logs_path": "factory/glm-4.6/24634b85/elastic_elasticsearch_pr1616/logs.jsonl",
  "errors": [],
  "edit_run_id": "24634b85",
  "test_label": null
}