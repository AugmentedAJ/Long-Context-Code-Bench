{
  "repo_url": "https://github.com/elastic/elasticsearch.git",
  "pr_number": 4422,
  "base_commit": "bb275166f1a1f20f5330691ab854d6dc61c51366",
  "runner": "factory",
  "model": "glm-4.6",
  "timeout_s": 1800,
  "status": "success",
  "elapsed_ms": 172457,
  "patch_unified": "diff --git a/src/main/java/org/elasticsearch/cluster/ClusterModule.java b/src/main/java/org/elasticsearch/cluster/ClusterModule.java\nindex 5edfa23..ce678bb 100644\n--- a/src/main/java/org/elasticsearch/cluster/ClusterModule.java\n+++ b/src/main/java/org/elasticsearch/cluster/ClusterModule.java\n@@ -20,7 +20,8 @@\n package org.elasticsearch.cluster;\n \n import com.google.common.collect.ImmutableList;\n-import org.elasticsearch.cluster.action.index.*;\n+import org.elasticsearch.cluster.action.index.NodeIndexDeletedAction;\n+import org.elasticsearch.cluster.action.index.NodeMappingRefreshAction;\n import org.elasticsearch.cluster.action.shard.ShardStateAction;\n import org.elasticsearch.cluster.metadata.*;\n import org.elasticsearch.cluster.node.DiscoveryNodeService;\n@@ -71,7 +72,6 @@ public class ClusterModule extends AbstractModule implements SpawnModules {\n         bind(RoutingService.class).asEagerSingleton();\n \n         bind(ShardStateAction.class).asEagerSingleton();\n-        bind(NodeIndexCreatedAction.class).asEagerSingleton();\n         bind(NodeIndexDeletedAction.class).asEagerSingleton();\n         bind(NodeMappingRefreshAction.class).asEagerSingleton();\n         bind(MappingUpdatedAction.class).asEagerSingleton();\ndiff --git a/src/main/java/org/elasticsearch/cluster/metadata/MetaDataCreateIndexService.java b/src/main/java/org/elasticsearch/cluster/metadata/MetaDataCreateIndexService.java\nindex a394166..af40939 100644\n--- a/src/main/java/org/elasticsearch/cluster/metadata/MetaDataCreateIndexService.java\n+++ b/src/main/java/org/elasticsearch/cluster/metadata/MetaDataCreateIndexService.java\n@@ -30,10 +30,11 @@ import org.apache.lucene.util.IOUtils;\n import org.elasticsearch.ElasticSearchException;\n import org.elasticsearch.Version;\n import org.elasticsearch.action.support.master.MasterNodeOperationRequest;\n+import org.elasticsearch.cluster.AckedClusterStateUpdateTask;\n import org.elasticsearch.cluster.ClusterService;\n import org.elasticsearch.cluster.ClusterState;\n-import org.elasticsearch.cluster.TimeoutClusterStateUpdateTask;\n-import org.elasticsearch.cluster.action.index.NodeIndexCreatedAction;\n+import org.elasticsearch.cluster.node.DiscoveryNode;\n+import org.elasticsearch.common.Nullable;\n import org.elasticsearch.cluster.block.ClusterBlock;\n import org.elasticsearch.cluster.block.ClusterBlocks;\n import org.elasticsearch.cluster.routing.RoutingTable;\n@@ -89,21 +90,19 @@ public class MetaDataCreateIndexService extends AbstractComponent {\n     private final ClusterService clusterService;\n     private final IndicesService indicesService;\n     private final AllocationService allocationService;\n-    private final NodeIndexCreatedAction nodeIndexCreatedAction;\n     private final MetaDataService metaDataService;\n     private final Version version;\n     private final String riverIndexName;\n \n     @Inject\n     public MetaDataCreateIndexService(Settings settings, Environment environment, ThreadPool threadPool, ClusterService clusterService, IndicesService indicesService,\n-                                      AllocationService allocationService, NodeIndexCreatedAction nodeIndexCreatedAction, MetaDataService metaDataService, Version version, @RiverIndexName String riverIndexName) {\n+                                      AllocationService allocationService, MetaDataService metaDataService, Version version, @RiverIndexName String riverIndexName) {\n         super(settings);\n         this.environment = environment;\n         this.threadPool = threadPool;\n         this.clusterService = clusterService;\n         this.indicesService = indicesService;\n         this.allocationService = allocationService;\n-        this.nodeIndexCreatedAction = nodeIndexCreatedAction;\n         this.metaDataService = metaDataService;\n         this.version = version;\n         this.riverIndexName = riverIndexName;\n@@ -174,13 +173,33 @@ public class MetaDataCreateIndexService extends AbstractComponent {\n \n     private void createIndex(final Request request, final Listener userListener, Semaphore mdLock) {\n         final CreateIndexListener listener = new CreateIndexListener(mdLock, request, userListener);\n-        clusterService.submitStateUpdateTask(\"create-index [\" + request.index + \"], cause [\" + request.cause + \"]\", Priority.URGENT, new TimeoutClusterStateUpdateTask() {\n+        clusterService.submitStateUpdateTask(\"create-index [\" + request.index + \"], cause [\" + request.cause + \"]\", Priority.URGENT, new AckedClusterStateUpdateTask() {\n \n             @Override\n             public TimeValue timeout() {\n                 return request.masterTimeout;\n             }\n \n+            @Override\n+            public boolean mustAck(DiscoveryNode discoveryNode) {\n+                return true;\n+            }\n+\n+            @Override\n+            public void onAllNodesAcked(@Nullable Throwable t) {\n+                listener.onResponse(new Response(true));\n+            }\n+\n+            @Override\n+            public void onAckTimeout() {\n+                listener.onResponse(new Response(false));\n+            }\n+\n+            @Override\n+            public TimeValue ackTimeout() {\n+                return request.timeout;\n+            }\n+\n             @Override\n             public void onFailure(String source, Throwable t) {\n                 listener.onFailure(t);\n@@ -360,31 +379,6 @@ public class MetaDataCreateIndexService extends AbstractComponent {\n                         updatedState = ClusterState.builder(updatedState).routingResult(routingResult).build();\n                     }\n \n-                    // we wait for events from all nodes that the index has been added to the metadata\n-                    final AtomicInteger counter = new AtomicInteger(currentState.nodes().size());\n-\n-                    final NodeIndexCreatedAction.Listener nodeIndexCreatedListener = new NodeIndexCreatedAction.Listener() {\n-                        @Override\n-                        public void onNodeIndexCreated(String index, String nodeId) {\n-                            if (index.equals(request.index)) {\n-                                if (counter.decrementAndGet() == 0) {\n-                                    listener.onResponse(new Response(true, indexMetaData));\n-                                    nodeIndexCreatedAction.remove(this);\n-                                }\n-                            }\n-                        }\n-                    };\n-\n-                    nodeIndexCreatedAction.add(nodeIndexCreatedListener);\n-\n-                    listener.future = threadPool.schedule(request.timeout, ThreadPool.Names.SAME, new Runnable() {\n-                        @Override\n-                        public void run() {\n-                            listener.onResponse(new Response(false, indexMetaData));\n-                            nodeIndexCreatedAction.remove(nodeIndexCreatedListener);\n-                        }\n-                    });\n-\n                     return updatedState;\n                 } finally {\n                     if (indexCreated) {\n@@ -406,7 +400,6 @@ public class MetaDataCreateIndexService extends AbstractComponent {\n         private final Semaphore mdLock;\n         private final Request request;\n         private final Listener listener;\n-        volatile ScheduledFuture future;\n \n         private CreateIndexListener(Semaphore mdLock, Request request, Listener listener) {\n             this.mdLock = mdLock;\n@@ -418,9 +411,6 @@ public class MetaDataCreateIndexService extends AbstractComponent {\n         public void onResponse(final Response response) {\n             if (notified.compareAndSet(false, true)) {\n                 mdLock.release();\n-                if (future != null) {\n-                    future.cancel(false);\n-                }\n                 listener.onResponse(response);\n             }\n         }\n@@ -429,9 +419,6 @@ public class MetaDataCreateIndexService extends AbstractComponent {\n         public void onFailure(Throwable t) {\n             if (notified.compareAndSet(false, true)) {\n                 mdLock.release();\n-                if (future != null) {\n-                    future.cancel(false);\n-                }\n                 listener.onFailure(t);\n             }\n         }\ndiff --git a/src/main/java/org/elasticsearch/indices/cluster/IndicesClusterStateService.java b/src/main/java/org/elasticsearch/indices/cluster/IndicesClusterStateService.java\nindex d559b94..c9a7fb8 100644\n--- a/src/main/java/org/elasticsearch/indices/cluster/IndicesClusterStateService.java\n+++ b/src/main/java/org/elasticsearch/indices/cluster/IndicesClusterStateService.java\n@@ -28,7 +28,6 @@ import org.elasticsearch.ExceptionsHelper;\n import org.elasticsearch.cluster.ClusterChangedEvent;\n import org.elasticsearch.cluster.ClusterService;\n import org.elasticsearch.cluster.ClusterStateListener;\n-import org.elasticsearch.cluster.action.index.NodeIndexCreatedAction;\n import org.elasticsearch.cluster.action.index.NodeIndexDeletedAction;\n import org.elasticsearch.cluster.action.index.NodeMappingRefreshAction;\n import org.elasticsearch.cluster.action.shard.ShardStateAction;\n@@ -86,7 +85,6 @@ public class IndicesClusterStateService extends AbstractLifecycleComponent<Indic\n     private final ThreadPool threadPool;\n     private final RecoveryTarget recoveryTarget;\n     private final ShardStateAction shardStateAction;\n-    private final NodeIndexCreatedAction nodeIndexCreatedAction;\n     private final NodeIndexDeletedAction nodeIndexDeletedAction;\n     private final NodeMappingRefreshAction nodeMappingRefreshAction;\n \n@@ -117,7 +115,7 @@ public class IndicesClusterStateService extends AbstractLifecycleComponent<Indic\n     public IndicesClusterStateService(Settings settings, IndicesService indicesService, ClusterService clusterService,\n                                       ThreadPool threadPool, RecoveryTarget recoveryTarget,\n                                       ShardStateAction shardStateAction,\n-                                      NodeIndexCreatedAction nodeIndexCreatedAction, NodeIndexDeletedAction nodeIndexDeletedAction,\n+                                      NodeIndexDeletedAction nodeIndexDeletedAction,\n                                       NodeMappingRefreshAction nodeMappingRefreshAction) {\n         super(settings);\n         this.indicesService = indicesService;\n@@ -125,7 +123,6 @@ public class IndicesClusterStateService extends AbstractLifecycleComponent<Indic\n         this.threadPool = threadPool;\n         this.recoveryTarget = recoveryTarget;\n         this.shardStateAction = shardStateAction;\n-        this.nodeIndexCreatedAction = nodeIndexCreatedAction;\n         this.nodeIndexDeletedAction = nodeIndexDeletedAction;\n         this.nodeMappingRefreshAction = nodeMappingRefreshAction;\n \n@@ -193,13 +190,7 @@ public class IndicesClusterStateService extends AbstractLifecycleComponent<Indic\n     private void sendIndexLifecycleEvents(final ClusterChangedEvent event) {\n         String localNodeId = event.state().nodes().localNodeId();\n         assert localNodeId != null;\n-        for (String index : event.indicesCreated()) {\n-            try {\n-                nodeIndexCreatedAction.nodeIndexCreated(event.state(), index, localNodeId);\n-            } catch (Throwable e) {\n-                logger.debug(\"failed to send to master index {} created event\", e, index);\n-            }\n-        }\n+        // No need to send index created events anymore - the ack mechanism handles this\n         for (String index : event.indicesDeleted()) {\n             try {\n                 nodeIndexDeletedAction.nodeIndexDeleted(event.state(), index, localNodeId);",
  "logs_path": "factory/glm-4.6/24634b85/elastic_elasticsearch_pr4422/logs.jsonl",
  "errors": [],
  "edit_run_id": "24634b85",
  "test_label": null
}