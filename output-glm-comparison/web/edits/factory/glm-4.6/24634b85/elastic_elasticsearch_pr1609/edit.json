{
  "repo_url": "https://github.com/elastic/elasticsearch.git",
  "pr_number": 1609,
  "base_commit": "0530115f62fc2128196fc0f3e39af4d4d1a2aea5",
  "runner": "factory",
  "model": "glm-4.6",
  "timeout_s": 1800,
  "status": "success",
  "elapsed_ms": 124657,
  "patch_unified": "diff --git a/src/main/java/org/elasticsearch/action/update/TransportUpdateAction.java b/src/main/java/org/elasticsearch/action/update/TransportUpdateAction.java\nindex ae9eea7..ae791e6 100644\n--- a/src/main/java/org/elasticsearch/action/update/TransportUpdateAction.java\n+++ b/src/main/java/org/elasticsearch/action/update/TransportUpdateAction.java\n@@ -216,12 +216,16 @@ public class TransportUpdateAction extends TransportInstanceSingleOperationActio\n             IndexRequest indexRequest = Requests.indexRequest(request.index()).type(request.type()).id(request.id()).routing(routing).parent(parent)\n                     .source(source, sourceAndContent.v1())\n                     .version(getResult.version()).replicationType(request.replicationType()).consistencyLevel(request.consistencyLevel())\n-                    .timestamp(timestamp).ttl(ttl);\n+                    .timestamp(timestamp).ttl(ttl).percolate(request.percolate());\n             indexRequest.operationThreaded(false);\n             indexAction.execute(indexRequest, new ActionListener<IndexResponse>() {\n                 @Override\n                 public void onResponse(IndexResponse response) {\n                     UpdateResponse update = new UpdateResponse(response.index(), response.type(), response.id(), response.version());\n+                    // Transfer percolation matches if any\n+                    if (response.matches() != null) {\n+                        update.matches(response.matches());\n+                    }\n                     listener.onResponse(update);\n                 }\n \ndiff --git a/src/main/java/org/elasticsearch/action/update/UpdateRequest.java b/src/main/java/org/elasticsearch/action/update/UpdateRequest.java\nindex 05e39ce..6032058 100644\n--- a/src/main/java/org/elasticsearch/action/update/UpdateRequest.java\n+++ b/src/main/java/org/elasticsearch/action/update/UpdateRequest.java\n@@ -54,6 +54,8 @@ public class UpdateRequest extends InstanceShardOperationRequest {\n     private ReplicationType replicationType = ReplicationType.DEFAULT;\n     private WriteConsistencyLevel consistencyLevel = WriteConsistencyLevel.DEFAULT;\n \n+    String percolate;\n+\n     UpdateRequest() {\n \n     }\n@@ -281,6 +283,20 @@ public class UpdateRequest extends InstanceShardOperationRequest {\n         return this;\n     }\n \n+    /**\n+     * Causes the update request document to be percolated. The parameter is the percolate query\n+     * to use to reduce the percolated queries that are going to run against this doc. Can be\n+     * set to <tt>*</tt> to indicate that all percolate queries should be run.\n+     */\n+    public UpdateRequest percolate(String percolate) {\n+        this.percolate = percolate;\n+        return this;\n+    }\n+\n+    public String percolate() {\n+        return this.percolate;\n+    }\n+\n     @Override\n     public void readFrom(StreamInput in) throws IOException {\n         super.readFrom(in);\n@@ -297,6 +313,9 @@ public class UpdateRequest extends InstanceShardOperationRequest {\n         }\n         scriptParams = in.readMap();\n         retryOnConflict = in.readVInt();\n+        if (in.readBoolean()) {\n+            percolate = in.readUTF();\n+        }\n     }\n \n     @Override\n@@ -321,5 +340,11 @@ public class UpdateRequest extends InstanceShardOperationRequest {\n         }\n         out.writeMap(scriptParams);\n         out.writeVInt(retryOnConflict);\n+        if (percolate == null) {\n+            out.writeBoolean(false);\n+        } else {\n+            out.writeBoolean(true);\n+            out.writeUTF(percolate);\n+        }\n     }\n }\ndiff --git a/src/main/java/org/elasticsearch/action/update/UpdateResponse.java b/src/main/java/org/elasticsearch/action/update/UpdateResponse.java\nindex f4a41dd..3cb6efd 100644\n--- a/src/main/java/org/elasticsearch/action/update/UpdateResponse.java\n+++ b/src/main/java/org/elasticsearch/action/update/UpdateResponse.java\n@@ -19,11 +19,14 @@\n \n package org.elasticsearch.action.update;\n \n+import com.google.common.collect.ImmutableList;\n import org.elasticsearch.action.ActionResponse;\n import org.elasticsearch.common.io.stream.StreamInput;\n import org.elasticsearch.common.io.stream.StreamOutput;\n \n import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.List;\n \n /**\n  */\n@@ -37,6 +40,8 @@ public class UpdateResponse implements ActionResponse {\n \n     private long version;\n \n+    private List<String> matches;\n+\n     public UpdateResponse() {\n \n     }\n@@ -104,12 +109,54 @@ public class UpdateResponse implements ActionResponse {\n         return version();\n     }\n \n+    /**\n+     * Returns the percolate queries matches. <tt>null</tt> if no percolation was requested.\n+     */\n+    public List<String> matches() {\n+        return this.matches;\n+    }\n+\n+    /**\n+     * Returns the percolate queries matches. <tt>null</tt> if no percolation was requested.\n+     */\n+    public List<String> getMatches() {\n+        return this.matches;\n+    }\n+\n+    /**\n+     * Internal.\n+     */\n+    public void matches(List<String> matches) {\n+        this.matches = matches;\n+    }\n+\n     @Override\n     public void readFrom(StreamInput in) throws IOException {\n         index = in.readUTF();\n         id = in.readUTF();\n         type = in.readUTF();\n         version = in.readLong();\n+        if (in.readBoolean()) {\n+            int size = in.readVInt();\n+            if (size == 0) {\n+                matches = ImmutableList.of();\n+            } else if (size == 1) {\n+                matches = ImmutableList.of(in.readUTF());\n+            } else if (size == 2) {\n+                matches = ImmutableList.of(in.readUTF(), in.readUTF());\n+            } else if (size == 3) {\n+                matches = ImmutableList.of(in.readUTF(), in.readUTF(), in.readUTF());\n+            } else if (size == 4) {\n+                matches = ImmutableList.of(in.readUTF(), in.readUTF(), in.readUTF(), in.readUTF());\n+            } else if (size == 5) {\n+                matches = ImmutableList.of(in.readUTF(), in.readUTF(), in.readUTF(), in.readUTF(), in.readUTF());\n+            } else {\n+                matches = new ArrayList<String>();\n+                for (int i = 0; i < size; i++) {\n+                    matches.add(in.readUTF());\n+                }\n+            }\n+        }\n     }\n \n     @Override\n@@ -118,5 +165,14 @@ public class UpdateResponse implements ActionResponse {\n         out.writeUTF(id);\n         out.writeUTF(type);\n         out.writeLong(version);\n+        if (matches == null) {\n+            out.writeBoolean(false);\n+        } else {\n+            out.writeBoolean(true);\n+            out.writeVInt(matches.size());\n+            for (String match : matches) {\n+                out.writeUTF(match);\n+            }\n+        }\n     }\n }\ndiff --git a/src/main/java/org/elasticsearch/rest/action/update/RestUpdateAction.java b/src/main/java/org/elasticsearch/rest/action/update/RestUpdateAction.java\nindex e6bef60..7d30da4 100644\n--- a/src/main/java/org/elasticsearch/rest/action/update/RestUpdateAction.java\n+++ b/src/main/java/org/elasticsearch/rest/action/update/RestUpdateAction.java\n@@ -75,6 +75,7 @@ public class RestUpdateAction extends BaseRestHandler {\n             }\n         }\n         updateRequest.retryOnConflict(request.paramAsInt(\"retry_on_conflict\", updateRequest.retryOnConflict()));\n+        updateRequest.percolate(request.param(\"percolate\"));\n \n         // see if we have it in the body\n         if (request.hasContent()) {\n@@ -92,6 +93,9 @@ public class RestUpdateAction extends BaseRestHandler {\n                     if (content.containsKey(\"params\")) {\n                         updateRequest.scriptParams((Map<String, Object>) content.get(\"params\"));\n                     }\n+                    if (content.containsKey(\"percolate\")) {\n+                        updateRequest.percolate(content.get(\"percolate\").toString());\n+                    }\n                 } catch (Exception e) {\n                     try {\n                         channel.sendResponse(new XContentThrowableRestResponse(request, e));\n@@ -114,6 +118,9 @@ public class RestUpdateAction extends BaseRestHandler {\n                             .field(Fields._TYPE, response.type())\n                             .field(Fields._ID, response.id())\n                             .field(Fields._VERSION, response.version());\n+                    if (response.getMatches() != null) {\n+                        builder.field(Fields._MATCHES, response.getMatches());\n+                    }\n                     builder.endObject();\n                     RestStatus status = OK;\n                     if (response.version() == 1) {\n@@ -142,5 +149,6 @@ public class RestUpdateAction extends BaseRestHandler {\n         static final XContentBuilderString _TYPE = new XContentBuilderString(\"_type\");\n         static final XContentBuilderString _ID = new XContentBuilderString(\"_id\");\n         static final XContentBuilderString _VERSION = new XContentBuilderString(\"_version\");\n+        static final XContentBuilderString _MATCHES = new XContentBuilderString(\"_matches\");\n     }\n }",
  "logs_path": "factory/glm-4.6/24634b85/elastic_elasticsearch_pr1609/logs.jsonl",
  "errors": [],
  "edit_run_id": "24634b85",
  "test_label": null
}