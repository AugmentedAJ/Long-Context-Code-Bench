{
  "repo_url": "https://github.com/elastic/elasticsearch.git",
  "pr_number": 1609,
  "base_commit": "0530115f62fc2128196fc0f3e39af4d4d1a2aea5",
  "runner": "factory",
  "model": "mcp:glm-4.6",
  "timeout_s": 1800,
  "status": "success",
  "elapsed_ms": 700424,
  "patch_unified": "diff --git a/src/main/java/org/elasticsearch/action/update/TransportUpdateAction.java b/src/main/java/org/elasticsearch/action/update/TransportUpdateAction.java\nindex ae9eea7..32c2eb5 100644\n--- a/src/main/java/org/elasticsearch/action/update/TransportUpdateAction.java\n+++ b/src/main/java/org/elasticsearch/action/update/TransportUpdateAction.java\n@@ -43,6 +43,7 @@ import org.elasticsearch.cluster.routing.ShardRouting;\n import org.elasticsearch.common.collect.Tuple;\n import org.elasticsearch.common.inject.Inject;\n import org.elasticsearch.common.settings.Settings;\n+import org.elasticsearch.common.strings.Strings;\n import org.elasticsearch.common.unit.TimeValue;\n import org.elasticsearch.common.xcontent.XContentHelper;\n import org.elasticsearch.common.xcontent.XContentType;\n@@ -50,10 +51,12 @@ import org.elasticsearch.index.engine.DocumentMissingException;\n import org.elasticsearch.index.engine.DocumentSourceMissingException;\n import org.elasticsearch.index.engine.VersionConflictEngineException;\n import org.elasticsearch.index.get.GetResult;\n+import org.elasticsearch.index.mapper.ParsedDocument;\n import org.elasticsearch.index.mapper.internal.ParentFieldMapper;\n import org.elasticsearch.index.mapper.internal.RoutingFieldMapper;\n import org.elasticsearch.index.mapper.internal.SourceFieldMapper;\n import org.elasticsearch.index.mapper.internal.TTLFieldMapper;\n+import org.elasticsearch.index.percolator.PercolatorExecutor;\n import org.elasticsearch.index.service.IndexService;\n import org.elasticsearch.index.shard.IllegalIndexShardStateException;\n import org.elasticsearch.index.shard.ShardId;\n@@ -208,20 +211,32 @@ public class TransportUpdateAction extends TransportInstanceSingleOperationActio\n             }\n         }\n \n-        // TODO percolate?\n-\n-        // TODO: external version type, does it make sense here? does not seem like it...\n+        // handle percolation\n+        boolean shouldPercolate = Strings.hasLength(request.percolate());\n+        ParsedDocument parsedDoc = null;\n+        \n+        // apply script to update the source\n+        String routing = getResult.fields().containsKey(RoutingFieldMapper.NAME) ? getResult.field(RoutingFieldMapper.NAME).value().toString() : null;\n+        String parent = getResult.fields().containsKey(ParentFieldMapper.NAME) ? getResult.field(ParentFieldMapper.NAME).value().toString() : null;\n+        // No TTL has been given in the update script so we keep previous TTL value if there is one\n+        if (ttl == null) {\n+            ttl = getResult.fields().containsKey(TTLFieldMapper.NAME) ? (Long) getResult.field(TTLFieldMapper.NAME).value() : null;\n+            if (ttl != null) {\n+                ttl = ttl - (System.currentTimeMillis() - getDate); // It is an approximation of exact TTL value, could be improved\n+            }\n+        }\n \n         if (operation == null || \"index\".equals(operation)) {\n             IndexRequest indexRequest = Requests.indexRequest(request.index()).type(request.type()).id(request.id()).routing(routing).parent(parent)\n                     .source(source, sourceAndContent.v1())\n                     .version(getResult.version()).replicationType(request.replicationType()).consistencyLevel(request.consistencyLevel())\n-                    .timestamp(timestamp).ttl(ttl);\n+                    .timestamp(timestamp).ttl(ttl).percolate(request.percolate());\n             indexRequest.operationThreaded(false);\n             indexAction.execute(indexRequest, new ActionListener<IndexResponse>() {\n                 @Override\n                 public void onResponse(IndexResponse response) {\n                     UpdateResponse update = new UpdateResponse(response.index(), response.type(), response.id(), response.version());\n+                    update.matches(response.matches());\n                     listener.onResponse(update);\n                 }\n \n@@ -250,6 +265,7 @@ public class TransportUpdateAction extends TransportInstanceSingleOperationActio\n                 @Override\n                 public void onResponse(DeleteResponse response) {\n                     UpdateResponse update = new UpdateResponse(response.index(), response.type(), response.id(), response.version());\n+                    // No percolation matches for delete operation\n                     listener.onResponse(update);\n                 }\n \n@@ -271,10 +287,14 @@ public class TransportUpdateAction extends TransportInstanceSingleOperationActio\n                 }\n             });\n         } else if (\"none\".equals(operation)) {\n-            listener.onResponse(new UpdateResponse(getResult.index(), getResult.type(), getResult.id(), getResult.version()));\n+            UpdateResponse update = new UpdateResponse(getResult.index(), getResult.type(), getResult.id(), getResult.version());\n+            // No percolation matches for none operation\n+            listener.onResponse(update);\n         } else {\n             logger.warn(\"Used update operation [{}] for script [{}], doing nothing...\", operation, request.script);\n-            listener.onResponse(new UpdateResponse(getResult.index(), getResult.type(), getResult.id(), getResult.version()));\n+            UpdateResponse update = new UpdateResponse(getResult.index(), getResult.type(), getResult.id(), getResult.version());\n+            // No percolation matches for unknown operation\n+            listener.onResponse(update);\n         }\n     }\n }\ndiff --git a/src/main/java/org/elasticsearch/action/update/UpdateRequest.java b/src/main/java/org/elasticsearch/action/update/UpdateRequest.java\nindex 05e39ce..47167e2 100644\n--- a/src/main/java/org/elasticsearch/action/update/UpdateRequest.java\n+++ b/src/main/java/org/elasticsearch/action/update/UpdateRequest.java\n@@ -53,15 +53,18 @@ public class UpdateRequest extends InstanceShardOperationRequest {\n \n     private ReplicationType replicationType = ReplicationType.DEFAULT;\n     private WriteConsistencyLevel consistencyLevel = WriteConsistencyLevel.DEFAULT;\n+    \n+    private String percolate;\n \n     UpdateRequest() {\n-\n+        this.percolate = null;\n     }\n \n     public UpdateRequest(String index, String type, String id) {\n         this.index = index;\n         this.type = type;\n         this.id = id;\n+        this.percolate = null;\n     }\n \n     @Override\n@@ -281,6 +284,23 @@ public class UpdateRequest extends InstanceShardOperationRequest {\n         return this;\n     }\n \n+    /**\n+     * Causes the update request document to be percolated. The parameter is the percolate query\n+     * to use to reduce the percolated queries that are going to run against this doc. Can be\n+     * set to <tt>*</tt> to indicate that all percolate queries should be run.\n+     */\n+    public UpdateRequest percolate(String percolate) {\n+        this.percolate = percolate;\n+        return this;\n+    }\n+\n+    /**\n+     * The percolate query to run against this document.\n+     */\n+    public String percolate() {\n+        return this.percolate;\n+    }\n+\n     @Override\n     public void readFrom(StreamInput in) throws IOException {\n         super.readFrom(in);\n@@ -297,6 +317,11 @@ public class UpdateRequest extends InstanceShardOperationRequest {\n         }\n         scriptParams = in.readMap();\n         retryOnConflict = in.readVInt();\n+        if (in.readBoolean()) {\n+            percolate = in.readUTF();\n+        } else {\n+            percolate = null;\n+        }\n     }\n \n     @Override\n@@ -321,5 +346,11 @@ public class UpdateRequest extends InstanceShardOperationRequest {\n         }\n         out.writeMap(scriptParams);\n         out.writeVInt(retryOnConflict);\n+        if (percolate == null) {\n+            out.writeBoolean(false);\n+        } else {\n+            out.writeBoolean(true);\n+            out.writeUTF(percolate);\n+        }\n     }\n }\ndiff --git a/src/main/java/org/elasticsearch/action/update/UpdateResponse.java b/src/main/java/org/elasticsearch/action/update/UpdateResponse.java\nindex f4a41dd..f2e6dc3 100644\n--- a/src/main/java/org/elasticsearch/action/update/UpdateResponse.java\n+++ b/src/main/java/org/elasticsearch/action/update/UpdateResponse.java\n@@ -19,11 +19,15 @@\n \n package org.elasticsearch.action.update;\n \n+import com.google.common.collect.ImmutableList;\n+import com.google.common.collect.Lists;\n import org.elasticsearch.action.ActionResponse;\n import org.elasticsearch.common.io.stream.StreamInput;\n import org.elasticsearch.common.io.stream.StreamOutput;\n \n import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.List;\n \n /**\n  */\n@@ -37,8 +41,10 @@ public class UpdateResponse implements ActionResponse {\n \n     private long version;\n \n-    public UpdateResponse() {\n+    private List<String> matches;\n \n+    public UpdateResponse() {\n+        this.matches = null;\n     }\n \n     public UpdateResponse(String index, String type, String id, long version) {\n@@ -104,12 +110,50 @@ public class UpdateResponse implements ActionResponse {\n         return version();\n     }\n \n+    /**\n+     * Returns the percolate queries matches. <tt>null</tt> if no percolation was requested.\n+     */\n+    public List<String> matches() {\n+        return this.matches;\n+    }\n+\n+    /**\n+     * Returns the percolate queries matches. <tt>null</tt> if no percolation was requested.\n+     */\n+    public List<String> getMatches() {\n+        return this.matches;\n+    }\n+\n+    public void matches(List<String> matches) {\n+        this.matches = matches;\n+    }\n+\n     @Override\n     public void readFrom(StreamInput in) throws IOException {\n         index = in.readUTF();\n         id = in.readUTF();\n         type = in.readUTF();\n         version = in.readLong();\n+        int size = in.readVInt();\n+        if (size == 0) {\n+            matches = ImmutableList.of();\n+        } else if (size == 1) {\n+            matches = ImmutableList.of(in.readUTF());\n+        } else if (size == 2) {\n+            matches = ImmutableList.of(in.readUTF(), in.readUTF());\n+        } else if (size == 3) {\n+            matches = ImmutableList.of(in.readUTF(), in.readUTF(), in.readUTF());\n+        } else if (size == 4) {\n+            matches = ImmutableList.of(in.readUTF(), in.readUTF(), in.readUTF(), in.readUTF());\n+        } else if (size == 5) {\n+            matches = ImmutableList.of(in.readUTF(), in.readUTF(), in.readUTF(), in.readUTF(), in.readUTF());\n+        } else {\n+            String[] tmpMatches = new String[size];\n+            for (int i = 0; i < size; i++) {\n+                tmpMatches[i] = in.readUTF();\n+            }\n+            matches = ImmutableList.copyOf(tmpMatches);\n+        }\n     }\n \n     @Override\n@@ -118,5 +162,13 @@ public class UpdateResponse implements ActionResponse {\n         out.writeUTF(id);\n         out.writeUTF(type);\n         out.writeLong(version);\n+        if (matches == null) {\n+            out.writeVInt(0);\n+        } else {\n+            out.writeVInt(matches.size());\n+            for (String match : matches) {\n+                out.writeUTF(match);\n+            }\n+        }\n     }\n }\ndiff --git a/src/main/java/org/elasticsearch/client/action/update/UpdateRequestBuilder.java b/src/main/java/org/elasticsearch/client/action/update/UpdateRequestBuilder.java\nindex dd5c4e3..1482bad 100644\n--- a/src/main/java/org/elasticsearch/client/action/update/UpdateRequestBuilder.java\n+++ b/src/main/java/org/elasticsearch/client/action/update/UpdateRequestBuilder.java\n@@ -150,6 +150,16 @@ public class UpdateRequestBuilder extends BaseRequestBuilder<UpdateRequest, Upda\n         return this;\n     }\n \n+    /**\n+     * Causes the update request document to be percolated. The parameter is the percolate query\n+     * to use to reduce the percolated queries that are going to run against this doc. Can be\n+     * set to <tt>*</tt> to indicate that all percolate queries should be run.\n+     */\n+    public UpdateRequestBuilder setPercolate(String percolate) {\n+        request.percolate(percolate);\n+        return this;\n+    }\n+\n     @Override\n     protected void doExecute(ActionListener<UpdateResponse> listener) {\n         client.update(request, listener);\ndiff --git a/src/main/java/org/elasticsearch/rest/action/update/RestUpdateAction.java b/src/main/java/org/elasticsearch/rest/action/update/RestUpdateAction.java\nindex e6bef60..5a6dcab 100644\n--- a/src/main/java/org/elasticsearch/rest/action/update/RestUpdateAction.java\n+++ b/src/main/java/org/elasticsearch/rest/action/update/RestUpdateAction.java\n@@ -75,6 +75,7 @@ public class RestUpdateAction extends BaseRestHandler {\n             }\n         }\n         updateRequest.retryOnConflict(request.paramAsInt(\"retry_on_conflict\", updateRequest.retryOnConflict()));\n+        updateRequest.percolate(request.param(\"percolate\"));\n \n         // see if we have it in the body\n         if (request.hasContent()) {\n@@ -92,6 +93,9 @@ public class RestUpdateAction extends BaseRestHandler {\n                     if (content.containsKey(\"params\")) {\n                         updateRequest.scriptParams((Map<String, Object>) content.get(\"params\"));\n                     }\n+                    if (content.containsKey(\"percolate\")) {\n+                        updateRequest.percolate(content.get(\"percolate\").toString());\n+                    }\n                 } catch (Exception e) {\n                     try {\n                         channel.sendResponse(new XContentThrowableRestResponse(request, e));\n@@ -114,6 +118,9 @@ public class RestUpdateAction extends BaseRestHandler {\n                             .field(Fields._TYPE, response.type())\n                             .field(Fields._ID, response.id())\n                             .field(Fields._VERSION, response.version());\n+                    if (response.matches() != null && !response.matches().isEmpty()) {\n+                        builder.field(Fields.MATCHES, response.matches());\n+                    }\n                     builder.endObject();\n                     RestStatus status = OK;\n                     if (response.version() == 1) {\n@@ -142,5 +149,6 @@ public class RestUpdateAction extends BaseRestHandler {\n         static final XContentBuilderString _TYPE = new XContentBuilderString(\"_type\");\n         static final XContentBuilderString _ID = new XContentBuilderString(\"_id\");\n         static final XContentBuilderString _VERSION = new XContentBuilderString(\"_version\");\n+        static final XContentBuilderString MATCHES = new XContentBuilderString(\"matches\");\n     }\n }",
  "logs_path": "factory/mcp:glm-4.6/6bf04592/elastic_elasticsearch_pr1609/logs.jsonl",
  "errors": [],
  "edit_run_id": "6bf04592",
  "test_label": "v1-mcp"
}