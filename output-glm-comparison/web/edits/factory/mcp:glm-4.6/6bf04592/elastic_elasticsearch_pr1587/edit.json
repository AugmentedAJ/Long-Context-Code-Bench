{
  "repo_url": "https://github.com/elastic/elasticsearch.git",
  "pr_number": 1587,
  "base_commit": "df4a3bfd379fd90b3667bbcd7ca2ed4619fee025",
  "runner": "factory",
  "model": "mcp:glm-4.6",
  "timeout_s": 1800,
  "status": "success",
  "elapsed_ms": 398192,
  "patch_unified": "diff --git a/src/test/java/org/elasticsearch/test/integration/ttl/SimpleTTLTests.java b/src/test/java/org/elasticsearch/test/integration/ttl/SimpleTTLTests.java\nindex 89f4ab7..1fa700d 100644\n--- a/src/test/java/org/elasticsearch/test/integration/ttl/SimpleTTLTests.java\n+++ b/src/test/java/org/elasticsearch/test/integration/ttl/SimpleTTLTests.java\n@@ -20,6 +20,7 @@\n package org.elasticsearch.test.integration.ttl;\n \n import org.elasticsearch.action.get.GetResponse;\n+import org.elasticsearch.action.search.SearchResponse;\n import org.elasticsearch.client.Client;\n import org.elasticsearch.common.settings.Settings;\n import org.elasticsearch.common.xcontent.XContentFactory;\n@@ -29,6 +30,9 @@ import org.testng.annotations.BeforeClass;\n import org.testng.annotations.Test;\n \n import static org.elasticsearch.common.settings.ImmutableSettings.settingsBuilder;\n+import static org.elasticsearch.common.xcontent.XContentFactory.jsonBuilder;\n+import static org.elasticsearch.index.query.QueryBuilders.matchAllQuery;\n+import static org.elasticsearch.index.query.QueryBuilders.termQuery;\n import static org.hamcrest.MatcherAssert.assertThat;\n import static org.hamcrest.Matchers.*;\n \n@@ -119,4 +123,272 @@ public class SimpleTTLTests extends AbstractNodesTests {\n         getResponse = client.prepareGet(\"test\", \"type1\", \"1\").setFields(\"_ttl\").setRealtime(false).execute().actionGet();\n         assertThat(getResponse.exists(), equalTo(false));\n     }\n+\n+    /**\n+     * Test TTL functionality with custom routing across multiple shards.\n+     * This ensures that TTL purger correctly preserves routing information\n+     * when deleting expired documents.\n+     */\n+    @Test\n+    public void testTTLWithCustomRouting() throws Exception {\n+        client.admin().indices().prepareDelete(\"test_routing\").execute().actionGet();\n+\n+        // Create index with multiple shards to ensure documents can be distributed\n+        client.admin().indices().prepareCreate(\"test_routing\")\n+                .setSettings(settingsBuilder()\n+                        .put(\"number_of_shards\", 3)\n+                        .put(\"number_of_replicas\", 1)\n+                        .put(\"routing.hash.type\", \"simple\"))\n+                .addMapping(\"type1\", XContentFactory.jsonBuilder()\n+                        .startObject()\n+                        .startObject(\"type1\")\n+                        .startObject(\"_timestamp\").field(\"enabled\", true).field(\"store\", \"yes\").endObject()\n+                        .startObject(\"_ttl\").field(\"enabled\", true).field(\"store\", \"yes\").endObject()\n+                        .endObject()\n+                        .endObject())\n+                .execute().actionGet();\n+        \n+        client.admin().cluster().prepareHealth().setWaitForGreenStatus().execute().actionGet();\n+\n+        long ttlValue = 3000;\n+        String[] routingValues = {\"user1\", \"user2\", \"user3\"};\n+        String[] documentIds = {\"doc1\", \"doc2\", \"doc3\"};\n+\n+        logger.info(\"--> indexing documents with custom routing\");\n+        // Index documents with different routing values to distribute across shards\n+        for (int i = 0; i < routingValues.length; i++) {\n+            client.prepareIndex(\"test_routing\", \"type1\", documentIds[i])\n+                    .setSource(jsonBuilder()\n+                            .startObject()\n+                            .field(\"user\", routingValues[i])\n+                            .field(\"message\", \"Test message for \" + routingValues[i])\n+                            .field(\"timestamp\", System.currentTimeMillis())\n+                            .endObject())\n+                    .setTTL(ttlValue)\n+                    .setRouting(routingValues[i])\n+                    .setRefresh(true)\n+                    .execute()\n+                    .actionGet();\n+        }\n+\n+        logger.info(\"--> verifying documents exist with routing\");\n+        // Verify all documents exist and their routing is preserved\n+        for (int i = 0; i < routingValues.length; i++) {\n+            String docId = documentIds[i];\n+            String routing = routingValues[i];\n+            \n+            GetResponse getResponse = client.prepareGet(\"test_routing\", \"type1\", docId)\n+                    .setFields(\"_ttl\", \"_routing\")\n+                    .setRouting(routing)\n+                    .execute()\n+                    .actionGet();\n+            \n+            assertThat(\"Document \" + docId + \" should exist\", getResponse.exists(), equalTo(true));\n+            assertThat(\"Document \" + docId + \" should have TTL field\", getResponse.field(\"_ttl\"), notNullValue());\n+            assertThat(\"Document \" + docId + \" should have correct routing\", \n+                      getResponse.field(\"_routing\").value(), equalTo(routing));\n+        }\n+\n+        // Verify documents are distributed across the index\n+        SearchResponse searchResponse = client.prepareSearch(\"test_routing\")\n+                .setQuery(matchAllQuery())\n+                .execute()\n+                .actionGet();\n+        assertThat(\"All documents should be found\", searchResponse.getHits().totalHits(), equalTo((long) routingValues.length));\n+\n+        logger.info(\"--> waiting for TTL expiration\");\n+        // Wait for documents to expire\n+        long expirationTime = System.currentTimeMillis() + ttlValue + purgeInterval + 2000;\n+        long currentTime = System.currentTimeMillis();\n+        if (expirationTime - currentTime > 0) {\n+            Thread.sleep(expirationTime - currentTime);\n+        }\n+\n+        logger.info(\"--> verifying documents have expired with routing\");\n+        // Verify all documents have expired, using their respective routing values\n+        for (int i = 0; i < routingValues.length; i++) {\n+            String docId = documentIds[i];\n+            String routing = routingValues[i];\n+            \n+            GetResponse getResponse = client.prepareGet(\"test_routing\", \"type1\", docId)\n+                    .setRouting(routing)\n+                    .execute()\n+                    .actionGet();\n+            \n+            assertThat(\"Document \" + docId + \" with routing \" + routing + \" should have expired\", \n+                      getResponse.exists(), equalTo(false));\n+        }\n+\n+        // Verify no documents remain via search\n+        searchResponse = client.prepareSearch(\"test_routing\")\n+                .setQuery(matchAllQuery())\n+                .execute()\n+                .actionGet();\n+        assertThat(\"All routed documents should have been purged\", \n+                  searchResponse.getHits().totalHits(), equalTo(0L));\n+    }\n+\n+    /**\n+     * Test TTL behavior when multiple documents share the same routing value.\n+     * This ensures the TTL purger handles multiple documents with the same routing correctly.\n+     */\n+    @Test\n+    public void testTTLWithSameRoutingMultipleDocuments() throws Exception {\n+        client.admin().indices().prepareDelete(\"test_same_routing\").execute().actionGet();\n+\n+        client.admin().indices().prepareCreate(\"test_same_routing\")\n+                .setSettings(settingsBuilder()\n+                        .put(\"number_of_shards\", 2)\n+                        .put(\"number_of_replicas\", 1))\n+                .addMapping(\"type1\", XContentFactory.jsonBuilder()\n+                        .startObject()\n+                        .startObject(\"type1\")\n+                        .startObject(\"_timestamp\").field(\"enabled\", true).field(\"store\", \"yes\").endObject()\n+                        .startObject(\"_ttl\").field(\"enabled\", true).field(\"store\", \"yes\").endObject()\n+                        .endObject()\n+                        .endObject())\n+                .execute().actionGet();\n+        \n+        client.admin().cluster().prepareHealth().setWaitForGreenStatus().execute().actionGet();\n+\n+        String routingValue = \"same_user\";\n+        long ttlValue = 2500;\n+        int numDocs = 5;\n+\n+        logger.info(\"--> indexing multiple documents with same routing\");\n+        // Index multiple documents with the same routing value\n+        for (int i = 0; i < numDocs; i++) {\n+            client.prepareIndex(\"test_same_routing\", \"type1\", \"doc\" + i)\n+                    .setSource(jsonBuilder()\n+                            .startObject()\n+                            .field(\"user\", routingValue)\n+                            .field(\"message\", \"Message \" + i)\n+                            .field(\"order\", i)\n+                            .endObject())\n+                    .setTTL(ttlValue)\n+                    .setRouting(routingValue)\n+                    .setRefresh(true)\n+                    .execute()\n+                    .actionGet();\n+        }\n+\n+        // Verify all documents exist\n+        SearchResponse searchResponse = client.prepareSearch(\"test_same_routing\")\n+                .setQuery(termQuery(\"user\", routingValue))\n+                .execute()\n+                .actionGet();\n+        assertThat(\"All documents with same routing should be found\", \n+                  searchResponse.getHits().totalHits(), equalTo((long) numDocs));\n+\n+        logger.info(\"--> waiting for TTL expiration for same routing documents\");\n+        // Wait for expiration\n+        long expirationTime = System.currentTimeMillis() + ttlValue + purgeInterval + 1000;\n+        long currentTime = System.currentTimeMillis();\n+        if (expirationTime - currentTime > 0) {\n+            Thread.sleep(expirationTime - currentTime);\n+        }\n+\n+        // Verify all documents with the same routing have expired\n+        searchResponse = client.prepareSearch(\"test_same_routing\")\n+                .setQuery(termQuery(\"user\", routingValue))\n+                .execute()\n+                .actionGet();\n+        assertThat(\"All documents with routing \" + routingValue + \" should have expired\", \n+                  searchResponse.getHits().totalHits(), equalTo(0L));\n+    }\n+\n+    /**\n+     * Test TTL with mixed scenarios - some documents with routing, some without.\n+     * This ensures TTL works correctly regardless of whether routing is used.\n+     */\n+    @Test\n+    public void testTTLWithMixedRouting() throws Exception {\n+        client.admin().indices().prepareDelete(\"test_mixed_routing\").execute().actionGet();\n+\n+        client.admin().indices().prepareCreate(\"test_mixed_routing\")\n+                .setSettings(settingsBuilder()\n+                        .put(\"number_of_shards\", 3)\n+                        .put(\"number_of_replicas\", 1))\n+                .addMapping(\"type1\", XContentFactory.jsonBuilder()\n+                        .startObject()\n+                        .startObject(\"type1\")\n+                        .startObject(\"_timestamp\").field(\"enabled\", true).field(\"store\", \"yes\").endObject()\n+                        .startObject(\"_ttl\").field(\"enabled\", true).field(\"store\", \"yes\").endObject()\n+                        .endObject()\n+                        .endObject())\n+                .execute().actionGet();\n+        \n+        client.admin().cluster().prepareHealth().setWaitForGreenStatus().execute().actionGet();\n+\n+        long ttlValue = 2000;\n+\n+        logger.info(\"--> indexing documents with mixed routing\");\n+        // Index documents with routing\n+        for (int i = 0; i < 3; i++) {\n+            String routing = \"user_\" + i;\n+            client.prepareIndex(\"test_mixed_routing\", \"type1\", \"routed_doc_\" + i)\n+                    .setSource(jsonBuilder()\n+                            .startObject()\n+                            .field(\"type\", \"routed\")\n+                            .field(\"user\", routing)\n+                            .field(\"message\", \"Routed document \" + i)\n+                            .endObject())\n+                    .setTTL(ttlValue)\n+                    .setRouting(routing)\n+                    .setRefresh(true)\n+                    .execute()\n+                    .actionGet();\n+        }\n+\n+        // Index documents without routing\n+        for (int i = 0; i < 3; i++) {\n+            client.prepareIndex(\"test_mixed_routing\", \"type1\", \"unrouted_doc_\" + i)\n+                    .setSource(jsonBuilder()\n+                            .startObject()\n+                            .field(\"type\", \"unrouted\")\n+                            .field(\"message\", \"Unrouted document \" + i)\n+                            .endObject())\n+                    .setTTL(ttlValue)\n+                    .setRefresh(true)\n+                    .execute()\n+                    .actionGet();\n+        }\n+\n+        // Verify all documents exist\n+        SearchResponse searchResponse = client.prepareSearch(\"test_mixed_routing\")\n+                .setQuery(matchAllQuery())\n+                .execute()\n+                .actionGet();\n+        assertThat(\"All documents should be found\", searchResponse.getHits().totalHits(), equalTo(6L));\n+\n+        // Verify routed documents\n+        searchResponse = client.prepareSearch(\"test_mixed_routing\")\n+                .setQuery(termQuery(\"type\", \"routed\"))\n+                .execute()\n+                .actionGet();\n+        assertThat(\"Routed documents should be found\", searchResponse.getHits().totalHits(), equalTo(3L));\n+\n+        // Verify unrouted documents\n+        searchResponse = client.prepareSearch(\"test_mixed_routing\")\n+                .setQuery(termQuery(\"type\", \"unrouted\"))\n+                .execute()\n+                .actionGet();\n+        assertThat(\"Unrouted documents should be found\", searchResponse.getHits().totalHits(), equalTo(3L));\n+\n+        logger.info(\"--> waiting for TTL expiration for mixed routing documents\");\n+        // Wait for TTL expiration\n+        long expirationTime = System.currentTimeMillis() + ttlValue + purgeInterval + 1000;\n+        long currentTime = System.currentTimeMillis();\n+        if (expirationTime - currentTime > 0) {\n+            Thread.sleep(expirationTime - currentTime);\n+        }\n+\n+        // Verify all documents have expired\n+        searchResponse = client.prepareSearch(\"test_mixed_routing\")\n+                .setQuery(matchAllQuery())\n+                .execute()\n+                .actionGet();\n+        assertThat(\"All documents (routed and unrouted) should have expired\", \n+                  searchResponse.getHits().totalHits(), equalTo(0L));\n+    }\n }",
  "logs_path": "factory/mcp:glm-4.6/6bf04592/elastic_elasticsearch_pr1587/logs.jsonl",
  "errors": [],
  "edit_run_id": "6bf04592",
  "test_label": "v1-mcp"
}