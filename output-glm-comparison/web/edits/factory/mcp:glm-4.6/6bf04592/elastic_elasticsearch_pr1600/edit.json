{
  "repo_url": "https://github.com/elastic/elasticsearch.git",
  "pr_number": 1600,
  "base_commit": "ed8a46ce09ccf43adec55af91a72fc9c5dc1ec05",
  "runner": "factory",
  "model": "mcp:glm-4.6",
  "timeout_s": 1800,
  "status": "success",
  "elapsed_ms": 519126,
  "patch_unified": "diff --git a/src/main/java/org/elasticsearch/action/update/TransportUpdateAction.java b/src/main/java/org/elasticsearch/action/update/TransportUpdateAction.java\nindex 5a296cd..35d730b 100644\n--- a/src/main/java/org/elasticsearch/action/update/TransportUpdateAction.java\n+++ b/src/main/java/org/elasticsearch/action/update/TransportUpdateAction.java\n@@ -52,6 +52,7 @@ import org.elasticsearch.index.get.GetResult;\n import org.elasticsearch.index.mapper.internal.ParentFieldMapper;\n import org.elasticsearch.index.mapper.internal.RoutingFieldMapper;\n import org.elasticsearch.index.mapper.internal.SourceFieldMapper;\n+import org.elasticsearch.index.mapper.internal.TTLFieldMapper;\n import org.elasticsearch.index.mapper.internal.TimestampFieldMapper;\n import org.elasticsearch.index.service.IndexService;\n import org.elasticsearch.index.shard.IllegalIndexShardStateException;\n@@ -188,15 +189,33 @@ public class TransportUpdateAction extends TransportInstanceSingleOperationActio\n         // apply script to update the source\n         String routing = getResult.fields().containsKey(RoutingFieldMapper.NAME) ? getResult.field(RoutingFieldMapper.NAME).value().toString() : null;\n         String parent = getResult.fields().containsKey(ParentFieldMapper.NAME) ? getResult.field(ParentFieldMapper.NAME).value().toString() : null;\n-        // TODO ttl/timestamp\n+        \n+        // Extract timestamp and TTL from existing document\n+        String timestamp = null;\n+        if (getResult.fields().containsKey(TimestampFieldMapper.NAME)) {\n+            timestamp = getResult.field(TimestampFieldMapper.NAME).value().toString();\n+        }\n+        \n+        long ttl = -1;\n+        if (getResult.fields().containsKey(TTLFieldMapper.NAME)) {\n+            // TTL field stores the expiration timestamp, not the TTL itself\n+            Long expiration = (Long) getResult.field(TTLFieldMapper.NAME).value();\n+            long documentTimestamp = getResult.timestamp();\n+            ttl = expiration - documentTimestamp;\n+        }\n \n         // TODO percolate?\n \n         // TODO: external version type, does it make sense here? does not seem like it...\n \n         if (operation == null || \"index\".equals(operation)) {\n+            // Use timestamp/TTL from request if provided, otherwise use existing values\n+            String finalTimestamp = request.timestamp() != null ? request.timestamp() : timestamp;\n+            long finalTTL = request.ttl() != -1 ? request.ttl() : ttl;\n+            \n             IndexRequest indexRequest = Requests.indexRequest(request.index()).type(request.type()).id(request.id()).routing(routing).parent(parent)\n                     .source(source, sourceAndContent.v1())\n+                    .timestamp(finalTimestamp).ttl(finalTTL)\n                     .version(getResult.version()).replicationType(request.replicationType()).consistencyLevel(request.consistencyLevel());\n             indexRequest.operationThreaded(false);\n             indexAction.execute(indexRequest, new ActionListener<IndexResponse>() {\ndiff --git a/src/main/java/org/elasticsearch/action/update/UpdateRequest.java b/src/main/java/org/elasticsearch/action/update/UpdateRequest.java\nindex 05e39ce..39676fa 100644\n--- a/src/main/java/org/elasticsearch/action/update/UpdateRequest.java\n+++ b/src/main/java/org/elasticsearch/action/update/UpdateRequest.java\n@@ -44,6 +44,8 @@ public class UpdateRequest extends InstanceShardOperationRequest {\n     private String routing;\n \n     String script;\n+    private String timestamp;\n+    private long ttl = -1;\n     @Nullable\n     String scriptLang;\n     @Nullable\n@@ -149,6 +151,44 @@ public class UpdateRequest extends InstanceShardOperationRequest {\n         return this.routing;\n     }\n \n+    /**\n+     * Sets the timestamp either as millis since the epoch, or, in the configured date format.\n+     */\n+    public UpdateRequest timestamp(String timestamp) {\n+        this.timestamp = timestamp;\n+        return this;\n+    }\n+\n+    /**\n+     * The timestamp to use.\n+     */\n+    public String timestamp() {\n+        return this.timestamp;\n+    }\n+\n+    /**\n+     * Sets the relative ttl value. It musts be > 0 as it makes little sense otherwise. Setting it\n+     * to <tt>null</tt> will reset to have no ttl.\n+     */\n+    public UpdateRequest ttl(Long ttl) {\n+        if (ttl == null) {\n+            this.ttl = -1;\n+            return this;\n+        }\n+        if (ttl <= 0) {\n+            throw new ElasticSearchIllegalArgumentException(\"TTL value must be > 0. Illegal value provided [\" + ttl + \"]\");\n+        }\n+        this.ttl = ttl;\n+        return this;\n+    }\n+\n+    /**\n+     * The ttl value.\n+     */\n+    public long ttl() {\n+        return this.ttl;\n+    }\n+\n     int shardId() {\n         return this.shardId;\n     }\n@@ -297,6 +337,10 @@ public class UpdateRequest extends InstanceShardOperationRequest {\n         }\n         scriptParams = in.readMap();\n         retryOnConflict = in.readVInt();\n+        if (in.readBoolean()) {\n+            timestamp = in.readUTF();\n+        }\n+        ttl = in.readLong();\n     }\n \n     @Override\n@@ -321,5 +365,12 @@ public class UpdateRequest extends InstanceShardOperationRequest {\n         }\n         out.writeMap(scriptParams);\n         out.writeVInt(retryOnConflict);\n+        if (timestamp == null) {\n+            out.writeBoolean(false);\n+        } else {\n+            out.writeBoolean(true);\n+            out.writeUTF(timestamp);\n+        }\n+        out.writeLong(ttl);\n     }\n }\ndiff --git a/src/main/java/org/elasticsearch/rest/action/update/RestUpdateAction.java b/src/main/java/org/elasticsearch/rest/action/update/RestUpdateAction.java\nindex e6bef60..3867902 100644\n--- a/src/main/java/org/elasticsearch/rest/action/update/RestUpdateAction.java\n+++ b/src/main/java/org/elasticsearch/rest/action/update/RestUpdateAction.java\n@@ -57,6 +57,8 @@ public class RestUpdateAction extends BaseRestHandler {\n         updateRequest.routing(request.param(\"routing\"));\n         updateRequest.parent(request.param(\"parent\")); // order is important, set it after routing, so it will set the routing\n         updateRequest.timeout(request.paramAsTime(\"timeout\", updateRequest.timeout()));\n+        updateRequest.timestamp(request.param(\"timestamp\"));\n+        updateRequest.ttl(request.paramAsLong(\"ttl\", -1));\n         String replicationType = request.param(\"replication\");\n         if (replicationType != null) {\n             updateRequest.replicationType(ReplicationType.fromString(replicationType));\n@@ -92,6 +94,17 @@ public class RestUpdateAction extends BaseRestHandler {\n                     if (content.containsKey(\"params\")) {\n                         updateRequest.scriptParams((Map<String, Object>) content.get(\"params\"));\n                     }\n+                    if (content.containsKey(\"timestamp\")) {\n+                        updateRequest.timestamp(content.get(\"timestamp\").toString());\n+                    }\n+                    if (content.containsKey(\"ttl\")) {\n+                        Object ttlValue = content.get(\"ttl\");\n+                        if (ttlValue instanceof Number) {\n+                            updateRequest.ttl(((Number) ttlValue).longValue());\n+                        } else if (ttlValue instanceof String) {\n+                            updateRequest.ttl(Long.parseLong(ttlValue.toString()));\n+                        }\n+                    }\n                 } catch (Exception e) {\n                     try {\n                         channel.sendResponse(new XContentThrowableRestResponse(request, e));",
  "logs_path": "factory/mcp:glm-4.6/6bf04592/elastic_elasticsearch_pr1600/logs.jsonl",
  "errors": [],
  "edit_run_id": "6bf04592",
  "test_label": "v1-mcp"
}