{
  "repo_url": "https://github.com/elastic/elasticsearch.git",
  "pr_number": 4225,
  "base_commit": "81e13a870b112ad2921e1627bb3aabab48bf763c",
  "runner": "factory",
  "model": "mcp:glm-4.6",
  "timeout_s": 1800,
  "status": "success",
  "elapsed_ms": 814644,
  "patch_unified": "diff --git a/src/main/java/org/elasticsearch/common/geo/GeoDistance.java b/src/main/java/org/elasticsearch/common/geo/GeoDistance.java\nindex 0ded558..03ff470 100644\n--- a/src/main/java/org/elasticsearch/common/geo/GeoDistance.java\n+++ b/src/main/java/org/elasticsearch/common/geo/GeoDistance.java\n@@ -75,18 +75,11 @@ public enum GeoDistance {\n     ARC() {\n         @Override\n         public double calculate(double sourceLatitude, double sourceLongitude, double targetLatitude, double targetLongitude, DistanceUnit unit) {\n-            double longitudeDifference = targetLongitude - sourceLongitude;\n-            double a = Math.toRadians(90D - sourceLatitude);\n-            double c = Math.toRadians(90D - targetLatitude);\n-            double factor = (Math.cos(a) * Math.cos(c)) + (Math.sin(a) * Math.sin(c) * Math.cos(Math.toRadians(longitudeDifference)));\n-\n-            if (factor < -1D) {\n-                return Math.PI * unit.getEarthRadius();\n-            } else if (factor >= 1D) {\n-                return 0;\n-            } else {\n-                return Math.acos(factor) * unit.getEarthRadius();\n-            }\n+            // Use SloppyMath.haversinMeters for more accurate and efficient haversine calculation\n+            double distanceInMeters = SloppyMath.haversinMeters(sourceLatitude, sourceLongitude, targetLatitude, targetLongitude);\n+            \n+            // Convert from meters to the target unit using the built-in converter\n+            return DistanceUnit.convert(distanceInMeters, DistanceUnit.METERS, unit);\n         }\n \n         @Override\n@@ -294,6 +287,7 @@ public enum GeoDistance {\n         private final double sourceLatitude;\n         private final double sourceLongitude;\n         private final double earthRadius;\n+        private final DistanceUnit unit;\n \n         private final double a;\n         private final double sinA;\n@@ -303,6 +297,7 @@ public enum GeoDistance {\n             this.sourceLatitude = sourceLatitude;\n             this.sourceLongitude = sourceLongitude;\n             this.earthRadius = unit.getEarthRadius();\n+            this.unit = unit;\n             this.a = Math.toRadians(90D - sourceLatitude);\n             this.sinA = Math.sin(a);\n             this.cosA = Math.cos(a);\n@@ -310,17 +305,11 @@ public enum GeoDistance {\n \n         @Override\n         public double calculate(double targetLatitude, double targetLongitude) {\n-            double longitudeDifference = targetLongitude - sourceLongitude;\n-            double c = Math.toRadians(90D - targetLatitude);\n-            double factor = (cosA * Math.cos(c)) + (sinA * Math.sin(c) * Math.cos(Math.toRadians(longitudeDifference)));\n-\n-            if (factor < -1D) {\n-                return Math.PI * earthRadius;\n-            } else if (factor >= 1D) {\n-                return 0;\n-            } else {\n-                return Math.acos(factor) * earthRadius;\n-            }\n+            // Use SloppyMath.haversinMeters for more accurate and efficient haversine calculation\n+            double distanceInMeters = SloppyMath.haversinMeters(sourceLatitude, sourceLongitude, targetLatitude, targetLongitude);\n+            \n+            // Convert from meters to the target unit\n+            return DistanceUnit.convert(distanceInMeters, DistanceUnit.METERS, unit);\n         }\n     }\n }",
  "logs_path": "factory/mcp:glm-4.6/6bf04592/elastic_elasticsearch_pr4225/logs.jsonl",
  "errors": [],
  "edit_run_id": "6bf04592",
  "test_label": "v1-mcp"
}