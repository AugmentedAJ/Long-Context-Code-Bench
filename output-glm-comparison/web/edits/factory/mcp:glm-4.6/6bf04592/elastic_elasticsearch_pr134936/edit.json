{
  "repo_url": "https://github.com/elastic/elasticsearch.git",
  "pr_number": 134936,
  "base_commit": "0d0c0ad2354f522d2dbd3ecd2db295f3cf085ba0",
  "runner": "factory",
  "model": "mcp:glm-4.6",
  "timeout_s": 1800,
  "status": "success",
  "elapsed_ms": 602584,
  "patch_unified": "diff --git a/server/src/main/java/org/elasticsearch/ingest/ConditionalProcessor.java b/server/src/main/java/org/elasticsearch/ingest/ConditionalProcessor.java\nindex 24e093d5..57a80083 100644\n--- a/server/src/main/java/org/elasticsearch/ingest/ConditionalProcessor.java\n+++ b/server/src/main/java/org/elasticsearch/ingest/ConditionalProcessor.java\n@@ -26,6 +26,9 @@ import java.util.Map;\n import java.util.Set;\n import java.util.function.BiConsumer;\n import java.util.function.LongSupplier;\n+import java.util.Spliterator;\n+import java.util.function.Consumer;\n+import java.util.function.Predicate;\n import java.util.stream.Collectors;\n \n import static org.elasticsearch.ingest.ConfigurationUtils.newConfigurationException;\n@@ -158,6 +161,8 @@ public class ConditionalProcessor extends AbstractProcessor implements WrappingP\n             return new UnmodifiableIngestData((Map<String, Object>) raw);\n         } else if (raw instanceof List) {\n             return new UnmodifiableIngestList((List<Object>) raw);\n+        } else if (raw instanceof Set) {\n+            return new UnmodifiableIngestSet((Set<Object>) raw);\n         } else if (raw instanceof byte[] bytes) {\n             return bytes.clone();\n         }\n@@ -465,4 +470,119 @@ public class ConditionalProcessor extends AbstractProcessor implements WrappingP\n             }\n         }\n     }\n+\n+    private static final class UnmodifiableIngestSet implements Set<Object> {\n+\n+        private final Set<Object> data;\n+\n+        UnmodifiableIngestSet(Set<Object> data) {\n+            this.data = data;\n+        }\n+\n+        @Override\n+        public int size() {\n+            return data.size();\n+        }\n+\n+        @Override\n+        public boolean isEmpty() {\n+            return data.isEmpty();\n+        }\n+\n+        @Override\n+        public boolean contains(Object o) {\n+            return data.contains(o);\n+        }\n+\n+        @Override\n+        public Iterator<Object> iterator() {\n+            Iterator<Object> wrapped = data.iterator();\n+            return new Iterator<Object>() {\n+                @Override\n+                public boolean hasNext() {\n+                    return wrapped.hasNext();\n+                }\n+\n+                @Override\n+                public Object next() {\n+                    return wrapUnmodifiable(wrapped.next());\n+                }\n+\n+                @Override\n+                public void remove() {\n+                    throw unmodifiableException();\n+                }\n+            };\n+        }\n+\n+        @Override\n+        public Object[] toArray() {\n+            Object[] wrapped = data.toArray(new Object[0]);\n+            for (int i = 0; i < wrapped.length; i++) {\n+                wrapped[i] = wrapUnmodifiable(wrapped[i]);\n+            }\n+            return wrapped;\n+        }\n+\n+        @Override\n+        @SuppressWarnings(\"unchecked\")\n+        public <T> T[] toArray(T[] a) {\n+            Object[] raw = data.toArray(new Object[0]);\n+            T[] wrapped = (T[]) Arrays.copyOf(raw, a.length, a.getClass());\n+            for (int i = 0; i < wrapped.length; i++) {\n+                wrapped[i] = (T) wrapUnmodifiable(wrapped[i]);\n+            }\n+            return wrapped;\n+        }\n+\n+        @Override\n+        public boolean add(Object e) {\n+            throw unmodifiableException();\n+        }\n+\n+        @Override\n+        public boolean remove(Object o) {\n+            throw unmodifiableException();\n+        }\n+\n+        @Override\n+        public boolean containsAll(Collection<?> c) {\n+            return data.containsAll(c);\n+        }\n+\n+        @Override\n+        public boolean addAll(Collection<?> c) {\n+            throw unmodifiableException();\n+        }\n+\n+        @Override\n+        public boolean retainAll(Collection<?> c) {\n+            throw unmodifiableException();\n+        }\n+\n+        @Override\n+        public boolean removeAll(Collection<?> c) {\n+            throw unmodifiableException();\n+        }\n+\n+        @Override\n+        public void clear() {\n+            throw unmodifiableException();\n+        }\n+\n+        @Override\n+        public Spliterator<Object> spliterator() {\n+            return data.spliterator();\n+        }\n+\n+        @Override\n+        public boolean removeIf(Predicate<? super Object> filter) {\n+            throw unmodifiableException();\n+        }\n+\n+        @Override\n+        public void forEach(Consumer<? super Object> action) {\n+            data.forEach(obj -> action.accept(wrapUnmodifiable(obj)));\n+        }\n+    }\n }\ndiff --git a/server/src/test/java/org/elasticsearch/ingest/ConditionalProcessorTests.java b/server/src/test/java/org/elasticsearch/ingest/ConditionalProcessorTests.java\nindex 1317233d..851bef7d 100644\n--- a/server/src/test/java/org/elasticsearch/ingest/ConditionalProcessorTests.java\n+++ b/server/src/test/java/org/elasticsearch/ingest/ConditionalProcessorTests.java\n@@ -28,6 +28,7 @@ import java.util.ArrayList;\n import java.util.HashMap;\n import java.util.List;\n import java.util.Map;\n+import java.util.Set;\n import java.util.concurrent.TimeUnit;\n import java.util.concurrent.atomic.AtomicBoolean;\n import java.util.function.BiConsumer;\n@@ -141,6 +142,8 @@ public class ConditionalProcessorTests extends ESTestCase {\n         assertMutatingCtxThrows(ctx -> ctx.put(\"foo\", \"bar\"));\n         assertMutatingCtxThrows(ctx -> ((List<Object>) ctx.get(\"listField\")).add(\"bar\"));\n         assertMutatingCtxThrows(ctx -> ((List<Object>) ctx.get(\"listField\")).remove(\"bar\"));\n+        assertMutatingCtxThrows(ctx -> ((Set<Object>) ctx.get(\"setField\")).add(\"bar\"));\n+        assertMutatingCtxThrows(ctx -> ((Set<Object>) ctx.get(\"setField\")).remove(\"bar\"));\n     }\n \n     public void testPrecompiledError() {\n@@ -221,6 +224,7 @@ public class ConditionalProcessorTests extends ESTestCase {\n         );\n         IngestDocument ingestDocument = RandomDocumentPicks.randomIngestDocument(random(), document);\n         ingestDocument.setFieldValue(\"listField\", new ArrayList<>());\n+        ingestDocument.setFieldValue(\"setField\", new java.util.HashSet<>());\n         execProcessor(processor, ingestDocument, (result, e) -> {});\n         Exception e = safeGet(expectedException);\n         assertThat(e, instanceOf(UnsupportedOperationException.class));",
  "logs_path": "factory/mcp:glm-4.6/6bf04592/elastic_elasticsearch_pr134936/logs.jsonl",
  "errors": [],
  "edit_run_id": "6bf04592",
  "test_label": "v1-mcp"
}