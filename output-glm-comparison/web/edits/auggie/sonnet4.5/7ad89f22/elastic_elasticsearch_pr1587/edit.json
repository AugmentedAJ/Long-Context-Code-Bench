{
  "repo_url": "https://github.com/elastic/elasticsearch.git",
  "pr_number": 1587,
  "base_commit": "df4a3bfd379fd90b3667bbcd7ca2ed4619fee025",
  "runner": "auggie",
  "model": "sonnet4.5",
  "timeout_s": 1800,
  "status": "success",
  "elapsed_ms": 162513,
  "patch_unified": "diff --git a/src/test/java/org/elasticsearch/test/integration/ttl/SimpleTTLTests.java b/src/test/java/org/elasticsearch/test/integration/ttl/SimpleTTLTests.java\nindex 89f4ab7..f432632 100644\n--- a/src/test/java/org/elasticsearch/test/integration/ttl/SimpleTTLTests.java\n+++ b/src/test/java/org/elasticsearch/test/integration/ttl/SimpleTTLTests.java\n@@ -19,10 +19,14 @@\n \n package org.elasticsearch.test.integration.ttl;\n \n+import org.elasticsearch.action.admin.cluster.health.ClusterHealthResponse;\n+import org.elasticsearch.action.admin.cluster.health.ClusterHealthStatus;\n import org.elasticsearch.action.get.GetResponse;\n+import org.elasticsearch.action.search.SearchResponse;\n import org.elasticsearch.client.Client;\n import org.elasticsearch.common.settings.Settings;\n import org.elasticsearch.common.xcontent.XContentFactory;\n+import org.elasticsearch.index.query.QueryBuilders;\n import org.elasticsearch.test.integration.AbstractNodesTests;\n import org.testng.annotations.AfterClass;\n import org.testng.annotations.BeforeClass;\n@@ -119,4 +123,210 @@ public class SimpleTTLTests extends AbstractNodesTests {\n         getResponse = client.prepareGet(\"test\", \"type1\", \"1\").setFields(\"_ttl\").setRealtime(false).execute().actionGet();\n         assertThat(getResponse.exists(), equalTo(false));\n     }\n+\n+    @Test\n+    public void testTTLWithRouting() throws Exception {\n+        client.admin().indices().prepareDelete().execute().actionGet();\n+\n+        // Create index with multiple shards to ensure routing distributes documents\n+        client.admin().indices().prepareCreate(\"test\")\n+                .setSettings(settingsBuilder()\n+                        .put(\"index.number_of_shards\", 5)\n+                        .put(\"index.number_of_replicas\", 1))\n+                .addMapping(\"type1\", XContentFactory.jsonBuilder()\n+                        .startObject()\n+                        .startObject(\"type1\")\n+                        .startObject(\"_timestamp\").field(\"enabled\", true).field(\"store\", \"yes\").endObject()\n+                        .startObject(\"_ttl\").field(\"enabled\", true).field(\"store\", \"yes\").endObject()\n+                        .endObject()\n+                        .endObject())\n+                .execute().actionGet();\n+        client.admin().cluster().prepareHealth().setWaitForGreenStatus().execute().actionGet();\n+\n+        long providedTTLValue = 3000;\n+        logger.info(\"--> indexing with routing\");\n+\n+        // Index documents with different routing values to distribute across shards\n+        client.prepareIndex(\"test\", \"type1\", \"1\").setRouting(\"routing_1\").setSource(\"field1\", \"value1\").setTTL(providedTTLValue).setRefresh(true).execute().actionGet();\n+        client.prepareIndex(\"test\", \"type1\", \"2\").setRouting(\"routing_2\").setSource(\"field1\", \"value2\").setTTL(providedTTLValue).setRefresh(true).execute().actionGet();\n+        client.prepareIndex(\"test\", \"type1\", \"3\").setRouting(\"routing_3\").setSource(\"field1\", \"value3\").setTTL(providedTTLValue).setRefresh(true).execute().actionGet();\n+\n+        long now = System.currentTimeMillis();\n+\n+        logger.info(\"--> checking ttl with routing\");\n+        // Verify documents exist with routing\n+        GetResponse getResponse = client.prepareGet(\"test\", \"type1\", \"1\").setRouting(\"routing_1\").setFields(\"_ttl\").setRealtime(true).execute().actionGet();\n+        assertThat(getResponse.exists(), equalTo(true));\n+        long ttl0 = ((Number) getResponse.field(\"_ttl\").value()).longValue();\n+        assertThat(ttl0, greaterThan(0L));\n+        assertThat(ttl0, lessThan(providedTTLValue));\n+\n+        getResponse = client.prepareGet(\"test\", \"type1\", \"2\").setRouting(\"routing_2\").setFields(\"_ttl\").setRealtime(true).execute().actionGet();\n+        assertThat(getResponse.exists(), equalTo(true));\n+        ttl0 = ((Number) getResponse.field(\"_ttl\").value()).longValue();\n+        assertThat(ttl0, greaterThan(0L));\n+        assertThat(ttl0, lessThan(providedTTLValue));\n+\n+        getResponse = client.prepareGet(\"test\", \"type1\", \"3\").setRouting(\"routing_3\").setFields(\"_ttl\").setRealtime(true).execute().actionGet();\n+        assertThat(getResponse.exists(), equalTo(true));\n+        ttl0 = ((Number) getResponse.field(\"_ttl\").value()).longValue();\n+        assertThat(ttl0, greaterThan(0L));\n+        assertThat(ttl0, lessThan(providedTTLValue));\n+\n+        logger.info(\"--> checking purger with routing\");\n+        // Wait for documents to expire\n+        long shouldBeExpiredDate = now + providedTTLValue + purgeInterval + 2000;\n+        long now1 = System.currentTimeMillis();\n+        if (shouldBeExpiredDate - now1 > 0) {\n+            Thread.sleep(shouldBeExpiredDate - now1);\n+        }\n+\n+        // Verify all documents with routing have been purged\n+        getResponse = client.prepareGet(\"test\", \"type1\", \"1\").setRouting(\"routing_1\").setFields(\"_ttl\").setRealtime(true).execute().actionGet();\n+        assertThat(getResponse.exists(), equalTo(false));\n+\n+        getResponse = client.prepareGet(\"test\", \"type1\", \"2\").setRouting(\"routing_2\").setFields(\"_ttl\").setRealtime(true).execute().actionGet();\n+        assertThat(getResponse.exists(), equalTo(false));\n+\n+        getResponse = client.prepareGet(\"test\", \"type1\", \"3\").setRouting(\"routing_3\").setFields(\"_ttl\").setRealtime(true).execute().actionGet();\n+        assertThat(getResponse.exists(), equalTo(false));\n+    }\n+\n+    @Test\n+    public void testTTLWithMultipleRoutingValues() throws Exception {\n+        client.admin().indices().prepareDelete().execute().actionGet();\n+\n+        // Create index with multiple shards\n+        client.admin().indices().prepareCreate(\"test\")\n+                .setSettings(settingsBuilder()\n+                        .put(\"index.number_of_shards\", 5)\n+                        .put(\"index.number_of_replicas\", 1))\n+                .addMapping(\"type1\", XContentFactory.jsonBuilder()\n+                        .startObject()\n+                        .startObject(\"type1\")\n+                        .startObject(\"_timestamp\").field(\"enabled\", true).field(\"store\", \"yes\").endObject()\n+                        .startObject(\"_ttl\").field(\"enabled\", true).field(\"store\", \"yes\").endObject()\n+                        .endObject()\n+                        .endObject())\n+                .execute().actionGet();\n+\n+        ClusterHealthResponse healthResponse = client.admin().cluster().prepareHealth().setWaitForGreenStatus().execute().actionGet();\n+        assertThat(healthResponse.getStatus(), equalTo(ClusterHealthStatus.GREEN));\n+\n+        long providedTTLValue = 3000;\n+        logger.info(\"--> indexing multiple documents with different routing values\");\n+\n+        // Index multiple documents with various routing values to ensure distribution across shards\n+        for (int i = 0; i < 10; i++) {\n+            client.prepareIndex(\"test\", \"type1\", \"doc_\" + i)\n+                    .setRouting(\"routing_\" + (i % 5))\n+                    .setSource(\"field1\", \"value\" + i)\n+                    .setTTL(providedTTLValue)\n+                    .execute().actionGet();\n+        }\n+\n+        client.admin().indices().prepareRefresh(\"test\").execute().actionGet();\n+        long now = System.currentTimeMillis();\n+\n+        logger.info(\"--> verifying all documents exist\");\n+        // Verify all documents exist\n+        SearchResponse searchResponse = client.prepareSearch(\"test\")\n+                .setQuery(QueryBuilders.matchAllQuery())\n+                .execute().actionGet();\n+        assertThat(searchResponse.getHits().getTotalHits(), equalTo(10L));\n+\n+        logger.info(\"--> waiting for TTL expiration\");\n+        // Wait for documents to expire\n+        long shouldBeExpiredDate = now + providedTTLValue + purgeInterval + 2000;\n+        long now1 = System.currentTimeMillis();\n+        if (shouldBeExpiredDate - now1 > 0) {\n+            Thread.sleep(shouldBeExpiredDate - now1);\n+        }\n+\n+        logger.info(\"--> verifying all documents have been purged\");\n+        // Verify all documents have been purged regardless of routing\n+        searchResponse = client.prepareSearch(\"test\")\n+                .setQuery(QueryBuilders.matchAllQuery())\n+                .execute().actionGet();\n+        assertThat(searchResponse.getHits().getTotalHits(), equalTo(0L));\n+\n+        // Verify individual documents with routing are gone\n+        for (int i = 0; i < 10; i++) {\n+            GetResponse getResponse = client.prepareGet(\"test\", \"type1\", \"doc_\" + i)\n+                    .setRouting(\"routing_\" + (i % 5))\n+                    .execute().actionGet();\n+            assertThat(getResponse.exists(), equalTo(false));\n+        }\n+    }\n+\n+    @Test\n+    public void testTTLWithRoutingOnSpecificShards() throws Exception {\n+        client.admin().indices().prepareDelete().execute().actionGet();\n+\n+        // Create index with multiple shards\n+        client.admin().indices().prepareCreate(\"test\")\n+                .setSettings(settingsBuilder()\n+                        .put(\"index.number_of_shards\", 3)\n+                        .put(\"index.number_of_replicas\", 1))\n+                .addMapping(\"type1\", XContentFactory.jsonBuilder()\n+                        .startObject()\n+                        .startObject(\"type1\")\n+                        .startObject(\"_timestamp\").field(\"enabled\", true).field(\"store\", \"yes\").endObject()\n+                        .startObject(\"_ttl\").field(\"enabled\", true).field(\"store\", \"yes\").endObject()\n+                        .endObject()\n+                        .endObject())\n+                .execute().actionGet();\n+\n+        client.admin().cluster().prepareHealth().setWaitForGreenStatus().execute().actionGet();\n+\n+        long shortTTL = 2000;\n+        long longTTL = 10000;\n+\n+        logger.info(\"--> indexing documents with different TTL values and routing\");\n+        // Index documents with short TTL on one routing value\n+        client.prepareIndex(\"test\", \"type1\", \"short_1\").setRouting(\"short_routing\").setSource(\"field1\", \"short1\").setTTL(shortTTL).execute().actionGet();\n+        client.prepareIndex(\"test\", \"type1\", \"short_2\").setRouting(\"short_routing\").setSource(\"field1\", \"short2\").setTTL(shortTTL).execute().actionGet();\n+\n+        // Index documents with long TTL on different routing value\n+        client.prepareIndex(\"test\", \"type1\", \"long_1\").setRouting(\"long_routing\").setSource(\"field1\", \"long1\").setTTL(longTTL).execute().actionGet();\n+        client.prepareIndex(\"test\", \"type1\", \"long_2\").setRouting(\"long_routing\").setSource(\"field1\", \"long2\").setTTL(longTTL).execute().actionGet();\n+\n+        client.admin().indices().prepareRefresh(\"test\").execute().actionGet();\n+        long now = System.currentTimeMillis();\n+\n+        logger.info(\"--> verifying all documents exist\");\n+        SearchResponse searchResponse = client.prepareSearch(\"test\")\n+                .setQuery(QueryBuilders.matchAllQuery())\n+                .execute().actionGet();\n+        assertThat(searchResponse.getHits().getTotalHits(), equalTo(4L));\n+\n+        logger.info(\"--> waiting for short TTL documents to expire\");\n+        // Wait for short TTL documents to expire\n+        long shouldBeExpiredDate = now + shortTTL + purgeInterval + 2000;\n+        long now1 = System.currentTimeMillis();\n+        if (shouldBeExpiredDate - now1 > 0) {\n+            Thread.sleep(shouldBeExpiredDate - now1);\n+        }\n+\n+        logger.info(\"--> verifying short TTL documents are purged but long TTL documents remain\");\n+        // Verify short TTL documents are gone\n+        GetResponse getResponse = client.prepareGet(\"test\", \"type1\", \"short_1\").setRouting(\"short_routing\").execute().actionGet();\n+        assertThat(getResponse.exists(), equalTo(false));\n+\n+        getResponse = client.prepareGet(\"test\", \"type1\", \"short_2\").setRouting(\"short_routing\").execute().actionGet();\n+        assertThat(getResponse.exists(), equalTo(false));\n+\n+        // Verify long TTL documents still exist\n+        getResponse = client.prepareGet(\"test\", \"type1\", \"long_1\").setRouting(\"long_routing\").execute().actionGet();\n+        assertThat(getResponse.exists(), equalTo(true));\n+\n+        getResponse = client.prepareGet(\"test\", \"type1\", \"long_2\").setRouting(\"long_routing\").execute().actionGet();\n+        assertThat(getResponse.exists(), equalTo(true));\n+\n+        // Verify count\n+        searchResponse = client.prepareSearch(\"test\")\n+                .setQuery(QueryBuilders.matchAllQuery())\n+                .execute().actionGet();\n+        assertThat(searchResponse.getHits().getTotalHits(), equalTo(2L));\n+    }\n }",
  "logs_path": "auggie/sonnet4.5/7ad89f22/elastic_elasticsearch_pr1587/logs.jsonl",
  "errors": [],
  "edit_run_id": "7ad89f22",
  "test_label": "v1-rollouts-1-3-sonnet4.5"
}