{
  "repo_url": "https://github.com/elastic/elasticsearch.git",
  "pr_number": 134495,
  "base_commit": "36181aa6f726d08d5c9c779f2d6e99b732de0ccc",
  "runner": "auggie",
  "model": "sonnet4.5",
  "timeout_s": 1800,
  "status": "success",
  "elapsed_ms": 297478,
  "patch_unified": "diff --git a/qa/ccs-unavailable-clusters/src/javaRestTest/java/org/elasticsearch/search/CrossClusterSearchUnavailableClusterIT.java b/qa/ccs-unavailable-clusters/src/javaRestTest/java/org/elasticsearch/search/CrossClusterSearchUnavailableClusterIT.java\nindex a09a9da1..54771f93 100644\n--- a/qa/ccs-unavailable-clusters/src/javaRestTest/java/org/elasticsearch/search/CrossClusterSearchUnavailableClusterIT.java\n+++ b/qa/ccs-unavailable-clusters/src/javaRestTest/java/org/elasticsearch/search/CrossClusterSearchUnavailableClusterIT.java\n@@ -178,13 +178,7 @@ public class CrossClusterSearchUnavailableClusterIT extends ESRestTestCase {\n                 Response response = client().performRequest(new Request(\"GET\", \"/index,remote1:index/_search\"));\n                 assertEquals(200, response.getStatusLine().getStatusCode());\n                 ObjectPath objectPath = ObjectPath.createFromResponse(response);\n-                assertNotNull(objectPath.evaluate(\"_clusters\"));\n-                assertThat(objectPath.evaluate(\"_clusters.total\"), equalTo(2));\n-                assertThat(objectPath.evaluate(\"_clusters.successful\"), equalTo(2));\n-                assertThat(objectPath.evaluate(\"_clusters.skipped\"), equalTo(0));\n-                assertThat(objectPath.evaluate(\"_clusters.running\"), equalTo(0));\n-                assertThat(objectPath.evaluate(\"_clusters.partial\"), equalTo(0));\n-                assertThat(objectPath.evaluate(\"_clusters.failed\"), equalTo(0));\n+                assertClustersMetadata(objectPath, 2, 2, 0, 0, 0, 0);\n                 assertThat(objectPath.evaluate(\"hits.total.value\"), equalTo(10));\n                 assertThat(objectPath.evaluateArraySize(\"hits.hits\"), equalTo(10));\n             }\n@@ -192,13 +186,7 @@ public class CrossClusterSearchUnavailableClusterIT extends ESRestTestCase {\n                 Response response = client().performRequest(new Request(\"GET\", \"/remote1:index/_search\"));\n                 assertEquals(200, response.getStatusLine().getStatusCode());\n                 ObjectPath objectPath = ObjectPath.createFromResponse(response);\n-                assertNotNull(objectPath.evaluate(\"_clusters\"));\n-                assertThat(objectPath.evaluate(\"_clusters.total\"), equalTo(1));\n-                assertThat(objectPath.evaluate(\"_clusters.successful\"), equalTo(1));\n-                assertThat(objectPath.evaluate(\"_clusters.skipped\"), equalTo(0));\n-                assertThat(objectPath.evaluate(\"_clusters.running\"), equalTo(0));\n-                assertThat(objectPath.evaluate(\"_clusters.partial\"), equalTo(0));\n-                assertThat(objectPath.evaluate(\"_clusters.failed\"), equalTo(0));\n+                assertClustersMetadata(objectPath, 1, 1, 0, 0, 0, 0);\n                 assertThat(objectPath.evaluate(\"hits.total.value\"), equalTo(0));\n                 assertThat(objectPath.evaluateArraySize(\"hits.hits\"), equalTo(0));\n             }\n@@ -207,13 +195,7 @@ public class CrossClusterSearchUnavailableClusterIT extends ESRestTestCase {\n                 Response response = client().performRequest(new Request(\"GET\", \"/index,remote1:index/_search?scroll=1m\"));\n                 assertEquals(200, response.getStatusLine().getStatusCode());\n                 ObjectPath objectPath = ObjectPath.createFromResponse(response);\n-                assertNotNull(objectPath.evaluate(\"_clusters\"));\n-                assertThat(objectPath.evaluate(\"_clusters.total\"), equalTo(2));\n-                assertThat(objectPath.evaluate(\"_clusters.successful\"), equalTo(2));\n-                assertThat(objectPath.evaluate(\"_clusters.skipped\"), equalTo(0));\n-                assertThat(objectPath.evaluate(\"_clusters.running\"), equalTo(0));\n-                assertThat(objectPath.evaluate(\"_clusters.partial\"), equalTo(0));\n-                assertThat(objectPath.evaluate(\"_clusters.failed\"), equalTo(0));\n+                assertClustersMetadata(objectPath, 2, 2, 0, 0, 0, 0);\n                 assertThat(objectPath.evaluate(\"hits.total.value\"), equalTo(10));\n                 assertThat(objectPath.evaluateArraySize(\"hits.hits\"), equalTo(10));\n                 String scrollId = objectPath.evaluate(\"_scroll_id\");\n@@ -236,13 +218,7 @@ public class CrossClusterSearchUnavailableClusterIT extends ESRestTestCase {\n                 Response response = client().performRequest(new Request(\"GET\", \"/index,remote1:index/_search\"));\n                 assertEquals(200, response.getStatusLine().getStatusCode());\n                 ObjectPath objectPath = ObjectPath.createFromResponse(response);\n-                assertNotNull(objectPath.evaluate(\"_clusters\"));\n-                assertThat(objectPath.evaluate(\"_clusters.total\"), equalTo(2));\n-                assertThat(objectPath.evaluate(\"_clusters.successful\"), equalTo(1));\n-                assertThat(objectPath.evaluate(\"_clusters.skipped\"), equalTo(1));\n-                assertThat(objectPath.evaluate(\"_clusters.running\"), equalTo(0));\n-                assertThat(objectPath.evaluate(\"_clusters.partial\"), equalTo(0));\n-                assertThat(objectPath.evaluate(\"_clusters.failed\"), equalTo(0));\n+                assertClustersMetadata(objectPath, 2, 1, 1, 0, 0, 0);\n                 assertThat(objectPath.evaluate(\"hits.total.value\"), equalTo(10));\n                 assertThat(objectPath.evaluateArraySize(\"hits.hits\"), equalTo(10));\n             }\n@@ -250,13 +226,7 @@ public class CrossClusterSearchUnavailableClusterIT extends ESRestTestCase {\n                 Response response = client().performRequest(new Request(\"GET\", \"/remote1:index/_search\"));\n                 assertEquals(200, response.getStatusLine().getStatusCode());\n                 ObjectPath objectPath = ObjectPath.createFromResponse(response);\n-                assertNotNull(objectPath.evaluate(\"_clusters\"));\n-                assertThat(objectPath.evaluate(\"_clusters.total\"), equalTo(1));\n-                assertThat(objectPath.evaluate(\"_clusters.successful\"), equalTo(0));\n-                assertThat(objectPath.evaluate(\"_clusters.skipped\"), equalTo(1));\n-                assertThat(objectPath.evaluate(\"_clusters.running\"), equalTo(0));\n-                assertThat(objectPath.evaluate(\"_clusters.partial\"), equalTo(0));\n-                assertThat(objectPath.evaluate(\"_clusters.failed\"), equalTo(0));\n+                assertClustersMetadata(objectPath, 1, 0, 1, 0, 0, 0);\n                 assertThat(objectPath.evaluate(\"hits.total.value\"), equalTo(0));\n                 assertThat(objectPath.evaluateArraySize(\"hits.hits\"), equalTo(0));\n             }\n@@ -265,13 +235,7 @@ public class CrossClusterSearchUnavailableClusterIT extends ESRestTestCase {\n                 Response response = client().performRequest(new Request(\"GET\", \"/index,remote1:index/_search?scroll=1m\"));\n                 assertEquals(200, response.getStatusLine().getStatusCode());\n                 ObjectPath objectPath = ObjectPath.createFromResponse(response);\n-                assertNotNull(objectPath.evaluate(\"_clusters\"));\n-                assertThat(objectPath.evaluate(\"_clusters.total\"), equalTo(2));\n-                assertThat(objectPath.evaluate(\"_clusters.successful\"), equalTo(1));\n-                assertThat(objectPath.evaluate(\"_clusters.skipped\"), equalTo(1));\n-                assertThat(objectPath.evaluate(\"_clusters.running\"), equalTo(0));\n-                assertThat(objectPath.evaluate(\"_clusters.partial\"), equalTo(0));\n-                assertThat(objectPath.evaluate(\"_clusters.failed\"), equalTo(0));\n+                assertClustersMetadata(objectPath, 2, 1, 1, 0, 0, 0);\n                 assertThat(objectPath.evaluate(\"hits.total.value\"), equalTo(10));\n                 assertThat(objectPath.evaluateArraySize(\"hits.hits\"), equalTo(10));\n                 String scrollId = objectPath.evaluate(\"_scroll_id\");\n@@ -377,6 +341,27 @@ public class CrossClusterSearchUnavailableClusterIT extends ESRestTestCase {\n         }\n     }\n \n+    /**\n+     * Helper method to assert _clusters metadata counts (total, successful, running, skipped, partial, failed).\n+     */\n+    private static void assertClustersMetadata(\n+        ObjectPath objectPath,\n+        int expectedTotal,\n+        int expectedSuccessful,\n+        int expectedSkipped,\n+        int expectedRunning,\n+        int expectedPartial,\n+        int expectedFailed\n+    ) {\n+        assertNotNull(objectPath.evaluate(\"_clusters\"));\n+        assertThat(objectPath.evaluate(\"_clusters.total\"), equalTo(expectedTotal));\n+        assertThat(objectPath.evaluate(\"_clusters.successful\"), equalTo(expectedSuccessful));\n+        assertThat(objectPath.evaluate(\"_clusters.skipped\"), equalTo(expectedSkipped));\n+        assertThat(objectPath.evaluate(\"_clusters.running\"), equalTo(expectedRunning));\n+        assertThat(objectPath.evaluate(\"_clusters.partial\"), equalTo(expectedPartial));\n+        assertThat(objectPath.evaluate(\"_clusters.failed\"), equalTo(expectedFailed));\n+    }\n+\n     private static void updateRemoteClusterSettings(Map<String, Object> settings) throws IOException {\n         Request request = new Request(\"PUT\", \"/_cluster/settings\");\n         request.setEntity(buildUpdateSettingsRequestBody(settings));\ndiff --git a/qa/multi-cluster-search/src/test/java/org/elasticsearch/search/CCSDuelIT.java b/qa/multi-cluster-search/src/test/java/org/elasticsearch/search/CCSDuelIT.java\nindex 5b4ff08d..73686413 100644\n--- a/qa/multi-cluster-search/src/test/java/org/elasticsearch/search/CCSDuelIT.java\n+++ b/qa/multi-cluster-search/src/test/java/org/elasticsearch/search/CCSDuelIT.java\n@@ -1259,6 +1259,24 @@ public class CCSDuelIT extends ESRestTestCase {\n         return ContentType.create(xContentType.mediaTypeWithoutParameters(), (Charset) null);\n     }\n \n+    /**\n+     * Helper method to assert _clusters metadata counts.\n+     */\n+    private static void assertClustersMetadata(\n+        ObjectPath response,\n+        int expectedTotal,\n+        int expectedSuccessful,\n+        int expectedSkipped,\n+        int expectedRunning,\n+        int expectedFailed\n+    ) throws IOException {\n+        assertThat(response.evaluate(\"_clusters.total\"), equalTo(expectedTotal));\n+        assertThat(response.evaluate(\"_clusters.successful\"), equalTo(expectedSuccessful));\n+        assertThat(response.evaluate(\"_clusters.skipped\"), equalTo(expectedSkipped));\n+        assertThat(response.evaluate(\"_clusters.running\"), equalTo(expectedRunning));\n+        assertThat(response.evaluate(\"_clusters.failed\"), equalTo(expectedFailed));\n+    }\n+\n     private static void assertMultiClusterSearchResponse(ObjectPath searchResponse) throws IOException {\n         assertThat(searchResponse.evaluate(\"_clusters.total\"), equalTo(2));\n         // for bwc checks we expect SUCCESSFUL + PARTIAL to be equal to 2\n@@ -1273,8 +1291,7 @@ public class CCSDuelIT extends ESRestTestCase {\n     }\n \n     private static void assertSingleRemoteClusterSearchResponse(ObjectPath searchResponse) throws IOException {\n-        assertThat(searchResponse.evaluate(\"_clusters.total\"), equalTo(1));\n-        assertThat(searchResponse.evaluate(\"_clusters.successful\"), equalTo(1));\n+        assertClustersMetadata(searchResponse, 1, 1, 0, 0, 0);\n         assertThat(searchResponse.evaluate(\"_shards.total\"), greaterThanOrEqualTo(1));\n         assertThat(searchResponse.evaluate(\"_shards.successful\"), greaterThanOrEqualTo(1));\n     }\ndiff --git a/x-pack/plugin/esql/qa/server/multi-clusters/src/javaRestTest/java/org/elasticsearch/xpack/esql/ccq/MultiClustersIT.java b/x-pack/plugin/esql/qa/server/multi-clusters/src/javaRestTest/java/org/elasticsearch/xpack/esql/ccq/MultiClustersIT.java\nindex 42b7bc59..406673e5 100644\n--- a/x-pack/plugin/esql/qa/server/multi-clusters/src/javaRestTest/java/org/elasticsearch/xpack/esql/ccq/MultiClustersIT.java\n+++ b/x-pack/plugin/esql/qa/server/multi-clusters/src/javaRestTest/java/org/elasticsearch/xpack/esql/ccq/MultiClustersIT.java\n@@ -334,12 +334,7 @@ public class MultiClustersIT extends ESRestTestCase {\n         int expectedNumClusters = remoteOnly ? 1 : 2;\n         Set<String> expectedClusterAliases = remoteOnly ? Set.of(\"remote_cluster\") : Set.of(\"remote_cluster\", \"(local)\");\n \n-        assertThat(clusters.get(\"total\"), equalTo(expectedNumClusters));\n-        assertThat(clusters.get(\"successful\"), equalTo(expectedNumClusters));\n-        assertThat(clusters.get(\"running\"), equalTo(0));\n-        assertThat(clusters.get(\"skipped\"), equalTo(0));\n-        assertThat(clusters.get(\"partial\"), equalTo(0));\n-        assertThat(clusters.get(\"failed\"), equalTo(0));\n+        assertClusterMetadataCounts(clusters, expectedNumClusters, expectedNumClusters, 0, 0, 0, 0);\n \n         @SuppressWarnings(\"unchecked\")\n         Map<String, Object> details = (Map<String, Object>) clusters.get(\"details\");\n@@ -347,15 +342,55 @@ public class MultiClustersIT extends ESRestTestCase {\n \n         @SuppressWarnings(\"unchecked\")\n         Map<String, Object> remoteCluster = (Map<String, Object>) details.get(\"remote_cluster\");\n-        assertThat(remoteCluster.keySet(), equalTo(Set.of(\"status\", \"indices\", \"took\", \"_shards\")));\n-        assertThat(remoteCluster.get(\"status\"), equalTo(\"successful\"));\n-        assertThat(remoteCluster.get(\"indices\"), equalTo(\"test-remote-index\"));\n-        assertThat((Integer) remoteCluster.get(\"took\"), greaterThanOrEqualTo(0));\n+        assertClusterDetails(remoteCluster, \"successful\", \"test-remote-index\");\n+\n+        if (remoteOnly == false) {\n+            @SuppressWarnings(\"unchecked\")\n+            Map<String, Object> localCluster = (Map<String, Object>) details.get(\"(local)\");\n+            assertClusterDetails(localCluster, \"successful\", \"test-local-index\");\n+        }\n+    }\n+\n+    /**\n+     * Helper method to assert _clusters metadata counts (total, successful, running, skipped, partial, failed).\n+     */\n+    private void assertClusterMetadataCounts(\n+        Map<String, Object> clusters,\n+        int expectedTotal,\n+        int expectedSuccessful,\n+        int expectedRunning,\n+        int expectedSkipped,\n+        int expectedPartial,\n+        int expectedFailed\n+    ) {\n+        assertThat(clusters.get(\"total\"), equalTo(expectedTotal));\n+        assertThat(clusters.get(\"successful\"), equalTo(expectedSuccessful));\n+        assertThat(clusters.get(\"running\"), equalTo(expectedRunning));\n+        assertThat(clusters.get(\"skipped\"), equalTo(expectedSkipped));\n+        assertThat(clusters.get(\"partial\"), equalTo(expectedPartial));\n+        assertThat(clusters.get(\"failed\"), equalTo(expectedFailed));\n+    }\n+\n+    /**\n+     * Helper method to assert individual cluster details (status, indices, took, _shards).\n+     */\n+    private void assertClusterDetails(Map<String, Object> clusterDetails, String expectedStatus, String expectedIndices) {\n+        assertThat(clusterDetails.keySet(), equalTo(Set.of(\"status\", \"indices\", \"took\", \"_shards\")));\n+        assertThat(clusterDetails.get(\"status\"), equalTo(expectedStatus));\n+        assertThat(clusterDetails.get(\"indices\"), equalTo(expectedIndices));\n+        assertThat((Integer) clusterDetails.get(\"took\"), greaterThanOrEqualTo(0));\n \n         @SuppressWarnings(\"unchecked\")\n-        Map<String, Object> remoteClusterShards = (Map<String, Object>) remoteCluster.get(\"_shards\");\n+        Map<String, Object> shards = (Map<String, Object>) clusterDetails.get(\"_shards\");\n+        assertShardCounts(shards);\n+    }\n+\n+    /**\n+     * Helper method to assert shard counts (total, successful, skipped, failed).\n+     */\n+    private void assertShardCounts(Map<String, Object> shards) {\n         assertThat(\n-            remoteClusterShards,\n+            shards,\n             matchesMap().entry(\"total\", greaterThanOrEqualTo(0))\n                 .entry(\"successful\", greaterThanOrEqualTo(0))\n                 .entry(\"skipped\", greaterThanOrEqualTo(0))\n@@ -363,34 +398,10 @@ public class MultiClustersIT extends ESRestTestCase {\n         );\n         if (checkShardCounts()) {\n             assertThat(\n-                (int) remoteClusterShards.get(\"successful\") + (int) remoteClusterShards.get(\"skipped\"),\n-                equalTo(remoteClusterShards.get(\"total\"))\n+                (int) shards.get(\"successful\") + (int) shards.get(\"skipped\"),\n+                equalTo(shards.get(\"total\"))\n             );\n         }\n-        if (remoteOnly == false) {\n-            @SuppressWarnings(\"unchecked\")\n-            Map<String, Object> localCluster = (Map<String, Object>) details.get(\"(local)\");\n-            assertThat(localCluster.keySet(), equalTo(Set.of(\"status\", \"indices\", \"took\", \"_shards\")));\n-            assertThat(localCluster.get(\"status\"), equalTo(\"successful\"));\n-            assertThat(localCluster.get(\"indices\"), equalTo(\"test-local-index\"));\n-            assertThat((Integer) localCluster.get(\"took\"), greaterThanOrEqualTo(0));\n-\n-            @SuppressWarnings(\"unchecked\")\n-            Map<String, Object> localClusterShards = (Map<String, Object>) localCluster.get(\"_shards\");\n-            assertThat(\n-                localClusterShards,\n-                matchesMap().entry(\"total\", greaterThanOrEqualTo(0))\n-                    .entry(\"successful\", greaterThanOrEqualTo(0))\n-                    .entry(\"skipped\", greaterThanOrEqualTo(0))\n-                    .entry(\"failed\", 0)\n-            );\n-            if (checkShardCounts()) {\n-                assertThat(\n-                    (int) localClusterShards.get(\"successful\") + (int) localClusterShards.get(\"skipped\"),\n-                    equalTo(localClusterShards.get(\"total\"))\n-                );\n-            }\n-        }\n     }\n \n     public void testGroupedAggs() throws Exception {",
  "logs_path": "auggie/sonnet4.5/7ad89f22/elastic_elasticsearch_pr134495/logs.jsonl",
  "errors": [],
  "edit_run_id": "7ad89f22",
  "test_label": "v1-rollouts-1-3-sonnet4.5"
}