{
  "repo_url": "https://github.com/elastic/elasticsearch.git",
  "pr_number": 3632,
  "base_commit": "9e7b3963d81afc74907a130533738cb90e6f993b",
  "runner": "auggie",
  "model": "sonnet4.5",
  "timeout_s": 1800,
  "status": "success",
  "elapsed_ms": 417595,
  "patch_unified": "diff --git a/src/main/java/org/elasticsearch/search/highlight/FastVectorHighlighter.java b/src/main/java/org/elasticsearch/search/highlight/FastVectorHighlighter.java\nindex 7763753..a9abf8f 100644\n--- a/src/main/java/org/elasticsearch/search/highlight/FastVectorHighlighter.java\n+++ b/src/main/java/org/elasticsearch/search/highlight/FastVectorHighlighter.java\n@@ -122,18 +122,25 @@ public class FastVectorHighlighter implements Highlighter {\n                     cache.fvh = new org.apache.lucene.search.vectorhighlight.FastVectorHighlighter();\n                 }\n                 CustomFieldQuery.highlightFilters.set(field.highlightFilter());\n-                if (field.requireFieldMatch()) {\n-                    if (cache.fieldMatchFieldQuery == null) {\n-                        // we use top level reader to rewrite the query against all readers, with use caching it across hits (and across readers...)\n-                        cache.fieldMatchFieldQuery = new CustomFieldQuery(context.parsedQuery().query(), hitContext.topLevelReader(), true, field.requireFieldMatch());\n-                    }\n-                    fieldQuery = cache.fieldMatchFieldQuery;\n+                // Use custom highlight query if provided, otherwise use the search query\n+                if (field.highlightQuery() != null) {\n+                    // When a custom highlight query is provided, create a new FieldQuery for it\n+                    fieldQuery = new CustomFieldQuery(field.highlightQuery(), hitContext.topLevelReader(), true, field.requireFieldMatch());\n                 } else {\n-                    if (cache.noFieldMatchFieldQuery == null) {\n-                        // we use top level reader to rewrite the query against all readers, with use caching it across hits (and across readers...)\n-                        cache.noFieldMatchFieldQuery = new CustomFieldQuery(context.parsedQuery().query(), hitContext.topLevelReader(), true, field.requireFieldMatch());\n+                    // Use cached field query for the search query\n+                    if (field.requireFieldMatch()) {\n+                        if (cache.fieldMatchFieldQuery == null) {\n+                            // we use top level reader to rewrite the query against all readers, with use caching it across hits (and across readers...)\n+                            cache.fieldMatchFieldQuery = new CustomFieldQuery(context.parsedQuery().query(), hitContext.topLevelReader(), true, field.requireFieldMatch());\n+                        }\n+                        fieldQuery = cache.fieldMatchFieldQuery;\n+                    } else {\n+                        if (cache.noFieldMatchFieldQuery == null) {\n+                            // we use top level reader to rewrite the query against all readers, with use caching it across hits (and across readers...)\n+                            cache.noFieldMatchFieldQuery = new CustomFieldQuery(context.parsedQuery().query(), hitContext.topLevelReader(), true, field.requireFieldMatch());\n+                        }\n+                        fieldQuery = cache.noFieldMatchFieldQuery;\n                     }\n-                    fieldQuery = cache.noFieldMatchFieldQuery;\n                 }\n                 cache.mappers.put(mapper, entry);\n             }\ndiff --git a/src/main/java/org/elasticsearch/search/highlight/HighlightBuilder.java b/src/main/java/org/elasticsearch/search/highlight/HighlightBuilder.java\nindex 4e0ccc6..93d879f 100644\n--- a/src/main/java/org/elasticsearch/search/highlight/HighlightBuilder.java\n+++ b/src/main/java/org/elasticsearch/search/highlight/HighlightBuilder.java\n@@ -21,6 +21,7 @@ package org.elasticsearch.search.highlight;\n \n import org.elasticsearch.common.xcontent.ToXContent;\n import org.elasticsearch.common.xcontent.XContentBuilder;\n+import org.elasticsearch.index.query.QueryBuilder;\n \n import java.io.IOException;\n import java.util.List;\n@@ -282,6 +283,10 @@ public class HighlightBuilder implements ToXContent {\n                 if (field.options != null && field.options.size() > 0) {\n                     builder.field(\"options\", field.options);\n                 }\n+                if (field.highlightQuery != null) {\n+                    builder.field(\"highlight_query\");\n+                    field.highlightQuery.toXContent(builder, params);\n+                }\n \n                 builder.endObject();\n             }\n@@ -307,6 +312,7 @@ public class HighlightBuilder implements ToXContent {\n         String highlighterType;\n         String fragmenter;\n         Map<String, Object> options;\n+        QueryBuilder highlightQuery;\n \n         public Field(String name) {\n             this.name = name;\n@@ -408,5 +414,14 @@ public class HighlightBuilder implements ToXContent {\n             this.options = options;\n             return this;\n         }\n+\n+        /**\n+         * Set a custom highlight query to be used for highlighting instead of the search query.\n+         * This allows highlighting different terms than those used for searching.\n+         */\n+        public Field highlightQuery(QueryBuilder highlightQuery) {\n+            this.highlightQuery = highlightQuery;\n+            return this;\n+        }\n     }\n }\ndiff --git a/src/main/java/org/elasticsearch/search/highlight/HighlighterParseElement.java b/src/main/java/org/elasticsearch/search/highlight/HighlighterParseElement.java\nindex edceffc..05aaa02 100644\n--- a/src/main/java/org/elasticsearch/search/highlight/HighlighterParseElement.java\n+++ b/src/main/java/org/elasticsearch/search/highlight/HighlighterParseElement.java\n@@ -20,8 +20,10 @@\n package org.elasticsearch.search.highlight;\n \n import com.google.common.collect.Lists;\n+import org.apache.lucene.search.Query;\n import org.apache.lucene.search.vectorhighlight.SimpleBoundaryScanner;\n import org.elasticsearch.common.xcontent.XContentParser;\n+import org.elasticsearch.index.query.ParsedQuery;\n import org.elasticsearch.search.SearchParseElement;\n import org.elasticsearch.search.SearchParseException;\n import org.elasticsearch.search.internal.SearchContext;\n@@ -185,8 +187,13 @@ public class HighlighterParseElement implements SearchParseElement {\n                                     } else if (\"fragmenter\".equals(fieldName)) {\n                                         field.fragmenter(parser.text());\n                                     }\n-                                } else if (fieldName.equals(\"options\")) {\n-                                    field.options(parser.map());\n+                                } else if (token == XContentParser.Token.START_OBJECT) {\n+                                    if (fieldName.equals(\"options\")) {\n+                                        field.options(parser.map());\n+                                    } else if (\"highlight_query\".equals(fieldName) || \"highlightQuery\".equals(fieldName)) {\n+                                        ParsedQuery parsedQuery = context.queryParserService().parse(parser);\n+                                        field.highlightQuery(parsedQuery.query());\n+                                    }\n                                 }\n                             }\n                             fields.add(field);\ndiff --git a/src/main/java/org/elasticsearch/search/highlight/PlainHighlighter.java b/src/main/java/org/elasticsearch/search/highlight/PlainHighlighter.java\nindex ff1d0f8..dfa4735 100644\n--- a/src/main/java/org/elasticsearch/search/highlight/PlainHighlighter.java\n+++ b/src/main/java/org/elasticsearch/search/highlight/PlainHighlighter.java\n@@ -72,7 +72,8 @@ public class PlainHighlighter implements Highlighter {\n         if (entry == null) {\n             // Don't use the context.query() since it might be rewritten, and we need to pass the non rewritten queries to\n             // let the highlighter handle MultiTerm ones\n-            Query query = context.parsedQuery().query();\n+            // Use custom highlight query if provided, otherwise use the search query\n+            Query query = field.highlightQuery() != null ? field.highlightQuery() : context.parsedQuery().query();\n             QueryScorer queryScorer = new CustomQueryScorer(query, field.requireFieldMatch() ? mapper.names().indexName() : null);\n             queryScorer.setExpandMultiTermQuery(true);\n             Fragmenter fragmenter;\ndiff --git a/src/main/java/org/elasticsearch/search/highlight/SearchContextHighlight.java b/src/main/java/org/elasticsearch/search/highlight/SearchContextHighlight.java\nindex 04e71d2..c88f198 100644\n--- a/src/main/java/org/elasticsearch/search/highlight/SearchContextHighlight.java\n+++ b/src/main/java/org/elasticsearch/search/highlight/SearchContextHighlight.java\n@@ -19,6 +19,8 @@\n \n package org.elasticsearch.search.highlight;\n \n+import org.apache.lucene.search.Query;\n+\n import java.util.List;\n import java.util.Map;\n \n@@ -68,6 +70,8 @@ public class SearchContextHighlight {\n \n         private Map<String, Object> options;\n \n+        private Query highlightQuery;\n+\n         public Field(String field) {\n             this.field = field;\n         }\n@@ -187,5 +191,13 @@ public class SearchContextHighlight {\n         public void options(Map<String, Object> options) {\n             this.options = options;\n         }\n+\n+        public Query highlightQuery() {\n+            return highlightQuery;\n+        }\n+\n+        public void highlightQuery(Query highlightQuery) {\n+            this.highlightQuery = highlightQuery;\n+        }\n     }\n }\ndiff --git a/src/test/java/org/elasticsearch/search/highlight/HighlighterSearchTests.java b/src/test/java/org/elasticsearch/search/highlight/HighlighterSearchTests.java\nindex 1857b9a..27496a8 100644\n--- a/src/test/java/org/elasticsearch/search/highlight/HighlighterSearchTests.java\n+++ b/src/test/java/org/elasticsearch/search/highlight/HighlighterSearchTests.java\n@@ -1598,4 +1598,75 @@ public class HighlighterSearchTests extends AbstractIntegrationTest {\n         assertThat(response.getFailedShards(), equalTo(0));\n     }\n \n+    @Test\n+    public void testCustomHighlightQuery() throws Exception {\n+        wipeIndex(\"test\");\n+        client().admin().indices().prepareCreate(\"test\").execute().actionGet();\n+        client().admin().cluster().prepareHealth(\"test\").setWaitForGreenStatus().execute().actionGet();\n+\n+        client().prepareIndex(\"test\", \"type1\", \"1\")\n+                .setSource(\"field1\", \"The quick brown fox jumps over the lazy dog\")\n+                .setRefresh(true).execute().actionGet();\n+\n+        // Search for \"lazy\" but highlight \"quick\" and \"brown\" using a custom highlight query\n+        SearchSourceBuilder source = searchSource()\n+                .query(termQuery(\"field1\", \"lazy\"))\n+                .from(0).size(60).explain(true)\n+                .highlight(highlight().field(new HighlightBuilder.Field(\"field1\")\n+                        .highlightQuery(QueryBuilders.boolQuery()\n+                                .should(termQuery(\"field1\", \"quick\"))\n+                                .should(termQuery(\"field1\", \"brown\"))))\n+                        .preTags(\"<em>\").postTags(\"</em>\"));\n+\n+        SearchResponse searchResponse = client().search(searchRequest(\"test\").source(source).searchType(QUERY_THEN_FETCH)).actionGet();\n+        assertNoFailures(searchResponse);\n+        assertThat(searchResponse.getHits().totalHits(), equalTo(1l));\n+\n+        // The document should be found by searching for \"lazy\", but highlighting should show \"quick\" and \"brown\"\n+        assertThat(searchResponse.getHits().getAt(0).highlightFields().get(\"field1\").fragments()[0].string(),\n+                equalTo(\"The <em>quick</em> <em>brown</em> fox jumps over the lazy dog\"));\n+    }\n+\n+    @Test\n+    public void testCustomHighlightQueryWithFastVectorHighlighter() throws Exception {\n+        wipeIndex(\"test\");\n+        client().admin().indices().prepareCreate(\"test\")\n+                .addMapping(\"type1\", jsonBuilder()\n+                        .startObject()\n+                            .startObject(\"type1\")\n+                                .startObject(\"properties\")\n+                                    .startObject(\"field1\")\n+                                        .field(\"type\", \"string\")\n+                                        .field(\"term_vector\", \"with_positions_offsets\")\n+                                    .endObject()\n+                                .endObject()\n+                            .endObject()\n+                        .endObject())\n+                .execute().actionGet();\n+        client().admin().cluster().prepareHealth(\"test\").setWaitForGreenStatus().execute().actionGet();\n+\n+        client().prepareIndex(\"test\", \"type1\", \"1\")\n+                .setSource(\"field1\", \"The quick brown fox jumps over the lazy dog\")\n+                .setRefresh(true).execute().actionGet();\n+\n+        // Search for \"lazy\" but highlight \"quick\" and \"brown\" using a custom highlight query with FVH\n+        SearchSourceBuilder source = searchSource()\n+                .query(termQuery(\"field1\", \"lazy\"))\n+                .from(0).size(60).explain(true)\n+                .highlight(highlight().field(new HighlightBuilder.Field(\"field1\")\n+                        .highlightQuery(QueryBuilders.boolQuery()\n+                                .should(termQuery(\"field1\", \"quick\"))\n+                                .should(termQuery(\"field1\", \"brown\")))\n+                        .highlighterType(\"fast-vector-highlighter\"))\n+                        .preTags(\"<em>\").postTags(\"</em>\"));\n+\n+        SearchResponse searchResponse = client().search(searchRequest(\"test\").source(source).searchType(QUERY_THEN_FETCH)).actionGet();\n+        assertNoFailures(searchResponse);\n+        assertThat(searchResponse.getHits().totalHits(), equalTo(1l));\n+\n+        // The document should be found by searching for \"lazy\", but highlighting should show \"quick\" and \"brown\"\n+        assertThat(searchResponse.getHits().getAt(0).highlightFields().get(\"field1\").fragments()[0].string(),\n+                equalTo(\"The <em>quick</em> <em>brown</em> fox jumps over the lazy dog\"));\n+    }\n+\n }",
  "logs_path": "auggie/sonnet4.5/7ad89f22/elastic_elasticsearch_pr3632/logs.jsonl",
  "errors": [],
  "edit_run_id": "7ad89f22",
  "test_label": "v1-rollouts-1-3-sonnet4.5"
}