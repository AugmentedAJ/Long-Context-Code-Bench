{
  "repo_url": "https://github.com/elastic/elasticsearch.git",
  "pr_number": 4212,
  "base_commit": "22852d8040df7c789e0cdbb32d33ef1e5cc76435",
  "runner": "auggie",
  "model": "sonnet4.5",
  "timeout_s": 1800,
  "status": "success",
  "elapsed_ms": 176875,
  "patch_unified": "diff --git a/src/main/java/org/elasticsearch/repositories/RepositoriesService.java b/src/main/java/org/elasticsearch/repositories/RepositoriesService.java\nindex 0f9d59d..2d332cd 100644\n--- a/src/main/java/org/elasticsearch/repositories/RepositoriesService.java\n+++ b/src/main/java/org/elasticsearch/repositories/RepositoriesService.java\n@@ -27,6 +27,8 @@ import org.elasticsearch.cluster.ack.ClusterStateUpdateResponse;\n import org.elasticsearch.cluster.metadata.MetaData;\n import org.elasticsearch.cluster.metadata.RepositoriesMetaData;\n import org.elasticsearch.cluster.metadata.RepositoryMetaData;\n+import org.elasticsearch.cluster.metadata.RestoreMetaData;\n+import org.elasticsearch.cluster.metadata.SnapshotMetaData;\n import org.elasticsearch.cluster.node.DiscoveryNode;\n import org.elasticsearch.common.Nullable;\n import org.elasticsearch.common.component.AbstractComponent;\n@@ -72,6 +74,37 @@ public class RepositoriesService extends AbstractComponent implements ClusterSta\n         }\n     }\n \n+    /**\n+     * Checks if a repository is currently in use by any snapshot or restore operations\n+     *\n+     * @param repositoryName repository name to check\n+     * @param clusterState   current cluster state\n+     * @return true if repository is in use, false otherwise\n+     */\n+    private boolean isRepositoryInUse(String repositoryName, ClusterState clusterState) {\n+        // Check if repository is used by any snapshot operations\n+        SnapshotMetaData snapshots = clusterState.metaData().custom(SnapshotMetaData.TYPE);\n+        if (snapshots != null) {\n+            for (SnapshotMetaData.Entry entry : snapshots.entries()) {\n+                if (repositoryName.equals(entry.snapshotId().getRepository())) {\n+                    return true;\n+                }\n+            }\n+        }\n+\n+        // Check if repository is used by any restore operations\n+        RestoreMetaData restores = clusterState.metaData().custom(RestoreMetaData.TYPE);\n+        if (restores != null) {\n+            for (RestoreMetaData.Entry entry : restores.entries()) {\n+                if (repositoryName.equals(entry.snapshotId().getRepository())) {\n+                    return true;\n+                }\n+            }\n+        }\n+\n+        return false;\n+    }\n+\n     /**\n      * Registers new repository in the cluster\n      * <p/>\n@@ -87,14 +120,24 @@ public class RepositoriesService extends AbstractComponent implements ClusterSta\n         clusterService.submitStateUpdateTask(request.cause, new AckedClusterStateUpdateTask() {\n             @Override\n             public ClusterState execute(ClusterState currentState) {\n+                // Check if repository is currently in use\n+                MetaData metaData = currentState.metaData();\n+                RepositoriesMetaData repositories = metaData.custom(RepositoriesMetaData.TYPE);\n+                if (repositories != null && repositories.repository(request.name) != null) {\n+                    // Repository exists, check if it's in use before allowing modification\n+                    if (isRepositoryInUse(request.name, currentState)) {\n+                        throw new RepositoryInUseException(request.name,\n+                            \"cannot modify repository that is currently used by snapshot or restore operations\");\n+                    }\n+                }\n+\n                 // Trying to create the new repository on master to make sure it works\n                 if (!registerRepository(newRepositoryMetaData)) {\n                     // The new repository has the same settings as the old one - ignore\n                     return currentState;\n                 }\n-                MetaData metaData = currentState.metaData();\n                 MetaData.Builder mdBuilder = MetaData.builder(currentState.metaData());\n-                RepositoriesMetaData repositories = metaData.custom(RepositoriesMetaData.TYPE);\n+                repositories = metaData.custom(RepositoriesMetaData.TYPE);\n                 if (repositories == null) {\n                     logger.info(\"put repository [{}]\", request.name);\n                     repositories = new RepositoriesMetaData(new RepositoryMetaData(request.name, request.type, request.settings));\n@@ -172,6 +215,12 @@ public class RepositoriesService extends AbstractComponent implements ClusterSta\n         clusterService.submitStateUpdateTask(request.cause, new AckedClusterStateUpdateTask() {\n             @Override\n             public ClusterState execute(ClusterState currentState) {\n+                // Check if repository is currently in use\n+                if (isRepositoryInUse(request.name, currentState)) {\n+                    throw new RepositoryInUseException(request.name,\n+                        \"cannot delete repository that is currently used by snapshot or restore operations\");\n+                }\n+\n                 MetaData metaData = currentState.metaData();\n                 MetaData.Builder mdBuilder = MetaData.builder(currentState.metaData());\n                 RepositoriesMetaData repositories = metaData.custom(RepositoriesMetaData.TYPE);",
  "logs_path": "auggie/sonnet4.5/7ad89f22/elastic_elasticsearch_pr4212/logs.jsonl",
  "errors": [],
  "edit_run_id": "7ad89f22",
  "test_label": "v1-rollouts-1-3-sonnet4.5"
}