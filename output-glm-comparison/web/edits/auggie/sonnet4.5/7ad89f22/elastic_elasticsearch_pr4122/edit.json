{
  "repo_url": "https://github.com/elastic/elasticsearch.git",
  "pr_number": 4122,
  "base_commit": "6f286c338207f2a333294e9e576d0f1319981148",
  "runner": "auggie",
  "model": "sonnet4.5",
  "timeout_s": 1800,
  "status": "success",
  "elapsed_ms": 226085,
  "patch_unified": "diff --git a/src/main/java/org/apache/lucene/search/XLuceneConstantScoreQuery.java b/src/main/java/org/apache/lucene/search/XLuceneConstantScoreQuery.java\nindex 64e63f3..c4bd047 100644\n--- a/src/main/java/org/apache/lucene/search/XLuceneConstantScoreQuery.java\n+++ b/src/main/java/org/apache/lucene/search/XLuceneConstantScoreQuery.java\n@@ -19,6 +19,7 @@ package org.apache.lucene.search;\n \n import org.apache.lucene.index.AtomicReaderContext;\n import org.apache.lucene.index.IndexReader;\n+import org.apache.lucene.index.Term;\n import org.apache.lucene.util.Bits;\n import org.apache.lucene.util.Version;\n import org.elasticsearch.common.lucene.Lucene;\n@@ -26,6 +27,7 @@ import org.elasticsearch.common.lucene.Lucene;\n import java.io.IOException;\n import java.util.Collection;\n import java.util.Collections;\n+import java.util.Set;\n \n /**\n  * Extension of {@link ConstantScoreQuery} that works around LUCENE-5307.\n@@ -69,6 +71,14 @@ public class XLuceneConstantScoreQuery extends ConstantScoreQuery {\n         return this;\n     }\n \n+    @Override\n+    public void extractTerms(Set<Term> terms) {\n+        // If we wrap a query (not a filter), extract its terms\n+        if (query != null) {\n+            query.extractTerms(terms);\n+        }\n+    }\n+\n     @Override\n     public Weight createWeight(IndexSearcher searcher) throws IOException {\n         return new XConstantWeight(searcher);\ndiff --git a/src/test/java/org/elasticsearch/search/highlight/HighlighterSearchTests.java b/src/test/java/org/elasticsearch/search/highlight/HighlighterSearchTests.java\nindex f0356d0..cbdb8f0 100644\n--- a/src/test/java/org/elasticsearch/search/highlight/HighlighterSearchTests.java\n+++ b/src/test/java/org/elasticsearch/search/highlight/HighlighterSearchTests.java\n@@ -2020,6 +2020,22 @@ public class HighlighterSearchTests extends AbstractIntegrationTest {\n         assertHighlight(searchResponse, 0, \"field2\", 0, 1, equalTo(\"The <x>quick</x> <x>brown</x> fox jumps over the lazy dog!\"));\n     }\n \n+    @Test\n+    public void testPostingsHighlighterConstantScoreQuery() throws ElasticSearchException, IOException {\n+        assertAcked(client().admin().indices().prepareCreate(\"test\").addMapping(\"type1\", type1PostingsffsetsMapping()));\n+        ensureGreen();\n+\n+        client().prepareIndex(\"test\", \"type1\").setSource(\"field1\", \"this is a test\", \"field2\", \"The quick brown fox jumps over the lazy dog! Second sentence.\").get();\n+        refresh();\n+        logger.info(\"--> highlighting and searching on field2 with constant score query\");\n+        SearchSourceBuilder source = searchSource().query(constantScoreQuery(termQuery(\"field2\", \"quick\")))\n+                .highlight(highlight().field(\"field2\").preTags(\"<x>\").postTags(\"</x>\"));\n+        SearchResponse searchResponse = client().search(searchRequest(\"test\").source(source)).actionGet();\n+        assertHitCount(searchResponse, 1l);\n+\n+        assertHighlight(searchResponse, 0, \"field2\", 0, 1, equalTo(\"The <x>quick</x> brown fox jumps over the lazy dog!\"));\n+    }\n+\n     public XContentBuilder type1PostingsffsetsMapping() throws IOException {\n         return XContentFactory.jsonBuilder().startObject().startObject(\"type1\")\n                 .startObject(\"_all\").field(\"store\", \"yes\").field(\"index_options\", \"offsets\").endObject()",
  "logs_path": "auggie/sonnet4.5/7ad89f22/elastic_elasticsearch_pr4122/logs.jsonl",
  "errors": [],
  "edit_run_id": "7ad89f22",
  "test_label": "v1-rollouts-1-3-sonnet4.5"
}