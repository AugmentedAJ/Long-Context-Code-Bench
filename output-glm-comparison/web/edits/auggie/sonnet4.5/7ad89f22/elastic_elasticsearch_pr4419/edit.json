{
  "repo_url": "https://github.com/elastic/elasticsearch.git",
  "pr_number": 4419,
  "base_commit": "4e7ce4ee02a85ca02b8a07a27ae4e82341e2db39",
  "runner": "auggie",
  "model": "sonnet4.5",
  "timeout_s": 1800,
  "status": "success",
  "elapsed_ms": 269924,
  "patch_unified": "diff --git a/src/main/java/org/elasticsearch/index/shard/service/InternalIndexShard.java b/src/main/java/org/elasticsearch/index/shard/service/InternalIndexShard.java\nindex 1eaf50f..143f91f 100644\n--- a/src/main/java/org/elasticsearch/index/shard/service/InternalIndexShard.java\n+++ b/src/main/java/org/elasticsearch/index/shard/service/InternalIndexShard.java\n@@ -173,6 +173,7 @@ public class InternalIndexShard extends AbstractIndexShardComponent implements I\n         this.indexService = indexService;\n         this.codecService = codecService;\n         state = IndexShardState.CREATED;\n+        this.indicesLifecycle.indexShardStateChanged(this, null, IndexShardState.CREATED, \"shard created\");\n \n         this.refreshInterval = indexSettings.getAsTime(\"engine.robin.refresh_interval\", indexSettings.getAsTime(INDEX_REFRESH_INTERVAL, engine.defaultRefreshInterval()));\n         this.mergeInterval = indexSettings.getAsTime(\"index.merge.async_interval\", TimeValue.timeValueSeconds(1));\n@@ -286,9 +287,11 @@ public class InternalIndexShard extends AbstractIndexShardComponent implements I\n                 }\n \n                 boolean movedToStarted = false;\n+                IndexShardState previousState = null;\n                 synchronized (mutex) {\n                     // do the check under a mutex, so we make sure to only change to STARTED if in POST_RECOVERY\n                     if (state == IndexShardState.POST_RECOVERY) {\n+                        previousState = state;\n                         logger.debug(\"state: [{}]->[{}], reason [global state is [{}]]\", state, IndexShardState.STARTED, newRouting.state());\n                         state = IndexShardState.STARTED;\n                         movedToStarted = true;\n@@ -297,6 +300,7 @@ public class InternalIndexShard extends AbstractIndexShardComponent implements I\n                     }\n                 }\n                 if (movedToStarted) {\n+                    indicesLifecycle.indexShardStateChanged(this, previousState, IndexShardState.STARTED, \"global state is [\" + newRouting.state() + \"]\");\n                     indicesLifecycle.afterIndexShardStarted(this);\n                 }\n             }\n@@ -313,6 +317,7 @@ public class InternalIndexShard extends AbstractIndexShardComponent implements I\n      */\n     public IndexShardState recovering(String reason) throws IndexShardStartedException,\n             IndexShardRelocatedException, IndexShardRecoveringException, IndexShardClosedException {\n+        IndexShardState previousState;\n         synchronized (mutex) {\n             IndexShardState returnValue = state;\n             if (state == IndexShardState.CLOSED) {\n@@ -331,19 +336,24 @@ public class InternalIndexShard extends AbstractIndexShardComponent implements I\n                 throw new IndexShardRecoveringException(shardId);\n             }\n             logger.debug(\"state: [{}]->[{}], reason [{}]\", state, IndexShardState.RECOVERING, reason);\n+            previousState = state;\n             state = IndexShardState.RECOVERING;\n+            indicesLifecycle.indexShardStateChanged(this, previousState, IndexShardState.RECOVERING, reason);\n             return returnValue;\n         }\n     }\n \n     public InternalIndexShard relocated(String reason) throws IndexShardNotStartedException {\n+        IndexShardState previousState;\n         synchronized (mutex) {\n             if (state != IndexShardState.STARTED) {\n                 throw new IndexShardNotStartedException(shardId, state);\n             }\n             logger.debug(\"state: [{}]->[{}], reason [{}]\", state, IndexShardState.RELOCATED, reason);\n+            previousState = state;\n             state = IndexShardState.RELOCATED;\n         }\n+        indicesLifecycle.indexShardStateChanged(this, previousState, IndexShardState.RELOCATED, reason);\n         return this;\n     }\n \n@@ -641,6 +651,7 @@ public class InternalIndexShard extends AbstractIndexShardComponent implements I\n     }\n \n     public void close(String reason) {\n+        IndexShardState previousState;\n         synchronized (mutex) {\n             indexSettingsService.removeListener(applyRefreshSettings);\n             if (state != IndexShardState.CLOSED) {\n@@ -656,8 +667,10 @@ public class InternalIndexShard extends AbstractIndexShardComponent implements I\n             if (logger.isDebugEnabled()) {\n                 logger.debug(\"state: [{}]->[{}], reason [{}]\", state, IndexShardState.CLOSED, reason);\n             }\n+            previousState = state;\n             state = IndexShardState.CLOSED;\n         }\n+        indicesLifecycle.indexShardStateChanged(this, previousState, IndexShardState.CLOSED, reason);\n     }\n \n     public long checkIndexTook() {\n@@ -666,6 +679,7 @@ public class InternalIndexShard extends AbstractIndexShardComponent implements I\n \n \n     public InternalIndexShard postRecovery(String reason) throws IndexShardStartedException, IndexShardRelocatedException, IndexShardClosedException {\n+        IndexShardState previousState;\n         synchronized (mutex) {\n             if (state == IndexShardState.CLOSED) {\n                 throw new IndexShardClosedException(shardId);\n@@ -682,8 +696,10 @@ public class InternalIndexShard extends AbstractIndexShardComponent implements I\n             engine.start();\n             startScheduledTasksIfNeeded();\n             logger.debug(\"state: [{}]->[{}], reason [{}]\", state, IndexShardState.POST_RECOVERY, reason);\n+            previousState = state;\n             state = IndexShardState.POST_RECOVERY;\n         }\n+        indicesLifecycle.indexShardStateChanged(this, previousState, IndexShardState.POST_RECOVERY, reason);\n         indicesLifecycle.afterIndexShardPostRecovery(this);\n         return this;\n     }\n@@ -724,10 +740,13 @@ public class InternalIndexShard extends AbstractIndexShardComponent implements I\n         // clear unreferenced files\n         translog.clearUnreferenced();\n         engine.refresh(new Engine.Refresh(\"recovery_finalization\").force(true));\n+        IndexShardState previousState;\n         synchronized (mutex) {\n             logger.debug(\"state: [{}]->[{}], reason [post recovery]\", state, IndexShardState.POST_RECOVERY);\n+            previousState = state;\n             state = IndexShardState.POST_RECOVERY;\n         }\n+        indicesLifecycle.indexShardStateChanged(this, previousState, IndexShardState.POST_RECOVERY, \"post recovery\");\n         indicesLifecycle.afterIndexShardPostRecovery(this);\n         startScheduledTasksIfNeeded();\n         engine.enableGcDeletes(true);\ndiff --git a/src/main/java/org/elasticsearch/indices/IndicesLifecycle.java b/src/main/java/org/elasticsearch/indices/IndicesLifecycle.java\nindex 9c95dd5..d31481a 100644\n--- a/src/main/java/org/elasticsearch/indices/IndicesLifecycle.java\n+++ b/src/main/java/org/elasticsearch/indices/IndicesLifecycle.java\n@@ -23,6 +23,7 @@ import org.elasticsearch.cluster.routing.ShardRouting;\n import org.elasticsearch.common.Nullable;\n import org.elasticsearch.index.Index;\n import org.elasticsearch.index.service.IndexService;\n+import org.elasticsearch.index.shard.IndexShardState;\n import org.elasticsearch.index.shard.ShardId;\n import org.elasticsearch.index.shard.service.IndexShard;\n \n@@ -58,6 +59,18 @@ public interface IndicesLifecycle {\n \n         }\n \n+        /**\n+         * Called when the shard state has changed.\n+         *\n+         * @param indexShard The index shard\n+         * @param previousState The previous shard state (can be null)\n+         * @param currentState The current shard state\n+         * @param reason The reason for the state change\n+         */\n+        public void indexShardStateChanged(IndexShard indexShard, @Nullable IndexShardState previousState, IndexShardState currentState, @Nullable String reason) {\n+\n+        }\n+\n         /**\n          * Called before the index gets created.\n          */\ndiff --git a/src/main/java/org/elasticsearch/indices/InternalIndicesLifecycle.java b/src/main/java/org/elasticsearch/indices/InternalIndicesLifecycle.java\nindex b196f9e..73037ed 100644\n--- a/src/main/java/org/elasticsearch/indices/InternalIndicesLifecycle.java\n+++ b/src/main/java/org/elasticsearch/indices/InternalIndicesLifecycle.java\n@@ -26,6 +26,7 @@ import org.elasticsearch.common.inject.Inject;\n import org.elasticsearch.common.settings.Settings;\n import org.elasticsearch.index.Index;\n import org.elasticsearch.index.service.IndexService;\n+import org.elasticsearch.index.shard.IndexShardState;\n import org.elasticsearch.index.shard.ShardId;\n import org.elasticsearch.index.shard.service.IndexShard;\n \n@@ -61,6 +62,16 @@ public class InternalIndicesLifecycle extends AbstractComponent implements Indic\n         }\n     }\n \n+    public void indexShardStateChanged(IndexShard indexShard, @Nullable IndexShardState previousState, IndexShardState currentState, @Nullable String reason) {\n+        for (Listener listener : listeners) {\n+            try {\n+                listener.indexShardStateChanged(indexShard, previousState, currentState, reason);\n+            } catch (Throwable t) {\n+                logger.warn(\"{} failed to invoke shard state changed callback\", t, indexShard.shardId());\n+            }\n+        }\n+    }\n+\n     public void beforeIndexCreated(Index index) {\n         for (Listener listener : listeners) {\n             try {",
  "logs_path": "auggie/sonnet4.5/7ad89f22/elastic_elasticsearch_pr4419/logs.jsonl",
  "errors": [],
  "edit_run_id": "7ad89f22",
  "test_label": "v1-rollouts-1-3-sonnet4.5"
}