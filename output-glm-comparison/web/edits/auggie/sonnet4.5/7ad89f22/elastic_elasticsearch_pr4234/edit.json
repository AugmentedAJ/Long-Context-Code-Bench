{
  "repo_url": "https://github.com/elastic/elasticsearch.git",
  "pr_number": 4234,
  "base_commit": "7d3b78c29327a1774695c4567bab0c40e7b97b6a",
  "runner": "auggie",
  "model": "sonnet4.5",
  "timeout_s": 1800,
  "status": "success",
  "elapsed_ms": 192118,
  "patch_unified": "diff --git a/src/main/java/org/elasticsearch/cluster/routing/operation/plain/PlainOperationRouting.java b/src/main/java/org/elasticsearch/cluster/routing/operation/plain/PlainOperationRouting.java\nindex 3b5376a..845d68a 100644\n--- a/src/main/java/org/elasticsearch/cluster/routing/operation/plain/PlainOperationRouting.java\n+++ b/src/main/java/org/elasticsearch/cluster/routing/operation/plain/PlainOperationRouting.java\n@@ -219,7 +219,11 @@ public class PlainOperationRouting extends AbstractComponent implements Operatio\n                 return indexShard.onlyNodeActiveInitializingShardsIt(localNodeId);\n             }\n             if (preference.startsWith(\"_only_node:\")) {\n-                return indexShard.onlyNodeActiveInitializingShardsIt(preference.substring(\"_only_node:\".length()));\n+                String nodeId = preference.substring(\"_only_node:\".length());\n+                if (!nodes.nodeExists(nodeId)) {\n+                    throw new ElasticSearchIllegalArgumentException(\"no node with id[\" + nodeId + \"] found for _only_node preference\");\n+                }\n+                return indexShard.onlyNodeActiveInitializingShardsIt(nodeId);\n             }\n         }\n         // if not, then use it as the index\ndiff --git a/src/test/java/org/elasticsearch/cluster/structure/RoutingIteratorTests.java b/src/test/java/org/elasticsearch/cluster/structure/RoutingIteratorTests.java\nindex a0721e4..4c29058 100644\n--- a/src/test/java/org/elasticsearch/cluster/structure/RoutingIteratorTests.java\n+++ b/src/test/java/org/elasticsearch/cluster/structure/RoutingIteratorTests.java\n@@ -21,6 +21,7 @@ package org.elasticsearch.cluster.structure;\n \n import com.google.common.collect.ImmutableList;\n import com.google.common.collect.ImmutableMap;\n+import org.elasticsearch.ElasticSearchIllegalArgumentException;\n import org.elasticsearch.cluster.ClusterState;\n import org.elasticsearch.cluster.metadata.IndexMetaData;\n import org.elasticsearch.cluster.metadata.MetaData;\n@@ -358,4 +359,41 @@ public class RoutingIteratorTests extends ElasticsearchTestCase {\n         assertThat(shardIterators.iterator().next().shardId().id(), equalTo(0));\n         assertThat(shardIterators.iterator().next().nextOrNull().currentNodeId(), equalTo(\"node1\"));\n     }\n+\n+    @Test\n+    public void testOnlyNodePreferenceWithNonExistingNode() {\n+        AllocationService strategy = new AllocationService(settingsBuilder()\n+                .put(\"cluster.routing.allocation.concurrent_recoveries\", 10)\n+                .build());\n+\n+        MetaData metaData = MetaData.builder()\n+                .put(IndexMetaData.builder(\"test\").numberOfShards(1).numberOfReplicas(1))\n+                .build();\n+\n+        RoutingTable routingTable = RoutingTable.builder()\n+                .addAsNew(metaData.index(\"test\"))\n+                .build();\n+\n+        ClusterState clusterState = ClusterState.builder().metaData(metaData).routingTable(routingTable).build();\n+\n+        clusterState = ClusterState.builder(clusterState).nodes(DiscoveryNodes.builder()\n+                .put(newNode(\"node1\"))\n+                .put(newNode(\"node2\"))\n+                .localNodeId(\"node1\")\n+        ).build();\n+        routingTable = strategy.reroute(clusterState).routingTable();\n+        clusterState = ClusterState.builder(clusterState).routingTable(routingTable).build();\n+\n+        routingTable = strategy.applyStartedShards(clusterState, clusterState.routingNodes().shardsWithState(INITIALIZING)).routingTable();\n+        clusterState = ClusterState.builder(clusterState).routingTable(routingTable).build();\n+\n+        PlainOperationRouting operationRouting = new PlainOperationRouting(ImmutableSettings.Builder.EMPTY_SETTINGS, new DjbHashFunction(), new AwarenessAllocationDecider());\n+\n+        try {\n+            operationRouting.searchShards(clusterState, new String[]{\"test\"}, new String[]{\"test\"}, null, \"_only_node:non_existing_node\");\n+            fail(\"Expected ElasticSearchIllegalArgumentException\");\n+        } catch (ElasticSearchIllegalArgumentException e) {\n+            assertThat(e.getMessage(), containsString(\"no node with id[non_existing_node] found\"));\n+        }\n+    }\n }\n\\ No newline at end of file\ndiff --git a/src/test/java/org/elasticsearch/search/preference/SearchPreferenceTests.java b/src/test/java/org/elasticsearch/search/preference/SearchPreferenceTests.java\nindex 870303d..0dd222b 100644\n--- a/src/test/java/org/elasticsearch/search/preference/SearchPreferenceTests.java\n+++ b/src/test/java/org/elasticsearch/search/preference/SearchPreferenceTests.java\n@@ -19,6 +19,7 @@\n \n package org.elasticsearch.search.preference;\n \n+import org.elasticsearch.ElasticSearchIllegalArgumentException;\n import org.elasticsearch.action.admin.cluster.health.ClusterHealthStatus;\n import org.elasticsearch.action.search.SearchResponse;\n import org.elasticsearch.action.search.SearchType;\n@@ -96,4 +97,20 @@ public class SearchPreferenceTests extends ElasticsearchIntegrationTest {\n         searchResponse = client().prepareSearch().setQuery(matchAllQuery()).setPreference(\"1234\").execute().actionGet();\n         assertThat(searchResponse.getHits().totalHits(), equalTo(1l));\n     }\n+\n+    @Test\n+    public void testOnlyNodePreferenceWithNonExistingNode() throws Exception {\n+        createIndex(\"test\");\n+        client().admin().cluster().prepareHealth().setWaitForEvents(Priority.LANGUID).setWaitForGreenStatus().execute().actionGet();\n+\n+        client().prepareIndex(\"test\", \"type1\").setSource(\"field1\", \"value1\").execute().actionGet();\n+        client().admin().indices().prepareRefresh().execute().actionGet();\n+\n+        try {\n+            client().prepareSearch().setQuery(matchAllQuery()).setPreference(\"_only_node:non_existing_node\").execute().actionGet();\n+            fail(\"Expected ElasticSearchIllegalArgumentException\");\n+        } catch (ElasticSearchIllegalArgumentException e) {\n+            assertThat(e.getMessage(), containsString(\"no node with id[non_existing_node] found\"));\n+        }\n+    }\n }",
  "logs_path": "auggie/sonnet4.5/7ad89f22/elastic_elasticsearch_pr4234/logs.jsonl",
  "errors": [],
  "edit_run_id": "7ad89f22",
  "test_label": "v1-rollouts-1-3-sonnet4.5"
}