{
  "repo_url": "https://github.com/elastic/elasticsearch.git",
  "pr_number": 134955,
  "base_commit": "8272fc895484bdcf635a3828616e03183cac283d",
  "runner": "auggie",
  "model": "sonnet4.5",
  "timeout_s": 1800,
  "status": "success",
  "elapsed_ms": 305099,
  "patch_unified": "diff --git a/x-pack/plugin/transform/src/main/java/org/elasticsearch/xpack/transform/transforms/ClientTransformIndexer.java b/x-pack/plugin/transform/src/main/java/org/elasticsearch/xpack/transform/transforms/ClientTransformIndexer.java\nindex c7fd6df4..7b8fba5f 100644\n--- a/x-pack/plugin/transform/src/main/java/org/elasticsearch/xpack/transform/transforms/ClientTransformIndexer.java\n+++ b/x-pack/plugin/transform/src/main/java/org/elasticsearch/xpack/transform/transforms/ClientTransformIndexer.java\n@@ -25,7 +25,9 @@ import org.elasticsearch.action.search.SearchResponse;\n import org.elasticsearch.action.search.TransportClosePointInTimeAction;\n import org.elasticsearch.action.search.TransportOpenPointInTimeAction;\n import org.elasticsearch.action.search.TransportSearchAction;\n+import org.elasticsearch.action.support.GroupedActionListener;\n import org.elasticsearch.action.support.IndicesOptions;\n+import org.elasticsearch.action.support.UnsafePlainActionFuture;\n import org.elasticsearch.action.support.master.AcknowledgedRequest;\n import org.elasticsearch.client.internal.ParentTaskAssigningClient;\n import org.elasticsearch.cluster.block.ClusterBlockLevel;\n@@ -435,7 +437,7 @@ class ClientTransformIndexer extends TransformIndexer {\n \n     @Override\n     protected void afterFinishOrFailure() {\n-        closePointInTime();\n+        closePointInTimeSync();\n         super.afterFinishOrFailure();\n     }\n \n@@ -477,20 +479,48 @@ class ClientTransformIndexer extends TransformIndexer {\n \n     @Override\n     protected void onStop() {\n-        closePointInTime();\n+        closePointInTimeSync();\n         super.onStop();\n     }\n \n-    private void closePointInTime() {\n-        for (String name : namedPits.keySet()) {\n-            closePointInTime(name);\n+    private void closePointInTimeSync() {\n+        if (namedPits.isEmpty()) {\n+            return;\n+        }\n+\n+        // Use UnsafePlainActionFuture to wait for all PIT close requests to complete\n+        var future = new UnsafePlainActionFuture<Void>(ThreadPool.Names.GENERIC);\n+        closePointInTime(future);\n+\n+        try {\n+            // Wait for all PIT close requests to complete with a reasonable timeout\n+            future.actionGet(TimeValue.timeValueSeconds(30));\n+        } catch (Exception e) {\n+            // Log the error but don't fail the checkpoint completion\n+            logger.warn(() -> \"[\" + getJobId() + \"] Failed to wait for all PIT close requests to complete\", e);\n         }\n     }\n \n-    private void closePointInTime(String name) {\n+    private void closePointInTime(ActionListener<Void> listener) {\n+        if (namedPits.isEmpty()) {\n+            listener.onResponse(null);\n+            return;\n+        }\n+\n+        // Collect all PIT names to close\n+        var pitNames = new java.util.ArrayList<>(namedPits.keySet());\n+        var groupedListener = new GroupedActionListener<>(pitNames.size(), listener.map(responses -> null));\n+\n+        for (String name : pitNames) {\n+            closePointInTime(name, groupedListener);\n+        }\n+    }\n+\n+    private void closePointInTime(String name, ActionListener<Void> listener) {\n         PointInTimeBuilder pit = namedPits.remove(name);\n \n         if (pit == null) {\n+            listener.onResponse(null);\n             return;\n         }\n \n@@ -505,9 +535,12 @@ class ClientTransformIndexer extends TransformIndexer {\n             closePitRequest,\n             ActionListener.wrap(response -> {\n                 logger.trace(\"[{}] closed pit search context [{}]\", getJobId(), oldPit);\n+                listener.onResponse(null);\n             }, e -> {\n                 // note: closing the pit should never throw, even if the pit is invalid\n                 logger.error(() -> \"[\" + getJobId() + \"] Failed to close point in time reader\", e);\n+                // Still call onResponse to not block the grouped listener\n+                listener.onResponse(null);\n             })\n         );\n     }",
  "logs_path": "auggie/sonnet4.5/7ad89f22/elastic_elasticsearch_pr134955/logs.jsonl",
  "errors": [],
  "edit_run_id": "7ad89f22",
  "test_label": "v1-rollouts-1-3-sonnet4.5"
}