{
  "repo_url": "https://github.com/elastic/elasticsearch.git",
  "pr_number": 4129,
  "base_commit": "f7d5d1e5c9a04117f780a62cac970dbe24ddebf7",
  "runner": "auggie",
  "model": "sonnet4.5",
  "timeout_s": 1800,
  "status": "success",
  "elapsed_ms": 235554,
  "patch_unified": "diff --git a/src/main/java/org/elasticsearch/search/suggest/completion/CompletionTokenStream.java b/src/main/java/org/elasticsearch/search/suggest/completion/CompletionTokenStream.java\nindex 260bd57..b423fd0 100644\n--- a/src/main/java/org/elasticsearch/search/suggest/completion/CompletionTokenStream.java\n+++ b/src/main/java/org/elasticsearch/search/suggest/completion/CompletionTokenStream.java\n@@ -19,12 +19,15 @@\n package org.elasticsearch.search.suggest.completion;\n \n import org.apache.lucene.analysis.TokenStream;\n+import org.apache.lucene.analysis.tokenattributes.CharTermAttribute;\n import org.apache.lucene.analysis.tokenattributes.PayloadAttribute;\n import org.apache.lucene.analysis.tokenattributes.PositionIncrementAttribute;\n import org.apache.lucene.analysis.tokenattributes.TermToBytesRefAttribute;\n import org.apache.lucene.util.AttributeImpl;\n import org.apache.lucene.util.BytesRef;\n+import org.apache.lucene.util.CharsRef;\n import org.apache.lucene.util.IntsRef;\n+import org.apache.lucene.util.UnicodeUtil;\n import org.apache.lucene.util.fst.Util;\n \n import java.io.IOException;\n@@ -115,8 +118,9 @@ public final class CompletionTokenStream extends TokenStream {\n         public void setBytesRef(BytesRef bytes);\n     }\n \n-    public static final class ByteTermAttributeImpl extends AttributeImpl implements ByteTermAttribute, TermToBytesRefAttribute {\n+    public static final class ByteTermAttributeImpl extends AttributeImpl implements ByteTermAttribute, TermToBytesRefAttribute, CharTermAttribute {\n         private BytesRef bytes;\n+        private final CharsRef charsRef = new CharsRef();\n \n         @Override\n         public int fillBytesRef() {\n@@ -131,16 +135,95 @@ public final class CompletionTokenStream extends TokenStream {\n         @Override\n         public void setBytesRef(BytesRef bytes) {\n             this.bytes = bytes;\n+            // Convert UTF-8 bytes to chars for CharTermAttribute compatibility\n+            if (bytes != null) {\n+                UnicodeUtil.UTF8toUTF16(bytes, charsRef);\n+            } else {\n+                charsRef.length = 0;\n+            }\n         }\n \n         @Override\n         public void clear() {\n+            charsRef.length = 0;\n         }\n \n         @Override\n         public void copyTo(AttributeImpl target) {\n             ByteTermAttributeImpl other = (ByteTermAttributeImpl) target;\n             other.bytes = bytes;\n+            other.charsRef.copyChars(charsRef);\n+        }\n+\n+        // CharTermAttribute implementation\n+        @Override\n+        public void append(CharSequence csq) {\n+            append(csq, 0, csq.length());\n+        }\n+\n+        @Override\n+        public void append(CharSequence csq, int start, int end) {\n+            int len = end - start;\n+            if (len == 0) {\n+                return;\n+            }\n+            resizeBuffer(charsRef.length + len);\n+            for (int i = start; i < end; i++) {\n+                charsRef.chars[charsRef.length++] = csq.charAt(i);\n+            }\n+        }\n+\n+        @Override\n+        public void append(char c) {\n+            resizeBuffer(charsRef.length + 1);\n+            charsRef.chars[charsRef.length++] = c;\n+        }\n+\n+        @Override\n+        public void setLength(int length) {\n+            if (length > charsRef.chars.length) {\n+                throw new IllegalArgumentException(\"length \" + length + \" exceeds buffer size \" + charsRef.chars.length);\n+            }\n+            charsRef.length = length;\n+        }\n+\n+        @Override\n+        public void setEmpty() {\n+            charsRef.length = 0;\n+        }\n+\n+        @Override\n+        public char[] buffer() {\n+            return charsRef.chars;\n+        }\n+\n+        @Override\n+        public char[] resizeBuffer(int newSize) {\n+            charsRef.grow(newSize);\n+            return charsRef.chars;\n+        }\n+\n+        @Override\n+        public int length() {\n+            return charsRef.length;\n+        }\n+\n+        @Override\n+        public CharSequence subSequence(int start, int end) {\n+            return new String(charsRef.chars, start, end - start);\n+        }\n+\n+        @Override\n+        public char charAt(int index) {\n+            if (index >= charsRef.length) {\n+                throw new IndexOutOfBoundsException();\n+            }\n+            return charsRef.chars[index];\n+        }\n+\n+        @Override\n+        public String toString() {\n+            return charsRef.toString();\n         }\n     }\n }\n\\ No newline at end of file",
  "logs_path": "auggie/sonnet4.5/7ad89f22/elastic_elasticsearch_pr4129/logs.jsonl",
  "errors": [],
  "edit_run_id": "7ad89f22",
  "test_label": "v1-rollouts-1-3-sonnet4.5"
}