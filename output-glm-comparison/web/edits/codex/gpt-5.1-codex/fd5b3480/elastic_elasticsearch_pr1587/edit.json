{
  "repo_url": "https://github.com/elastic/elasticsearch.git",
  "pr_number": 1587,
  "base_commit": "df4a3bfd379fd90b3667bbcd7ca2ed4619fee025",
  "runner": "codex",
  "model": "gpt-5.1-codex",
  "timeout_s": 10800,
  "status": "success",
  "elapsed_ms": 59607,
  "patch_unified": "diff --git a/src/test/java/org/elasticsearch/test/integration/ttl/SimpleTTLTests.java b/src/test/java/org/elasticsearch/test/integration/ttl/SimpleTTLTests.java\nindex 89f4ab7..2007668 100644\n--- a/src/test/java/org/elasticsearch/test/integration/ttl/SimpleTTLTests.java\n+++ b/src/test/java/org/elasticsearch/test/integration/ttl/SimpleTTLTests.java\n@@ -19,6 +19,7 @@\n \n package org.elasticsearch.test.integration.ttl;\n \n+import org.elasticsearch.action.get.GetRequestBuilder;\n import org.elasticsearch.action.get.GetResponse;\n import org.elasticsearch.client.Client;\n import org.elasticsearch.common.settings.Settings;\n@@ -60,6 +61,9 @@ public class SimpleTTLTests extends AbstractNodesTests {\n         client.admin().indices().prepareDelete().execute().actionGet();\n \n         client.admin().indices().prepareCreate(\"test\")\n+                .setSettings(settingsBuilder()\n+                        .put(\"index.number_of_shards\", 5)\n+                        .put(\"index.number_of_replicas\", 1))\n                 .addMapping(\"type1\", XContentFactory.jsonBuilder()\n                         .startObject()\n                         .startObject(\"type1\")\n@@ -72,51 +76,49 @@ public class SimpleTTLTests extends AbstractNodesTests {\n         long providedTTLValue = 3000;\n         logger.info(\"--> checking ttl\");\n         client.prepareIndex(\"test\", \"type1\", \"1\").setSource(\"field1\", \"value1\").setTTL(providedTTLValue).setRefresh(true).execute().actionGet();\n+        client.prepareIndex(\"test\", \"type1\", \"2\").setSource(\"field1\", \"value1\").setRouting(\"routing\").setTTL(providedTTLValue).setRefresh(true).execute().actionGet();\n         long now = System.currentTimeMillis();\n \n-        // realtime get check\n-        long now1 = System.currentTimeMillis();\n-        GetResponse getResponse = client.prepareGet(\"test\", \"type1\", \"1\").setFields(\"_ttl\").setRealtime(true).execute().actionGet();\n-        long ttl0 = ((Number) getResponse.field(\"_ttl\").value()).longValue();\n-        assertThat(ttl0, greaterThan(0L));\n-        assertThat(ttl0, lessThan(providedTTLValue - (now1 - now)));\n-        // verify the ttl is still decreasing when going to the replica\n-        now1 = System.currentTimeMillis();\n-        getResponse = client.prepareGet(\"test\", \"type1\", \"1\").setFields(\"_ttl\").setRealtime(true).execute().actionGet();\n-        ttl0 = ((Number) getResponse.field(\"_ttl\").value()).longValue();\n-        assertThat(ttl0, greaterThan(0L));\n-        assertThat(ttl0, lessThan(providedTTLValue - (now1 - now)));\n-        // non realtime get (stored)\n-        now1 = System.currentTimeMillis();\n-        getResponse = client.prepareGet(\"test\", \"type1\", \"1\").setFields(\"_ttl\").setRealtime(false).execute().actionGet();\n-        ttl0 = ((Number) getResponse.field(\"_ttl\").value()).longValue();\n-        assertThat(ttl0, greaterThan(0L));\n-        assertThat(ttl0, lessThan(providedTTLValue - (now1 - now)));\n-        // non realtime get going the replica\n-        now1 = System.currentTimeMillis();\n-        getResponse = client.prepareGet(\"test\", \"type1\", \"1\").setFields(\"_ttl\").setRealtime(false).execute().actionGet();\n-        ttl0 = ((Number) getResponse.field(\"_ttl\").value()).longValue();\n-        assertThat(ttl0, greaterThan(0L));\n-        assertThat(ttl0, lessThan(providedTTLValue - (now1 - now)));\n+        assertTTL(\"1\", null, providedTTLValue, now);\n+        assertTTL(\"2\", \"routing\", providedTTLValue, now);\n \n         logger.info(\"--> checking purger\");\n         // make sure the purger has done its job\n         long shouldBeExpiredDate = now + providedTTLValue + purgeInterval + 2000;\n-        now1 = System.currentTimeMillis();\n+        long now1 = System.currentTimeMillis();\n         if (shouldBeExpiredDate - now1 > 0) {\n             Thread.sleep(shouldBeExpiredDate - now1);\n         }\n-        // realtime get check\n-        getResponse = client.prepareGet(\"test\", \"type1\", \"1\").setFields(\"_ttl\").setRealtime(true).execute().actionGet();\n-        assertThat(getResponse.exists(), equalTo(false));\n-        // replica realtime get check\n-        getResponse = client.prepareGet(\"test\", \"type1\", \"1\").setFields(\"_ttl\").setRealtime(true).execute().actionGet();\n-        assertThat(getResponse.exists(), equalTo(false));\n-        // non realtime get (stored) check\n-        getResponse = client.prepareGet(\"test\", \"type1\", \"1\").setFields(\"_ttl\").setRealtime(false).execute().actionGet();\n-        assertThat(getResponse.exists(), equalTo(false));\n-        // non realtime get going the replica check\n-        getResponse = client.prepareGet(\"test\", \"type1\", \"1\").setFields(\"_ttl\").setRealtime(false).execute().actionGet();\n-        assertThat(getResponse.exists(), equalTo(false));\n+        assertPurged(\"1\", null);\n+        assertPurged(\"2\", \"routing\");\n+    }\n+\n+    private void assertTTL(String id, String routing, long providedTTLValue, long startTime) {\n+        for (boolean realtime : new boolean[]{true, false}) {\n+            for (int i = 0; i < 2; i++) {\n+                long now = System.currentTimeMillis();\n+                GetRequestBuilder getRequestBuilder = client.prepareGet(\"test\", \"type1\", id).setFields(\"_ttl\").setRealtime(realtime);\n+                if (routing != null) {\n+                    getRequestBuilder.setRouting(routing);\n+                }\n+                GetResponse getResponse = getRequestBuilder.execute().actionGet();\n+                long ttl = ((Number) getResponse.field(\"_ttl\").value()).longValue();\n+                assertThat(ttl, greaterThan(0L));\n+                assertThat(ttl, lessThan(providedTTLValue - (now - startTime)));\n+            }\n+        }\n+    }\n+\n+    private void assertPurged(String id, String routing) {\n+        for (boolean realtime : new boolean[]{true, false}) {\n+            for (int i = 0; i < 2; i++) {\n+                GetRequestBuilder getRequestBuilder = client.prepareGet(\"test\", \"type1\", id).setFields(\"_ttl\").setRealtime(realtime);\n+                if (routing != null) {\n+                    getRequestBuilder.setRouting(routing);\n+                }\n+                GetResponse getResponse = getRequestBuilder.execute().actionGet();\n+                assertThat(getResponse.exists(), equalTo(false));\n+            }\n+        }\n     }\n }",
  "logs_path": "codex/gpt-5.1-codex/b8978668/elastic_elasticsearch_pr1587/logs.jsonl",
  "errors": [],
  "edit_run_id": "fd5b3480",
  "test_label": "v1-agent-comparison"
}