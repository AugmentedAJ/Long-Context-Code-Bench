{
  "repo_url": "https://github.com/elastic/elasticsearch.git",
  "pr_number": 3632,
  "base_commit": "9e7b3963d81afc74907a130533738cb90e6f993b",
  "runner": "codex",
  "model": "gpt-5.1-codex",
  "timeout_s": 10800,
  "status": "success",
  "elapsed_ms": 526691,
  "patch_unified": "diff --git a/docs/reference/search/request/highlighting.asciidoc b/docs/reference/search/request/highlighting.asciidoc\nindex 43d5817..e2031cb 100644\n--- a/docs/reference/search/request/highlighting.asciidoc\n+++ b/docs/reference/search/request/highlighting.asciidoc\n@@ -200,6 +200,39 @@ be highlighted only if a query matched that field. `false` means that\n terms are highlighted on all requested fields regardless if the query\n matches specifically on them.\n \n+[[highlight-query]]\n+==== Highlight Query\n+\n+By default the highlighters derive their terms from the main search\n+query. In some cases it is desirable to provide a separate query that\n+is only used for highlighting, for example when using\n+<<search-request-rescore,rescore>> queries or when you need to sort\n+highlighted fragments based on a different set of terms. A custom query\n+can be provided either globally for all highlight fields or per field\n+using the `highlight_query` option.\n+\n+[source,js]\n+--------------------------------------------------\n+{\n+    \"query\" : {...},\n+    \"highlight\" : {\n+        \"highlight_query\" : {\n+            \"match\" : { \"content\" : \"elastic\" }\n+        },\n+        \"fields\" : {\n+            \"content\" : {},\n+            \"title\" : {\n+                \"highlight_query\" : { \"match\" : { \"title\" : \"search\" } }\n+            }\n+        }\n+    }\n+}\n+--------------------------------------------------\n+\n+In the example above, the `content` field is highlighted using the\n+global highlight query, while the `title` field overrides it with its\n+own query.\n+\n [[boundary-characters]]\n ==== Boundary Characters\n \ndiff --git a/src/main/java/org/elasticsearch/action/search/SearchRequestBuilder.java b/src/main/java/org/elasticsearch/action/search/SearchRequestBuilder.java\nindex 5bc80e2..846928c 100644\n--- a/src/main/java/org/elasticsearch/action/search/SearchRequestBuilder.java\n+++ b/src/main/java/org/elasticsearch/action/search/SearchRequestBuilder.java\n@@ -689,6 +689,11 @@ public class SearchRequestBuilder extends ActionRequestBuilder<SearchRequest, Se\n         return this;\n     }\n \n+    public SearchRequestBuilder setHighlighterQuery(QueryBuilder highlightQuery) {\n+        highlightBuilder().highlightQuery(highlightQuery);\n+        return this;\n+    }\n+\n     /**\n      * Delegates to {@link org.elasticsearch.search.suggest.SuggestBuilder#setText(String)}.\n      */\ndiff --git a/src/main/java/org/elasticsearch/search/highlight/FastVectorHighlighter.java b/src/main/java/org/elasticsearch/search/highlight/FastVectorHighlighter.java\nindex 7763753..d6dcb2a 100644\n--- a/src/main/java/org/elasticsearch/search/highlight/FastVectorHighlighter.java\n+++ b/src/main/java/org/elasticsearch/search/highlight/FastVectorHighlighter.java\n@@ -78,6 +78,10 @@ public class FastVectorHighlighter implements Highlighter {\n         try {\n             MapperHighlightEntry entry = cache.mappers.get(mapper);\n             FieldQuery fieldQuery = null;\n+            Query fieldQuerySource = field.highlightQuery();\n+            if (fieldQuerySource == null) {\n+                fieldQuerySource = context.parsedQuery().query();\n+            }\n             if (entry == null) {\n                 FragListBuilder fragListBuilder;\n                 BaseFragmentsBuilder fragmentsBuilder;\n@@ -121,21 +125,23 @@ public class FastVectorHighlighter implements Highlighter {\n                     // fragment builders are used explicitly\n                     cache.fvh = new org.apache.lucene.search.vectorhighlight.FastVectorHighlighter();\n                 }\n-                CustomFieldQuery.highlightFilters.set(field.highlightFilter());\n+                cache.mappers.put(mapper, entry);\n+            }\n+            CustomFieldQuery.highlightFilters.set(field.highlightFilter());\n+            if (field.highlightQuery() == null) {\n                 if (field.requireFieldMatch()) {\n                     if (cache.fieldMatchFieldQuery == null) {\n-                        // we use top level reader to rewrite the query against all readers, with use caching it across hits (and across readers...)\n-                        cache.fieldMatchFieldQuery = new CustomFieldQuery(context.parsedQuery().query(), hitContext.topLevelReader(), true, field.requireFieldMatch());\n+                        cache.fieldMatchFieldQuery = new CustomFieldQuery(fieldQuerySource, hitContext.topLevelReader(), true, field.requireFieldMatch());\n                     }\n                     fieldQuery = cache.fieldMatchFieldQuery;\n                 } else {\n                     if (cache.noFieldMatchFieldQuery == null) {\n-                        // we use top level reader to rewrite the query against all readers, with use caching it across hits (and across readers...)\n-                        cache.noFieldMatchFieldQuery = new CustomFieldQuery(context.parsedQuery().query(), hitContext.topLevelReader(), true, field.requireFieldMatch());\n+                        cache.noFieldMatchFieldQuery = new CustomFieldQuery(fieldQuerySource, hitContext.topLevelReader(), true, field.requireFieldMatch());\n                     }\n                     fieldQuery = cache.noFieldMatchFieldQuery;\n                 }\n-                cache.mappers.put(mapper, entry);\n+            } else {\n+                fieldQuery = new CustomFieldQuery(fieldQuerySource, hitContext.topLevelReader(), true, field.requireFieldMatch());\n             }\n \n             String[] fragments;\ndiff --git a/src/main/java/org/elasticsearch/search/highlight/HighlightBuilder.java b/src/main/java/org/elasticsearch/search/highlight/HighlightBuilder.java\nindex 4e0ccc6..f266efd 100644\n--- a/src/main/java/org/elasticsearch/search/highlight/HighlightBuilder.java\n+++ b/src/main/java/org/elasticsearch/search/highlight/HighlightBuilder.java\n@@ -21,6 +21,7 @@ package org.elasticsearch.search.highlight;\n \n import org.elasticsearch.common.xcontent.ToXContent;\n import org.elasticsearch.common.xcontent.XContentBuilder;\n+import org.elasticsearch.index.query.QueryBuilder;\n \n import java.io.IOException;\n import java.util.List;\n@@ -55,6 +56,8 @@ public class HighlightBuilder implements ToXContent {\n \n     private Map<String, Object> options;\n \n+    private QueryBuilder highlightQuery;\n+\n     /**\n      * Adds a field to be highlighted with default fragment size of 100 characters, and\n      * default number of fragments of 5 using the default encoder\n@@ -209,6 +212,11 @@ public class HighlightBuilder implements ToXContent {\n         return this;\n     }\n \n+    public HighlightBuilder highlightQuery(QueryBuilder highlightQuery) {\n+        this.highlightQuery = highlightQuery;\n+        return this;\n+    }\n+\n     @Override\n     public XContentBuilder toXContent(XContentBuilder builder, Params params) throws IOException {\n         builder.startObject(\"highlight\");\n@@ -239,6 +247,10 @@ public class HighlightBuilder implements ToXContent {\n         if (options != null && options.size() > 0) {\n             builder.field(\"options\", options);\n         }\n+        if (highlightQuery != null) {\n+            builder.field(\"highlight_query\");\n+            highlightQuery.toXContent(builder, params);\n+        }\n         if (fields != null) {\n             builder.startObject(\"fields\");\n             for (Field field : fields) {\n@@ -282,6 +294,10 @@ public class HighlightBuilder implements ToXContent {\n                 if (field.options != null && field.options.size() > 0) {\n                     builder.field(\"options\", field.options);\n                 }\n+                if (field.highlightQuery != null) {\n+                    builder.field(\"highlight_query\");\n+                    field.highlightQuery.toXContent(builder, params);\n+                }\n \n                 builder.endObject();\n             }\n@@ -307,6 +323,7 @@ public class HighlightBuilder implements ToXContent {\n         String highlighterType;\n         String fragmenter;\n         Map<String, Object> options;\n+        QueryBuilder highlightQuery;\n \n         public Field(String name) {\n             this.name = name;\n@@ -408,5 +425,10 @@ public class HighlightBuilder implements ToXContent {\n             this.options = options;\n             return this;\n         }\n+\n+        public Field highlightQuery(QueryBuilder highlightQuery) {\n+            this.highlightQuery = highlightQuery;\n+            return this;\n+        }\n     }\n }\ndiff --git a/src/main/java/org/elasticsearch/search/highlight/HighlighterParseElement.java b/src/main/java/org/elasticsearch/search/highlight/HighlighterParseElement.java\nindex edceffc..8e03c7e 100644\n--- a/src/main/java/org/elasticsearch/search/highlight/HighlighterParseElement.java\n+++ b/src/main/java/org/elasticsearch/search/highlight/HighlighterParseElement.java\n@@ -20,6 +20,7 @@\n package org.elasticsearch.search.highlight;\n \n import com.google.common.collect.Lists;\n+import org.apache.lucene.search.Query;\n import org.apache.lucene.search.vectorhighlight.SimpleBoundaryScanner;\n import org.elasticsearch.common.xcontent.XContentParser;\n import org.elasticsearch.search.SearchParseElement;\n@@ -80,6 +81,7 @@ public class HighlighterParseElement implements SearchParseElement {\n         String globalHighlighterType = null;\n         String globalFragmenter = null;\n         Map<String, Object> globalOptions = null;\n+        Query globalHighlightQuery = null;\n \n         while ((token = parser.nextToken()) != XContentParser.Token.END_OBJECT) {\n             if (token == XContentParser.Token.FIELD_NAME) {\n@@ -130,6 +132,8 @@ public class HighlighterParseElement implements SearchParseElement {\n                 } else if (\"fragmenter\".equals(topLevelFieldName)) {\n                     globalFragmenter = parser.text();\n                 }\n+            } else if (token == XContentParser.Token.START_OBJECT && (\"highlight_query\".equals(topLevelFieldName) || \"highlightQuery\".equals(topLevelFieldName))) {\n+                globalHighlightQuery = context.queryParserService().parse(parser).query();\n             } else if (token == XContentParser.Token.START_OBJECT && \"options\".equals(topLevelFieldName)) {\n                 globalOptions = parser.map();\n             } else if (token == XContentParser.Token.START_OBJECT) {\n@@ -185,6 +189,8 @@ public class HighlighterParseElement implements SearchParseElement {\n                                     } else if (\"fragmenter\".equals(fieldName)) {\n                                         field.fragmenter(parser.text());\n                                     }\n+                                } else if (token == XContentParser.Token.START_OBJECT && (\"highlight_query\".equals(fieldName) || \"highlightQuery\".equals(fieldName))) {\n+                                    field.highlightQuery(context.queryParserService().parse(parser).query());\n                                 } else if (fieldName.equals(\"options\")) {\n                                     field.options(parser.map());\n                                 }\n@@ -240,6 +246,9 @@ public class HighlighterParseElement implements SearchParseElement {\n             if (field.options() == null || field.options().size() == 0) {\n                 field.options(globalOptions);\n             }\n+            if (field.highlightQuery() == null) {\n+                field.highlightQuery(globalHighlightQuery);\n+            }\n         }\n \n         context.highlight(new SearchContextHighlight(fields));\ndiff --git a/src/main/java/org/elasticsearch/search/highlight/PlainHighlighter.java b/src/main/java/org/elasticsearch/search/highlight/PlainHighlighter.java\nindex ff1d0f8..4825599 100644\n--- a/src/main/java/org/elasticsearch/search/highlight/PlainHighlighter.java\n+++ b/src/main/java/org/elasticsearch/search/highlight/PlainHighlighter.java\n@@ -68,12 +68,19 @@ public class PlainHighlighter implements Highlighter {\n         }\n         Map<FieldMapper<?>, org.apache.lucene.search.highlight.Highlighter> cache = (Map<FieldMapper<?>, org.apache.lucene.search.highlight.Highlighter>) hitContext.cache().get(CACHE_KEY);\n \n-        org.apache.lucene.search.highlight.Highlighter entry = cache.get(mapper);\n-        if (entry == null) {\n+        Query highlightQuery = field.highlightQuery();\n+        if (highlightQuery == null) {\n             // Don't use the context.query() since it might be rewritten, and we need to pass the non rewritten queries to\n             // let the highlighter handle MultiTerm ones\n-            Query query = context.parsedQuery().query();\n-            QueryScorer queryScorer = new CustomQueryScorer(query, field.requireFieldMatch() ? mapper.names().indexName() : null);\n+            highlightQuery = context.parsedQuery().query();\n+        }\n+\n+        org.apache.lucene.search.highlight.Highlighter entry = null;\n+        if (field.highlightQuery() == null) {\n+            entry = cache.get(mapper);\n+        }\n+        if (entry == null) {\n+            QueryScorer queryScorer = new CustomQueryScorer(highlightQuery, field.requireFieldMatch() ? mapper.names().indexName() : null);\n             queryScorer.setExpandMultiTermQuery(true);\n             Fragmenter fragmenter;\n             if (field.numberOfFragments() == 0) {\n@@ -94,7 +101,9 @@ public class PlainHighlighter implements Highlighter {\n             // always highlight across all data\n             entry.setMaxDocCharsToAnalyze(Integer.MAX_VALUE);\n \n-            cache.put(mapper, entry);\n+            if (field.highlightQuery() == null) {\n+                cache.put(mapper, entry);\n+            }\n         }\n \n         List<Object> textsToHighlight;\ndiff --git a/src/main/java/org/elasticsearch/search/highlight/SearchContextHighlight.java b/src/main/java/org/elasticsearch/search/highlight/SearchContextHighlight.java\nindex 04e71d2..c88f198 100644\n--- a/src/main/java/org/elasticsearch/search/highlight/SearchContextHighlight.java\n+++ b/src/main/java/org/elasticsearch/search/highlight/SearchContextHighlight.java\n@@ -19,6 +19,8 @@\n \n package org.elasticsearch.search.highlight;\n \n+import org.apache.lucene.search.Query;\n+\n import java.util.List;\n import java.util.Map;\n \n@@ -68,6 +70,8 @@ public class SearchContextHighlight {\n \n         private Map<String, Object> options;\n \n+        private Query highlightQuery;\n+\n         public Field(String field) {\n             this.field = field;\n         }\n@@ -187,5 +191,13 @@ public class SearchContextHighlight {\n         public void options(Map<String, Object> options) {\n             this.options = options;\n         }\n+\n+        public Query highlightQuery() {\n+            return highlightQuery;\n+        }\n+\n+        public void highlightQuery(Query highlightQuery) {\n+            this.highlightQuery = highlightQuery;\n+        }\n     }\n }\ndiff --git a/src/test/java/org/elasticsearch/search/highlight/HighlighterSearchTests.java b/src/test/java/org/elasticsearch/search/highlight/HighlighterSearchTests.java\nindex 1857b9a..c32482e 100644\n--- a/src/test/java/org/elasticsearch/search/highlight/HighlighterSearchTests.java\n+++ b/src/test/java/org/elasticsearch/search/highlight/HighlighterSearchTests.java\n@@ -154,6 +154,74 @@ public class HighlighterSearchTests extends AbstractIntegrationTest {\n         SearchResponse search = client().prepareSearch(\"test\").setTypes(\"test\").setQuery(matchQuery(\"name.autocomplete\", \"deut tel\").operator(Operator.OR)).addHighlightedField(\"name.autocomplete\").execute().actionGet();\n         assertHighlight(search, 0, \"name.autocomplete\", 0, equalTo(\"ARCO<em>TEL</em> Ho<em>tel</em>s <em>Deut</em>schland\"));\n     }\n+\n+    @Test\n+    public void testGlobalHighlightQuery() throws Exception {\n+        wipeIndex(\"test\");\n+        client().admin().indices().prepareCreate(\"test\")\n+                .addMapping(\"type\", jsonBuilder()\n+                        .startObject()\n+                            .startObject(\"type\")\n+                                .startObject(\"properties\")\n+                                    .startObject(\"field\")\n+                                        .field(\"type\", \"string\")\n+                                        .field(\"store\", \"yes\")\n+                                    .endObject()\n+                                .endObject()\n+                            .endObject()\n+                        .endObject())\n+                .execute().actionGet();\n+        ensureYellow();\n+        client().prepareIndex(\"test\", \"type\", \"1\")\n+                .setSource(\"field\", \"foo bar baz\")\n+                .execute().actionGet();\n+        refresh();\n+\n+        SearchResponse searchResponse = client().prepareSearch(\"test\")\n+                .setQuery(termQuery(\"field\", \"foo\"))\n+                .setHighlighterQuery(termQuery(\"field\", \"bar\"))\n+                .addHighlightedField(new HighlightBuilder.Field(\"field\"))\n+                .execute().actionGet();\n+\n+        assertHighlight(searchResponse, 0, \"field\", 0, equalTo(\"foo <em>bar</em> baz\"));\n+    }\n+\n+    @Test\n+    public void testFieldSpecificHighlightQueryOnFvh() throws Exception {\n+        wipeIndex(\"test\");\n+        client().admin().indices().prepareCreate(\"test\")\n+                .addMapping(\"type\", jsonBuilder()\n+                        .startObject()\n+                            .startObject(\"type\")\n+                                .startObject(\"properties\")\n+                                    .startObject(\"field\")\n+                                        .field(\"type\", \"string\")\n+                                        .field(\"store\", \"yes\")\n+                                        .field(\"term_vector\", \"with_positions_offsets\")\n+                                    .endObject()\n+                                .endObject()\n+                            .endObject()\n+                        .endObject())\n+                .execute().actionGet();\n+        ensureYellow();\n+        client().prepareIndex(\"test\", \"type\", \"1\")\n+                .setSource(\"field\", \"foo bar baz qux\")\n+                .execute().actionGet();\n+        refresh();\n+\n+        HighlightBuilder.Field highlightField = new HighlightBuilder.Field(\"field\")\n+                .highlighterType(\"fvh\")\n+                .fragmentSize(50)\n+                .numOfFragments(1)\n+                .highlightQuery(termQuery(\"field\", \"qux\"));\n+\n+        SearchResponse searchResponse = client().prepareSearch(\"test\")\n+                .setQuery(termQuery(\"field\", \"foo\"))\n+                .addHighlightedField(highlightField)\n+                .execute().actionGet();\n+\n+        assertHighlight(searchResponse, 0, \"field\", 0, equalTo(\"foo bar baz <em>qux</em>\"));\n+    }\n     \n     @Test \n     public void testMultiPhraseCutoff() throws ElasticSearchException, IOException {",
  "logs_path": "codex/gpt-5.1-codex/1c2e04d5/elastic_elasticsearch_pr3632/logs.jsonl",
  "errors": [],
  "edit_run_id": "fd5b3480",
  "test_label": "v1-agent-comparison"
}