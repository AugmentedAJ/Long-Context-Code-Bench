{
  "repo_url": "https://github.com/elastic/elasticsearch.git",
  "pr_number": 2558,
  "base_commit": "2eb09e6b1abceb316c789f173988ac733a55dc8b",
  "runner": "codex",
  "model": "gpt-5.1-codex",
  "timeout_s": 10800,
  "status": "success",
  "elapsed_ms": 357450,
  "patch_unified": "diff --git a/src/main/java/org/elasticsearch/cluster/routing/allocation/allocator/ShardsAllocatorModule.java b/src/main/java/org/elasticsearch/cluster/routing/allocation/allocator/ShardsAllocatorModule.java\nindex a3d8da2..6a94ac8 100644\n--- a/src/main/java/org/elasticsearch/cluster/routing/allocation/allocator/ShardsAllocatorModule.java\n+++ b/src/main/java/org/elasticsearch/cluster/routing/allocation/allocator/ShardsAllocatorModule.java\n@@ -48,6 +48,10 @@ public class ShardsAllocatorModule extends AbstractModule {\n     @Override\n     protected void configure() {\n         bind(GatewayAllocator.class).to(gatewayAllocator).asEagerSingleton();\n-        bind(ShardsAllocator.class).to(shardsAllocator == null ? BalancedShardsAllocator.class : shardsAllocator).asEagerSingleton();\n+        Class<? extends ShardsAllocator> allocatorClass = shardsAllocator;\n+        if (allocatorClass == null) {\n+            allocatorClass = ShardsAllocators.resolveAllocator(settings);\n+        }\n+        bind(ShardsAllocator.class).to(allocatorClass).asEagerSingleton();\n     }\n }\ndiff --git a/src/main/java/org/elasticsearch/cluster/routing/allocation/allocator/ShardsAllocators.java b/src/main/java/org/elasticsearch/cluster/routing/allocation/allocator/ShardsAllocators.java\nindex 9efcf7e..9bf838b 100644\n--- a/src/main/java/org/elasticsearch/cluster/routing/allocation/allocator/ShardsAllocators.java\n+++ b/src/main/java/org/elasticsearch/cluster/routing/allocation/allocator/ShardsAllocators.java\n@@ -19,6 +19,7 @@\n \n package org.elasticsearch.cluster.routing.allocation.allocator;\n \n+import org.elasticsearch.ElasticSearchIllegalStateException;\n import org.elasticsearch.cluster.routing.MutableShardRouting;\n import org.elasticsearch.cluster.routing.RoutingNode;\n import org.elasticsearch.cluster.routing.allocation.FailedRerouteAllocation;\n@@ -30,6 +31,9 @@ import org.elasticsearch.common.settings.ImmutableSettings;\n import org.elasticsearch.common.settings.Settings;\n import org.elasticsearch.gateway.none.NoneGatewayAllocator;\n \n+import java.lang.reflect.NoSuchMethodException;\n+import java.util.Locale;\n+\n /**\n  * The {@link ShardsAllocator} class offers methods for allocating shard within a cluster.\n  * These methods include moving shards and re-balancing the cluster. It also allows management\n@@ -37,6 +41,10 @@ import org.elasticsearch.gateway.none.NoneGatewayAllocator;\n  */\n public class ShardsAllocators extends AbstractComponent implements ShardsAllocator {\n \n+    public static final String TYPE_SETTING = \"cluster.routing.allocation.type\";\n+    private static final String ALLOCATOR_CLASS_PREFIX = \"org.elasticsearch.cluster.routing.allocation.allocator.\";\n+    private static final String ALLOCATOR_CLASS_SUFFIX = \"ShardsAllocator\";\n+\n     private final GatewayAllocator gatewayAllocator;\n     private final ShardsAllocator allocator;\n \n@@ -45,7 +53,7 @@ public class ShardsAllocators extends AbstractComponent implements ShardsAllocat\n     }\n \n     public ShardsAllocators(Settings settings) {\n-      this(settings, new NoneGatewayAllocator(), new BalancedShardsAllocator(settings));\n+        this(settings, new NoneGatewayAllocator(), createAllocator(settings));\n     }\n \n     @Inject\n@@ -55,6 +63,36 @@ public class ShardsAllocators extends AbstractComponent implements ShardsAllocat\n         this.allocator = allocator;\n     }\n \n+    static Class<? extends ShardsAllocator> resolveAllocator(Settings settings) {\n+        String type = settings.get(TYPE_SETTING);\n+        if (type == null) {\n+            return BalancedShardsAllocator.class;\n+        }\n+        String lowercaseType = type.toLowerCase(Locale.ROOT);\n+        if (\"balanced_shards\".equals(lowercaseType)) {\n+            return BalancedShardsAllocator.class;\n+        }\n+        if (\"even_shards\".equals(lowercaseType) || \"even_shards_count\".equals(lowercaseType)) {\n+            return EvenShardsCountAllocator.class;\n+        }\n+        return settings.getAsClass(TYPE_SETTING, BalancedShardsAllocator.class, ALLOCATOR_CLASS_PREFIX, ALLOCATOR_CLASS_SUFFIX);\n+    }\n+\n+    private static ShardsAllocator createAllocator(Settings settings) {\n+        Class<? extends ShardsAllocator> allocatorClass = resolveAllocator(settings);\n+        try {\n+            return allocatorClass.getConstructor(Settings.class).newInstance(settings);\n+        } catch (NoSuchMethodException e) {\n+            try {\n+                return allocatorClass.newInstance();\n+            } catch (Exception e1) {\n+                throw new ElasticSearchIllegalStateException(\"Failed to create instance of [\" + allocatorClass.getName() + \"]\", e1);\n+            }\n+        } catch (Exception e) {\n+            throw new ElasticSearchIllegalStateException(\"Failed to create instance of [\" + allocatorClass.getName() + \"]\", e);\n+        }\n+    }\n+\n     @Override\n     public void applyStartedShards(StartedRerouteAllocation allocation) {\n         gatewayAllocator.applyStartedShards(allocation);",
  "logs_path": "codex/gpt-5.1-codex/fd5b3480/elastic_elasticsearch_pr2558/logs.jsonl",
  "errors": [],
  "edit_run_id": "fd5b3480",
  "test_label": "v1-agent-comparison"
}