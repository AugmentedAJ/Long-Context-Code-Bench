{
  "repo_url": "https://github.com/elastic/elasticsearch.git",
  "pr_number": 4212,
  "base_commit": "22852d8040df7c789e0cdbb32d33ef1e5cc76435",
  "runner": "codex",
  "model": "gpt-5.1-codex",
  "timeout_s": 10800,
  "status": "success",
  "elapsed_ms": 239438,
  "patch_unified": "diff --git a/src/main/java/org/elasticsearch/repositories/RepositoriesService.java b/src/main/java/org/elasticsearch/repositories/RepositoriesService.java\nindex 0f9d59d..577451b 100644\n--- a/src/main/java/org/elasticsearch/repositories/RepositoriesService.java\n+++ b/src/main/java/org/elasticsearch/repositories/RepositoriesService.java\n@@ -27,6 +27,8 @@ import org.elasticsearch.cluster.ack.ClusterStateUpdateResponse;\n import org.elasticsearch.cluster.metadata.MetaData;\n import org.elasticsearch.cluster.metadata.RepositoriesMetaData;\n import org.elasticsearch.cluster.metadata.RepositoryMetaData;\n+import org.elasticsearch.cluster.metadata.RestoreMetaData;\n+import org.elasticsearch.cluster.metadata.SnapshotMetaData;\n import org.elasticsearch.cluster.node.DiscoveryNode;\n import org.elasticsearch.common.Nullable;\n import org.elasticsearch.common.component.AbstractComponent;\n@@ -38,6 +40,7 @@ import org.elasticsearch.common.regex.Regex;\n import org.elasticsearch.common.settings.Settings;\n import org.elasticsearch.common.unit.TimeValue;\n import org.elasticsearch.index.snapshots.IndexShardRepository;\n+import org.elasticsearch.snapshots.ConcurrentSnapshotExecutionException;\n \n import java.util.ArrayList;\n import java.util.List;\n@@ -87,6 +90,7 @@ public class RepositoriesService extends AbstractComponent implements ClusterSta\n         clusterService.submitStateUpdateTask(request.cause, new AckedClusterStateUpdateTask() {\n             @Override\n             public ClusterState execute(ClusterState currentState) {\n+                ensureRepositoryNotInUse(currentState, request.name, \"create or modify\");\n                 // Trying to create the new repository on master to make sure it works\n                 if (!registerRepository(newRepositoryMetaData)) {\n                     // The new repository has the same settings as the old one - ignore\n@@ -180,6 +184,7 @@ public class RepositoriesService extends AbstractComponent implements ClusterSta\n                     boolean changed = false;\n                     for (RepositoryMetaData repositoryMetaData : repositories.repositories()) {\n                         if (Regex.simpleMatch(request.name, repositoryMetaData.name())) {\n+                            ensureRepositoryNotInUse(currentState, repositoryMetaData.name(), \"delete\");\n                             logger.info(\"delete repository [{}]\", repositoryMetaData.name());\n                             changed = true;\n                         } else {\n@@ -232,6 +237,27 @@ public class RepositoriesService extends AbstractComponent implements ClusterSta\n         });\n     }\n \n+    private void ensureRepositoryNotInUse(ClusterState currentState, String repository, String action) {\n+        SnapshotMetaData snapshots = currentState.metaData().custom(SnapshotMetaData.TYPE);\n+        if (snapshots != null) {\n+            for (SnapshotMetaData.Entry snapshot : snapshots.entries()) {\n+                if (repository.equals(snapshot.snapshotId().getRepository())) {\n+                    throw new ConcurrentSnapshotExecutionException(snapshot.snapshotId(),\n+                            \"cannot \" + action + \" repository [\" + repository + \"] because a snapshot is currently running\");\n+                }\n+            }\n+        }\n+        RestoreMetaData restores = currentState.metaData().custom(RestoreMetaData.TYPE);\n+        if (restores != null) {\n+            for (RestoreMetaData.Entry entry : restores.entries()) {\n+                if (repository.equals(entry.snapshotId().getRepository())) {\n+                    throw new ConcurrentSnapshotExecutionException(entry.snapshotId(),\n+                            \"cannot \" + action + \" repository [\" + repository + \"] because a restore is currently running\");\n+                }\n+            }\n+        }\n+    }\n+\n     /**\n      * Checks if new repositories appeared in or disappeared from cluster metadata and updates current list of\n      * repositories accordingly.",
  "logs_path": "codex/gpt-5.1-codex/b8978668/elastic_elasticsearch_pr4212/logs.jsonl",
  "errors": [],
  "edit_run_id": "fd5b3480",
  "test_label": "v1-agent-comparison"
}