{
  "repo_url": "https://github.com/elastic/elasticsearch.git",
  "pr_number": 134776,
  "base_commit": "2ea81d0548b2a25633ffe948cd9304a2c0c59563",
  "runner": "codex",
  "model": "gpt-5.1-codex",
  "timeout_s": 10800,
  "status": "success",
  "elapsed_ms": 616575,
  "patch_unified": "diff --git a/x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/security/authc/Authentication.java b/x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/security/authc/Authentication.java\nindex ac543c4f..f6ea019b 100644\n--- a/x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/security/authc/Authentication.java\n+++ b/x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/security/authc/Authentication.java\n@@ -1376,26 +1376,24 @@ public final class Authentication implements ToXContentObject {\n         return authentication;\n     }\n \n-    public static Authentication newCloudAccessTokenAuthentication(\n+    public static Authentication newCloudAuthentication(\n         AuthenticationResult<User> authResult,\n-        Authentication.RealmRef realmRef\n+        AuthenticationType authenticationType,\n+        Subject.Type subjectType,\n+        @Nullable Authentication.RealmRef realmRef,\n+        @Nullable String nodeName\n     ) {\n-        assert authResult.isAuthenticated() : \"cloud access token authn result must be successful\";\n+        assert authResult.isAuthenticated() : \"cloud authentication result must be successful\";\n         final User user = authResult.getValue();\n-        return new Authentication(\n-            new Subject(user, realmRef, TransportVersion.current(), authResult.getMetadata()),\n-            AuthenticationType.TOKEN\n-        );\n-    }\n-\n-    public static Authentication newCloudApiKeyAuthentication(AuthenticationResult<User> authResult, String nodeName) {\n-        assert authResult.isAuthenticated() : \"cloud API Key authn result must be successful\";\n-        final User apiKeyUser = authResult.getValue();\n-        final Authentication.RealmRef authenticatedBy = newCloudApiKeyRealmRef(nodeName);\n-        return new Authentication(\n-            new Subject(apiKeyUser, authenticatedBy, TransportVersion.current(), authResult.getMetadata()),\n-            AuthenticationType.API_KEY\n-        );\n+        final Authentication.RealmRef authenticatedBy;\n+        if (subjectType == Subject.Type.USER) {\n+            authenticatedBy = Objects.requireNonNull(realmRef, \"realm reference is required for cloud user authentication\");\n+        } else if (subjectType == Subject.Type.CLOUD_API_KEY) {\n+            authenticatedBy = newCloudApiKeyRealmRef(Objects.requireNonNull(nodeName, \"node name is required for cloud API key\"));\n+        } else {\n+            throw new IllegalArgumentException(\"subject type [\" + subjectType + \"] is not supported for cloud authentication\");\n+        }\n+        return new Authentication(new Subject(user, authenticatedBy, TransportVersion.current(), authResult.getMetadata()), authenticationType);\n     }\n \n     public static Authentication newApiKeyAuthentication(AuthenticationResult<User> authResult, String nodeName) {\ndiff --git a/x-pack/plugin/core/src/test/java/org/elasticsearch/xpack/core/security/authc/AuthenticationSerializationTests.java b/x-pack/plugin/core/src/test/java/org/elasticsearch/xpack/core/security/authc/AuthenticationSerializationTests.java\nindex 095a7ed6..09a10125 100644\n--- a/x-pack/plugin/core/src/test/java/org/elasticsearch/xpack/core/security/authc/AuthenticationSerializationTests.java\n+++ b/x-pack/plugin/core/src/test/java/org/elasticsearch/xpack/core/security/authc/AuthenticationSerializationTests.java\n@@ -13,6 +13,8 @@ import org.elasticsearch.common.io.stream.StreamInput;\n import org.elasticsearch.test.ESTestCase;\n import org.elasticsearch.test.TransportVersionUtils;\n import org.elasticsearch.transport.RemoteClusterPortSettings;\n+import org.elasticsearch.xpack.core.security.authc.Authentication.AuthenticationType;\n+import org.elasticsearch.xpack.core.security.authc.Subject;\n import org.elasticsearch.xpack.core.security.authc.support.AuthenticationContextSerializer;\n import org.elasticsearch.xpack.core.security.user.ElasticUser;\n import org.elasticsearch.xpack.core.security.user.InternalUsers;\n@@ -116,8 +118,11 @@ public class AuthenticationSerializationTests extends ESTestCase {\n     }\n \n     public void testWriteToAndReadFromWithCloudApiKeyAuthentication() throws Exception {\n-        final Authentication authentication = Authentication.newCloudApiKeyAuthentication(\n+        final Authentication authentication = Authentication.newCloudAuthentication(\n             AuthenticationResult.success(new User(randomAlphanumericOfLength(5), \"superuser\"), Map.of()),\n+            AuthenticationType.API_KEY,\n+            Subject.Type.CLOUD_API_KEY,\n+            null,\n             randomAlphanumericOfLength(10)\n         );\n \n@@ -133,8 +138,11 @@ public class AuthenticationSerializationTests extends ESTestCase {\n     }\n \n     public void testWriteToWithCloudApiKeyThrowsOnUnsupportedVersion() {\n-        final Authentication authentication = Authentication.newCloudApiKeyAuthentication(\n+        final Authentication authentication = Authentication.newCloudAuthentication(\n             AuthenticationResult.success(new User(randomAlphanumericOfLength(5), \"superuser\"), Map.of()),\n+            AuthenticationType.API_KEY,\n+            Subject.Type.CLOUD_API_KEY,\n+            null,\n             randomAlphanumericOfLength(10)\n         );\n \ndiff --git a/x-pack/plugin/core/src/test/java/org/elasticsearch/xpack/core/security/authc/AuthenticationTestHelper.java b/x-pack/plugin/core/src/test/java/org/elasticsearch/xpack/core/security/authc/AuthenticationTestHelper.java\nindex e9449e78..d1176380 100644\n--- a/x-pack/plugin/core/src/test/java/org/elasticsearch/xpack/core/security/authc/AuthenticationTestHelper.java\n+++ b/x-pack/plugin/core/src/test/java/org/elasticsearch/xpack/core/security/authc/AuthenticationTestHelper.java\n@@ -18,6 +18,7 @@ import org.elasticsearch.xcontent.XContentType;\n import org.elasticsearch.xpack.core.security.action.apikey.ApiKey;\n import org.elasticsearch.xpack.core.security.action.service.TokenInfo;\n import org.elasticsearch.xpack.core.security.authc.Authentication.AuthenticationType;\n+import org.elasticsearch.xpack.core.security.authc.Subject;\n import org.elasticsearch.xpack.core.security.authc.esnative.NativeRealmSettings;\n import org.elasticsearch.xpack.core.security.authc.file.FileRealmSettings;\n import org.elasticsearch.xpack.core.security.authc.jwt.JwtRealmSettings;\n@@ -287,8 +288,11 @@ public class AuthenticationTestHelper {\n \n         assert user.principal().equals(apiKeyId) : \"user principal must match cloud API key ID\";\n \n-        return Authentication.newCloudApiKeyAuthentication(\n+        return Authentication.newCloudAuthentication(\n             AuthenticationResult.success(user, user.metadata()),\n+            AuthenticationType.API_KEY,\n+            Subject.Type.CLOUD_API_KEY,\n+            null,\n             \"node_\" + ESTestCase.randomAlphaOfLengthBetween(3, 8)\n         );\n ",
  "logs_path": "codex/gpt-5.1-codex/1c2e04d5/elastic_elasticsearch_pr134776/logs.jsonl",
  "errors": [],
  "edit_run_id": "fd5b3480",
  "test_label": "v1-agent-comparison"
}