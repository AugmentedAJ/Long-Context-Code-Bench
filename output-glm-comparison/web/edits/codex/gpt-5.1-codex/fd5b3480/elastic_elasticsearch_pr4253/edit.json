{
  "repo_url": "https://github.com/elastic/elasticsearch.git",
  "pr_number": 4253,
  "base_commit": "9f5d01ca4cc06bf7affdb5a656dc838c383e0c4c",
  "runner": "codex",
  "model": "gpt-5.1-codex",
  "timeout_s": 10800,
  "status": "success",
  "elapsed_ms": 525664,
  "patch_unified": "diff --git a/src/main/java/org/apache/lucene/search/suggest/analyzing/XAnalyzingSuggester.java b/src/main/java/org/apache/lucene/search/suggest/analyzing/XAnalyzingSuggester.java\nindex f107d17..b577a26 100644\n--- a/src/main/java/org/apache/lucene/search/suggest/analyzing/XAnalyzingSuggester.java\n+++ b/src/main/java/org/apache/lucene/search/suggest/analyzing/XAnalyzingSuggester.java\n@@ -123,6 +123,8 @@ public class XAnalyzingSuggester extends Lookup {\n    */\n   private final boolean preserveSep;\n \n+  private static final int MAX_DEDUP_BYTES = 5;\n+\n   /** Include this flag in the options parameter to {@link\n    *  #XAnalyzingSuggester(Analyzer,Analyzer,int,int,int,FST,boolean,int)} to always\n    *  return the exact match first, regardless of score.  This\n@@ -212,12 +214,8 @@ public class XAnalyzingSuggester extends Lookup {\n     this.exactFirst = (options & EXACT_FIRST) != 0;\n     this.preserveSep = (options & PRESERVE_SEP) != 0;\n \n-    // NOTE: this is just an implementation limitation; if\n-    // somehow this is a problem we could fix it by using\n-    // more than one byte to disambiguate ... but 256 seems\n-    // like it should be way more then enough.\n-    if (maxSurfaceFormsPerAnalyzedForm <= 0 || maxSurfaceFormsPerAnalyzedForm > 256) {\n-      throw new IllegalArgumentException(\"maxSurfaceFormsPerAnalyzedForm must be > 0 and < 256 (got: \" + maxSurfaceFormsPerAnalyzedForm + \")\");\n+    if (maxSurfaceFormsPerAnalyzedForm <= 0) {\n+      throw new IllegalArgumentException(\"maxSurfaceFormsPerAnalyzedForm must be > 0 (got: \" + maxSurfaceFormsPerAnalyzedForm + \")\");\n     }\n     this.maxSurfaceFormsPerAnalyzedForm = maxSurfaceFormsPerAnalyzedForm;\n \n@@ -331,6 +329,22 @@ public class XAnalyzingSuggester extends Lookup {\n     return tsta;\n   }\n   \n+  private static int appendDedup(BytesRef analyzed, int dedup) {\n+    final int startLength = analyzed.length;\n+    analyzed.grow(startLength + 1 + MAX_DEDUP_BYTES);\n+    int pos = analyzed.offset + startLength;\n+    analyzed.bytes[pos++] = (byte) END_BYTE;\n+    int value = dedup;\n+    while ((value & ~0x7F) != 0) {\n+      analyzed.bytes[pos++] = (byte) ((value & 0x7F) | 0x80);\n+      value >>>= 7;\n+    }\n+    analyzed.bytes[pos++] = (byte) value;\n+    int appended = pos - (analyzed.offset + startLength);\n+    analyzed.length = startLength + appended;\n+    return appended;\n+  }\n+  \n   private static class AnalyzingComparator implements Comparator<BytesRef> {\n \n     private final boolean hasPayloads;\n@@ -537,7 +551,7 @@ public class XAnalyzingSuggester extends Lookup {\n           seenSurfaceForms.add(BytesRef.deepCopyOf(surface));\n         }\n \n-        // TODO: I think we can avoid the extra 2 bytes when\n+        // TODO: I think we can avoid the extra bytes when\n         // there is no dup (dedup==0), but we'd have to fix\n         // the exactFirst logic ... which would be sort of\n         // hairy because we'd need to special case the two\n@@ -545,9 +559,7 @@ public class XAnalyzingSuggester extends Lookup {\n \n         // NOTE: must be byte 0 so we sort before whatever\n         // is next\n-        analyzed.bytes[analyzed.offset+analyzed.length] = 0;\n-        analyzed.bytes[analyzed.offset+analyzed.length+1] = (byte) dedup;\n-        analyzed.length += 2;\n+        appendDedup(analyzed, dedup);\n \n         Util.toIntsRef(analyzed, scratchInts);\n         //System.out.println(\"ADD: \" + scratchInts + \" -> \" + cost + \": \" + surface.utf8ToString());\n@@ -999,15 +1011,16 @@ public class XAnalyzingSuggester extends Lookup {\n         public void finishTerm(long defaultWeight) throws IOException {\n             ArrayUtil.timSort(surfaceFormsAndPayload, 0, count);\n             int deduplicator = 0;\n-            analyzed.bytes[analyzed.offset + analyzed.length] = 0;\n-            analyzed.length += 2;\n+            final int analyzedLength = analyzed.length;\n             for (int i = 0; i < count; i++) {\n-                analyzed.bytes[analyzed.offset + analyzed.length - 1 ] = (byte) deduplicator++;\n+                analyzed.length = analyzedLength;\n+                appendDedup(analyzed, deduplicator++);\n                 Util.toIntsRef(analyzed, scratchInts);\n                 SurfaceFormAndPayload candiate = surfaceFormsAndPayload[i];\n                 long cost = candiate.weight == -1 ? encodeWeight(Math.min(Integer.MAX_VALUE, defaultWeight)) : candiate.weight;\n                 builder.add(scratchInts, outputs.newPair(cost, candiate.payload));\n             }\n+            analyzed.length = analyzedLength;\n             seenSurfaceForms.clear();\n             count = 0;\n         }\ndiff --git a/src/main/java/org/elasticsearch/search/suggest/completion/Completion090PostingsFormat.java b/src/main/java/org/elasticsearch/search/suggest/completion/Completion090PostingsFormat.java\nindex 646d1b5..2a63bca 100644\n--- a/src/main/java/org/elasticsearch/search/suggest/completion/Completion090PostingsFormat.java\n+++ b/src/main/java/org/elasticsearch/search/suggest/completion/Completion090PostingsFormat.java\n@@ -54,7 +54,8 @@ import java.util.Map;\n public class Completion090PostingsFormat extends PostingsFormat {\n \n     public static final String CODEC_NAME = \"completion090\";\n-    public static final int SUGGEST_CODEC_VERSION = 1;\n+    public static final int SUGGEST_CODEC_VERSION_START = 1;\n+    public static final int SUGGEST_CODEC_VERSION_CURRENT = 2;\n     public static final String EXTENSION = \"cmp\";\n \n     private final static ESLogger logger = Loggers.getLogger(Completion090PostingsFormat.class);\n@@ -111,7 +112,7 @@ public class Completion090PostingsFormat extends PostingsFormat {\n             boolean success = false;\n             try {\n                 output = state.directory.createOutput(suggestFSTFile, state.context);\n-                CodecUtil.writeHeader(output, CODEC_NAME, SUGGEST_CODEC_VERSION);\n+                CodecUtil.writeHeader(output, CODEC_NAME, SUGGEST_CODEC_VERSION_CURRENT);\n                 /*\n                  * we write the delegate postings format name so we can load it\n                  * without getting an instance in the ctor\n@@ -211,7 +212,7 @@ public class Completion090PostingsFormat extends PostingsFormat {\n         public CompletionFieldsProducer(SegmentReadState state) throws IOException {\n             String suggestFSTFile = IndexFileNames.segmentFileName(state.segmentInfo.name, state.segmentSuffix, EXTENSION);\n             IndexInput input = state.directory.openInput(suggestFSTFile, state.context);\n-            CodecUtil.checkHeader(input, CODEC_NAME, SUGGEST_CODEC_VERSION, SUGGEST_CODEC_VERSION);\n+            CodecUtil.checkHeader(input, CODEC_NAME, SUGGEST_CODEC_VERSION_START, SUGGEST_CODEC_VERSION_CURRENT);\n             boolean success = false;\n             try {\n                 PostingsFormat delegatePostingsFormat = PostingsFormat.forName(input.readString());",
  "logs_path": "codex/gpt-5.1-codex/fd5b3480/elastic_elasticsearch_pr4253/logs.jsonl",
  "errors": [],
  "edit_run_id": "fd5b3480",
  "test_label": "v1-agent-comparison"
}