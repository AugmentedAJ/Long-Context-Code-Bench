{
  "repo_url": "https://github.com/elastic/elasticsearch.git",
  "pr_number": 134369,
  "base_commit": "20d6049c7f1068af75dd34270f7b74cf1f76991c",
  "runner": "codex",
  "model": "gpt-5.1-codex",
  "timeout_s": 10800,
  "status": "success",
  "elapsed_ms": 178384,
  "patch_unified": "diff --git a/server/src/main/java/org/elasticsearch/snapshots/RestoreService.java b/server/src/main/java/org/elasticsearch/snapshots/RestoreService.java\nindex 1be7411b..90cf2054 100644\n--- a/server/src/main/java/org/elasticsearch/snapshots/RestoreService.java\n+++ b/server/src/main/java/org/elasticsearch/snapshots/RestoreService.java\n@@ -267,14 +267,14 @@ public final class RestoreService implements ClusterStateApplier {\n      * @param projectId project for the restore\n      * @param request  restore request\n      * @param listener restore listener\n-     * @param updater  handler that allows callers to make modifications to {@link Metadata}\n+     * @param updater  handler that allows callers to make modifications to {@link ProjectMetadata}\n      *                 in the same cluster state update as the restore operation\n      */\n     public void restoreSnapshot(\n         final ProjectId projectId,\n         final RestoreSnapshotRequest request,\n         final ActionListener<RestoreCompletionResponse> listener,\n-        final BiConsumer<ClusterState, Metadata.Builder> updater\n+        final BiConsumer<ClusterState, ProjectMetadata.Builder> updater\n     ) {\n         assert Repository.assertSnapshotMetaThread();\n \n@@ -368,8 +368,8 @@ public final class RestoreService implements ClusterStateApplier {\n      * @param repository     the repository to restore from\n      * @param request        restore request\n      * @param repositoryData current repository data for the repository to restore from\n-     * @param updater        handler that allows callers to make modifications to {@link Metadata} in the same cluster state update as the\n-     *                       restore operation\n+     * @param updater        handler that allows callers to make modifications to {@link ProjectMetadata} in the same cluster state update\n+     *                       as the restore operation\n      * @param listener       listener to resolve once restore has been started\n      * @throws IOException   on failure to load metadata from the repository\n      */\n@@ -378,7 +378,7 @@ public final class RestoreService implements ClusterStateApplier {\n         Repository repository,\n         RestoreSnapshotRequest request,\n         RepositoryData repositoryData,\n-        BiConsumer<ClusterState, Metadata.Builder> updater,\n+        BiConsumer<ClusterState, ProjectMetadata.Builder> updater,\n         ActionListener<RestoreCompletionResponse> listener\n     ) throws IOException {\n         assert Repository.assertSnapshotMetaThread();\n@@ -1371,7 +1371,7 @@ public final class RestoreService implements ClusterStateApplier {\n \n         private final Collection<DataStream> dataStreamsToRestore;\n \n-        private final BiConsumer<ClusterState, Metadata.Builder> updater;\n+        private final BiConsumer<ClusterState, ProjectMetadata.Builder> updater;\n \n         private final AllocationActionListener<RestoreCompletionResponse> listener;\n         private final Settings settings;\n@@ -1387,7 +1387,7 @@ public final class RestoreService implements ClusterStateApplier {\n             SnapshotInfo snapshotInfo,\n             Metadata metadata,\n             Collection<DataStream> dataStreamsToRestore,\n-            BiConsumer<ClusterState, Metadata.Builder> updater,\n+            BiConsumer<ClusterState, ProjectMetadata.Builder> updater,\n             Settings settings,\n             ActionListener<RestoreCompletionResponse> listener\n         ) {\n@@ -1586,7 +1586,9 @@ public final class RestoreService implements ClusterStateApplier {\n                 );\n             }\n \n-            updater.accept(currentState, mdBuilder);\n+            final ProjectMetadata.Builder projectMetadataBuilder = mdBuilder.getProject(projectId);\n+            assert projectMetadataBuilder != null : \"project metadata builder must exist for project \" + projectId;\n+            updater.accept(currentState, projectMetadataBuilder);\n             final ClusterState updatedClusterState = builder.metadata(mdBuilder)\n                 .blocks(blocks)\n                 .putRoutingTable(projectId, rtBuilder.build())\ndiff --git a/x-pack/plugin/ccr/src/main/java/org/elasticsearch/xpack/ccr/action/TransportPutFollowAction.java b/x-pack/plugin/ccr/src/main/java/org/elasticsearch/xpack/ccr/action/TransportPutFollowAction.java\nindex 27a910fa..d8493a69 100644\n--- a/x-pack/plugin/ccr/src/main/java/org/elasticsearch/xpack/ccr/action/TransportPutFollowAction.java\n+++ b/x-pack/plugin/ccr/src/main/java/org/elasticsearch/xpack/ccr/action/TransportPutFollowAction.java\n@@ -212,16 +212,16 @@ public final class TransportPutFollowAction extends TransportMasterNodeAction<Pu\n             description = \"CCR may not be in scope for multi-project though we haven't made the decision explicitly yet. See also ES-12139\"\n         )\n         final ProjectId projectId = ProjectId.DEFAULT;\n-        final BiConsumer<ClusterState, Metadata.Builder> updater;\n+        final BiConsumer<ClusterState, ProjectMetadata.Builder> updater;\n         if (remoteDataStream == null) {\n             // If the index we're following is not part of a data stream, start the\n             // restoration of the index normally.\n-            updater = (clusterState, mdBuilder) -> {};\n+            updater = (clusterState, projectBuilder) -> {};\n         } else {\n             String followerIndexName = request.getFollowerIndex();\n             // This method is used to update the metadata in the same cluster state\n             // update as the snapshot is restored.\n-            updater = (currentState, mdBuilder) -> {\n+            updater = (currentState, projectBuilder) -> {\n                 final String localDataStreamName;\n \n                 // If we have been given a data stream name, use that name for the local\n@@ -234,7 +234,6 @@ public final class TransportPutFollowAction extends TransportMasterNodeAction<Pu\n                     // There was no specified name, use the original data stream name.\n                     localDataStreamName = remoteDataStream.getName();\n                 }\n-                final ProjectMetadata.Builder projectBuilder = mdBuilder.getProject(projectId);\n                 final DataStream localDataStream = projectBuilder.dataStream(localDataStreamName);\n                 final Index followerIndex = projectBuilder.get(followerIndexName).getIndex();\n                 assert followerIndex != null : \"expected followerIndex \" + followerIndexName + \" to exist in the state, but it did not\";",
  "logs_path": "codex/gpt-5.1-codex/b8978668/elastic_elasticsearch_pr134369/logs.jsonl",
  "errors": [],
  "edit_run_id": "fd5b3480",
  "test_label": "v1-agent-comparison"
}