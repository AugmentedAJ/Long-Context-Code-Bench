{
  "repo_url": "https://github.com/elastic/elasticsearch.git",
  "pr_number": 4122,
  "base_commit": "6f286c338207f2a333294e9e576d0f1319981148",
  "runner": "codex",
  "model": "gpt-5.1-codex",
  "timeout_s": 10800,
  "status": "success",
  "elapsed_ms": 321346,
  "patch_unified": "diff --git a/src/main/java/org/elasticsearch/search/highlight/PostingsHighlighter.java b/src/main/java/org/elasticsearch/search/highlight/PostingsHighlighter.java\nindex 796cf88..461ebe8 100644\n--- a/src/main/java/org/elasticsearch/search/highlight/PostingsHighlighter.java\n+++ b/src/main/java/org/elasticsearch/search/highlight/PostingsHighlighter.java\n@@ -67,19 +67,28 @@ public class PostingsHighlighter implements Highlighter {\n         SearchContext context = highlighterContext.context;\n         FetchSubPhase.HitContext hitContext = highlighterContext.hitContext;\n \n-        if (!hitContext.cache().containsKey(CACHE_KEY)) {\n+        @SuppressWarnings(\"unchecked\")\n+        Map<Query, HighlighterEntry> cache = (Map<Query, HighlighterEntry>) hitContext.cache().get(CACHE_KEY);\n+        if (cache == null) {\n+            cache = new IdentityHashMap<Query, HighlighterEntry>();\n+            hitContext.cache().put(CACHE_KEY, cache);\n+        }\n+\n+        Query highlightQuery = highlighterContext.highlightQuery;\n+        HighlighterEntry highlighterEntry = cache.get(highlightQuery);\n+        if (highlighterEntry == null) {\n             //get the non rewritten query and rewrite it\n             Query query;\n             try {\n-                query = rewrite(context, hitContext.topLevelReader());\n+                query = rewrite(highlightQuery, context, hitContext.topLevelReader());\n             } catch (IOException e) {\n                 throw new FetchPhaseExecutionException(context, \"Failed to highlight field [\" + highlighterContext.fieldName + \"]\", e);\n             }\n             SortedSet<Term> queryTerms = extractTerms(query);\n-            hitContext.cache().put(CACHE_KEY, new HighlighterEntry(queryTerms));\n+            highlighterEntry = new HighlighterEntry(queryTerms);\n+            cache.put(highlightQuery, highlighterEntry);\n         }\n \n-        HighlighterEntry highlighterEntry = (HighlighterEntry) hitContext.cache().get(CACHE_KEY);\n         MapperHighlighterEntry mapperHighlighterEntry = highlighterEntry.mappers.get(fieldMapper);\n \n         if (mapperHighlighterEntry == null) {\n@@ -146,11 +155,15 @@ public class PostingsHighlighter implements Highlighter {\n         return null;\n     }\n \n-    private static Query rewrite(SearchContext searchContext, IndexReader reader) throws IOException {\n+    private static Query rewrite(Query original, SearchContext searchContext, IndexReader reader) throws IOException {\n+        if (original == null) {\n+            return null;\n+        }\n         //rewrite is expensive: if the query was already rewritten we try not to rewrite\n-        boolean mustRewrite = !searchContext.queryRewritten();\n-\n-        Query original = searchContext.parsedQuery().query();\n+        boolean mustRewrite = true;\n+        if (original == searchContext.parsedQuery().query()) {\n+            mustRewrite = !searchContext.queryRewritten();\n+        }\n \n         MultiTermQuery originalMultiTermQuery = null;\n         MultiTermQuery.RewriteMethod originalRewriteMethod = null;\n@@ -175,11 +188,9 @@ public class PostingsHighlighter implements Highlighter {\n             query = rewrittenQuery;\n         }\n \n-        if (originalMultiTermQuery != null) {\n-            if (originalRewriteMethod != null) {\n-                //set back the original rewrite method after the rewrite is done\n-                originalMultiTermQuery.setRewriteMethod(originalRewriteMethod);\n-            }\n+        if (originalMultiTermQuery != null && originalRewriteMethod != null) {\n+            //set back the original rewrite method after the rewrite is done\n+            originalMultiTermQuery.setRewriteMethod(originalRewriteMethod);\n         }\n \n         return query;\ndiff --git a/src/test/java/org/elasticsearch/search/highlight/HighlighterSearchTests.java b/src/test/java/org/elasticsearch/search/highlight/HighlighterSearchTests.java\nindex f0356d0..0e210ac 100644\n--- a/src/test/java/org/elasticsearch/search/highlight/HighlighterSearchTests.java\n+++ b/src/test/java/org/elasticsearch/search/highlight/HighlighterSearchTests.java\n@@ -1301,7 +1301,7 @@ public class HighlighterSearchTests extends AbstractIntegrationTest {\n     @Test\n     public void testHighlightUsesHighlightQuery() throws IOException {\n         assertAcked(prepareCreate(\"test\")\n-                .addMapping(\"type1\", \"text\", \"type=string,store=yes,term_vector=with_positions_offsets\"));\n+                .addMapping(\"type1\", \"text\", \"type=string,store=yes,term_vector=with_positions_offsets,index_options=offsets\"));\n         ensureGreen();\n \n         index(\"test\", \"type1\", \"1\", \"text\", \"some stuff stuff stuff stuff stuff to highlight against the stuff phrase\");\n@@ -1339,6 +1339,11 @@ public class HighlighterSearchTests extends AbstractIntegrationTest {\n         assertHighlight(response, 0, \"text\", 0, highlightedMatcher);\n         // Note that the plain highlighter doesn't join the highlighted elements for us\n \n+        // And do the same for the postings highlighter\n+        field.highlighterType(\"postings\");\n+        response = search.get();\n+        assertHighlight(response, 0, \"text\", 0, highlightedMatcher);\n+\n         // Make sure the fvh takes the highlightQuery into account when it is set on the highlight context instead of the field\n         search.setHighlighterQuery(matchPhraseQuery(\"text\", \"stuff phrase\"));\n         field.highlighterType(\"fvh\").highlightQuery(null);\n@@ -1350,6 +1355,11 @@ public class HighlighterSearchTests extends AbstractIntegrationTest {\n         response = search.get();\n         assertHighlight(response, 0, \"text\", 0, highlightedMatcher);\n         // Note that the plain highlighter doesn't join the highlighted elements for us\n+\n+        // And do the same for the postings highlighter\n+        field.highlighterType(\"postings\");\n+        response = search.get();\n+        assertHighlight(response, 0, \"text\", 0, highlightedMatcher);\n     }\n \n     private static String randomStoreField() {",
  "logs_path": "codex/gpt-5.1-codex/fd5b3480/elastic_elasticsearch_pr4122/logs.jsonl",
  "errors": [],
  "edit_run_id": "fd5b3480",
  "test_label": "v1-agent-comparison"
}