{
  "repo_url": "https://github.com/elastic/elasticsearch.git",
  "pr_number": 4238,
  "base_commit": "8e17d636ef441a9be80977d34acfaabc12982eb7",
  "runner": "codex",
  "model": "gpt-5.1-codex",
  "timeout_s": 10800,
  "status": "success",
  "elapsed_ms": 197311,
  "patch_unified": "diff --git a/src/main/java/org/elasticsearch/cluster/routing/allocation/decider/ThrottlingAllocationDecider.java b/src/main/java/org/elasticsearch/cluster/routing/allocation/decider/ThrottlingAllocationDecider.java\nindex 8af6d85..dadddbb 100644\n--- a/src/main/java/org/elasticsearch/cluster/routing/allocation/decider/ThrottlingAllocationDecider.java\n+++ b/src/main/java/org/elasticsearch/cluster/routing/allocation/decider/ThrottlingAllocationDecider.java\n@@ -82,7 +82,7 @@ public class ThrottlingAllocationDecider extends AllocationDecider {\n                 List<MutableShardRouting> shards = node.shards();\n                 for (int i = 0; i < shards.size(); i++) {\n                     MutableShardRouting shard = shards.get(i);\n-                    if (shard.state() == ShardRoutingState.INITIALIZING && shard.primary()) {\n+                    if (shard.state() == ShardRoutingState.INITIALIZING && shard.primary() && shard.relocatingNodeId() == null) {\n                         primariesInRecovery++;\n                     }\n                 }\ndiff --git a/src/test/java/org/elasticsearch/cluster/routing/allocation/ThrottlingAllocationTests.java b/src/test/java/org/elasticsearch/cluster/routing/allocation/ThrottlingAllocationTests.java\nindex da89e11..342e2da 100644\n--- a/src/test/java/org/elasticsearch/cluster/routing/allocation/ThrottlingAllocationTests.java\n+++ b/src/test/java/org/elasticsearch/cluster/routing/allocation/ThrottlingAllocationTests.java\n@@ -23,12 +23,21 @@ import org.elasticsearch.cluster.ClusterState;\n import org.elasticsearch.cluster.metadata.IndexMetaData;\n import org.elasticsearch.cluster.metadata.MetaData;\n import org.elasticsearch.cluster.node.DiscoveryNodes;\n+import org.elasticsearch.cluster.routing.MutableShardRouting;\n+import org.elasticsearch.cluster.routing.RoutingNode;\n import org.elasticsearch.cluster.routing.RoutingTable;\n+import org.elasticsearch.cluster.routing.allocation.decider.Decision;\n+import org.elasticsearch.cluster.routing.allocation.decider.ThrottlingAllocationDecider;\n import org.elasticsearch.common.logging.ESLogger;\n import org.elasticsearch.common.logging.Loggers;\n+import org.elasticsearch.common.settings.Settings;\n+import org.elasticsearch.node.settings.NodeSettingsService;\n import org.elasticsearch.test.ElasticsearchTestCase;\n import org.junit.Test;\n \n+import java.util.ArrayList;\n+import java.util.List;\n+\n import static org.elasticsearch.cluster.routing.ShardRoutingState.*;\n import static org.elasticsearch.cluster.routing.allocation.RoutingAllocationTests.newNode;\n import static org.elasticsearch.common.settings.ImmutableSettings.settingsBuilder;\n@@ -171,4 +180,27 @@ public class ThrottlingAllocationTests extends ElasticsearchTestCase {\n         assertThat(routingTable.shardsWithState(INITIALIZING).size(), equalTo(0));\n         assertThat(routingTable.shardsWithState(UNASSIGNED).size(), equalTo(0));\n     }\n+\n+    @Test\n+    public void testRelocatingPrimariesDoNotCountAsLocalRecoveries() {\n+        Settings settings = settingsBuilder()\n+                .put(\"cluster.routing.allocation.node_initial_primaries_recoveries\", 1)\n+                .put(\"cluster.routing.allocation.node_concurrent_recoveries\", 10)\n+                .build();\n+        ThrottlingAllocationDecider decider = new ThrottlingAllocationDecider(settings, new NodeSettingsService(settings));\n+\n+        MutableShardRouting unassignedPrimary = new MutableShardRouting(\"idx\", 1, null, true, UNASSIGNED, 0);\n+\n+        List<MutableShardRouting> shards = new ArrayList<MutableShardRouting>();\n+        shards.add(new MutableShardRouting(\"idx\", 0, \"node1\", \"node0\", true, INITIALIZING, 0));\n+\n+        RoutingNode node = new RoutingNode(\"node1\", newNode(\"node1\"), shards);\n+\n+        Decision decision = decider.canAllocate(unassignedPrimary, node, null);\n+        assertThat(decision, equalTo(Decision.YES));\n+\n+        shards.add(new MutableShardRouting(\"idx\", 2, \"node1\", null, true, INITIALIZING, 0));\n+        decision = decider.canAllocate(unassignedPrimary, node, null);\n+        assertThat(decision, equalTo(Decision.THROTTLE));\n+    }\n }",
  "logs_path": "codex/gpt-5.1-codex/fd5b3480/elastic_elasticsearch_pr4238/logs.jsonl",
  "errors": [],
  "edit_run_id": "fd5b3480",
  "test_label": "v1-agent-comparison"
}