{
  "repo_url": "https://github.com/elastic/elasticsearch.git",
  "pr_number": 134915,
  "base_commit": "dd4b8d96484bc1b0f86d7b006d79cac5916b3f45",
  "head_commit": "526e7d87ca1231e51bd44f0ec00ca32c08367b83",
  "judge_mode": "llm",
  "judge_model": "claude-sonnet-4-5",
  "scores": {
    "correctness": -0.8,
    "completeness": -0.9,
    "code_reuse": -0.7,
    "best_practices": -0.6,
    "unsolicited_docs": 1.0
  },
  "aggregate": -0.4000000000000001,
  "rationale": "The agent's changes are largely incorrect and incomplete. Ground truth adds capability checks using `INLINESTATS_SUPPORTS_REMOTE.isEnabled()` and creates a centralized `randomStats()` helper method in `AbstractCrossClusterTestCase` that is reused across multiple test files (CrossClusterCancellationIT, CrossClusterQueryIT, CrossClusterQueryUnavailableRemotesIT). The agent instead: (1) adds a blanket `assumeFalse` in GenerativeForkRestTest that disables all INLINESTATS tests rather than guarding them properly, (2) uses `Build.current().isSnapshot()` checks instead of the proper capability check `INLINESTATS_SUPPORTS_REMOTE.isEnabled()`, (3) misses the CrossClusterCancellationIT and CrossClusterQueryIT files entirely, (4) fails to create the reusable `randomStats()` helper method, and (5) guards entire test methods in CrossClusterQueryUnavailableRemotesIT rather than just the randomStats() calls. The approach fundamentally misunderstands the task: it should guard specific INLINESTATS usage with capability checks, not disable tests or use incorrect build checks. Missing the helper method also violates code reuse principles present in ground truth.",
  "edit_run_id": "6bf04592",
  "judge_run_id": "609ef74e",
  "ground_truth_patch": "diff --git a/x-pack/plugin/esql/src/internalClusterTest/java/org/elasticsearch/xpack/esql/action/AbstractCrossClusterTestCase.java b/x-pack/plugin/esql/src/internalClusterTest/java/org/elasticsearch/xpack/esql/action/AbstractCrossClusterTestCase.java\nindex 97b89eec429e..cfaa234d39a0 100644\n--- a/x-pack/plugin/esql/src/internalClusterTest/java/org/elasticsearch/xpack/esql/action/AbstractCrossClusterTestCase.java\n+++ b/x-pack/plugin/esql/src/internalClusterTest/java/org/elasticsearch/xpack/esql/action/AbstractCrossClusterTestCase.java\n@@ -45,6 +45,7 @@ import java.util.concurrent.TimeUnit;\n import java.util.concurrent.atomic.AtomicLong;\n \n import static org.elasticsearch.test.hamcrest.ElasticsearchAssertions.assertAcked;\n+import static org.elasticsearch.xpack.esql.action.EsqlCapabilities.Cap.INLINESTATS_SUPPORTS_REMOTE;\n import static org.hamcrest.Matchers.aMapWithSize;\n import static org.hamcrest.Matchers.equalTo;\n import static org.hamcrest.Matchers.greaterThanOrEqualTo;\n@@ -367,4 +368,8 @@ public abstract class AbstractCrossClusterTestCase extends AbstractMultiClusters\n             new EsRejectedExecutionException(\"node is shutting down\")\n         );\n     }\n+\n+    protected static String randomStats() {\n+        return INLINESTATS_SUPPORTS_REMOTE.isEnabled() ? randomFrom(\"STATS\", \"INLINESTATS\") : \"STATS\";\n+    }\n }\ndiff --git a/x-pack/plugin/esql/src/internalClusterTest/java/org/elasticsearch/xpack/esql/action/CrossClusterCancellationIT.java b/x-pack/plugin/esql/src/internalClusterTest/java/org/elasticsearch/xpack/esql/action/CrossClusterCancellationIT.java\nindex b3aa68b4efa4..d7d0256af896 100644\n--- a/x-pack/plugin/esql/src/internalClusterTest/java/org/elasticsearch/xpack/esql/action/CrossClusterCancellationIT.java\n+++ b/x-pack/plugin/esql/src/internalClusterTest/java/org/elasticsearch/xpack/esql/action/CrossClusterCancellationIT.java\n@@ -84,7 +84,7 @@ public class CrossClusterCancellationIT extends AbstractCrossClusterTestCase {\n     public void testCancel() throws Exception {\n         createRemoteIndex(between(10, 100));\n         EsqlQueryRequest request = EsqlQueryRequest.syncEsqlQueryRequest();\n-        String stats = randomFrom(\"STATS\", \"INLINESTATS\");\n+        String stats = randomStats();\n         request.query(\"FROM *:test | \" + stats + \" total=sum(const) | LIMIT 1\");\n         request.pragmas(randomPragmas());\n         PlainActionFuture<EsqlQueryResponse> requestFuture = new PlainActionFuture<>();\n@@ -162,7 +162,7 @@ public class CrossClusterCancellationIT extends AbstractCrossClusterTestCase {\n     public void testTasks() throws Exception {\n         createRemoteIndex(between(10, 100));\n         EsqlQueryRequest request = EsqlQueryRequest.syncEsqlQueryRequest();\n-        String stats = randomFrom(\"STATS\", \"INLINESTATS\");\n+        String stats = randomStats();\n         request.query(\"FROM *:test | \" + stats + \" total=sum(const) | LIMIT 1\");\n         request.pragmas(randomPragmas());\n         ActionFuture<EsqlQueryResponse> requestFuture = client().execute(EsqlQueryAction.INSTANCE, request);\n@@ -201,7 +201,7 @@ public class CrossClusterCancellationIT extends AbstractCrossClusterTestCase {\n     public void testCancelSkipUnavailable() throws Exception {\n         createRemoteIndex(between(10, 100));\n         EsqlQueryRequest request = EsqlQueryRequest.syncEsqlQueryRequest();\n-        String stats = randomFrom(\"STATS\", \"INLINESTATS\");\n+        String stats = randomStats();\n         request.query(\"FROM *:test | \" + stats + \" total=sum(const) | LIMIT 1\");\n         request.pragmas(randomPragmas());\n         request.includeCCSMetadata(true);\ndiff --git a/x-pack/plugin/esql/src/internalClusterTest/java/org/elasticsearch/xpack/esql/action/CrossClusterQueryIT.java b/x-pack/plugin/esql/src/internalClusterTest/java/org/elasticsearch/xpack/esql/action/CrossClusterQueryIT.java\nindex 6aaf7b18a14d..f3ba9b3ba34f 100644\n--- a/x-pack/plugin/esql/src/internalClusterTest/java/org/elasticsearch/xpack/esql/action/CrossClusterQueryIT.java\n+++ b/x-pack/plugin/esql/src/internalClusterTest/java/org/elasticsearch/xpack/esql/action/CrossClusterQueryIT.java\n@@ -791,6 +791,7 @@ public class CrossClusterQueryIT extends AbstractCrossClusterTestCase {\n     }\n \n     public void testRemoteFailureInlinestats() throws IOException {\n+        assumeTrue(\"requires inlinestats\", EsqlCapabilities.Cap.INLINESTATS_SUPPORTS_REMOTE.isEnabled());\n         Map<String, Object> testClusterInfo = setupFailClusters();\n         String localIndex = (String) testClusterInfo.get(\"local.index\");\n         String remote1Index = (String) testClusterInfo.get(\"remote.index\");\ndiff --git a/x-pack/plugin/esql/src/internalClusterTest/java/org/elasticsearch/xpack/esql/action/CrossClusterQueryUnavailableRemotesIT.java b/x-pack/plugin/esql/src/internalClusterTest/java/org/elasticsearch/xpack/esql/action/CrossClusterQueryUnavailableRemotesIT.java\nindex b92947fb828d..4cc90a3ed722 100644\n--- a/x-pack/plugin/esql/src/internalClusterTest/java/org/elasticsearch/xpack/esql/action/CrossClusterQueryUnavailableRemotesIT.java\n+++ b/x-pack/plugin/esql/src/internalClusterTest/java/org/elasticsearch/xpack/esql/action/CrossClusterQueryUnavailableRemotesIT.java\n@@ -159,6 +159,7 @@ public class CrossClusterQueryUnavailableRemotesIT extends AbstractCrossClusterT\n     }\n \n     public void testCCSAgainstDisconnectedRemoteWithSkipUnavailableTrueInlinestats() throws Exception {\n+        assumeTrue(\"requires inlinestats\", EsqlCapabilities.Cap.INLINESTATS_SUPPORTS_REMOTE.isEnabled());\n         int numClusters = 3;\n         Map<String, Object> testClusterInfo = setupClusters(numClusters);\n         int localNumShards = (Integer) testClusterInfo.get(\"local.num_shards\");\n@@ -289,7 +290,7 @@ public class CrossClusterQueryUnavailableRemotesIT extends AbstractCrossClusterT\n             Boolean requestIncludeMeta = includeCCSMetadata.v1();\n             boolean responseExpectMeta = includeCCSMetadata.v2();\n \n-            String stats = randomFrom(\"STATS\", \"INLINESTATS\");\n+            String stats = randomStats();\n             // query only the REMOTE_CLUSTER_1\n             try (\n                 EsqlQueryResponse resp = runQuery(\n@@ -379,7 +380,7 @@ public class CrossClusterQueryUnavailableRemotesIT extends AbstractCrossClusterT\n             Tuple<Boolean, Boolean> includeCCSMetadata = randomIncludeCCSMetadata();\n             Boolean requestIncludeMeta = includeCCSMetadata.v1();\n \n-            String stats = randomFrom(\"STATS\", \"INLINESTATS\");\n+            String stats = randomStats();\n             final Exception exception = expectThrows(\n                 Exception.class,\n                 () -> runQuery(\"FROM logs-*,*:logs-* | \" + stats + \" sum (v) | SORT v\", requestIncludeMeta)\n@@ -399,7 +400,7 @@ public class CrossClusterQueryUnavailableRemotesIT extends AbstractCrossClusterT\n         try {\n             Tuple<Boolean, Boolean> includeCCSMetadata = randomIncludeCCSMetadata();\n             Boolean requestIncludeMeta = includeCCSMetadata.v1();\n-            String stats = randomFrom(\"STATS\", \"INLINESTATS\");\n+            String stats = randomStats();\n             {\n                 // close the remote cluster so that it is unavailable\n                 cluster(REMOTE_CLUSTER_1).close();"
}