{
  "repo_url": "https://github.com/elastic/elasticsearch.git",
  "pr_number": 134790,
  "base_commit": "e929c93ac04627c8d4d0ac47c45efcaa715f7fc5",
  "head_commit": "df9982136705897da6187ece3dd33562f9fdfc59",
  "judge_mode": "llm",
  "judge_model": "claude-sonnet-4-5",
  "scores": {
    "correctness": -1.0,
    "completeness": -1.0,
    "code_reuse": 0.0,
    "best_practices": 0.0,
    "unsolicited_docs": 0.0
  },
  "aggregate": -0.4,
  "rationale": "The agent produced an empty diff with no changes whatsoever, despite the task requesting to 'Fix the selected code'. The ground truth shows a comprehensive bug fix that: (1) adds a new field 'lastOptimisedValue' to cache optimized values in ESUTF8StreamJsonParser.java, (2) implements logic to facilitate second retrieval of the same value by returning the cached value, (3) refactors duplicate token state reset logic into a new 'maybeResetCurrentTokenState()' method that also clears the cache, (4) adds comprehensive tests in ESUTF8StreamJsonParserTests.java to verify double retrieval works, (5) adds a YAML REST API test for multi-field keyword scenarios with escaped characters, (6) registers a new node feature flag 'MULTI_FIELD_UNICODE_OPTIMISATION_FIX' in MapperFeatures.java, and (7) creates a changelog entry documenting the bug fix for issue #134770. The agent failed to implement any of these changes, resulting in complete absence of the requested functionality. Since no code was written, code_reuse and best_practices are not applicable (scored as 0.0), and there is no unsolicited documentation to penalize (scored as 0.0).",
  "edit_run_id": "24634b85",
  "judge_run_id": "3e164e1c",
  "ground_truth_patch": "diff --git a/docs/changelog/134790.yaml b/docs/changelog/134790.yaml\nnew file mode 100644\nindex 00000000000..d59f0acb4bc\n--- /dev/null\n+++ b/docs/changelog/134790.yaml\n@@ -0,0 +1,6 @@\n+pr: 134790\n+summary: \"Bug fix: Facilitate second retrieval of the same value\"\n+area: Infra/Core\n+type: bug\n+issues:\n+ - 134770\ndiff --git a/libs/x-content/impl/src/main/java/org/elasticsearch/xcontent/provider/json/ESUTF8StreamJsonParser.java b/libs/x-content/impl/src/main/java/org/elasticsearch/xcontent/provider/json/ESUTF8StreamJsonParser.java\nindex bf33f2b3ae6..c5c5f514885 100644\n--- a/libs/x-content/impl/src/main/java/org/elasticsearch/xcontent/provider/json/ESUTF8StreamJsonParser.java\n+++ b/libs/x-content/impl/src/main/java/org/elasticsearch/xcontent/provider/json/ESUTF8StreamJsonParser.java\n@@ -28,6 +28,7 @@ import java.util.List;\n public class ESUTF8StreamJsonParser extends UTF8StreamJsonParser implements OptimizedTextCapable {\n     protected int stringEnd = -1;\n     protected int stringLength;\n+    protected byte[] lastOptimisedValue;\n \n     private final List<Integer> backslashes = new ArrayList<>();\n \n@@ -53,6 +54,9 @@ public class ESUTF8StreamJsonParser extends UTF8StreamJsonParser implements Opti\n     @Override\n     public Text getValueAsText() throws IOException {\n         if (_currToken == JsonToken.VALUE_STRING && _tokenIncomplete) {\n+            if (lastOptimisedValue != null) {\n+                return new Text(new XContentString.UTF8Bytes(lastOptimisedValue), stringLength);\n+            }\n             if (stringEnd > 0) {\n                 final int len = stringEnd - 1 - _inputPtr;\n                 return new Text(new XContentString.UTF8Bytes(_inputBuffer, _inputPtr, len), stringLength);\n@@ -137,37 +141,40 @@ public class ESUTF8StreamJsonParser extends UTF8StreamJsonParser implements Opti\n                 copyPtr = backslash + 1;\n             }\n             System.arraycopy(inputBuffer, copyPtr, buff, destPtr, ptr - copyPtr);\n+            lastOptimisedValue = buff;\n             return new Text(new XContentString.UTF8Bytes(buff), stringLength);\n         }\n     }\n \n     @Override\n     public JsonToken nextToken() throws IOException {\n-        if (_currToken == JsonToken.VALUE_STRING && _tokenIncomplete && stringEnd > 0) {\n-            _inputPtr = stringEnd;\n-            _tokenIncomplete = false;\n-        }\n+        maybeResetCurrentTokenState();\n         stringEnd = -1;\n         return super.nextToken();\n     }\n \n     @Override\n     public boolean nextFieldName(SerializableString str) throws IOException {\n-        if (_currToken == JsonToken.VALUE_STRING && _tokenIncomplete && stringEnd > 0) {\n-            _inputPtr = stringEnd;\n-            _tokenIncomplete = false;\n-        }\n+        maybeResetCurrentTokenState();\n         stringEnd = -1;\n         return super.nextFieldName(str);\n     }\n \n     @Override\n     public String nextFieldName() throws IOException {\n+        maybeResetCurrentTokenState();\n+        stringEnd = -1;\n+        return super.nextFieldName();\n+    }\n+\n+    /**\n+     * Resets the current token state before moving to the next.\n+     */\n+    private void maybeResetCurrentTokenState() {\n         if (_currToken == JsonToken.VALUE_STRING && _tokenIncomplete && stringEnd > 0) {\n             _inputPtr = stringEnd;\n             _tokenIncomplete = false;\n+            lastOptimisedValue = null;\n         }\n-        stringEnd = -1;\n-        return super.nextFieldName();\n     }\n }\ndiff --git a/libs/x-content/impl/src/test/java/org/elasticsearch/xcontent/provider/json/ESUTF8StreamJsonParserTests.java b/libs/x-content/impl/src/test/java/org/elasticsearch/xcontent/provider/json/ESUTF8StreamJsonParserTests.java\nindex de74def9397..5fdf000630b 100644\n--- a/libs/x-content/impl/src/test/java/org/elasticsearch/xcontent/provider/json/ESUTF8StreamJsonParserTests.java\n+++ b/libs/x-content/impl/src/test/java/org/elasticsearch/xcontent/provider/json/ESUTF8StreamJsonParserTests.java\n@@ -57,14 +57,30 @@ public class ESUTF8StreamJsonParserTests extends ESTestCase {\n             assertThat(parser.nextToken(), Matchers.equalTo(JsonToken.END_OBJECT));\n         });\n \n-        testParseJson(\"{\\\"foo\\\": \\\"bar\\\\\\\"baz\\\\\\\"\\\"}\", parser -> {\n+        testParseJson(\"{\\\"foo\\\": [\\\"bar\\\\\\\"baz\\\\\\\"\\\", \\\"foobar\\\"]}\", parser -> {\n             assertThat(parser.nextToken(), Matchers.equalTo(JsonToken.START_OBJECT));\n             assertThat(parser.nextFieldName(), Matchers.equalTo(\"foo\"));\n+\n+            assertThat(parser.nextValue(), Matchers.equalTo(JsonToken.START_ARRAY));\n             assertThat(parser.nextValue(), Matchers.equalTo(JsonToken.VALUE_STRING));\n \n-            var text = parser.getValueAsText();\n-            assertThat(text, Matchers.notNullValue());\n-            assertTextRef(text.bytes(), \"bar\\\"baz\\\"\");\n+            var firstText = parser.getValueAsText();\n+            assertThat(firstText, Matchers.notNullValue());\n+            assertTextRef(firstText.bytes(), \"bar\\\"baz\\\"\");\n+            // Retrieve the value for a second time to ensure the last value is available\n+            firstText = parser.getValueAsText();\n+            assertThat(firstText, Matchers.notNullValue());\n+            assertTextRef(firstText.bytes(), \"bar\\\"baz\\\"\");\n+\n+            // Ensure values lastOptimisedValue is reset\n+            assertThat(parser.nextValue(), Matchers.equalTo(JsonToken.VALUE_STRING));\n+            var secondTest = parser.getValueAsText();\n+            assertThat(secondTest, Matchers.notNullValue());\n+            assertTextRef(secondTest.bytes(), \"foobar\");\n+            secondTest = parser.getValueAsText();\n+            assertThat(secondTest, Matchers.notNullValue());\n+            assertTextRef(secondTest.bytes(), \"foobar\");\n+            assertThat(parser.nextValue(), Matchers.equalTo(JsonToken.END_ARRAY));\n         });\n \n         testParseJson(\"{\\\"foo\\\": \\\"b\\\\u00e5r\\\"}\", parser -> {\n@@ -256,9 +272,17 @@ public class ESUTF8StreamJsonParserTests extends ESTestCase {\n                     var text = parser.getValueAsText();\n                     assertTextRef(text.bytes(), currVal);\n                     assertThat(text.stringLength(), Matchers.equalTo(currVal.length()));\n+\n+                    // Retrieve it twice to ensure it works as expected\n+                    text = parser.getValueAsText();\n+                    assertTextRef(text.bytes(), currVal);\n+                    assertThat(text.stringLength(), Matchers.equalTo(currVal.length()));\n                 } else {\n                     assertThat(parser.getValueAsText(), Matchers.nullValue());\n                     assertThat(parser.getValueAsString(), Matchers.equalTo(currVal));\n+                    // Retrieve it twice to ensure it works as expected\n+                    assertThat(parser.getValueAsText(), Matchers.nullValue());\n+                    assertThat(parser.getValueAsString(), Matchers.equalTo(currVal));\n                 }\n             }\n         });\ndiff --git a/rest-api-spec/src/yamlRestTest/resources/rest-api-spec/test/mapping/30_multi_field_keyword.yml b/rest-api-spec/src/yamlRestTest/resources/rest-api-spec/test/mapping/30_multi_field_keyword.yml\nnew file mode 100644\nindex 00000000000..bcd772b84bb\n--- /dev/null\n+++ b/rest-api-spec/src/yamlRestTest/resources/rest-api-spec/test/mapping/30_multi_field_keyword.yml\n@@ -0,0 +1,49 @@\n+---\n+Keyword with escaped characters as multi-field:\n+  - requires:\n+      cluster_features: [ \"mapper.multi_field.unicode_optimisation_fix\" ]\n+      reason: \"requires a fix (#134770)\"\n+  - do:\n+      indices.create:\n+        index: test\n+        body:\n+          mappings:\n+            properties:\n+              foo:\n+                type: keyword\n+                fields:\n+                  bar:\n+                    type: keyword\n+\n+  - do:\n+      index:\n+        index: test\n+        id:    \"1\"\n+        refresh: true\n+        body:\n+          foo: \"c:\\\\windows\\\\system32\\\\svchost.exe\"\n+\n+  - do:\n+      search:\n+        index: test\n+        body:\n+          query:\n+            term:\n+              foo: \"c:\\\\windows\\\\system32\\\\svchost.exe\"\n+\n+  - match: { \"hits.total.value\": 1 }\n+  - match:\n+      hits.hits.0._source.foo: \"c:\\\\windows\\\\system32\\\\svchost.exe\"\n+\n+  # Test that optimisation works the same for the multi-fields as well.\n+  - do:\n+      search:\n+        index: test\n+        body:\n+          query:\n+            term:\n+              foo.bar: \"c:\\\\windows\\\\system32\\\\svchost.exe\"\n+\n+  - match: { \"hits.total.value\": 1 }\n+  - match:\n+      hits.hits.0._source.foo: \"c:\\\\windows\\\\system32\\\\svchost.exe\"\ndiff --git a/server/src/main/java/org/elasticsearch/index/mapper/MapperFeatures.java b/server/src/main/java/org/elasticsearch/index/mapper/MapperFeatures.java\nindex 284a2de238f..4397f399222 100644\n--- a/server/src/main/java/org/elasticsearch/index/mapper/MapperFeatures.java\n+++ b/server/src/main/java/org/elasticsearch/index/mapper/MapperFeatures.java\n@@ -48,6 +48,7 @@ public class MapperFeatures implements FeatureSpecification {\n     static final NodeFeature SEARCH_LOAD_PER_SHARD = new NodeFeature(\"mapper.search_load_per_shard\");\n     static final NodeFeature PATTERNED_TEXT = new NodeFeature(\"mapper.patterned_text\");\n     static final NodeFeature IGNORED_SOURCE_FIELDS_PER_ENTRY = new NodeFeature(\"mapper.ignored_source_fields_per_entry\");\n+    public static final NodeFeature MULTI_FIELD_UNICODE_OPTIMISATION_FIX = new NodeFeature(\"mapper.multi_field.unicode_optimisation_fix\");\n \n     @Override\n     public Set<NodeFeature> getTestFeatures() {\n@@ -82,7 +83,8 @@ public class MapperFeatures implements FeatureSpecification {\n             SEARCH_LOAD_PER_SHARD,\n             SPARSE_VECTOR_INDEX_OPTIONS_FEATURE,\n             PATTERNED_TEXT,\n-            IGNORED_SOURCE_FIELDS_PER_ENTRY\n+            IGNORED_SOURCE_FIELDS_PER_ENTRY,\n+            MULTI_FIELD_UNICODE_OPTIMISATION_FIX\n         );\n     }\n }"
}