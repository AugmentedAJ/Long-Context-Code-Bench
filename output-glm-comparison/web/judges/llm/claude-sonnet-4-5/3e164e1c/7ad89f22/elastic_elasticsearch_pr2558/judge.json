{
  "repo_url": "https://github.com/elastic/elasticsearch.git",
  "pr_number": 2558,
  "base_commit": "2eb09e6b1abceb316c789f173988ac733a55dc8b",
  "head_commit": "3d80c53192270daa4f4e8b00a2a11c68d13ab8c1",
  "judge_mode": "llm",
  "judge_model": "claude-sonnet-4-5",
  "scores": {
    "correctness": -0.3,
    "completeness": -0.7,
    "code_reuse": 0.0,
    "best_practices": -0.2,
    "unsolicited_docs": 1.0
  },
  "aggregate": -0.039999999999999994,
  "rationale": "The agent's implementation has several issues compared to ground truth: (1) Missing the loadShardsAllocator() method that ground truth extracted for better separation of concerns. (2) Missing the constructor initialization call to loadShardsAllocator(settings), which means the shardsAllocator field won't be populated early. (3) Missing the null check guard in configure() that ground truth added. (4) Incorrect class name suffix in getAsClass() - uses 'ShardsAllocator' instead of 'Allocator', which won't match existing allocator class names correctly. (5) Uses equalsIgnoreCase() instead of equals() for type comparison, which is less strict than ground truth. (6) Completely missing the test file (ShardsAllocatorModuleTests.java) that ground truth added, which is a significant omission for verifying the feature works. (7) Constant naming differs slightly (BALANCED_ALLOCATOR vs BALANCED_ALLOCATOR_KEY, EVEN_SHARD_ALLOCATOR vs EVEN_SHARD_COUNT_ALLOCATOR_KEY) but this is minor. The core logic flow is present but the implementation details and test coverage are substantially incomplete.",
  "edit_run_id": "7ad89f22",
  "judge_run_id": "3e164e1c",
  "ground_truth_patch": "diff --git a/src/main/java/org/elasticsearch/cluster/routing/allocation/allocator/ShardsAllocatorModule.java b/src/main/java/org/elasticsearch/cluster/routing/allocation/allocator/ShardsAllocatorModule.java\nindex a3d8da25616..c5b67259a20 100644\n--- a/src/main/java/org/elasticsearch/cluster/routing/allocation/allocator/ShardsAllocatorModule.java\n+++ b/src/main/java/org/elasticsearch/cluster/routing/allocation/allocator/ShardsAllocatorModule.java\n@@ -26,6 +26,12 @@ import org.elasticsearch.gateway.none.NoneGatewayAllocator;\n /**\n  */\n public class ShardsAllocatorModule extends AbstractModule {\n+\t\n+    public static final String EVEN_SHARD_COUNT_ALLOCATOR_KEY = \"even_shard\";\n+\n+    public static final String BALANCED_ALLOCATOR_KEY = \"balanced\"; // default\n+\n+    public static final String TYPE_KEY = \"cluster.routing.allocation.type\";\n \n     private Settings settings;\n \n@@ -35,6 +41,7 @@ public class ShardsAllocatorModule extends AbstractModule {\n \n     public ShardsAllocatorModule(Settings settings) {\n         this.settings = settings;\n+        shardsAllocator = loadShardsAllocator(settings);\n     }\n \n     public void setGatewayAllocator(Class<? extends GatewayAllocator> gatewayAllocator) {\n@@ -47,7 +54,24 @@ public class ShardsAllocatorModule extends AbstractModule {\n \n     @Override\n     protected void configure() {\n+        if (shardsAllocator == null) {\n+            shardsAllocator = loadShardsAllocator(settings);\n+        }\n         bind(GatewayAllocator.class).to(gatewayAllocator).asEagerSingleton();\n-        bind(ShardsAllocator.class).to(shardsAllocator == null ? BalancedShardsAllocator.class : shardsAllocator).asEagerSingleton();\n+        bind(ShardsAllocator.class).to(shardsAllocator).asEagerSingleton();\n+    }\n+    \n+    private Class<? extends ShardsAllocator> loadShardsAllocator(Settings settings) {\n+        final Class<? extends ShardsAllocator> shardsAllocator;\n+        final String type = settings.get(TYPE_KEY, BALANCED_ALLOCATOR_KEY);\n+        if (BALANCED_ALLOCATOR_KEY.equals(type)) {\n+            shardsAllocator = BalancedShardsAllocator.class;\n+        } else if (EVEN_SHARD_COUNT_ALLOCATOR_KEY.equals(type)) {\n+            shardsAllocator = EvenShardsCountAllocator.class;\n+        } else {\n+            shardsAllocator = settings.getAsClass(TYPE_KEY, BalancedShardsAllocator.class,\n+                    \"org.elasticsearch.cluster.routing.allocation.allocator.\", \"Allocator\");\n+        }\n+        return shardsAllocator;\n     }\n }\ndiff --git a/src/test/java/org/elasticsearch/test/unit/cluster/routing/allocation/ShardsAllocatorModuleTests.java b/src/test/java/org/elasticsearch/test/unit/cluster/routing/allocation/ShardsAllocatorModuleTests.java\nnew file mode 100644\nindex 00000000000..9798eb5b9a7\n--- /dev/null\n+++ b/src/test/java/org/elasticsearch/test/unit/cluster/routing/allocation/ShardsAllocatorModuleTests.java\n@@ -0,0 +1,75 @@\n+package org.elasticsearch.test.unit.cluster.routing.allocation;\n+\n+/*\n+ * Licensed to ElasticSearch and Shay Banon under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership. ElasticSearch licenses this\n+ * file to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+import static org.elasticsearch.common.settings.ImmutableSettings.settingsBuilder;\n+import static org.hamcrest.MatcherAssert.assertThat;\n+import static org.hamcrest.Matchers.instanceOf;\n+\n+import org.elasticsearch.cluster.routing.allocation.allocator.BalancedShardsAllocator;\n+import org.elasticsearch.cluster.routing.allocation.allocator.EvenShardsCountAllocator;\n+import org.elasticsearch.cluster.routing.allocation.allocator.ShardsAllocator;\n+import org.elasticsearch.cluster.routing.allocation.allocator.ShardsAllocatorModule;\n+import org.elasticsearch.common.settings.ImmutableSettings;\n+import org.elasticsearch.common.settings.Settings;\n+import org.elasticsearch.node.Node;\n+import org.elasticsearch.node.internal.InternalNode;\n+import org.elasticsearch.test.integration.AbstractNodesTests;\n+import org.testng.annotations.AfterMethod;\n+import org.testng.annotations.Test;\n+\n+@Test\n+public class ShardsAllocatorModuleTests extends AbstractNodesTests {\n+\n+    @AfterMethod\n+    public void cleanAndCloseNodes() throws Exception {\n+        closeAllNodes();\n+    }\n+\n+    public void testLoadDefaultShardsAllocator() {\n+        assertAllocatorInstance(ImmutableSettings.Builder.EMPTY_SETTINGS, BalancedShardsAllocator.class);\n+    }\n+\n+    public void testLoadByShortKeyShardsAllocator() {\n+        Settings build = settingsBuilder().put(ShardsAllocatorModule.TYPE_KEY, ShardsAllocatorModule.EVEN_SHARD_COUNT_ALLOCATOR_KEY)\n+                .build();\n+        assertAllocatorInstance(build, EvenShardsCountAllocator.class);\n+\n+        build = settingsBuilder().put(ShardsAllocatorModule.TYPE_KEY, ShardsAllocatorModule.BALANCED_ALLOCATOR_KEY).build();\n+        assertAllocatorInstance(build, BalancedShardsAllocator.class);\n+    }\n+\n+    public void testLoadByClassNameShardsAllocator() {\n+        Settings build = settingsBuilder().put(ShardsAllocatorModule.TYPE_KEY, \"EvenShardsCount\").build();\n+        assertAllocatorInstance(build, EvenShardsCountAllocator.class);\n+\n+        build = settingsBuilder().put(ShardsAllocatorModule.TYPE_KEY,\n+                \"org.elasticsearch.cluster.routing.allocation.allocator.EvenShardsCountAllocator\").build();\n+        assertAllocatorInstance(build, EvenShardsCountAllocator.class);\n+    }\n+\n+    private void assertAllocatorInstance(Settings settings, Class<? extends ShardsAllocator> clazz) {\n+        Node _node = startNode(\"node\", settings);\n+        InternalNode node = (InternalNode) _node;\n+        ShardsAllocator instance = node.injector().getInstance(ShardsAllocator.class);\n+        node.close();\n+        assertThat(instance, instanceOf(clazz));\n+    }\n+}"
}