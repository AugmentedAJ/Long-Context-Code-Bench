{
  "repo_url": "https://github.com/elastic/elasticsearch.git",
  "pr_number": 134776,
  "base_commit": "2ea81d0548b2a25633ffe948cd9304a2c0c59563",
  "head_commit": "f72a759ef9c123793dbb5aeb05c295e3ecadaf0b",
  "judge_mode": "llm",
  "judge_model": "claude-sonnet-4-5",
  "scores": {
    "correctness": -0.7,
    "completeness": -0.8,
    "code_reuse": -0.5,
    "best_practices": -0.6,
    "unsolicited_docs": -0.3
  },
  "aggregate": -0.58,
  "rationale": "The agent's implementation has critical gaps compared to ground truth: (1) Missing the VALID_CLOUD_AUTH_TYPES validation map that enforces which authentication types are valid for each subject type, (2) Missing Subject.Type parameter entirely - the unified method signature only takes authenticationType but not subjectType, making it impossible to distinguish CLOUD_API_KEY from USER subjects, (3) Missing RealmIdentifier parameter and logic to construct RealmRef differently based on subject type, (4) Missing @Deprecated annotations on legacy methods, (5) Test files not updated to use the new signature with additional parameters. The agent's method signature newCloudAuthentication(authResult, realmRef, authenticationType) cannot handle both authentication types AND subject types as required - it only handles authentication types. The ground truth signature newCloudAuthentication(authenticationType, subjectType, authResult, nodeName, realmId) properly separates concerns and validates combinations. The agent added unsolicited JavaDoc comments when none were in ground truth. This implementation would fail to support request-scoped-tokens properly because it lacks subject type differentiation.",
  "edit_run_id": "7ad89f22",
  "judge_run_id": "3e164e1c",
  "ground_truth_patch": "diff --git a/x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/security/authc/Authentication.java b/x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/security/authc/Authentication.java\nindex ac543c4f81c..55f1d33d97b 100644\n--- a/x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/security/authc/Authentication.java\n+++ b/x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/security/authc/Authentication.java\n@@ -1376,26 +1376,61 @@ public final class Authentication implements ToXContentObject {\n         return authentication;\n     }\n \n+    private static final Map<Subject.Type, Set<AuthenticationType>> VALID_CLOUD_AUTH_TYPES = Map.ofEntries(\n+        Map.entry(Subject.Type.CLOUD_API_KEY, Set.of(AuthenticationType.API_KEY, AuthenticationType.TOKEN)),\n+        Map.entry(Subject.Type.USER, Set.of(AuthenticationType.TOKEN))\n+    );\n+\n+    public static Authentication newCloudAuthentication(\n+        AuthenticationType authenticationType,\n+        Subject.Type subjectType,\n+        AuthenticationResult<User> authenticationResult,\n+        String nodeName,\n+        @Nullable RealmIdentifier realmId\n+    ) {\n+        assert authenticationResult.isAuthenticated() : \"cloud authentication results must be successful\";\n+\n+        if (VALID_CLOUD_AUTH_TYPES.getOrDefault(subjectType, Set.of()).contains(authenticationType) == false) {\n+            throw new IllegalArgumentException(\n+                \"Cannot create cloud [\" + subjectType + \"] authentication with authentication type [\" + authenticationType + \"]\"\n+            );\n+        }\n+\n+        final User user = authenticationResult.getValue();\n+        final RealmRef realmRef;\n+        if (subjectType == Subject.Type.CLOUD_API_KEY) {\n+            assert realmId == null : \"Cannot have realm id [\" + realmId + \"] for cloud API Key subject [\" + user + \"]\";\n+            realmRef = newCloudApiKeyRealmRef(nodeName);\n+        } else if (subjectType == Subject.Type.USER) {\n+            assert realmId != null : \"Must have realm id for cloud user subject [\" + user + \"]\";\n+            realmRef = new RealmRef(realmId.getName(), realmId.getType(), nodeName);\n+        } else {\n+            throw new IllegalArgumentException(\"Unsupported subject type [\" + subjectType + \"] for cloud authentication\");\n+        }\n+\n+        return new Authentication(\n+            new Subject(user, realmRef, TransportVersion.current(), authenticationResult.getMetadata()),\n+            authenticationType\n+        );\n+    }\n+\n+    @Deprecated\n     public static Authentication newCloudAccessTokenAuthentication(\n         AuthenticationResult<User> authResult,\n         Authentication.RealmRef realmRef\n     ) {\n-        assert authResult.isAuthenticated() : \"cloud access token authn result must be successful\";\n-        final User user = authResult.getValue();\n-        return new Authentication(\n-            new Subject(user, realmRef, TransportVersion.current(), authResult.getMetadata()),\n-            AuthenticationType.TOKEN\n+        return newCloudAuthentication(\n+            AuthenticationType.TOKEN,\n+            Subject.Type.USER,\n+            authResult,\n+            realmRef.nodeName,\n+            new RealmIdentifier(realmRef.type, realmRef.name)\n         );\n     }\n \n+    @Deprecated\n     public static Authentication newCloudApiKeyAuthentication(AuthenticationResult<User> authResult, String nodeName) {\n-        assert authResult.isAuthenticated() : \"cloud API Key authn result must be successful\";\n-        final User apiKeyUser = authResult.getValue();\n-        final Authentication.RealmRef authenticatedBy = newCloudApiKeyRealmRef(nodeName);\n-        return new Authentication(\n-            new Subject(apiKeyUser, authenticatedBy, TransportVersion.current(), authResult.getMetadata()),\n-            AuthenticationType.API_KEY\n-        );\n+        return newCloudAuthentication(AuthenticationType.API_KEY, Subject.Type.CLOUD_API_KEY, authResult, nodeName, null);\n     }\n \n     public static Authentication newApiKeyAuthentication(AuthenticationResult<User> authResult, String nodeName) {\ndiff --git a/x-pack/plugin/core/src/test/java/org/elasticsearch/xpack/core/security/authc/AuthenticationSerializationTests.java b/x-pack/plugin/core/src/test/java/org/elasticsearch/xpack/core/security/authc/AuthenticationSerializationTests.java\nindex 095a7ed6c59..dd01b9e8b10 100644\n--- a/x-pack/plugin/core/src/test/java/org/elasticsearch/xpack/core/security/authc/AuthenticationSerializationTests.java\n+++ b/x-pack/plugin/core/src/test/java/org/elasticsearch/xpack/core/security/authc/AuthenticationSerializationTests.java\n@@ -116,9 +116,12 @@ public class AuthenticationSerializationTests extends ESTestCase {\n     }\n \n     public void testWriteToAndReadFromWithCloudApiKeyAuthentication() throws Exception {\n-        final Authentication authentication = Authentication.newCloudApiKeyAuthentication(\n+        final Authentication authentication = Authentication.newCloudAuthentication(\n+            Authentication.AuthenticationType.API_KEY,\n+            Subject.Type.CLOUD_API_KEY,\n             AuthenticationResult.success(new User(randomAlphanumericOfLength(5), \"superuser\"), Map.of()),\n-            randomAlphanumericOfLength(10)\n+            randomAlphanumericOfLength(10),\n+            null\n         );\n \n         assertThat(authentication.isCloudApiKey(), is(true));\n@@ -133,9 +136,12 @@ public class AuthenticationSerializationTests extends ESTestCase {\n     }\n \n     public void testWriteToWithCloudApiKeyThrowsOnUnsupportedVersion() {\n-        final Authentication authentication = Authentication.newCloudApiKeyAuthentication(\n+        final Authentication authentication = Authentication.newCloudAuthentication(\n+            Authentication.AuthenticationType.API_KEY,\n+            Subject.Type.CLOUD_API_KEY,\n             AuthenticationResult.success(new User(randomAlphanumericOfLength(5), \"superuser\"), Map.of()),\n-            randomAlphanumericOfLength(10)\n+            randomAlphanumericOfLength(10),\n+            null\n         );\n \n         try (BytesStreamOutput out = new BytesStreamOutput()) {\ndiff --git a/x-pack/plugin/core/src/test/java/org/elasticsearch/xpack/core/security/authc/AuthenticationTestHelper.java b/x-pack/plugin/core/src/test/java/org/elasticsearch/xpack/core/security/authc/AuthenticationTestHelper.java\nindex e9449e78445..91fcdad5bb1 100644\n--- a/x-pack/plugin/core/src/test/java/org/elasticsearch/xpack/core/security/authc/AuthenticationTestHelper.java\n+++ b/x-pack/plugin/core/src/test/java/org/elasticsearch/xpack/core/security/authc/AuthenticationTestHelper.java\n@@ -287,9 +287,12 @@ public class AuthenticationTestHelper {\n \n         assert user.principal().equals(apiKeyId) : \"user principal must match cloud API key ID\";\n \n-        return Authentication.newCloudApiKeyAuthentication(\n+        return Authentication.newCloudAuthentication(\n+            Authentication.AuthenticationType.API_KEY,\n+            Subject.Type.CLOUD_API_KEY,\n             AuthenticationResult.success(user, user.metadata()),\n-            \"node_\" + ESTestCase.randomAlphaOfLengthBetween(3, 8)\n+            \"node_\" + ESTestCase.randomAlphaOfLengthBetween(3, 8),\n+            null\n         );\n \n     }"
}