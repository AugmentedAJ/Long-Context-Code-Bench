{
  "repo_url": "https://github.com/elastic/elasticsearch.git",
  "pr_number": 1609,
  "base_commit": "0530115f62fc2128196fc0f3e39af4d4d1a2aea5",
  "head_commit": "4b21cf2993f4c71d984e6f07cc3aeb6f6e7f6ae8",
  "judge_mode": "llm",
  "judge_model": "claude-sonnet-4-5",
  "scores": {
    "correctness": 0.0,
    "completeness": -0.1,
    "code_reuse": 0.0,
    "best_practices": 0.0,
    "unsolicited_docs": 0.0
  },
  "aggregate": -0.02,
  "rationale": "The agent's implementation is functionally correct and nearly complete. All core changes are present: added percolate field to UpdateRequest with getter/setter, serialization logic in readFrom/writeTo, percolate configuration in TransportUpdateAction, matches field in UpdateResponse with serialization, and REST API integration in RestUpdateAction. However, there are two minor differences: 1) In TransportUpdateAction.java, the TODO comment removal is missing (line 211 in ground truth removes '// TODO percolate?'), and 2) In RestUpdateAction.java, the percolate parameter extraction uses `request.param(\"percolate\")` instead of `request.param(\"percolate\", null)` - functionally equivalent but slightly different. The field placement in UpdateRequest differs (after consistencyLevel vs. after retryOnConflict) but this is stylistic and doesn't affect functionality. The comment wording is slightly different ('updated document' vs 'update request document') but conveys the same meaning. All serialization logic, matches handling, and REST response formatting match the ground truth exactly.",
  "edit_run_id": "7ad89f22",
  "judge_run_id": "3e164e1c",
  "ground_truth_patch": "diff --git a/src/main/java/org/elasticsearch/action/update/TransportUpdateAction.java b/src/main/java/org/elasticsearch/action/update/TransportUpdateAction.java\nindex ae9eea79b9f..8c1875429b9 100644\n--- a/src/main/java/org/elasticsearch/action/update/TransportUpdateAction.java\n+++ b/src/main/java/org/elasticsearch/action/update/TransportUpdateAction.java\n@@ -208,20 +208,20 @@ public class TransportUpdateAction extends TransportInstanceSingleOperationActio\n             }\n         }\n \n-        // TODO percolate?\n-\n         // TODO: external version type, does it make sense here? does not seem like it...\n \n         if (operation == null || \"index\".equals(operation)) {\n             IndexRequest indexRequest = Requests.indexRequest(request.index()).type(request.type()).id(request.id()).routing(routing).parent(parent)\n                     .source(source, sourceAndContent.v1())\n                     .version(getResult.version()).replicationType(request.replicationType()).consistencyLevel(request.consistencyLevel())\n-                    .timestamp(timestamp).ttl(ttl);\n+                    .timestamp(timestamp).ttl(ttl)\n+                    .percolate(request.percolate());\n             indexRequest.operationThreaded(false);\n             indexAction.execute(indexRequest, new ActionListener<IndexResponse>() {\n                 @Override\n                 public void onResponse(IndexResponse response) {\n                     UpdateResponse update = new UpdateResponse(response.index(), response.type(), response.id(), response.version());\n+                    update.matches(response.matches());\n                     listener.onResponse(update);\n                 }\n \ndiff --git a/src/main/java/org/elasticsearch/action/update/UpdateRequest.java b/src/main/java/org/elasticsearch/action/update/UpdateRequest.java\nindex 05e39cee924..9934c6f43b5 100644\n--- a/src/main/java/org/elasticsearch/action/update/UpdateRequest.java\n+++ b/src/main/java/org/elasticsearch/action/update/UpdateRequest.java\n@@ -51,6 +51,8 @@ public class UpdateRequest extends InstanceShardOperationRequest {\n \n     int retryOnConflict = 0;\n \n+    private String percolate;\n+\n     private ReplicationType replicationType = ReplicationType.DEFAULT;\n     private WriteConsistencyLevel consistencyLevel = WriteConsistencyLevel.DEFAULT;\n \n@@ -239,6 +241,20 @@ public class UpdateRequest extends InstanceShardOperationRequest {\n         return this.retryOnConflict;\n     }\n \n+    /**\n+     * Causes the update request document to be percolated. The parameter is the percolate query\n+     * to use to reduce the percolated queries that are going to run against this doc. Can be\n+     * set to <tt>*</tt> to indicate that all percolate queries should be run.\n+     */\n+    public UpdateRequest percolate(String percolate) {\n+        this.percolate = percolate;\n+        return this;\n+    }\n+\n+    public String percolate() {\n+        return this.percolate;\n+    }\n+\n     /**\n      * A timeout to wait if the index operation can't be performed immediately. Defaults to <tt>1m</tt>.\n      */\n@@ -297,6 +313,9 @@ public class UpdateRequest extends InstanceShardOperationRequest {\n         }\n         scriptParams = in.readMap();\n         retryOnConflict = in.readVInt();\n+        if (in.readBoolean()) {\n+            percolate = in.readUTF();\n+        }\n     }\n \n     @Override\n@@ -321,5 +340,11 @@ public class UpdateRequest extends InstanceShardOperationRequest {\n         }\n         out.writeMap(scriptParams);\n         out.writeVInt(retryOnConflict);\n+        if (percolate == null) {\n+            out.writeBoolean(false);\n+        } else {\n+            out.writeBoolean(true);\n+            out.writeUTF(percolate);\n+        }\n     }\n }\ndiff --git a/src/main/java/org/elasticsearch/action/update/UpdateResponse.java b/src/main/java/org/elasticsearch/action/update/UpdateResponse.java\nindex f4a41dd9d76..3cb6efdcbd8 100644\n--- a/src/main/java/org/elasticsearch/action/update/UpdateResponse.java\n+++ b/src/main/java/org/elasticsearch/action/update/UpdateResponse.java\n@@ -19,11 +19,14 @@\n \n package org.elasticsearch.action.update;\n \n+import com.google.common.collect.ImmutableList;\n import org.elasticsearch.action.ActionResponse;\n import org.elasticsearch.common.io.stream.StreamInput;\n import org.elasticsearch.common.io.stream.StreamOutput;\n \n import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.List;\n \n /**\n  */\n@@ -37,6 +40,8 @@ public class UpdateResponse implements ActionResponse {\n \n     private long version;\n \n+    private List<String> matches;\n+\n     public UpdateResponse() {\n \n     }\n@@ -104,12 +109,54 @@ public class UpdateResponse implements ActionResponse {\n         return version();\n     }\n \n+    /**\n+     * Returns the percolate queries matches. <tt>null</tt> if no percolation was requested.\n+     */\n+    public List<String> matches() {\n+        return this.matches;\n+    }\n+\n+    /**\n+     * Returns the percolate queries matches. <tt>null</tt> if no percolation was requested.\n+     */\n+    public List<String> getMatches() {\n+        return this.matches;\n+    }\n+\n+    /**\n+     * Internal.\n+     */\n+    public void matches(List<String> matches) {\n+        this.matches = matches;\n+    }\n+\n     @Override\n     public void readFrom(StreamInput in) throws IOException {\n         index = in.readUTF();\n         id = in.readUTF();\n         type = in.readUTF();\n         version = in.readLong();\n+        if (in.readBoolean()) {\n+            int size = in.readVInt();\n+            if (size == 0) {\n+                matches = ImmutableList.of();\n+            } else if (size == 1) {\n+                matches = ImmutableList.of(in.readUTF());\n+            } else if (size == 2) {\n+                matches = ImmutableList.of(in.readUTF(), in.readUTF());\n+            } else if (size == 3) {\n+                matches = ImmutableList.of(in.readUTF(), in.readUTF(), in.readUTF());\n+            } else if (size == 4) {\n+                matches = ImmutableList.of(in.readUTF(), in.readUTF(), in.readUTF(), in.readUTF());\n+            } else if (size == 5) {\n+                matches = ImmutableList.of(in.readUTF(), in.readUTF(), in.readUTF(), in.readUTF(), in.readUTF());\n+            } else {\n+                matches = new ArrayList<String>();\n+                for (int i = 0; i < size; i++) {\n+                    matches.add(in.readUTF());\n+                }\n+            }\n+        }\n     }\n \n     @Override\n@@ -118,5 +165,14 @@ public class UpdateResponse implements ActionResponse {\n         out.writeUTF(id);\n         out.writeUTF(type);\n         out.writeLong(version);\n+        if (matches == null) {\n+            out.writeBoolean(false);\n+        } else {\n+            out.writeBoolean(true);\n+            out.writeVInt(matches.size());\n+            for (String match : matches) {\n+                out.writeUTF(match);\n+            }\n+        }\n     }\n }\ndiff --git a/src/main/java/org/elasticsearch/rest/action/update/RestUpdateAction.java b/src/main/java/org/elasticsearch/rest/action/update/RestUpdateAction.java\nindex e6bef6050b1..3e3eb366927 100644\n--- a/src/main/java/org/elasticsearch/rest/action/update/RestUpdateAction.java\n+++ b/src/main/java/org/elasticsearch/rest/action/update/RestUpdateAction.java\n@@ -65,6 +65,7 @@ public class RestUpdateAction extends BaseRestHandler {\n         if (consistencyLevel != null) {\n             updateRequest.consistencyLevel(WriteConsistencyLevel.fromString(consistencyLevel));\n         }\n+        updateRequest.percolate(request.param(\"percolate\", null));\n         // we just send a response, no need to fork\n         updateRequest.listenerThreaded(false);\n         updateRequest.script(request.param(\"script\"));\n@@ -114,6 +115,13 @@ public class RestUpdateAction extends BaseRestHandler {\n                             .field(Fields._TYPE, response.type())\n                             .field(Fields._ID, response.id())\n                             .field(Fields._VERSION, response.version());\n+                    if (response.matches() != null) {\n+                        builder.startArray(Fields.MATCHES);\n+                        for (String match : response.matches()) {\n+                            builder.value(match);\n+                        }\n+                        builder.endArray();\n+                    }\n                     builder.endObject();\n                     RestStatus status = OK;\n                     if (response.version() == 1) {\n@@ -142,5 +150,6 @@ public class RestUpdateAction extends BaseRestHandler {\n         static final XContentBuilderString _TYPE = new XContentBuilderString(\"_type\");\n         static final XContentBuilderString _ID = new XContentBuilderString(\"_id\");\n         static final XContentBuilderString _VERSION = new XContentBuilderString(\"_version\");\n+        static final XContentBuilderString MATCHES = new XContentBuilderString(\"matches\");\n     }\n }"
}