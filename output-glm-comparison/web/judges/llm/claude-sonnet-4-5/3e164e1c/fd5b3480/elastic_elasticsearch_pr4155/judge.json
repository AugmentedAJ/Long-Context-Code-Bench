{
  "repo_url": "https://github.com/elastic/elasticsearch.git",
  "pr_number": 4155,
  "base_commit": "16ee74268240118c59b64ea3ee2ee854c7566505",
  "head_commit": "1e06c76467b16b4c673dbac2cc0d567d396f010b",
  "judge_mode": "llm",
  "judge_model": "claude-sonnet-4-5",
  "scores": {
    "correctness": -0.6,
    "completeness": -0.5,
    "code_reuse": -0.3,
    "best_practices": -0.4,
    "unsolicited_docs": 1.0
  },
  "aggregate": -0.16000000000000006,
  "rationale": "The agent's solution has critical correctness issues: (1) It catches exceptions after client.bulk() is called, but if client.bulk() throws synchronously, the semaphore is still released in the catch block AND also later in the ActionListener callbacks, causing double-release. (2) The ground truth uses a 'success' flag pattern to ensure the semaphore is released exactly once in the finally block only if client.bulk() fails, with the ActionListener callbacks handling release on success/failure paths. (3) The agent's approach doesn't handle InterruptedException properly (missing Thread.interrupted() call) and leaves the semaphore.acquire() and listener.beforeBulk() calls outside the restructured try-catch. (4) The ground truth restructures the control flow more comprehensively by moving all operations inside a unified try-catch-finally with the success flag, while the agent only wraps client.bulk(). Completeness: missing the success flag pattern, Thread.interrupted() call, and proper restructuring of the entire block. Code reuse: creates duplicate error handling logic in the catch block that already exists in ActionListener.onFailure. Best practices: the double-release bug is a serious concurrency anti-pattern that could cause semaphore corruption.",
  "edit_run_id": "fd5b3480",
  "judge_run_id": "3e164e1c",
  "ground_truth_patch": "diff --git a/src/main/java/org/elasticsearch/action/bulk/BulkProcessor.java b/src/main/java/org/elasticsearch/action/bulk/BulkProcessor.java\nindex b8fb83a02c8..a850cfc2ae0 100644\n--- a/src/main/java/org/elasticsearch/action/bulk/BulkProcessor.java\n+++ b/src/main/java/org/elasticsearch/action/bulk/BulkProcessor.java\n@@ -276,32 +276,39 @@ public class BulkProcessor {\n                 listener.afterBulk(executionId, bulkRequest, e);\n             }\n         } else {\n+            boolean success = false;\n             try {\n                 semaphore.acquire();\n+                listener.beforeBulk(executionId, bulkRequest);\n+                client.bulk(bulkRequest, new ActionListener<BulkResponse>() {\n+                    @Override\n+                    public void onResponse(BulkResponse response) {\n+                        try {\n+                            listener.afterBulk(executionId, bulkRequest, response);\n+                        } finally {\n+                            semaphore.release();\n+                        }\n+                    }\n+\n+                    @Override\n+                    public void onFailure(Throwable e) {\n+                        try {\n+                            listener.afterBulk(executionId, bulkRequest, e);\n+                        } finally {\n+                            semaphore.release();\n+                        }\n+                    }\n+                });\n+                success = true;\n             } catch (InterruptedException e) {\n+                Thread.interrupted();\n                 listener.afterBulk(executionId, bulkRequest, e);\n-                return;\n+            } finally {\n+                 if (!success) {  // if we fail on client.bulk() release the semaphore\n+                     semaphore.release();\n+                 }\n             }\n-            listener.beforeBulk(executionId, bulkRequest);\n-            client.bulk(bulkRequest, new ActionListener<BulkResponse>() {\n-                @Override\n-                public void onResponse(BulkResponse response) {\n-                    try {\n-                        listener.afterBulk(executionId, bulkRequest, response);\n-                    } finally {\n-                        semaphore.release();\n-                    }\n-                }\n \n-                @Override\n-                public void onFailure(Throwable e) {\n-                    try {\n-                        listener.afterBulk(executionId, bulkRequest, e);\n-                    } finally {\n-                        semaphore.release();\n-                    }\n-                }\n-            });\n         }\n     }\n "
}