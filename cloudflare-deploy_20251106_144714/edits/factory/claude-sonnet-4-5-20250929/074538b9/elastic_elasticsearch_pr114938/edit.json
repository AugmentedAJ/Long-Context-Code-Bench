{
  "repo_url": "https://github.com/elastic/elasticsearch.git",
  "pr_number": 114938,
  "base_commit": "54e3bdb61708ff64337c16964bdc667126fb83f0",
  "runner": "factory",
  "model": "claude-sonnet-4-5-20250929",
  "timeout_s": 7200,
  "status": "success",
  "elapsed_ms": 224526,
  "patch_unified": "diff --git a/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/enrich/EnrichPolicyResolver.java b/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/enrich/EnrichPolicyResolver.java\nindex 447df099..e67c406e 100644\n--- a/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/enrich/EnrichPolicyResolver.java\n+++ b/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/enrich/EnrichPolicyResolver.java\n@@ -25,6 +25,7 @@ import org.elasticsearch.core.Tuple;\n import org.elasticsearch.tasks.Task;\n import org.elasticsearch.threadpool.ThreadPool;\n import org.elasticsearch.transport.RemoteClusterAware;\n+import org.elasticsearch.transport.RemoteClusterService;\n import org.elasticsearch.transport.Transport;\n import org.elasticsearch.transport.TransportChannel;\n import org.elasticsearch.transport.TransportRequest;\n@@ -72,12 +73,14 @@ public class EnrichPolicyResolver {\n     private final IndexResolver indexResolver;\n     private final TransportService transportService;\n     private final ThreadPool threadPool;\n+    private final RemoteClusterService remoteClusterService;\n \n     public EnrichPolicyResolver(ClusterService clusterService, TransportService transportService, IndexResolver indexResolver) {\n         this.clusterService = clusterService;\n         this.transportService = transportService;\n         this.indexResolver = indexResolver;\n         this.threadPool = transportService.getThreadPool();\n+        this.remoteClusterService = transportService.getRemoteClusterService();\n         transportService.registerRequestHandler(\n             RESOLVE_ACTION_NAME,\n             threadPool.executor(ThreadPool.Names.SEARCH),\n@@ -257,22 +260,21 @@ public class EnrichPolicyResolver {\n             // remote clusters\n             if (remotePolicies.isEmpty() == false) {\n                 for (String cluster : remoteClusters) {\n-                    final Transport.Connection connection;\n-                    try {\n-                        connection = getRemoteConnection(cluster);\n-                    } catch (Exception e) {\n-                        refs.acquire().onFailure(e);\n-                        return;\n-                    }\n-                    transportService.sendRequest(\n-                        connection,\n-                        RESOLVE_ACTION_NAME,\n-                        new LookupRequest(cluster, remotePolicies),\n-                        TransportRequestOptions.EMPTY,\n-                        new ActionListenerResponseHandler<>(\n-                            refs.acquire(resp -> lookupResponses.put(cluster, resp)),\n-                            LookupResponse::new,\n-                            threadPool.executor(ThreadPool.Names.SEARCH)\n+                    ActionListener<LookupResponse> lookupListener = refs.acquire(resp -> lookupResponses.put(cluster, resp));\n+                    getRemoteConnection(\n+                        cluster,\n+                        lookupListener.delegateFailureAndWrap(\n+                            (delegate, connection) -> transportService.sendRequest(\n+                                connection,\n+                                RESOLVE_ACTION_NAME,\n+                                new LookupRequest(cluster, remotePolicies),\n+                                TransportRequestOptions.EMPTY,\n+                                new ActionListenerResponseHandler<>(\n+                                    delegate,\n+                                    LookupResponse::new,\n+                                    threadPool.executor(ThreadPool.Names.SEARCH)\n+                                )\n+                            )\n                         )\n                     );\n                 }\n@@ -389,13 +391,16 @@ public class EnrichPolicyResolver {\n         return metadata == null ? Map.of() : metadata.getPolicies();\n     }\n \n-    protected Transport.Connection getRemoteConnection(String cluster) {\n-        return transportService.getRemoteClusterService().getConnection(cluster);\n+    protected void getRemoteConnection(String cluster, ActionListener<Transport.Connection> listener) {\n+        remoteClusterService.maybeEnsureConnectedAndGetConnection(\n+            cluster,\n+            remoteClusterService.isSkipUnavailable(cluster) == false,\n+            listener\n+        );\n     }\n \n     public Map<String, List<String>> groupIndicesPerCluster(String[] indices) {\n-        return transportService.getRemoteClusterService()\n-            .groupIndices(SearchRequest.DEFAULT_INDICES_OPTIONS, indices)\n+        return remoteClusterService.groupIndices(SearchRequest.DEFAULT_INDICES_OPTIONS, indices)\n             .entrySet()\n             .stream()\n             .collect(Collectors.toMap(Map.Entry::getKey, e -> Arrays.asList(e.getValue().indices())));\ndiff --git a/x-pack/plugin/esql/src/test/java/org/elasticsearch/xpack/esql/enrich/EnrichPolicyResolverTests.java b/x-pack/plugin/esql/src/test/java/org/elasticsearch/xpack/esql/enrich/EnrichPolicyResolverTests.java\nindex 05a7486a..39170f1a 100644\n--- a/x-pack/plugin/esql/src/test/java/org/elasticsearch/xpack/esql/enrich/EnrichPolicyResolverTests.java\n+++ b/x-pack/plugin/esql/src/test/java/org/elasticsearch/xpack/esql/enrich/EnrichPolicyResolverTests.java\n@@ -446,9 +446,9 @@ public class EnrichPolicyResolverTests extends ESTestCase {\n         }\n \n         @Override\n-        protected Transport.Connection getRemoteConnection(String remoteCluster) {\n+        protected void getRemoteConnection(String remoteCluster, ActionListener<Transport.Connection> listener) {\n             assertThat(\"Must only called on the local cluster\", cluster, equalTo(LOCAL_CLUSTER_GROUP_KEY));\n-            return transports.get(\"\").getConnection(transports.get(remoteCluster).getLocalNode());\n+            listener.onResponse(transports.get(\"\").getConnection(transports.get(remoteCluster).getLocalNode()));\n         }\n \n         static ClusterService mockClusterService(Map<String, EnrichPolicy> policies) {",
  "logs_path": "factory/claude-sonnet-4-5-20250929/074538b9/elastic_elasticsearch_pr114938/logs.jsonl",
  "errors": [],
  "edit_run_id": "074538b9",
  "test_label": "v0"
}