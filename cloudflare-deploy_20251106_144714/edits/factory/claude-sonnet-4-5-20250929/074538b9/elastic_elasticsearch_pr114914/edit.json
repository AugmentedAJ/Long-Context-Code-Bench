{
  "repo_url": "https://github.com/elastic/elasticsearch.git",
  "pr_number": 114914,
  "base_commit": "041022944e7df963d4a3269dfa6ec7791247251e",
  "runner": "factory",
  "model": "claude-sonnet-4-5-20250929",
  "timeout_s": 7200,
  "status": "success",
  "elapsed_ms": 748354,
  "patch_unified": "diff --git a/docs/reference/inference/service-watsonx-ai.asciidoc b/docs/reference/inference/service-watsonx-ai.asciidoc\nindex 597afc27..800678bc 100644\n--- a/docs/reference/inference/service-watsonx-ai.asciidoc\n+++ b/docs/reference/inference/service-watsonx-ai.asciidoc\n@@ -35,6 +35,10 @@ Available task types:\n [[infer-service-watsonx-ai-api-request-body]]\n ==== {api-request-body-title}\n \n+`chunking_settings`::\n+(Optional, object)\n+include::inference-shared.asciidoc[tag=chunking-settings]\n+\n `service`::\n (Required, string)\n The type of service supported for the specified task type. In this case, \ndiff --git a/x-pack/plugin/inference/src/main/java/org/elasticsearch/xpack/inference/services/ibmwatsonx/IbmWatsonxService.java b/x-pack/plugin/inference/src/main/java/org/elasticsearch/xpack/inference/services/ibmwatsonx/IbmWatsonxService.java\nindex e960b0b7..6ff8f846 100644\n--- a/x-pack/plugin/inference/src/main/java/org/elasticsearch/xpack/inference/services/ibmwatsonx/IbmWatsonxService.java\n+++ b/x-pack/plugin/inference/src/main/java/org/elasticsearch/xpack/inference/services/ibmwatsonx/IbmWatsonxService.java\n@@ -16,6 +16,7 @@ import org.elasticsearch.core.Nullable;\n import org.elasticsearch.core.TimeValue;\n import org.elasticsearch.inference.ChunkedInferenceServiceResults;\n import org.elasticsearch.inference.ChunkingOptions;\n+import org.elasticsearch.inference.ChunkingSettings;\n import org.elasticsearch.inference.EmptySettingsConfiguration;\n import org.elasticsearch.inference.InferenceServiceConfiguration;\n import org.elasticsearch.inference.InferenceServiceResults;\n@@ -30,6 +31,7 @@ import org.elasticsearch.inference.TaskType;\n import org.elasticsearch.inference.configuration.SettingsConfigurationDisplayType;\n import org.elasticsearch.inference.configuration.SettingsConfigurationFieldType;\n import org.elasticsearch.rest.RestStatus;\n+import org.elasticsearch.xpack.inference.chunking.ChunkingSettingsBuilder;\n import org.elasticsearch.xpack.inference.chunking.EmbeddingRequestChunker;\n import org.elasticsearch.xpack.inference.external.action.ibmwatsonx.IbmWatsonxActionCreator;\n import org.elasticsearch.xpack.inference.external.http.sender.DocumentsOnlyInput;\n@@ -86,11 +88,19 @@ public class IbmWatsonxService extends SenderService {\n             Map<String, Object> serviceSettingsMap = removeFromMapOrThrowIfNull(config, ModelConfigurations.SERVICE_SETTINGS);\n             Map<String, Object> taskSettingsMap = removeFromMapOrDefaultEmpty(config, ModelConfigurations.TASK_SETTINGS);\n \n+            ChunkingSettings chunkingSettings = null;\n+            if (TaskType.TEXT_EMBEDDING.equals(taskType)) {\n+                chunkingSettings = ChunkingSettingsBuilder.fromMap(\n+                    removeFromMapOrDefaultEmpty(config, ModelConfigurations.CHUNKING_SETTINGS)\n+                );\n+            }\n+\n             IbmWatsonxModel model = createModel(\n                 inferenceEntityId,\n                 taskType,\n                 serviceSettingsMap,\n                 taskSettingsMap,\n+                chunkingSettings,\n                 serviceSettingsMap,\n                 TaskType.unsupportedTaskTypeErrorMsg(taskType, NAME),\n                 ConfigurationParseContext.REQUEST\n@@ -112,6 +122,7 @@ public class IbmWatsonxService extends SenderService {\n         TaskType taskType,\n         Map<String, Object> serviceSettings,\n         Map<String, Object> taskSettings,\n+        ChunkingSettings chunkingSettings,\n         @Nullable Map<String, Object> secretSettings,\n         String failureMessage,\n         ConfigurationParseContext context\n@@ -123,6 +134,7 @@ public class IbmWatsonxService extends SenderService {\n                 NAME,\n                 serviceSettings,\n                 taskSettings,\n+                chunkingSettings,\n                 secretSettings,\n                 context\n             );\n@@ -141,11 +153,19 @@ public class IbmWatsonxService extends SenderService {\n         Map<String, Object> taskSettingsMap = removeFromMapOrDefaultEmpty(config, ModelConfigurations.TASK_SETTINGS);\n         Map<String, Object> secretSettingsMap = removeFromMapOrDefaultEmpty(secrets, ModelSecrets.SECRET_SETTINGS);\n \n+        ChunkingSettings chunkingSettings = null;\n+        if (TaskType.TEXT_EMBEDDING.equals(taskType)) {\n+            chunkingSettings = ChunkingSettingsBuilder.fromMap(\n+                removeFromMapOrDefaultEmpty(config, ModelConfigurations.CHUNKING_SETTINGS)\n+            );\n+        }\n+\n         return createModelFromPersistent(\n             inferenceEntityId,\n             taskType,\n             serviceSettingsMap,\n             taskSettingsMap,\n+            chunkingSettings,\n             secretSettingsMap,\n             parsePersistedConfigErrorMsg(inferenceEntityId, NAME)\n         );\n@@ -166,6 +186,7 @@ public class IbmWatsonxService extends SenderService {\n         TaskType taskType,\n         Map<String, Object> serviceSettings,\n         Map<String, Object> taskSettings,\n+        ChunkingSettings chunkingSettings,\n         Map<String, Object> secretSettings,\n         String failureMessage\n     ) {\n@@ -174,6 +195,7 @@ public class IbmWatsonxService extends SenderService {\n             taskType,\n             serviceSettings,\n             taskSettings,\n+            chunkingSettings,\n             secretSettings,\n             failureMessage,\n             ConfigurationParseContext.PERSISTENT\n@@ -185,11 +207,19 @@ public class IbmWatsonxService extends SenderService {\n         Map<String, Object> serviceSettingsMap = removeFromMapOrThrowIfNull(config, ModelConfigurations.SERVICE_SETTINGS);\n         Map<String, Object> taskSettingsMap = removeFromMapOrDefaultEmpty(config, ModelConfigurations.TASK_SETTINGS);\n \n+        ChunkingSettings chunkingSettings = null;\n+        if (TaskType.TEXT_EMBEDDING.equals(taskType)) {\n+            chunkingSettings = ChunkingSettingsBuilder.fromMap(\n+                removeFromMapOrDefaultEmpty(config, ModelConfigurations.CHUNKING_SETTINGS)\n+            );\n+        }\n+\n         return createModelFromPersistent(\n             inferenceEntityId,\n             taskType,\n             serviceSettingsMap,\n             taskSettingsMap,\n+            chunkingSettings,\n             null,\n             parsePersistedConfigErrorMsg(inferenceEntityId, NAME)\n         );\ndiff --git a/x-pack/plugin/inference/src/main/java/org/elasticsearch/xpack/inference/services/ibmwatsonx/embeddings/IbmWatsonxEmbeddingsModel.java b/x-pack/plugin/inference/src/main/java/org/elasticsearch/xpack/inference/services/ibmwatsonx/embeddings/IbmWatsonxEmbeddingsModel.java\nindex d60e31b5..a826c7ff 100644\n--- a/x-pack/plugin/inference/src/main/java/org/elasticsearch/xpack/inference/services/ibmwatsonx/embeddings/IbmWatsonxEmbeddingsModel.java\n+++ b/x-pack/plugin/inference/src/main/java/org/elasticsearch/xpack/inference/services/ibmwatsonx/embeddings/IbmWatsonxEmbeddingsModel.java\n@@ -9,6 +9,7 @@ package org.elasticsearch.xpack.inference.services.ibmwatsonx.embeddings;\n \n import org.apache.http.client.utils.URIBuilder;\n import org.elasticsearch.core.Nullable;\n+import org.elasticsearch.inference.ChunkingSettings;\n import org.elasticsearch.inference.EmptyTaskSettings;\n import org.elasticsearch.inference.InputType;\n import org.elasticsearch.inference.ModelConfigurations;\n@@ -40,6 +41,7 @@ public class IbmWatsonxEmbeddingsModel extends IbmWatsonxModel {\n         String service,\n         Map<String, Object> serviceSettings,\n         Map<String, Object> taskSettings,\n+        ChunkingSettings chunkingSettings,\n         Map<String, Object> secrets,\n         ConfigurationParseContext context\n     ) {\n@@ -49,6 +51,7 @@ public class IbmWatsonxEmbeddingsModel extends IbmWatsonxModel {\n             service,\n             IbmWatsonxEmbeddingsServiceSettings.fromMap(serviceSettings, context),\n             EmptyTaskSettings.INSTANCE,\n+            chunkingSettings,\n             DefaultSecretSettings.fromMap(secrets)\n         );\n     }\n@@ -64,10 +67,11 @@ public class IbmWatsonxEmbeddingsModel extends IbmWatsonxModel {\n         String service,\n         IbmWatsonxEmbeddingsServiceSettings serviceSettings,\n         TaskSettings taskSettings,\n+        ChunkingSettings chunkingSettings,\n         @Nullable DefaultSecretSettings secrets\n     ) {\n         super(\n-            new ModelConfigurations(inferenceEntityId, taskType, service, serviceSettings, taskSettings),\n+            new ModelConfigurations(inferenceEntityId, taskType, service, serviceSettings, taskSettings, chunkingSettings),\n             new ModelSecrets(secrets),\n             serviceSettings\n         );\n@@ -86,10 +90,11 @@ public class IbmWatsonxEmbeddingsModel extends IbmWatsonxModel {\n         String uri,\n         IbmWatsonxEmbeddingsServiceSettings serviceSettings,\n         TaskSettings taskSettings,\n+        ChunkingSettings chunkingSettings,\n         @Nullable DefaultSecretSettings secrets\n     ) {\n         super(\n-            new ModelConfigurations(inferenceEntityId, taskType, service, serviceSettings, taskSettings),\n+            new ModelConfigurations(inferenceEntityId, taskType, service, serviceSettings, taskSettings, chunkingSettings),\n             new ModelSecrets(secrets),\n             serviceSettings\n         );\ndiff --git a/x-pack/plugin/inference/src/test/java/org/elasticsearch/xpack/inference/services/ibmwatsonx/IbmWatsonxServiceTests.java b/x-pack/plugin/inference/src/test/java/org/elasticsearch/xpack/inference/services/ibmwatsonx/IbmWatsonxServiceTests.java\nindex d6c491f2..aee5d833 100644\n--- a/x-pack/plugin/inference/src/test/java/org/elasticsearch/xpack/inference/services/ibmwatsonx/IbmWatsonxServiceTests.java\n+++ b/x-pack/plugin/inference/src/test/java/org/elasticsearch/xpack/inference/services/ibmwatsonx/IbmWatsonxServiceTests.java\n@@ -20,6 +20,7 @@ import org.elasticsearch.common.xcontent.XContentHelper;\n import org.elasticsearch.core.TimeValue;\n import org.elasticsearch.inference.ChunkedInferenceServiceResults;\n import org.elasticsearch.inference.ChunkingOptions;\n+import org.elasticsearch.inference.ChunkingSettings;\n import org.elasticsearch.inference.EmptyTaskSettings;\n import org.elasticsearch.inference.InferenceServiceConfiguration;\n import org.elasticsearch.inference.InferenceServiceResults;\n@@ -69,6 +70,7 @@ import static org.elasticsearch.xpack.inference.Utils.getInvalidModel;\n import static org.elasticsearch.xpack.inference.Utils.getPersistedConfigMap;\n import static org.elasticsearch.xpack.inference.Utils.inferenceUtilityPool;\n import static org.elasticsearch.xpack.inference.Utils.mockClusterServiceEmpty;\n+import static org.elasticsearch.xpack.inference.chunking.ChunkingSettingsTests.createRandomChunkingSettingsMap;\n import static org.elasticsearch.xpack.inference.external.http.Utils.entityAsMap;\n import static org.elasticsearch.xpack.inference.external.http.Utils.getUrl;\n import static org.elasticsearch.xpack.inference.results.TextEmbeddingResultsTests.buildExpectationFloat;\n@@ -150,6 +152,83 @@ public class IbmWatsonxServiceTests extends ESTestCase {\n         }\n     }\n \n+    public void testParseRequestConfig_CreatesAIbmWatsonxEmbeddingsModelWhenChunkingSettingsProvided() throws IOException {\n+        try (var service = createIbmWatsonxService()) {\n+            ActionListener<Model> modelListener = ActionListener.wrap(model -> {\n+                assertThat(model, instanceOf(IbmWatsonxEmbeddingsModel.class));\n+\n+                var embeddingsModel = (IbmWatsonxEmbeddingsModel) model;\n+                assertThat(embeddingsModel.getServiceSettings().modelId(), is(modelId));\n+                assertThat(embeddingsModel.getServiceSettings().projectId(), is(projectId));\n+                assertThat(embeddingsModel.getServiceSettings().url(), is(URI.create(url)));\n+                assertThat(embeddingsModel.getServiceSettings().apiVersion(), is(apiVersion));\n+                assertThat(embeddingsModel.getConfigurations().getChunkingSettings(), instanceOf(ChunkingSettings.class));\n+                assertThat(embeddingsModel.getSecretSettings().apiKey().toString(), is(apiKey));\n+            }, e -> fail(\"Model parsing should have succeeded, but failed: \" + e.getMessage()));\n+\n+            service.parseRequestConfig(\n+                \"id\",\n+                TaskType.TEXT_EMBEDDING,\n+                getRequestConfigMap(\n+                    new HashMap<>(\n+                        Map.of(\n+                            ServiceFields.MODEL_ID,\n+                            modelId,\n+                            IbmWatsonxServiceFields.PROJECT_ID,\n+                            projectId,\n+                            ServiceFields.URL,\n+                            url,\n+                            IbmWatsonxServiceFields.API_VERSION,\n+                            apiVersion\n+                        )\n+                    ),\n+                    new HashMap<>(Map.of()),\n+                    createRandomChunkingSettingsMap(),\n+                    getSecretSettingsMap(apiKey)\n+                ),\n+                modelListener\n+            );\n+        }\n+    }\n+\n+    public void testParseRequestConfig_CreatesAIbmWatsonxEmbeddingsModelWhenChunkingSettingsNotProvided() throws IOException {\n+        try (var service = createIbmWatsonxService()) {\n+            ActionListener<Model> modelListener = ActionListener.wrap(model -> {\n+                assertThat(model, instanceOf(IbmWatsonxEmbeddingsModel.class));\n+\n+                var embeddingsModel = (IbmWatsonxEmbeddingsModel) model;\n+                assertThat(embeddingsModel.getServiceSettings().modelId(), is(modelId));\n+                assertThat(embeddingsModel.getServiceSettings().projectId(), is(projectId));\n+                assertThat(embeddingsModel.getServiceSettings().url(), is(URI.create(url)));\n+                assertThat(embeddingsModel.getServiceSettings().apiVersion(), is(apiVersion));\n+                assertThat(embeddingsModel.getConfigurations().getChunkingSettings(), instanceOf(ChunkingSettings.class));\n+                assertThat(embeddingsModel.getSecretSettings().apiKey().toString(), is(apiKey));\n+            }, e -> fail(\"Model parsing should have succeeded, but failed: \" + e.getMessage()));\n+\n+            service.parseRequestConfig(\n+                \"id\",\n+                TaskType.TEXT_EMBEDDING,\n+                getRequestConfigMap(\n+                    new HashMap<>(\n+                        Map.of(\n+                            ServiceFields.MODEL_ID,\n+                            modelId,\n+                            IbmWatsonxServiceFields.PROJECT_ID,\n+                            projectId,\n+                            ServiceFields.URL,\n+                            url,\n+                            IbmWatsonxServiceFields.API_VERSION,\n+                            apiVersion\n+                        )\n+                    ),\n+                    new HashMap<>(Map.of()),\n+                    getSecretSettingsMap(apiKey)\n+                ),\n+                modelListener\n+            );\n+        }\n+    }\n+\n     public void testParseRequestConfig_ThrowsUnsupportedModelType() throws IOException {\n         try (var service = createIbmWatsonxService()) {\n             var failureListener = getModelListenerForException(\ndiff --git a/x-pack/plugin/inference/src/test/java/org/elasticsearch/xpack/inference/services/ibmwatsonx/embeddings/IbmWatsonxEmbeddingsModelTests.java b/x-pack/plugin/inference/src/test/java/org/elasticsearch/xpack/inference/services/ibmwatsonx/embeddings/IbmWatsonxEmbeddingsModelTests.java\nindex 93fd7e40..0d0b29bb 100644\n--- a/x-pack/plugin/inference/src/test/java/org/elasticsearch/xpack/inference/services/ibmwatsonx/embeddings/IbmWatsonxEmbeddingsModelTests.java\n+++ b/x-pack/plugin/inference/src/test/java/org/elasticsearch/xpack/inference/services/ibmwatsonx/embeddings/IbmWatsonxEmbeddingsModelTests.java\n@@ -33,6 +33,7 @@ public class IbmWatsonxEmbeddingsModelTests extends ESTestCase {\n             url,\n             new IbmWatsonxEmbeddingsServiceSettings(model, projectId, uri, apiVersion, null, null, SimilarityMeasure.DOT_PRODUCT, null),\n             EmptyTaskSettings.INSTANCE,\n+            null,\n             new DefaultSecretSettings(new SecureString(apiKey.toCharArray()))\n         );\n     }\n@@ -54,6 +55,7 @@ public class IbmWatsonxEmbeddingsModelTests extends ESTestCase {\n             url,\n             new IbmWatsonxEmbeddingsServiceSettings(model, projectId, uri, apiVersion, null, dimensions, similarityMeasure, null),\n             EmptyTaskSettings.INSTANCE,\n+            null,\n             new DefaultSecretSettings(new SecureString(apiKey.toCharArray()))\n         );\n     }\n@@ -82,6 +84,7 @@ public class IbmWatsonxEmbeddingsModelTests extends ESTestCase {\n                 null\n             ),\n             EmptyTaskSettings.INSTANCE,\n+            null,\n             new DefaultSecretSettings(new SecureString(apiKey.toCharArray()))\n         );\n     }",
  "logs_path": "factory/claude-sonnet-4-5-20250929/074538b9/elastic_elasticsearch_pr114914/logs.jsonl",
  "errors": [],
  "edit_run_id": "074538b9",
  "test_label": "v0"
}