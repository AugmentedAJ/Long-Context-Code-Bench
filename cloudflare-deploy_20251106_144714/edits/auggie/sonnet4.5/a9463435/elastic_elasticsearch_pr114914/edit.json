{
  "repo_url": "https://github.com/elastic/elasticsearch.git",
  "pr_number": 114914,
  "base_commit": "041022944e7df963d4a3269dfa6ec7791247251e",
  "runner": "auggie",
  "model": "sonnet4.5",
  "timeout_s": 1800,
  "status": "success",
  "elapsed_ms": 838407,
  "patch_unified": "diff --git a/x-pack/plugin/inference/src/main/java/org/elasticsearch/xpack/inference/services/ibmwatsonx/IbmWatsonxService.java b/x-pack/plugin/inference/src/main/java/org/elasticsearch/xpack/inference/services/ibmwatsonx/IbmWatsonxService.java\nindex e960b0b7..0971aa2e 100644\n--- a/x-pack/plugin/inference/src/main/java/org/elasticsearch/xpack/inference/services/ibmwatsonx/IbmWatsonxService.java\n+++ b/x-pack/plugin/inference/src/main/java/org/elasticsearch/xpack/inference/services/ibmwatsonx/IbmWatsonxService.java\n@@ -16,6 +16,7 @@ import org.elasticsearch.core.Nullable;\n import org.elasticsearch.core.TimeValue;\n import org.elasticsearch.inference.ChunkedInferenceServiceResults;\n import org.elasticsearch.inference.ChunkingOptions;\n+import org.elasticsearch.inference.ChunkingSettings;\n import org.elasticsearch.inference.EmptySettingsConfiguration;\n import org.elasticsearch.inference.InferenceServiceConfiguration;\n import org.elasticsearch.inference.InferenceServiceResults;\n@@ -30,6 +31,7 @@ import org.elasticsearch.inference.TaskType;\n import org.elasticsearch.inference.configuration.SettingsConfigurationDisplayType;\n import org.elasticsearch.inference.configuration.SettingsConfigurationFieldType;\n import org.elasticsearch.rest.RestStatus;\n+import org.elasticsearch.xpack.inference.chunking.ChunkingSettingsBuilder;\n import org.elasticsearch.xpack.inference.chunking.EmbeddingRequestChunker;\n import org.elasticsearch.xpack.inference.external.action.ibmwatsonx.IbmWatsonxActionCreator;\n import org.elasticsearch.xpack.inference.external.http.sender.DocumentsOnlyInput;\n@@ -86,11 +88,19 @@ public class IbmWatsonxService extends SenderService {\n             Map<String, Object> serviceSettingsMap = removeFromMapOrThrowIfNull(config, ModelConfigurations.SERVICE_SETTINGS);\n             Map<String, Object> taskSettingsMap = removeFromMapOrDefaultEmpty(config, ModelConfigurations.TASK_SETTINGS);\n \n+            ChunkingSettings chunkingSettings = null;\n+            if (TaskType.TEXT_EMBEDDING.equals(taskType)) {\n+                chunkingSettings = ChunkingSettingsBuilder.fromMap(\n+                    removeFromMapOrDefaultEmpty(config, ModelConfigurations.CHUNKING_SETTINGS)\n+                );\n+            }\n+\n             IbmWatsonxModel model = createModel(\n                 inferenceEntityId,\n                 taskType,\n                 serviceSettingsMap,\n                 taskSettingsMap,\n+                chunkingSettings,\n                 serviceSettingsMap,\n                 TaskType.unsupportedTaskTypeErrorMsg(taskType, NAME),\n                 ConfigurationParseContext.REQUEST\n@@ -112,6 +122,7 @@ public class IbmWatsonxService extends SenderService {\n         TaskType taskType,\n         Map<String, Object> serviceSettings,\n         Map<String, Object> taskSettings,\n+        @Nullable ChunkingSettings chunkingSettings,\n         @Nullable Map<String, Object> secretSettings,\n         String failureMessage,\n         ConfigurationParseContext context\n@@ -123,6 +134,7 @@ public class IbmWatsonxService extends SenderService {\n                 NAME,\n                 serviceSettings,\n                 taskSettings,\n+                chunkingSettings,\n                 secretSettings,\n                 context\n             );\n@@ -141,11 +153,19 @@ public class IbmWatsonxService extends SenderService {\n         Map<String, Object> taskSettingsMap = removeFromMapOrDefaultEmpty(config, ModelConfigurations.TASK_SETTINGS);\n         Map<String, Object> secretSettingsMap = removeFromMapOrDefaultEmpty(secrets, ModelSecrets.SECRET_SETTINGS);\n \n+        ChunkingSettings chunkingSettings = null;\n+        if (TaskType.TEXT_EMBEDDING.equals(taskType)) {\n+            chunkingSettings = ChunkingSettingsBuilder.fromMap(\n+                ServiceUtils.removeFromMap(config, ModelConfigurations.CHUNKING_SETTINGS)\n+            );\n+        }\n+\n         return createModelFromPersistent(\n             inferenceEntityId,\n             taskType,\n             serviceSettingsMap,\n             taskSettingsMap,\n+            chunkingSettings,\n             secretSettingsMap,\n             parsePersistedConfigErrorMsg(inferenceEntityId, NAME)\n         );\n@@ -166,6 +186,7 @@ public class IbmWatsonxService extends SenderService {\n         TaskType taskType,\n         Map<String, Object> serviceSettings,\n         Map<String, Object> taskSettings,\n+        @Nullable ChunkingSettings chunkingSettings,\n         Map<String, Object> secretSettings,\n         String failureMessage\n     ) {\n@@ -174,6 +195,7 @@ public class IbmWatsonxService extends SenderService {\n             taskType,\n             serviceSettings,\n             taskSettings,\n+            chunkingSettings,\n             secretSettings,\n             failureMessage,\n             ConfigurationParseContext.PERSISTENT\n@@ -185,11 +207,19 @@ public class IbmWatsonxService extends SenderService {\n         Map<String, Object> serviceSettingsMap = removeFromMapOrThrowIfNull(config, ModelConfigurations.SERVICE_SETTINGS);\n         Map<String, Object> taskSettingsMap = removeFromMapOrDefaultEmpty(config, ModelConfigurations.TASK_SETTINGS);\n \n+        ChunkingSettings chunkingSettings = null;\n+        if (TaskType.TEXT_EMBEDDING.equals(taskType)) {\n+            chunkingSettings = ChunkingSettingsBuilder.fromMap(\n+                ServiceUtils.removeFromMap(config, ModelConfigurations.CHUNKING_SETTINGS)\n+            );\n+        }\n+\n         return createModelFromPersistent(\n             inferenceEntityId,\n             taskType,\n             serviceSettingsMap,\n             taskSettingsMap,\n+            chunkingSettings,\n             null,\n             parsePersistedConfigErrorMsg(inferenceEntityId, NAME)\n         );\n@@ -266,7 +296,8 @@ public class IbmWatsonxService extends SenderService {\n         var batchedRequests = new EmbeddingRequestChunker(\n             input.getInputs(),\n             EMBEDDING_MAX_BATCH_SIZE,\n-            EmbeddingRequestChunker.EmbeddingType.FLOAT\n+            EmbeddingRequestChunker.EmbeddingType.FLOAT,\n+            ibmWatsonxModel.getConfigurations().getChunkingSettings()\n         ).batchRequestsWithListeners(listener);\n         for (var request : batchedRequests) {\n             var action = ibmWatsonxModel.accept(getActionCreator(getSender(), getServiceComponents()), taskSettings, inputType);\ndiff --git a/x-pack/plugin/inference/src/main/java/org/elasticsearch/xpack/inference/services/ibmwatsonx/embeddings/IbmWatsonxEmbeddingsModel.java b/x-pack/plugin/inference/src/main/java/org/elasticsearch/xpack/inference/services/ibmwatsonx/embeddings/IbmWatsonxEmbeddingsModel.java\nindex d60e31b5..99209425 100644\n--- a/x-pack/plugin/inference/src/main/java/org/elasticsearch/xpack/inference/services/ibmwatsonx/embeddings/IbmWatsonxEmbeddingsModel.java\n+++ b/x-pack/plugin/inference/src/main/java/org/elasticsearch/xpack/inference/services/ibmwatsonx/embeddings/IbmWatsonxEmbeddingsModel.java\n@@ -9,6 +9,7 @@ package org.elasticsearch.xpack.inference.services.ibmwatsonx.embeddings;\n \n import org.apache.http.client.utils.URIBuilder;\n import org.elasticsearch.core.Nullable;\n+import org.elasticsearch.inference.ChunkingSettings;\n import org.elasticsearch.inference.EmptyTaskSettings;\n import org.elasticsearch.inference.InputType;\n import org.elasticsearch.inference.ModelConfigurations;\n@@ -40,6 +41,7 @@ public class IbmWatsonxEmbeddingsModel extends IbmWatsonxModel {\n         String service,\n         Map<String, Object> serviceSettings,\n         Map<String, Object> taskSettings,\n+        @Nullable ChunkingSettings chunkingSettings,\n         Map<String, Object> secrets,\n         ConfigurationParseContext context\n     ) {\n@@ -49,6 +51,7 @@ public class IbmWatsonxEmbeddingsModel extends IbmWatsonxModel {\n             service,\n             IbmWatsonxEmbeddingsServiceSettings.fromMap(serviceSettings, context),\n             EmptyTaskSettings.INSTANCE,\n+            chunkingSettings,\n             DefaultSecretSettings.fromMap(secrets)\n         );\n     }\n@@ -64,10 +67,11 @@ public class IbmWatsonxEmbeddingsModel extends IbmWatsonxModel {\n         String service,\n         IbmWatsonxEmbeddingsServiceSettings serviceSettings,\n         TaskSettings taskSettings,\n+        @Nullable ChunkingSettings chunkingSettings,\n         @Nullable DefaultSecretSettings secrets\n     ) {\n         super(\n-            new ModelConfigurations(inferenceEntityId, taskType, service, serviceSettings, taskSettings),\n+            new ModelConfigurations(inferenceEntityId, taskType, service, serviceSettings, taskSettings, chunkingSettings),\n             new ModelSecrets(secrets),\n             serviceSettings\n         );\n@@ -86,10 +90,11 @@ public class IbmWatsonxEmbeddingsModel extends IbmWatsonxModel {\n         String uri,\n         IbmWatsonxEmbeddingsServiceSettings serviceSettings,\n         TaskSettings taskSettings,\n+        @Nullable ChunkingSettings chunkingSettings,\n         @Nullable DefaultSecretSettings secrets\n     ) {\n         super(\n-            new ModelConfigurations(inferenceEntityId, taskType, service, serviceSettings, taskSettings),\n+            new ModelConfigurations(inferenceEntityId, taskType, service, serviceSettings, taskSettings, chunkingSettings),\n             new ModelSecrets(secrets),\n             serviceSettings\n         );\ndiff --git a/x-pack/plugin/inference/src/test/java/org/elasticsearch/xpack/inference/services/ibmwatsonx/embeddings/IbmWatsonxEmbeddingsModelTests.java b/x-pack/plugin/inference/src/test/java/org/elasticsearch/xpack/inference/services/ibmwatsonx/embeddings/IbmWatsonxEmbeddingsModelTests.java\nindex 93fd7e40..0d0b29bb 100644\n--- a/x-pack/plugin/inference/src/test/java/org/elasticsearch/xpack/inference/services/ibmwatsonx/embeddings/IbmWatsonxEmbeddingsModelTests.java\n+++ b/x-pack/plugin/inference/src/test/java/org/elasticsearch/xpack/inference/services/ibmwatsonx/embeddings/IbmWatsonxEmbeddingsModelTests.java\n@@ -33,6 +33,7 @@ public class IbmWatsonxEmbeddingsModelTests extends ESTestCase {\n             url,\n             new IbmWatsonxEmbeddingsServiceSettings(model, projectId, uri, apiVersion, null, null, SimilarityMeasure.DOT_PRODUCT, null),\n             EmptyTaskSettings.INSTANCE,\n+            null,\n             new DefaultSecretSettings(new SecureString(apiKey.toCharArray()))\n         );\n     }\n@@ -54,6 +55,7 @@ public class IbmWatsonxEmbeddingsModelTests extends ESTestCase {\n             url,\n             new IbmWatsonxEmbeddingsServiceSettings(model, projectId, uri, apiVersion, null, dimensions, similarityMeasure, null),\n             EmptyTaskSettings.INSTANCE,\n+            null,\n             new DefaultSecretSettings(new SecureString(apiKey.toCharArray()))\n         );\n     }\n@@ -82,6 +84,7 @@ public class IbmWatsonxEmbeddingsModelTests extends ESTestCase {\n                 null\n             ),\n             EmptyTaskSettings.INSTANCE,\n+            null,\n             new DefaultSecretSettings(new SecureString(apiKey.toCharArray()))\n         );\n     }",
  "logs_path": "auggie/sonnet4.5/a9463435/elastic_elasticsearch_pr114914/logs.jsonl",
  "errors": [],
  "edit_run_id": "a9463435",
  "test_label": "v0"
}