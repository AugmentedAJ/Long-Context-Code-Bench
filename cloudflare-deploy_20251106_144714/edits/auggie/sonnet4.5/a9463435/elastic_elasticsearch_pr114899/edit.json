{
  "repo_url": "https://github.com/elastic/elasticsearch.git",
  "pr_number": 114899,
  "base_commit": "6f608803302230a24c2d81fc9c4b863eb3513cb8",
  "runner": "auggie",
  "model": "sonnet4.5",
  "timeout_s": 1800,
  "status": "success",
  "elapsed_ms": 460082,
  "patch_unified": "diff --git a/x-pack/plugin/esql/qa/testFixtures/src/main/resources/stats.csv-spec b/x-pack/plugin/esql/qa/testFixtures/src/main/resources/stats.csv-spec\nindex 496a747f..5fa36a57 100644\n--- a/x-pack/plugin/esql/qa/testFixtures/src/main/resources/stats.csv-spec\n+++ b/x-pack/plugin/esql/qa/testFixtures/src/main/resources/stats.csv-spec\n@@ -2291,6 +2291,16 @@ m:integer |a:double |x:integer\n 74999     |48249.0  |0\n ;\n \n+statsByConstantExpressionFromEval\n+from employees\n+| eval x = [1,2,3], y = 5 + 6\n+| stats m = max(salary), a = round(avg(salary)) by y + 1\n+;\n+\n+m:integer |a:double |y + 1:integer\n+74999     |48249.0  |12\n+;\n+\n \n statsWithFiltering\n required_capability: per_agg_filtering\ndiff --git a/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/plan/logical/Aggregate.java b/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/plan/logical/Aggregate.java\nindex b2f314a0..fe7fc239 100644\n--- a/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/plan/logical/Aggregate.java\n+++ b/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/plan/logical/Aggregate.java\n@@ -157,7 +157,16 @@ public class Aggregate extends UnaryPlan implements Stats {\n     }\n \n     public static AttributeSet computeReferences(List<? extends NamedExpression> aggregates, List<? extends Expression> groupings) {\n-        return Expressions.references(groupings).combine(Expressions.references(aggregates));\n+        // Collect grouping names to identify implicit aliases\n+        var groupingNames = Expressions.names(groupings);\n+\n+        // Filter out implicit aliases from aggregates - these are Attributes that match grouping names\n+        // These implicit aliases are added in LogicalPlanBuilder.stats() and should not contribute to field references\n+        var aggregatesWithoutImplicitAliases = aggregates.stream()\n+            .filter(agg -> agg instanceof Attribute == false || groupingNames.contains(agg.name()) == false)\n+            .toList();\n+\n+        return Expressions.references(groupings).combine(Expressions.references(aggregatesWithoutImplicitAliases));\n     }\n \n     @Override\ndiff --git a/x-pack/plugin/esql/src/test/java/org/elasticsearch/xpack/esql/session/IndexResolverFieldNamesTests.java b/x-pack/plugin/esql/src/test/java/org/elasticsearch/xpack/esql/session/IndexResolverFieldNamesTests.java\nindex 5425f770..0f2bffad 100644\n--- a/x-pack/plugin/esql/src/test/java/org/elasticsearch/xpack/esql/session/IndexResolverFieldNamesTests.java\n+++ b/x-pack/plugin/esql/src/test/java/org/elasticsearch/xpack/esql/session/IndexResolverFieldNamesTests.java\n@@ -81,6 +81,15 @@ public class IndexResolverFieldNamesTests extends ESTestCase {\n         );\n     }\n \n+    public void testStatsByConstantExpressionFromEval() {\n+        // Test for https://github.com/elastic/elasticsearch/issues/114714\n+        // STATS BY expression using only constants from EVAL should not require those fields from the index\n+        assertFieldNames(\n+            \"from employees | eval x = [1,2,3], y = 5 + 6 | stats m = max(salary) by y + 1\",\n+            Set.of(\"salary\", \"salary.*\")\n+        );\n+    }\n+\n     public void testIn1() {\n         assertFieldNames(\n             \"from employees | keep emp_no, is_rehired, still_hired \"",
  "logs_path": "auggie/sonnet4.5/a9463435/elastic_elasticsearch_pr114899/logs.jsonl",
  "errors": [],
  "edit_run_id": "a9463435",
  "test_label": "v0"
}