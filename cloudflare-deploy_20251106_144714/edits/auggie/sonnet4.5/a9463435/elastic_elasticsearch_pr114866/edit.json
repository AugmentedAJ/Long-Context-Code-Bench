{
  "repo_url": "https://github.com/elastic/elasticsearch.git",
  "pr_number": 114866,
  "base_commit": "d3ab379df5b5fb588e9071923ff0d4b6c20096af",
  "runner": "auggie",
  "model": "sonnet4.5",
  "timeout_s": 1800,
  "status": "success",
  "elapsed_ms": 709197,
  "patch_unified": "diff --git a/server/src/main/java/org/elasticsearch/index/mapper/SourceFieldMapper.java b/server/src/main/java/org/elasticsearch/index/mapper/SourceFieldMapper.java\nindex 834a04f9..ea7fbfd8 100644\n--- a/server/src/main/java/org/elasticsearch/index/mapper/SourceFieldMapper.java\n+++ b/server/src/main/java/org/elasticsearch/index/mapper/SourceFieldMapper.java\n@@ -92,6 +92,42 @@ public class SourceFieldMapper extends MetadataFieldMapper {\n         true\n     );\n \n+    private static final SourceFieldMapper DEFAULT_DISABLED = new SourceFieldMapper(\n+        Mode.DISABLED,\n+        Explicit.IMPLICIT_TRUE,\n+        Strings.EMPTY_ARRAY,\n+        Strings.EMPTY_ARRAY,\n+        null,\n+        true\n+    );\n+\n+    private static final SourceFieldMapper DEFAULT_DISABLED_NO_RECOVERY_SOURCE = new SourceFieldMapper(\n+        Mode.DISABLED,\n+        Explicit.IMPLICIT_TRUE,\n+        Strings.EMPTY_ARRAY,\n+        Strings.EMPTY_ARRAY,\n+        null,\n+        false\n+    );\n+\n+    private static final SourceFieldMapper DEFAULT_SYNTHETIC = new SourceFieldMapper(\n+        Mode.SYNTHETIC,\n+        Explicit.IMPLICIT_TRUE,\n+        Strings.EMPTY_ARRAY,\n+        Strings.EMPTY_ARRAY,\n+        null,\n+        true\n+    );\n+\n+    private static final SourceFieldMapper DEFAULT_SYNTHETIC_NO_RECOVERY_SOURCE = new SourceFieldMapper(\n+        Mode.SYNTHETIC,\n+        Explicit.IMPLICIT_TRUE,\n+        Strings.EMPTY_ARRAY,\n+        Strings.EMPTY_ARRAY,\n+        null,\n+        false\n+    );\n+\n     private static final SourceFieldMapper DEFAULT_NO_RECOVERY_SOURCE = new SourceFieldMapper(\n         null,\n         Explicit.IMPLICIT_TRUE,\n@@ -301,7 +337,7 @@ public class SourceFieldMapper extends MetadataFieldMapper {\n                 ? INDEX_MAPPER_SOURCE_MODE_SETTING.get(settings)\n                 : mode.get();\n             if (isDefault(sourceMode)) {\n-                return resolveSourceMode(indexMode, sourceMode, enableRecoverySource);\n+                return resolveSourceMode(indexMode, sourceMode == null ? Mode.STORED : sourceMode, enableRecoverySource);\n \n             }\n             if (supportsNonDefaultParameterValues == false) {\n@@ -344,27 +380,38 @@ public class SourceFieldMapper extends MetadataFieldMapper {\n     }\n \n     private static SourceFieldMapper resolveSourceMode(final IndexMode indexMode, final Mode sourceMode, boolean enableRecoverySource) {\n-        if (indexMode == IndexMode.STANDARD) {\n-            return enableRecoverySource ? DEFAULT : DEFAULT_NO_RECOVERY_SOURCE;\n-        }\n-        final SourceFieldMapper syntheticWithoutRecoverySource = indexMode == IndexMode.TIME_SERIES\n-            ? TSDB_DEFAULT_NO_RECOVERY_SOURCE\n-            : LOGSDB_DEFAULT_NO_RECOVERY_SOURCE;\n-        final SourceFieldMapper syntheticWithRecoverySource = indexMode == IndexMode.TIME_SERIES ? TSDB_DEFAULT : LOGSDB_DEFAULT;\n-        final SourceFieldMapper storedWithoutRecoverySource = indexMode == IndexMode.TIME_SERIES\n-            ? TSDB_DEFAULT_NO_RECOVERY_SOURCE_STORED\n-            : LOGSDB_DEFAULT_NO_RECOVERY_SOURCE_STORED;\n-        final SourceFieldMapper storedWithRecoverySource = indexMode == IndexMode.TIME_SERIES ? TSDB_DEFAULT_STORED : LOGSDB_DEFAULT_STORED;\n-\n-        switch (sourceMode) {\n-            case SYNTHETIC:\n-                return enableRecoverySource ? syntheticWithRecoverySource : syntheticWithoutRecoverySource;\n-            case STORED:\n-                return enableRecoverySource ? storedWithRecoverySource : storedWithoutRecoverySource;\n-            case DISABLED:\n-                throw new IllegalArgumentException(\"_source cannot be disabled in index using [\" + indexMode + \"] index mode\");\n+        switch (indexMode) {\n+            case STANDARD:\n+                switch (sourceMode) {\n+                    case SYNTHETIC:\n+                        return enableRecoverySource ? DEFAULT_SYNTHETIC : DEFAULT_SYNTHETIC_NO_RECOVERY_SOURCE;\n+                    case STORED:\n+                        return enableRecoverySource ? DEFAULT : DEFAULT_NO_RECOVERY_SOURCE;\n+                    case DISABLED:\n+                        return enableRecoverySource ? DEFAULT_DISABLED : DEFAULT_DISABLED_NO_RECOVERY_SOURCE;\n+                    default:\n+                        throw new IllegalArgumentException(\"Unsupported source mode: \" + sourceMode);\n+                }\n+            case TIME_SERIES:\n+            case LOGSDB:\n+                switch (sourceMode) {\n+                    case SYNTHETIC:\n+                        return enableRecoverySource\n+                            ? (indexMode == IndexMode.TIME_SERIES ? TSDB_DEFAULT : LOGSDB_DEFAULT)\n+                            : (indexMode == IndexMode.TIME_SERIES ? TSDB_DEFAULT_NO_RECOVERY_SOURCE : LOGSDB_DEFAULT_NO_RECOVERY_SOURCE);\n+                    case STORED:\n+                        return enableRecoverySource\n+                            ? (indexMode == IndexMode.TIME_SERIES ? TSDB_DEFAULT_STORED : LOGSDB_DEFAULT_STORED)\n+                            : (indexMode == IndexMode.TIME_SERIES\n+                                ? TSDB_DEFAULT_NO_RECOVERY_SOURCE_STORED\n+                                : LOGSDB_DEFAULT_NO_RECOVERY_SOURCE_STORED);\n+                    case DISABLED:\n+                        throw new IllegalArgumentException(\"_source can not be disabled in index using [\" + indexMode + \"] index mode\");\n+                    default:\n+                        throw new IllegalArgumentException(\"Unsupported source mode: \" + sourceMode);\n+                }\n             default:\n-                throw new IllegalStateException(\"Unexpected value: \" + sourceMode);\n+                throw new IllegalArgumentException(\"Unsupported index mode: \" + indexMode);\n         }\n     }\n \n@@ -378,7 +425,7 @@ public class SourceFieldMapper extends MetadataFieldMapper {\n                 return enableRecoverySource ? TSDB_LEGACY_DEFAULT : TSDB_LEGACY_DEFAULT_NO_RECOVERY_SOURCE;\n             }\n         }\n-        return resolveSourceMode(indexMode, settingSourceMode, enableRecoverySource);\n+        return resolveSourceMode(indexMode, settingSourceMode == null ? Mode.STORED : settingSourceMode, enableRecoverySource);\n     },\n         c -> new Builder(\n             c.getIndexSettings().getMode(),\n@@ -548,4 +595,12 @@ public class SourceFieldMapper extends MetadataFieldMapper {\n     public boolean isSynthetic() {\n         return mode == Mode.SYNTHETIC;\n     }\n+\n+    public boolean isDisabled() {\n+        return mode == Mode.DISABLED;\n+    }\n+\n+    public boolean isStored() {\n+        return mode == null || mode == Mode.STORED;\n+    }\n }\ndiff --git a/server/src/test/java/org/elasticsearch/index/mapper/SourceFieldMapperTests.java b/server/src/test/java/org/elasticsearch/index/mapper/SourceFieldMapperTests.java\nindex 2f417e68..df6d9380 100644\n--- a/server/src/test/java/org/elasticsearch/index/mapper/SourceFieldMapperTests.java\n+++ b/server/src/test/java/org/elasticsearch/index/mapper/SourceFieldMapperTests.java\n@@ -443,6 +443,167 @@ public class SourceFieldMapperTests extends MetadataMapperTestCase {\n         }\n     }\n \n+    public void testStandardIndexModeWithSourceModeSetting() throws IOException {\n+        // Test for IndexMode.STANDARD\n+        {\n+            final XContentBuilder mappings = topMapping(b -> {});\n+            final Settings settings = Settings.builder()\n+                .put(IndexSettings.MODE.getKey(), IndexMode.STANDARD.name())\n+                .put(SourceFieldMapper.INDEX_MAPPER_SOURCE_MODE_SETTING.getKey(), SourceFieldMapper.Mode.SYNTHETIC)\n+                .build();\n+            final MapperService mapperService = createMapperService(settings, mappings);\n+            DocumentMapper docMapper = mapperService.documentMapper();\n+            assertTrue(docMapper.sourceMapper().isSynthetic());\n+        }\n+        {\n+            final XContentBuilder mappings = topMapping(b -> {});\n+            final Settings settings = Settings.builder()\n+                .put(IndexSettings.MODE.getKey(), IndexMode.STANDARD.name())\n+                .put(SourceFieldMapper.INDEX_MAPPER_SOURCE_MODE_SETTING.getKey(), SourceFieldMapper.Mode.STORED)\n+                .build();\n+            final MapperService mapperService = createMapperService(settings, mappings);\n+            final DocumentMapper docMapper = mapperService.documentMapper();\n+            assertTrue(docMapper.sourceMapper().isStored());\n+        }\n+        {\n+            final XContentBuilder mappings = topMapping(b -> {});\n+            final Settings settings = Settings.builder()\n+                .put(IndexSettings.MODE.getKey(), IndexMode.STANDARD.name())\n+                .put(SourceFieldMapper.INDEX_MAPPER_SOURCE_MODE_SETTING.getKey(), SourceFieldMapper.Mode.DISABLED)\n+                .build();\n+            final MapperService mapperService = createMapperService(settings, mappings);\n+            final DocumentMapper docMapper = mapperService.documentMapper();\n+            assertTrue(docMapper.sourceMapper().isDisabled());\n+        }\n+\n+        // Test for IndexMode.LOGSDB\n+        {\n+            final XContentBuilder mappings = topMapping(b -> {});\n+            final Settings settings = Settings.builder()\n+                .put(IndexSettings.MODE.getKey(), IndexMode.LOGSDB.name())\n+                .put(SourceFieldMapper.INDEX_MAPPER_SOURCE_MODE_SETTING.getKey(), SourceFieldMapper.Mode.SYNTHETIC)\n+                .build();\n+            final MapperService mapperService = createMapperService(settings, mappings);\n+            DocumentMapper docMapper = mapperService.documentMapper();\n+            assertTrue(docMapper.sourceMapper().isSynthetic());\n+        }\n+        {\n+            final XContentBuilder mappings = topMapping(b -> {});\n+            final Settings settings = Settings.builder()\n+                .put(IndexSettings.MODE.getKey(), IndexMode.LOGSDB.name())\n+                .put(SourceFieldMapper.INDEX_MAPPER_SOURCE_MODE_SETTING.getKey(), SourceFieldMapper.Mode.STORED)\n+                .build();\n+            final MapperService mapperService = createMapperService(settings, mappings);\n+            final DocumentMapper docMapper = mapperService.documentMapper();\n+            assertTrue(docMapper.sourceMapper().isStored());\n+        }\n+        {\n+            final XContentBuilder mappings = topMapping(b -> {});\n+            final Settings settings = Settings.builder()\n+                .put(IndexSettings.MODE.getKey(), IndexMode.LOGSDB.name())\n+                .put(SourceFieldMapper.INDEX_MAPPER_SOURCE_MODE_SETTING.getKey(), SourceFieldMapper.Mode.DISABLED)\n+                .build();\n+            var ex = expectThrows(MapperParsingException.class, () -> createMapperService(settings, mappings));\n+            assertEquals(\"Failed to parse mapping: _source can not be disabled in index using [logsdb] index mode\", ex.getMessage());\n+        }\n+\n+        // Test for IndexMode.TIME_SERIES\n+        {\n+            final String mappings = \"\"\"\n+                    {\n+                        \"_doc\" : {\n+                            \"properties\": {\n+                                \"routing_field\": {\n+                                    \"type\": \"keyword\",\n+                                    \"time_series_dimension\": true\n+                                }\n+                            }\n+                        }\n+                    }\n+                \"\"\";\n+            final Settings settings = Settings.builder()\n+                .put(IndexSettings.MODE.getKey(), IndexMode.TIME_SERIES.name())\n+                .put(SourceFieldMapper.INDEX_MAPPER_SOURCE_MODE_SETTING.getKey(), SourceFieldMapper.Mode.SYNTHETIC)\n+                .put(IndexMetadata.INDEX_ROUTING_PATH.getKey(), \"routing_field\")\n+                .build();\n+            final MapperService mapperService = createMapperService(settings, mappings);\n+            DocumentMapper docMapper = mapperService.documentMapper();\n+            assertTrue(docMapper.sourceMapper().isSynthetic());\n+        }\n+        {\n+            final String mappings = \"\"\"\n+                    {\n+                        \"_doc\" : {\n+                            \"properties\": {\n+                                \"routing_field\": {\n+                                    \"type\": \"keyword\",\n+                                    \"time_series_dimension\": true\n+                                }\n+                            }\n+                        }\n+                    }\n+                \"\"\";\n+            final Settings settings = Settings.builder()\n+                .put(IndexSettings.MODE.getKey(), IndexMode.TIME_SERIES.name())\n+                .put(SourceFieldMapper.INDEX_MAPPER_SOURCE_MODE_SETTING.getKey(), SourceFieldMapper.Mode.STORED)\n+                .put(IndexMetadata.INDEX_ROUTING_PATH.getKey(), \"routing_field\")\n+                .build();\n+            final MapperService mapperService = createMapperService(settings, mappings);\n+            final DocumentMapper docMapper = mapperService.documentMapper();\n+            assertTrue(docMapper.sourceMapper().isStored());\n+        }\n+        {\n+            final String mappings = \"\"\"\n+                    {\n+                        \"_doc\" : {\n+                            \"properties\": {\n+                                \"routing_field\": {\n+                                    \"type\": \"keyword\",\n+                                    \"time_series_dimension\": true\n+                                }\n+                            }\n+                        }\n+                    }\n+                \"\"\";\n+            final Settings settings = Settings.builder()\n+                .put(IndexSettings.MODE.getKey(), IndexMode.TIME_SERIES.name())\n+                .put(SourceFieldMapper.INDEX_MAPPER_SOURCE_MODE_SETTING.getKey(), SourceFieldMapper.Mode.DISABLED)\n+                .put(IndexMetadata.INDEX_ROUTING_PATH.getKey(), \"routing_field\")\n+                .build();\n+            var ex = expectThrows(MapperParsingException.class, () -> createMapperService(settings, mappings));\n+            assertEquals(\"Failed to parse mapping: _source can not be disabled in index using [time_series] index mode\", ex.getMessage());\n+        }\n+\n+        // Test cases without IndexMode (default to standard)\n+        {\n+            final XContentBuilder mappings = topMapping(b -> {});\n+            final Settings settings = Settings.builder()\n+                .put(SourceFieldMapper.INDEX_MAPPER_SOURCE_MODE_SETTING.getKey(), SourceFieldMapper.Mode.SYNTHETIC)\n+                .build();\n+            final MapperService mapperService = createMapperService(settings, mappings);\n+            DocumentMapper docMapper = mapperService.documentMapper();\n+            assertTrue(docMapper.sourceMapper().isSynthetic());\n+        }\n+        {\n+            final XContentBuilder mappings = topMapping(b -> {});\n+            final Settings settings = Settings.builder()\n+                .put(SourceFieldMapper.INDEX_MAPPER_SOURCE_MODE_SETTING.getKey(), SourceFieldMapper.Mode.STORED)\n+                .build();\n+            final MapperService mapperService = createMapperService(settings, mappings);\n+            final DocumentMapper docMapper = mapperService.documentMapper();\n+            assertTrue(docMapper.sourceMapper().isStored());\n+        }\n+        {\n+            final XContentBuilder mappings = topMapping(b -> {});\n+            final Settings settings = Settings.builder()\n+                .put(SourceFieldMapper.INDEX_MAPPER_SOURCE_MODE_SETTING.getKey(), SourceFieldMapper.Mode.DISABLED)\n+                .build();\n+            final MapperService mapperService = createMapperService(settings, mappings);\n+            final DocumentMapper docMapper = mapperService.documentMapper();\n+            assertTrue(docMapper.sourceMapper().isDisabled());\n+        }\n+    }\n+\n     public void testRecoverySourceWithLogsCustom() throws IOException {\n         XContentBuilder mappings = topMapping(b -> b.startObject(SourceFieldMapper.NAME).field(\"mode\", \"synthetic\").endObject());\n         {",
  "logs_path": "auggie/sonnet4.5/a9463435/elastic_elasticsearch_pr114866/logs.jsonl",
  "errors": [],
  "edit_run_id": "a9463435",
  "test_label": "v0"
}