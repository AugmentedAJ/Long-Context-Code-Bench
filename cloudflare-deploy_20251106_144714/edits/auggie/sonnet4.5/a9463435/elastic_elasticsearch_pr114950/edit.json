{
  "repo_url": "https://github.com/elastic/elasticsearch.git",
  "pr_number": 114950,
  "base_commit": "0648ab8920bba04ae691fa1a74c73a1981c9a14d",
  "runner": "auggie",
  "model": "sonnet4.5",
  "timeout_s": 1800,
  "status": "success",
  "elapsed_ms": 848143,
  "patch_unified": "diff --git a/modules/reindex/src/test/java/org/elasticsearch/reindex/BulkByScrollParallelizationHelperTests.java b/modules/reindex/src/test/java/org/elasticsearch/reindex/BulkByScrollParallelizationHelperTests.java\nindex a6e28477..888fe64b 100644\n--- a/modules/reindex/src/test/java/org/elasticsearch/reindex/BulkByScrollParallelizationHelperTests.java\n+++ b/modules/reindex/src/test/java/org/elasticsearch/reindex/BulkByScrollParallelizationHelperTests.java\n@@ -24,7 +24,7 @@ import static org.elasticsearch.search.RandomSearchRequestGenerator.randomSearch\n public class BulkByScrollParallelizationHelperTests extends ESTestCase {\n     public void testSliceIntoSubRequests() throws IOException {\n         SearchRequest searchRequest = randomSearchRequest(\n-            () -> randomSearchSourceBuilder(() -> null, () -> null, () -> null, () -> null, () -> emptyList(), () -> null, () -> null)\n+            () -> randomSearchSourceBuilder(() -> null, () -> null, () -> null, () -> emptyList(), () -> null, () -> null)\n         );\n         if (searchRequest.source() != null) {\n             // Clear the slice builder if there is one set. We can't call sliceIntoSubRequests if it is.\ndiff --git a/server/src/main/java/org/elasticsearch/search/builder/SearchSourceBuilder.java b/server/src/main/java/org/elasticsearch/search/builder/SearchSourceBuilder.java\nindex cce4e0b5..2d76d764 100644\n--- a/server/src/main/java/org/elasticsearch/search/builder/SearchSourceBuilder.java\n+++ b/server/src/main/java/org/elasticsearch/search/builder/SearchSourceBuilder.java\n@@ -99,10 +99,10 @@ public final class SearchSourceBuilder implements Writeable, ToXContentObject, R\n     public static final ParseField TIMEOUT_FIELD = new ParseField(\"timeout\");\n     public static final ParseField TERMINATE_AFTER_FIELD = new ParseField(\"terminate_after\");\n     public static final ParseField QUERY_FIELD = new ParseField(\"query\");\n-    public static final ParseField SUB_SEARCHES_FIELD = new ParseField(\"sub_searches\");\n+    public static final ParseField SUB_SEARCHES_FIELD = new ParseField(\"sub_searches\").withAllDeprecated(\"retriever\");\n+    public static final ParseField RANK_FIELD = new ParseField(\"rank\").withAllDeprecated(\"retriever\");\n     public static final ParseField POST_FILTER_FIELD = new ParseField(\"post_filter\");\n     public static final ParseField KNN_FIELD = new ParseField(\"knn\");\n-    public static final ParseField RANK_FIELD = new ParseField(\"rank\");\n     public static final ParseField MIN_SCORE_FIELD = new ParseField(\"min_score\");\n     public static final ParseField VERSION_FIELD = new ParseField(\"version\");\n     public static final ParseField SEQ_NO_PRIMARY_TERM_FIELD = new ParseField(\"seq_no_primary_term\");\ndiff --git a/server/src/test/java/org/elasticsearch/search/AbstractSearchTestCase.java b/server/src/test/java/org/elasticsearch/search/AbstractSearchTestCase.java\nindex b716f11b..88c83df3 100644\n--- a/server/src/test/java/org/elasticsearch/search/AbstractSearchTestCase.java\n+++ b/server/src/test/java/org/elasticsearch/search/AbstractSearchTestCase.java\n@@ -89,7 +89,6 @@ public abstract class AbstractSearchTestCase extends ESTestCase {\n         return RandomSearchRequestGenerator.randomSearchSourceBuilder(\n             HighlightBuilderTests::randomHighlighterBuilder,\n             SuggestBuilderTests::randomSuggestBuilder,\n-            TestRankBuilder::randomRankBuilder,\n             QueryRescorerBuilderTests::randomRescoreBuilder,\n             randomExtBuilders,\n             CollapseBuilderTests::randomCollapseBuilder,\ndiff --git a/server/src/test/java/org/elasticsearch/search/vectors/KnnSearchRequestParserTests.java b/server/src/test/java/org/elasticsearch/search/vectors/KnnSearchRequestParserTests.java\nindex d9fe421b..4e4d2158 100644\n--- a/server/src/test/java/org/elasticsearch/search/vectors/KnnSearchRequestParserTests.java\n+++ b/server/src/test/java/org/elasticsearch/search/vectors/KnnSearchRequestParserTests.java\n@@ -74,7 +74,6 @@ public class KnnSearchRequestParserTests extends ESTestCase {\n             () -> null,\n             () -> null,\n             () -> null,\n-            () -> null,\n             Collections::emptyList,\n             () -> null,\n             () -> null\ndiff --git a/test/framework/src/main/java/org/elasticsearch/search/RandomSearchRequestGenerator.java b/test/framework/src/main/java/org/elasticsearch/search/RandomSearchRequestGenerator.java\nindex b59f1a5e..76b50533 100644\n--- a/test/framework/src/main/java/org/elasticsearch/search/RandomSearchRequestGenerator.java\n+++ b/test/framework/src/main/java/org/elasticsearch/search/RandomSearchRequestGenerator.java\n@@ -29,7 +29,6 @@ import org.elasticsearch.search.fetch.subphase.FetchSourceContext;\n import org.elasticsearch.search.fetch.subphase.FieldAndFormat;\n import org.elasticsearch.search.fetch.subphase.highlight.HighlightBuilder;\n import org.elasticsearch.search.internal.SearchContext;\n-import org.elasticsearch.search.rank.RankBuilder;\n import org.elasticsearch.search.rescore.RescorerBuilder;\n import org.elasticsearch.search.searchafter.SearchAfterBuilder;\n import org.elasticsearch.search.slice.SliceBuilder;\n@@ -122,7 +121,6 @@ public class RandomSearchRequestGenerator {\n     public static SearchSourceBuilder randomSearchSourceBuilder(\n         Supplier<HighlightBuilder> randomHighlightBuilder,\n         Supplier<SuggestBuilder> randomSuggestBuilder,\n-        Supplier<RankBuilder> rankContextBuilderSupplier,\n         Supplier<RescorerBuilder<?>> randomRescoreBuilder,\n         Supplier<List<SearchExtBuilder>> randomExtBuilders,\n         Supplier<CollapseBuilder> randomCollapseBuilder,\n@@ -354,9 +352,6 @@ public class RandomSearchRequestGenerator {\n         if (randomBoolean()) {\n             builder.suggest(randomSuggestBuilder.get());\n         }\n-        if (randomBoolean()) {\n-            builder.rankBuilder(rankContextBuilderSupplier.get());\n-        }\n         if (randomBoolean()) {\n             int numRescores = randomIntBetween(1, 5);\n             for (int i = 0; i < numRescores; i++) {\ndiff --git a/x-pack/plugin/rank-rrf/src/yamlRestTest/resources/rest-api-spec/test/rrf/100_rank_rrf.yml b/x-pack/plugin/rank-rrf/src/yamlRestTest/resources/rest-api-spec/test/rrf/100_rank_rrf.yml\nindex 64754064..3092b00a 100644\n--- a/x-pack/plugin/rank-rrf/src/yamlRestTest/resources/rest-api-spec/test/rrf/100_rank_rrf.yml\n+++ b/x-pack/plugin/rank-rrf/src/yamlRestTest/resources/rest-api-spec/test/rrf/100_rank_rrf.yml\n@@ -2,6 +2,8 @@ setup:\n   - requires:\n       cluster_features: \"gte_v8.8.0\"\n       reason: 'rank added in 8.8'\n+  - skip:\n+      features: \"warnings\"\n \n   - do:\n       indices.create:\n@@ -59,7 +61,14 @@ setup:\n ---\n \"Simple rank with bm25 search and kNN search\":\n \n+  - requires:\n+      cluster_features: [\"gte_v8.16.0\"]\n+      reason: \"deprecation added in 8.16\"\n+      test_runner_features: warnings\n+\n   - do:\n+      warnings:\n+        - \"Deprecated field [rank] used, replaced by [retriever]\"\n       search:\n         index: test\n         body:\n@@ -94,7 +103,15 @@ setup:\n ---\n \"Simple rank with multiple bm25 sub searches\":\n \n+  - requires:\n+      cluster_features: [\"gte_v8.16.0\"]\n+      reason: \"deprecation added in 8.16\"\n+      test_runner_features: warnings\n+\n   - do:\n+      warnings:\n+        - \"Deprecated field [rank] used, replaced by [retriever]\"\n+        - \"Deprecated field [sub_searches] used, replaced by [retriever]\"\n       search:\n         index: test\n         body:\n@@ -135,7 +152,15 @@ setup:\n ---\n \"Simple rank with multiple bm25 sub_searches and a knn search\":\n \n+  - requires:\n+      cluster_features: [\"gte_v8.16.0\"]\n+      reason: \"deprecation added in 8.16\"\n+      test_runner_features: warnings\n+\n   - do:\n+      warnings:\n+        - \"Deprecated field [rank] used, replaced by [retriever]\"\n+        - \"Deprecated field [sub_searches] used, replaced by [retriever]\"\n       search:\n         index: test\n         body:\ndiff --git a/x-pack/plugin/rank-rrf/src/yamlRestTest/resources/rest-api-spec/test/rrf/150_rank_rrf_pagination.yml b/x-pack/plugin/rank-rrf/src/yamlRestTest/resources/rest-api-spec/test/rrf/150_rank_rrf_pagination.yml\nindex b4893bfe..2516ed88 100644\n--- a/x-pack/plugin/rank-rrf/src/yamlRestTest/resources/rest-api-spec/test/rrf/150_rank_rrf_pagination.yml\n+++ b/x-pack/plugin/rank-rrf/src/yamlRestTest/resources/rest-api-spec/test/rrf/150_rank_rrf_pagination.yml\n@@ -63,7 +63,15 @@ setup:\n ---\n \"Standard pagination within rank_window_size\":\n   # this test retrieves the same results from two queries, and applies a simple pagination skipping the first result\n+  - requires:\n+      cluster_features: [\"gte_v8.16.0\"]\n+      reason: \"deprecation added in 8.16\"\n+      test_runner_features: warnings\n+\n   - do:\n+      warnings:\n+        - \"Deprecated field [rank] used, replaced by [retriever]\"\n+        - \"Deprecated field [sub_searches] used, replaced by [retriever]\"\n       search:\n         index: test\n         body:\n@@ -170,7 +178,15 @@ setup:\n ---\n \"Standard pagination outside rank_window_size\":\n   # in this example, from starts *after* rank_window_size so, we expect 0 results to be returned\n+  - requires:\n+      cluster_features: [\"gte_v8.16.0\"]\n+      reason: \"deprecation added in 8.16\"\n+      test_runner_features: warnings\n+\n   - do:\n+      warnings:\n+        - \"Deprecated field [rank] used, replaced by [retriever]\"\n+        - \"Deprecated field [sub_searches] used, replaced by [retriever]\"\n       search:\n         index: test\n         body:\n@@ -274,7 +290,15 @@ setup:\n ---\n \"Standard pagination partially outside rank_window_size\":\n   # in this example we have that from starts *within* rank_window_size, but \"from + size\" goes over\n+  - requires:\n+      cluster_features: [\"gte_v8.16.0\"]\n+      reason: \"deprecation added in 8.16\"\n+      test_runner_features: warnings\n+\n   - do:\n+      warnings:\n+        - \"Deprecated field [rank] used, replaced by [retriever]\"\n+        - \"Deprecated field [sub_searches] used, replaced by [retriever]\"\n       search:\n         index: test\n         body:\n@@ -384,7 +408,15 @@ setup:\n   # queryA has a result set of [1, 2, 3, 4] and\n   # queryB has a result set of [4, 3, 1, 2]\n   # so for rank_constant=10, the expected order is [1, 4, 3, 2]\n+  - requires:\n+      cluster_features: [\"gte_v8.16.0\"]\n+      reason: \"deprecation added in 8.16\"\n+      test_runner_features: warnings\n+\n   - do:\n+      warnings:\n+        - \"Deprecated field [rank] used, replaced by [retriever]\"\n+        - \"Deprecated field [sub_searches] used, replaced by [retriever]\"\n       search:\n         index: test\n         body:\n@@ -488,6 +520,9 @@ setup:\n   - match: { hits.hits.1._id: \"4\" }\n \n   - do:\n+      warnings:\n+        - \"Deprecated field [rank] used, replaced by [retriever]\"\n+        - \"Deprecated field [sub_searches] used, replaced by [retriever]\"\n       search:\n         index: test\n         body:\n@@ -597,7 +632,15 @@ setup:\n   # queryA has a result set of [5, 1] and\n   # queryB has a result set of [4, 3, 1, 2]\n   # so for rank_constant=10, the expected order is [1, 5, 4, 3, 2]\n+  - requires:\n+      cluster_features: [\"gte_v8.16.0\"]\n+      reason: \"deprecation added in 8.16\"\n+      test_runner_features: warnings\n+\n   - do:\n+      warnings:\n+        - \"Deprecated field [rank] used, replaced by [retriever]\"\n+        - \"Deprecated field [sub_searches] used, replaced by [retriever]\"\n       search:\n         index: test\n         body:\n@@ -685,6 +728,9 @@ setup:\n   - match: { hits.hits.1._id: \"5\" }\n \n   - do:\n+      warnings:\n+        - \"Deprecated field [rank] used, replaced by [retriever]\"\n+        - \"Deprecated field [sub_searches] used, replaced by [retriever]\"\n       search:\n         index: test\n         body:\n@@ -772,6 +818,9 @@ setup:\n   - match: { hits.hits.1._id: \"3\" }\n \n   - do:\n+      warnings:\n+        - \"Deprecated field [rank] used, replaced by [retriever]\"\n+        - \"Deprecated field [sub_searches] used, replaced by [retriever]\"\n       search:\n         index: test\n         body:\n@@ -867,7 +916,15 @@ setup:\n   # queryB has a result set of [4, 3]\n   # so for rank_constant=10, the expected order is [5, 4, 1, 3],\n   # and the rank_window_size-sized result set that we'd paginate over is [5, 4]\n+  - requires:\n+      cluster_features: [\"gte_v8.16.0\"]\n+      reason: \"deprecation added in 8.16\"\n+      test_runner_features: warnings\n+\n   - do:\n+      warnings:\n+        - \"Deprecated field [rank] used, replaced by [retriever]\"\n+        - \"Deprecated field [sub_searches] used, replaced by [retriever]\"\n       search:\n         index: test\n         body:\n@@ -955,6 +1012,9 @@ setup:\n   - match: { hits.hits.1._id: \"4\" }\n \n   - do:\n+      warnings:\n+        - \"Deprecated field [rank] used, replaced by [retriever]\"\n+        - \"Deprecated field [sub_searches] used, replaced by [retriever]\"\n       search:\n         index: test\n         body:\ndiff --git a/x-pack/plugin/rank-rrf/src/yamlRestTest/resources/rest-api-spec/test/rrf/200_rank_rrf_script.yml b/x-pack/plugin/rank-rrf/src/yamlRestTest/resources/rest-api-spec/test/rrf/200_rank_rrf_script.yml\nindex bca39dea..36e70581 100644\n--- a/x-pack/plugin/rank-rrf/src/yamlRestTest/resources/rest-api-spec/test/rrf/200_rank_rrf_script.yml\n+++ b/x-pack/plugin/rank-rrf/src/yamlRestTest/resources/rest-api-spec/test/rrf/200_rank_rrf_script.yml\n@@ -67,7 +67,14 @@ setup:\n ---\n \"RRF using single knn and single BM25 with a scripted metric aggregation\":\n \n+  - requires:\n+      cluster_features: [\"gte_v8.16.0\"]\n+      reason: \"deprecation added in 8.16\"\n+      test_runner_features: warnings\n+\n   - do:\n+      warnings:\n+        - \"Deprecated field [rank] used, replaced by [retriever]\"\n       search:\n         index: test\n         body:\n@@ -140,7 +147,14 @@ setup:\n ---\n \"RRF using multi-knn only with a scripted metric aggregation\":\n \n+  - requires:\n+      cluster_features: [\"gte_v8.16.0\"]\n+      reason: \"deprecation added in 8.16\"\n+      test_runner_features: warnings\n+\n   - do:\n+      warnings:\n+        - \"Deprecated field [rank] used, replaced by [retriever]\"\n       search:\n         index: test\n         body:\n@@ -195,7 +209,14 @@ setup:\n ---\n \"RRF using multi-knn and single BM25 with a scripted metric aggregation\":\n \n+  - requires:\n+      cluster_features: [\"gte_v8.16.0\"]\n+      reason: \"deprecation added in 8.16\"\n+      test_runner_features: warnings\n+\n   - do:\n+      warnings:\n+        - \"Deprecated field [rank] used, replaced by [retriever]\"\n       search:\n         index: test\n         body:\ndiff --git a/x-pack/plugin/rank-rrf/src/yamlRestTest/resources/rest-api-spec/test/rrf/550_rrf_sub_searches_explain.yml b/x-pack/plugin/rank-rrf/src/yamlRestTest/resources/rest-api-spec/test/rrf/550_rrf_sub_searches_explain.yml\nindex 5718cd34..ca1ac130 100644\n--- a/x-pack/plugin/rank-rrf/src/yamlRestTest/resources/rest-api-spec/test/rrf/550_rrf_sub_searches_explain.yml\n+++ b/x-pack/plugin/rank-rrf/src/yamlRestTest/resources/rest-api-spec/test/rrf/550_rrf_sub_searches_explain.yml\n@@ -75,6 +75,11 @@ setup:\n ---\n \"using a top level knn and query\":\n \n+  - requires:\n+      cluster_features: [\"gte_v8.16.0\"]\n+      reason: \"deprecation added in 8.16\"\n+      test_runner_features: warnings\n+\n   - do:\n       search:\n         index: test\n@@ -94,6 +99,8 @@ setup:\n               rank_constant: 1\n           size: 3\n           explain: true\n+      warnings:\n+        - \"Deprecated field [rank] used, replaced by [retriever]\"\n \n   - match: { hits.hits.0._id: \"3\" }\n   - match: { hits.hits.1._id: \"2\" }\n@@ -129,6 +136,11 @@ setup:\n ---\n \"using sub_searches\":\n \n+  - requires:\n+      cluster_features: [\"gte_v8.16.0\"]\n+      reason: \"deprecation added in 8.16\"\n+      test_runner_features: warnings\n+\n   - do:\n       search:\n         index: test\n@@ -159,6 +171,9 @@ setup:\n               rank_constant: 1\n           size: 3\n           explain: true\n+      warnings:\n+        - \"Deprecated field [rank] used, replaced by [retriever]\"\n+        - \"Deprecated field [sub_searches] used, replaced by [retriever]\"\n \n   - match: { hits.hits.0._id: \"3\" }\n   - match: { hits.hits.1._id: \"2\" }\n@@ -194,6 +209,11 @@ setup:\n ---\n \"using named top level knn and query\":\n \n+  - requires:\n+      cluster_features: [\"gte_v8.16.0\"]\n+      reason: \"deprecation added in 8.16\"\n+      test_runner_features: warnings\n+\n   - do:\n       search:\n         index: test\n@@ -216,6 +236,8 @@ setup:\n               rank_constant: 1\n           size: 3\n           explain: true\n+      warnings:\n+        - \"Deprecated field [rank] used, replaced by [retriever]\"\n \n   - match: { hits.hits.0._id: \"3\" }\n   - match: { hits.hits.1._id: \"2\" }\n@@ -251,6 +273,11 @@ setup:\n ---\n \"using named sub_searches\":\n \n+  - requires:\n+      cluster_features: [\"gte_v8.16.0\"]\n+      reason: \"deprecation added in 8.16\"\n+      test_runner_features: warnings\n+\n   - do:\n       search:\n         index: test\n@@ -285,6 +312,9 @@ setup:\n               rank_constant: 1\n           size: 3\n           explain: true\n+      warnings:\n+        - \"Deprecated field [rank] used, replaced by [retriever]\"\n+        - \"Deprecated field [sub_searches] used, replaced by [retriever]\"\n \n   - match: { hits.hits.0._id: \"3\" }\n   - match: { hits.hits.1._id: \"2\" }\n@@ -320,6 +350,11 @@ setup:\n ---\n \"using a mix of named and unnamed queries\":\n \n+  - requires:\n+      cluster_features: [\"gte_v8.16.0\"]\n+      reason: \"deprecation added in 8.16\"\n+      test_runner_features: warnings\n+\n   - do:\n       search:\n         index: test\n@@ -353,6 +388,9 @@ setup:\n               rank_constant: 1\n           size: 3\n           explain: true\n+      warnings:\n+        - \"Deprecated field [rank] used, replaced by [retriever]\"\n+        - \"Deprecated field [sub_searches] used, replaced by [retriever]\"\n \n   - match: { hits.hits.0._id: \"3\" }\n   - match: { hits.hits.1._id: \"2\" }\ndiff --git a/x-pack/plugin/rank-rrf/src/yamlRestTest/resources/rest-api-spec/test/rrf/600_rrf_retriever_profile.yml b/x-pack/plugin/rank-rrf/src/yamlRestTest/resources/rest-api-spec/test/rrf/600_rrf_retriever_profile.yml\nindex e3488541..0093a98d 100644\n--- a/x-pack/plugin/rank-rrf/src/yamlRestTest/resources/rest-api-spec/test/rrf/600_rrf_retriever_profile.yml\n+++ b/x-pack/plugin/rank-rrf/src/yamlRestTest/resources/rest-api-spec/test/rrf/600_rrf_retriever_profile.yml\n@@ -172,6 +172,11 @@ setup:\n ---\n \"using query and dfs knn search\":\n \n+  - requires:\n+      cluster_features: [\"gte_v8.16.0\"]\n+      reason: \"deprecation added in 8.16\"\n+      test_runner_features: warnings\n+\n   - do:\n       search:\n         index: test\n@@ -198,6 +203,8 @@ setup:\n           }\n           size: 3\n           profile: true\n+      warnings:\n+        - \"Deprecated field [rank] used, replaced by [retriever]\"\n \n   - match: { hits.hits.0._id: \"3\" }\n   - match: { hits.hits.1._id: \"2\" }",
  "logs_path": "auggie/sonnet4.5/a9463435/elastic_elasticsearch_pr114950/logs.jsonl",
  "errors": [],
  "edit_run_id": "a9463435",
  "test_label": "v0"
}