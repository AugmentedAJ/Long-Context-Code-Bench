{
  "repo_url": "https://github.com/elastic/elasticsearch.git",
  "pr_number": 114869,
  "base_commit": "2aec12c17383de5da35664d9160904b668944364",
  "runner": "auggie",
  "model": "sonnet4.5",
  "timeout_s": 1800,
  "status": "success",
  "elapsed_ms": 292719,
  "patch_unified": "diff --git a/qa/smoke-test-http/src/javaRestTest/java/org/elasticsearch/http/IncrementalBulkRestIT.java b/qa/smoke-test-http/src/javaRestTest/java/org/elasticsearch/http/IncrementalBulkRestIT.java\ndeleted file mode 100644\nindex da050116..00000000\n--- a/qa/smoke-test-http/src/javaRestTest/java/org/elasticsearch/http/IncrementalBulkRestIT.java\n+++ /dev/null\n@@ -1,201 +0,0 @@\n-/*\n- * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n- * or more contributor license agreements. Licensed under the \"Elastic License\n- * 2.0\", the \"GNU Affero General Public License v3.0 only\", and the \"Server Side\n- * Public License v 1\"; you may not use this file except in compliance with, at\n- * your election, the \"Elastic License 2.0\", the \"GNU Affero General Public\n- * License v3.0 only\", or the \"Server Side Public License, v 1\".\n- */\n-\n-package org.elasticsearch.http;\n-\n-import org.elasticsearch.action.bulk.IncrementalBulkService;\n-import org.elasticsearch.client.Request;\n-import org.elasticsearch.client.Response;\n-import org.elasticsearch.client.ResponseException;\n-import org.elasticsearch.common.settings.Settings;\n-import org.elasticsearch.common.xcontent.XContentHelper;\n-import org.elasticsearch.test.ESIntegTestCase;\n-import org.elasticsearch.xcontent.json.JsonXContent;\n-\n-import java.io.IOException;\n-import java.util.List;\n-import java.util.Map;\n-\n-import static org.elasticsearch.rest.RestStatus.OK;\n-import static org.hamcrest.CoreMatchers.containsString;\n-import static org.hamcrest.Matchers.equalTo;\n-\n-@ESIntegTestCase.ClusterScope(scope = ESIntegTestCase.Scope.SUITE, supportsDedicatedMasters = false, numDataNodes = 2, numClientNodes = 0)\n-public class IncrementalBulkRestIT extends HttpSmokeTestCase {\n-\n-    @Override\n-    protected Settings nodeSettings(int nodeOrdinal, Settings otherSettings) {\n-        return Settings.builder()\n-            .put(super.nodeSettings(nodeOrdinal, otherSettings))\n-            .put(IncrementalBulkService.INCREMENTAL_BULK.getKey(), true)\n-            .build();\n-    }\n-\n-    public void testBulkUriMatchingDoesNotMatchBulkCapabilitiesApi() throws IOException {\n-        Request request = new Request(\"GET\", \"/_capabilities?method=GET&path=%2F_bulk&capabilities=failure_store_status&pretty\");\n-        Response response = getRestClient().performRequest(request);\n-        assertEquals(200, response.getStatusLine().getStatusCode());\n-    }\n-\n-    public void testBulkMissingBody() throws IOException {\n-        Request request = new Request(randomBoolean() ? \"POST\" : \"PUT\", \"/_bulk\");\n-        request.setJsonEntity(\"\");\n-        ResponseException responseException = expectThrows(ResponseException.class, () -> getRestClient().performRequest(request));\n-        assertEquals(400, responseException.getResponse().getStatusLine().getStatusCode());\n-        assertThat(responseException.getMessage(), containsString(\"request body is required\"));\n-    }\n-\n-    public void testBulkRequestBodyImproperlyTerminated() throws IOException {\n-        Request request = new Request(randomBoolean() ? \"POST\" : \"PUT\", \"/_bulk\");\n-        // missing final line of the bulk body. cannot process\n-        request.setJsonEntity(\n-            \"{\\\"index\\\":{\\\"_index\\\":\\\"index_name\\\",\\\"_id\\\":\\\"1\\\"}}\\n\"\n-                + \"{\\\"field\\\":1}\\n\"\n-                + \"{\\\"index\\\":{\\\"_index\\\":\\\"index_name\\\",\\\"_id\\\":\\\"2\\\"}\"\n-        );\n-        ResponseException responseException = expectThrows(ResponseException.class, () -> getRestClient().performRequest(request));\n-        assertEquals(400, responseException.getResponse().getStatusLine().getStatusCode());\n-        assertThat(responseException.getMessage(), containsString(\"could not parse bulk request body\"));\n-    }\n-\n-    public void testIncrementalBulk() throws IOException {\n-        Request createRequest = new Request(\"PUT\", \"/index_name\");\n-        createRequest.setJsonEntity(\"\"\"\n-            {\n-              \"settings\": {\n-                \"index\": {\n-                  \"number_of_shards\": 1,\n-                  \"number_of_replicas\": 1,\n-                  \"write.wait_for_active_shards\": 2\n-                }\n-              }\n-            }\"\"\");\n-        final Response indexCreatedResponse = getRestClient().performRequest(createRequest);\n-        assertThat(indexCreatedResponse.getStatusLine().getStatusCode(), equalTo(OK.getStatus()));\n-\n-        Request firstBulkRequest = new Request(\"POST\", \"/index_name/_bulk\");\n-\n-        // index documents for the rollup job\n-        String bulkBody = \"{\\\"index\\\":{\\\"_index\\\":\\\"index_name\\\",\\\"_id\\\":\\\"1\\\"}}\\n\"\n-            + \"{\\\"field\\\":1}\\n\"\n-            + \"{\\\"index\\\":{\\\"_index\\\":\\\"index_name\\\",\\\"_id\\\":\\\"2\\\"}}\\n\"\n-            + \"{\\\"field\\\":1}\\n\"\n-            + \"\\r\\n\";\n-\n-        firstBulkRequest.setJsonEntity(bulkBody);\n-\n-        final Response indexSuccessFul = getRestClient().performRequest(firstBulkRequest);\n-        assertThat(indexSuccessFul.getStatusLine().getStatusCode(), equalTo(OK.getStatus()));\n-\n-        sendLargeBulk();\n-    }\n-\n-    public void testBulkWithIncrementalDisabled() throws IOException {\n-        Request createRequest = new Request(\"PUT\", \"/index_name\");\n-        createRequest.setJsonEntity(\"\"\"\n-            {\n-              \"settings\": {\n-                \"index\": {\n-                  \"number_of_shards\": 1,\n-                  \"number_of_replicas\": 1,\n-                  \"write.wait_for_active_shards\": 2\n-                }\n-              }\n-            }\"\"\");\n-        final Response indexCreatedResponse = getRestClient().performRequest(createRequest);\n-        assertThat(indexCreatedResponse.getStatusLine().getStatusCode(), equalTo(OK.getStatus()));\n-\n-        Request firstBulkRequest = new Request(\"POST\", \"/index_name/_bulk\");\n-\n-        // index documents for the rollup job\n-        String bulkBody = \"{\\\"index\\\":{\\\"_index\\\":\\\"index_name\\\",\\\"_id\\\":\\\"1\\\"}}\\n\"\n-            + \"{\\\"field\\\":1}\\n\"\n-            + \"{\\\"index\\\":{\\\"_index\\\":\\\"index_name\\\",\\\"_id\\\":\\\"2\\\"}}\\n\"\n-            + \"{\\\"field\\\":1}\\n\"\n-            + \"\\r\\n\";\n-\n-        firstBulkRequest.setJsonEntity(bulkBody);\n-\n-        final Response indexSuccessFul = getRestClient().performRequest(firstBulkRequest);\n-        assertThat(indexSuccessFul.getStatusLine().getStatusCode(), equalTo(OK.getStatus()));\n-\n-        updateClusterSettings(Settings.builder().put(IncrementalBulkService.INCREMENTAL_BULK.getKey(), false));\n-\n-        internalCluster().getInstances(IncrementalBulkService.class).forEach(i -> i.setForTests(false));\n-\n-        try {\n-            sendLargeBulk();\n-        } finally {\n-            internalCluster().getInstances(IncrementalBulkService.class).forEach(i -> i.setForTests(true));\n-            updateClusterSettings(Settings.builder().put(IncrementalBulkService.INCREMENTAL_BULK.getKey(), (String) null));\n-        }\n-    }\n-\n-    public void testIncrementalMalformed() throws IOException {\n-        Request createRequest = new Request(\"PUT\", \"/index_name\");\n-        createRequest.setJsonEntity(\"\"\"\n-            {\n-              \"settings\": {\n-                \"index\": {\n-                  \"number_of_shards\": 1,\n-                  \"number_of_replicas\": 1,\n-                  \"write.wait_for_active_shards\": 2\n-                }\n-              }\n-            }\"\"\");\n-        final Response indexCreatedResponse = getRestClient().performRequest(createRequest);\n-        assertThat(indexCreatedResponse.getStatusLine().getStatusCode(), equalTo(OK.getStatus()));\n-\n-        Request bulkRequest = new Request(\"POST\", \"/index_name/_bulk\");\n-\n-        // index documents for the rollup job\n-        final StringBuilder bulk = new StringBuilder();\n-        bulk.append(\"{\\\"index\\\":{\\\"_index\\\":\\\"index_name\\\"}}\\n\");\n-        bulk.append(\"{\\\"field\\\":1}\\n\");\n-        bulk.append(\"{}\\n\");\n-        bulk.append(\"\\r\\n\");\n-\n-        bulkRequest.setJsonEntity(bulk.toString());\n-\n-        expectThrows(ResponseException.class, () -> getRestClient().performRequest(bulkRequest));\n-    }\n-\n-    @SuppressWarnings(\"unchecked\")\n-    private static void sendLargeBulk() throws IOException {\n-        Request bulkRequest = new Request(\"POST\", \"/index_name/_bulk\");\n-\n-        // index documents for the rollup job\n-        final StringBuilder bulk = new StringBuilder();\n-        bulk.append(\"{\\\"delete\\\":{\\\"_index\\\":\\\"index_name\\\",\\\"_id\\\":\\\"1\\\"}}\\n\");\n-        int updates = 0;\n-        for (int i = 0; i < 1000; i++) {\n-            bulk.append(\"{\\\"index\\\":{\\\"_index\\\":\\\"index_name\\\"}}\\n\");\n-            bulk.append(\"{\\\"field\\\":\").append(i).append(\"}\\n\");\n-            if (randomBoolean() && randomBoolean() && randomBoolean() && randomBoolean()) {\n-                ++updates;\n-                bulk.append(\"{\\\"update\\\":{\\\"_index\\\":\\\"index_name\\\",\\\"_id\\\":\\\"2\\\"}}\\n\");\n-                bulk.append(\"{\\\"doc\\\":{\\\"field\\\":\").append(i).append(\"}}\\n\");\n-            }\n-        }\n-        bulk.append(\"\\r\\n\");\n-\n-        bulkRequest.setJsonEntity(bulk.toString());\n-\n-        final Response bulkResponse = getRestClient().performRequest(bulkRequest);\n-        assertThat(bulkResponse.getStatusLine().getStatusCode(), equalTo(OK.getStatus()));\n-        Map<String, Object> responseMap = XContentHelper.convertToMap(\n-            JsonXContent.jsonXContent,\n-            bulkResponse.getEntity().getContent(),\n-            true\n-        );\n-\n-        assertFalse((Boolean) responseMap.get(\"errors\"));\n-        assertThat(((List<Object>) responseMap.get(\"items\")).size(), equalTo(1001 + updates));\n-    }\n-}\ndiff --git a/server/src/main/java/org/elasticsearch/rest/action/document/RestBulkAction.java b/server/src/main/java/org/elasticsearch/rest/action/document/RestBulkAction.java\nindex 03694c74..c8e693df 100644\n--- a/server/src/main/java/org/elasticsearch/rest/action/document/RestBulkAction.java\n+++ b/server/src/main/java/org/elasticsearch/rest/action/document/RestBulkAction.java\n@@ -104,19 +104,23 @@ public class RestBulkAction extends BaseRestHandler {\n             boolean defaultRequireDataStream = request.paramAsBoolean(DocWriteRequest.REQUIRE_DATA_STREAM, false);\n             bulkRequest.timeout(request.paramAsTime(\"timeout\", BulkShardRequest.DEFAULT_TIMEOUT));\n             bulkRequest.setRefreshPolicy(request.param(\"refresh\"));\n-            bulkRequest.add(\n-                request.requiredContent(),\n-                defaultIndex,\n-                defaultRouting,\n-                defaultFetchSourceContext,\n-                defaultPipeline,\n-                defaultRequireAlias,\n-                defaultRequireDataStream,\n-                defaultListExecutedPipelines,\n-                allowExplicitIndex,\n-                request.getXContentType(),\n-                request.getRestApiVersion()\n-            );\n+            try {\n+                bulkRequest.add(\n+                    request.requiredContent(),\n+                    defaultIndex,\n+                    defaultRouting,\n+                    defaultFetchSourceContext,\n+                    defaultPipeline,\n+                    defaultRequireAlias,\n+                    defaultRequireDataStream,\n+                    defaultListExecutedPipelines,\n+                    allowExplicitIndex,\n+                    request.getXContentType(),\n+                    request.getRestApiVersion()\n+                );\n+            } catch (Exception e) {\n+                throw new ElasticsearchParseException(\"could not parse bulk request body\", e);\n+            }\n \n             return channel -> client.bulk(bulkRequest, new RestRefCountedChunkedToXContentListener<>(channel));\n         } else {",
  "logs_path": "auggie/sonnet4.5/a9463435/elastic_elasticsearch_pr114869/logs.jsonl",
  "errors": [],
  "edit_run_id": "a9463435",
  "test_label": "v0"
}