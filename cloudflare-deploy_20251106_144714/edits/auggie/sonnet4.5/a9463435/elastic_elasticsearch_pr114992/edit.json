{
  "repo_url": "https://github.com/elastic/elasticsearch.git",
  "pr_number": 114992,
  "base_commit": "cf9687f56de49bf5f07152b70b388d3f971aa9a5",
  "runner": "auggie",
  "model": "sonnet4.5",
  "timeout_s": 1800,
  "status": "success",
  "elapsed_ms": 1563126,
  "patch_unified": "diff --git a/server/src/main/java/org/elasticsearch/action/support/IndicesOptions.java b/server/src/main/java/org/elasticsearch/action/support/IndicesOptions.java\nindex 85889d83..21cc5a16 100644\n--- a/server/src/main/java/org/elasticsearch/action/support/IndicesOptions.java\n+++ b/server/src/main/java/org/elasticsearch/action/support/IndicesOptions.java\n@@ -325,6 +325,7 @@ public record IndicesOptions(\n      * @param allowAliasToMultipleIndices, allow aliases to multiple indices, true by default.\n      * @param allowClosedIndices, allow closed indices, true by default.\n      * @param allowFailureIndices, allow failure indices in the response, true by default\n+     * @param allowSelectors, allow selector syntax (::data, ::failures, ::*) in index expressions, true by default\n      * @param ignoreThrottled, filters out throttled (aka frozen indices), defaults to true. This is deprecated and the only one\n      *                         that only filters and never throws an error.\n      */\n@@ -332,11 +333,12 @@ public record IndicesOptions(\n         boolean allowAliasToMultipleIndices,\n         boolean allowClosedIndices,\n         boolean allowFailureIndices,\n+        boolean allowSelectors,\n         @Deprecated boolean ignoreThrottled\n     ) implements ToXContentFragment {\n \n         public static final String IGNORE_THROTTLED = \"ignore_throttled\";\n-        public static final GatekeeperOptions DEFAULT = new GatekeeperOptions(true, true, true, false);\n+        public static final GatekeeperOptions DEFAULT = new GatekeeperOptions(true, true, true, true, false);\n \n         public static GatekeeperOptions parseParameter(Object ignoreThrottled, GatekeeperOptions defaultOptions) {\n             if (ignoreThrottled == null && defaultOptions != null) {\n@@ -356,6 +358,7 @@ public record IndicesOptions(\n             private boolean allowAliasToMultipleIndices;\n             private boolean allowClosedIndices;\n             private boolean allowFailureIndices;\n+            private boolean allowSelectors;\n             private boolean ignoreThrottled;\n \n             public Builder() {\n@@ -366,6 +369,7 @@ public record IndicesOptions(\n                 allowAliasToMultipleIndices = options.allowAliasToMultipleIndices;\n                 allowClosedIndices = options.allowClosedIndices;\n                 allowFailureIndices = options.allowFailureIndices;\n+                allowSelectors = options.allowSelectors;\n                 ignoreThrottled = options.ignoreThrottled;\n             }\n \n@@ -396,6 +400,15 @@ public record IndicesOptions(\n                 return this;\n             }\n \n+            /**\n+             * Selector syntax (::data, ::failures, ::*) is accepted when true, otherwise the resolution will throw an error.\n+             * Defaults to true.\n+             */\n+            public Builder allowSelectors(boolean allowSelectors) {\n+                this.allowSelectors = allowSelectors;\n+                return this;\n+            }\n+\n             /**\n              * Throttled indices will not be included in the result. Defaults to false.\n              */\n@@ -405,7 +418,7 @@ public record IndicesOptions(\n             }\n \n             public GatekeeperOptions build() {\n-                return new GatekeeperOptions(allowAliasToMultipleIndices, allowClosedIndices, allowFailureIndices, ignoreThrottled);\n+                return new GatekeeperOptions(allowAliasToMultipleIndices, allowClosedIndices, allowFailureIndices, allowSelectors, ignoreThrottled);\n             }\n         }\n \n@@ -586,6 +599,7 @@ public record IndicesOptions(\n                 .allowAliasToMultipleIndices(true)\n                 .allowClosedIndices(true)\n                 .allowFailureIndices(false)\n+                .allowSelectors(false)\n                 .ignoreThrottled(false)\n         )\n         .build();\n@@ -651,6 +665,7 @@ public record IndicesOptions(\n                 .allowAliasToMultipleIndices(true)\n                 .allowClosedIndices(true)\n                 .allowFailureIndices(false)\n+                .allowSelectors(false)\n                 .ignoreThrottled(false)\n         )\n         .build();\n@@ -697,6 +712,7 @@ public record IndicesOptions(\n                 .allowAliasToMultipleIndices(true)\n                 .allowClosedIndices(true)\n                 .allowFailureIndices(false)\n+                .allowSelectors(false)\n                 .ignoreThrottled(false)\n         )\n         .build();\n@@ -909,6 +925,13 @@ public record IndicesOptions(\n         return gatekeeperOptions.allowFailureIndices();\n     }\n \n+    /**\n+     * @return whether selectors are allowed in index expressions\n+     */\n+    public boolean allowSelectors() {\n+        return gatekeeperOptions.allowSelectors();\n+    }\n+\n     /**\n      * @return whether aliases pointing to multiple indices are allowed\n      */\ndiff --git a/server/src/main/java/org/elasticsearch/cluster/metadata/IndexNameExpressionResolver.java b/server/src/main/java/org/elasticsearch/cluster/metadata/IndexNameExpressionResolver.java\nindex 279243ee..5c68d995 100644\n--- a/server/src/main/java/org/elasticsearch/cluster/metadata/IndexNameExpressionResolver.java\n+++ b/server/src/main/java/org/elasticsearch/cluster/metadata/IndexNameExpressionResolver.java\n@@ -286,6 +286,23 @@ public class IndexNameExpressionResolver {\n             boolean isExclusion = wildcardSeen && originalExpression.startsWith(\"-\");\n             String baseExpression = isExclusion ? originalExpression.substring(1) : originalExpression;\n \n+            // Parse and validate selector syntax\n+            IndexExpression indexExpression = IndexExpression.parse(baseExpression);\n+            if (indexExpression.hasSelector()) {\n+                // Check if selectors are allowed\n+                if (context.getOptions().allowSelectors() == false) {\n+                    throw new IllegalArgumentException(\n+                        \"Index expression [\"\n+                            + baseExpression\n+                            + \"] contains a selector [\"\n+                            + indexExpression.selector().getKey()\n+                            + \"], but selectors are not allowed for this operation\"\n+                    );\n+                }\n+                // Strip the selector from the expression for further processing\n+                baseExpression = indexExpression.name();\n+            }\n+\n             // Resolve date math\n             baseExpression = DateMathExpressionResolver.resolveExpression(baseExpression, context::getStartTime);\n \ndiff --git a/server/src/test/java/org/elasticsearch/action/support/IndicesOptionsTests.java b/server/src/test/java/org/elasticsearch/action/support/IndicesOptionsTests.java\nindex de7b43ad..fcd56be3 100644\n--- a/server/src/test/java/org/elasticsearch/action/support/IndicesOptionsTests.java\n+++ b/server/src/test/java/org/elasticsearch/action/support/IndicesOptionsTests.java\n@@ -341,7 +341,7 @@ public class IndicesOptionsTests extends ESTestCase {\n             randomBoolean(),\n             randomBoolean()\n         );\n-        GatekeeperOptions gatekeeperOptions = new GatekeeperOptions(randomBoolean(), randomBoolean(), randomBoolean(), randomBoolean());\n+        GatekeeperOptions gatekeeperOptions = new GatekeeperOptions(randomBoolean(), randomBoolean(), randomBoolean(), randomBoolean(), randomBoolean());\n         IndicesOptions.SelectorOptions selectorOptions = new IndicesOptions.SelectorOptions(randomFrom(IndexComponentSelector.values()));\n \n         IndicesOptions indicesOptions = new IndicesOptions(concreteTargetOptions, wildcardOptions, gatekeeperOptions, selectorOptions);\ndiff --git a/server/src/test/java/org/elasticsearch/cluster/metadata/IndexNameExpressionResolverTests.java b/server/src/test/java/org/elasticsearch/cluster/metadata/IndexNameExpressionResolverTests.java\nindex 30895767..a4235b42 100644\n--- a/server/src/test/java/org/elasticsearch/cluster/metadata/IndexNameExpressionResolverTests.java\n+++ b/server/src/test/java/org/elasticsearch/cluster/metadata/IndexNameExpressionResolverTests.java\n@@ -3423,6 +3423,60 @@ public class IndexNameExpressionResolverTests extends ESTestCase {\n         );\n     }\n \n+    public void testSelectorSyntaxValidation() {\n+        final String dataStreamName = \"my-data-stream\";\n+        IndexMetadata index1 = createBackingIndex(dataStreamName, 1, epochMillis).build();\n+        IndexMetadata index2 = createBackingIndex(dataStreamName, 2, epochMillis).build();\n+        IndexMetadata failureIndex1 = createFailureStore(dataStreamName, 1, epochMillis).build();\n+        IndexMetadata failureIndex2 = createFailureStore(dataStreamName, 2, epochMillis).build();\n+\n+        Metadata.Builder mdBuilder = Metadata.builder()\n+            .put(index1, false)\n+            .put(index2, false)\n+            .put(failureIndex1, false)\n+            .put(failureIndex2, false)\n+            .put(\n+                newInstance(\n+                    dataStreamName,\n+                    List.of(index1.getIndex(), index2.getIndex()),\n+                    List.of(failureIndex1.getIndex(), failureIndex2.getIndex())\n+                )\n+            );\n+\n+        ClusterState state = ClusterState.builder(new ClusterName(\"_name\")).metadata(mdBuilder).build();\n+\n+        // Test that selectors are rejected when allowSelectors is false\n+        {\n+            IndicesOptions indicesOptions = IndicesOptions.LENIENT_EXPAND_OPEN_NO_SELECTORS;\n+            IllegalArgumentException e = expectThrows(\n+                IllegalArgumentException.class,\n+                () -> indexNameExpressionResolver.concreteIndices(state, indicesOptions, true, \"my-data-stream::data\")\n+            );\n+            assertThat(e.getMessage(), containsString(\"selectors are not allowed\"));\n+        }\n+\n+        // Test that selectors are accepted when allowSelectors is true\n+        {\n+            IndicesOptions indicesOptions = IndicesOptions.builder(IndicesOptions.STRICT_EXPAND_OPEN)\n+                .gatekeeperOptions(IndicesOptions.GatekeeperOptions.builder().allowSelectors(true).build())\n+                .build();\n+            // This should not throw an exception\n+            Index[] result = indexNameExpressionResolver.concreteIndices(state, indicesOptions, true, \"my-data-stream::data\");\n+            assertThat(result, notNullValue());\n+            assertThat(result.length, equalTo(2));\n+        }\n+\n+        // Test that wildcard expressions with selectors are rejected when allowSelectors is false\n+        {\n+            IndicesOptions indicesOptions = IndicesOptions.LENIENT_EXPAND_OPEN_NO_SELECTORS;\n+            IllegalArgumentException e = expectThrows(\n+                IllegalArgumentException.class,\n+                () -> indexNameExpressionResolver.concreteIndices(state, indicesOptions, true, \"my-*::failures\")\n+            );\n+            assertThat(e.getMessage(), containsString(\"selectors are not allowed\"));\n+        }\n+    }\n+\n     public static IndexMetadata.Builder indexBuilder(String index) {\n         return indexBuilder(index, Settings.EMPTY);\n     }",
  "logs_path": "auggie/sonnet4.5/a9463435/elastic_elasticsearch_pr114992/logs.jsonl",
  "errors": [],
  "edit_run_id": "a9463435",
  "test_label": "v0"
}