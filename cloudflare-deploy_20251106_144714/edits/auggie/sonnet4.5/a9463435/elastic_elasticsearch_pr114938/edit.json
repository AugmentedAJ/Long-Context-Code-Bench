{
  "repo_url": "https://github.com/elastic/elasticsearch.git",
  "pr_number": 114938,
  "base_commit": "54e3bdb61708ff64337c16964bdc667126fb83f0",
  "runner": "auggie",
  "model": "sonnet4.5",
  "timeout_s": 1800,
  "status": "success",
  "elapsed_ms": 725076,
  "patch_unified": "diff --git a/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/enrich/EnrichPolicyResolver.java b/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/enrich/EnrichPolicyResolver.java\nindex 447df099..50c1d841 100644\n--- a/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/enrich/EnrichPolicyResolver.java\n+++ b/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/enrich/EnrichPolicyResolver.java\n@@ -257,24 +257,19 @@ public class EnrichPolicyResolver {\n             // remote clusters\n             if (remotePolicies.isEmpty() == false) {\n                 for (String cluster : remoteClusters) {\n-                    final Transport.Connection connection;\n-                    try {\n-                        connection = getRemoteConnection(cluster);\n-                    } catch (Exception e) {\n-                        refs.acquire().onFailure(e);\n-                        return;\n-                    }\n-                    transportService.sendRequest(\n-                        connection,\n-                        RESOLVE_ACTION_NAME,\n-                        new LookupRequest(cluster, remotePolicies),\n-                        TransportRequestOptions.EMPTY,\n-                        new ActionListenerResponseHandler<>(\n-                            refs.acquire(resp -> lookupResponses.put(cluster, resp)),\n-                            LookupResponse::new,\n-                            threadPool.executor(ThreadPool.Names.SEARCH)\n-                        )\n-                    );\n+                    getRemoteConnection(cluster, refs.acquire(connection -> {\n+                        transportService.sendRequest(\n+                            connection,\n+                            RESOLVE_ACTION_NAME,\n+                            new LookupRequest(cluster, remotePolicies),\n+                            TransportRequestOptions.EMPTY,\n+                            new ActionListenerResponseHandler<>(\n+                                refs.acquire(resp -> lookupResponses.put(cluster, resp)),\n+                                LookupResponse::new,\n+                                threadPool.executor(ThreadPool.Names.SEARCH)\n+                            )\n+                        );\n+                    }));\n                 }\n             }\n             // local cluster\n@@ -389,8 +384,13 @@ public class EnrichPolicyResolver {\n         return metadata == null ? Map.of() : metadata.getPolicies();\n     }\n \n-    protected Transport.Connection getRemoteConnection(String cluster) {\n-        return transportService.getRemoteClusterService().getConnection(cluster);\n+    protected void getRemoteConnection(String cluster, ActionListener<Transport.Connection> listener) {\n+        transportService.getRemoteClusterService()\n+            .maybeEnsureConnectedAndGetConnection(\n+                cluster,\n+                transportService.getRemoteClusterService().isSkipUnavailable(cluster) == false,\n+                listener\n+            );\n     }\n \n     public Map<String, List<String>> groupIndicesPerCluster(String[] indices) {\ndiff --git a/x-pack/plugin/esql/src/test/java/org/elasticsearch/xpack/esql/enrich/EnrichPolicyResolverTests.java b/x-pack/plugin/esql/src/test/java/org/elasticsearch/xpack/esql/enrich/EnrichPolicyResolverTests.java\nindex 05a7486a..8885a7fc 100644\n--- a/x-pack/plugin/esql/src/test/java/org/elasticsearch/xpack/esql/enrich/EnrichPolicyResolverTests.java\n+++ b/x-pack/plugin/esql/src/test/java/org/elasticsearch/xpack/esql/enrich/EnrichPolicyResolverTests.java\n@@ -446,9 +446,12 @@ public class EnrichPolicyResolverTests extends ESTestCase {\n         }\n \n         @Override\n-        protected Transport.Connection getRemoteConnection(String remoteCluster) {\n+        protected void getRemoteConnection(String remoteCluster, ActionListener<Transport.Connection> listener) {\n             assertThat(\"Must only called on the local cluster\", cluster, equalTo(LOCAL_CLUSTER_GROUP_KEY));\n-            return transports.get(\"\").getConnection(transports.get(remoteCluster).getLocalNode());\n+            ActionListener.completeWith(\n+                listener,\n+                () -> transports.get(\"\").getConnection(transports.get(remoteCluster).getLocalNode())\n+            );\n         }\n \n         static ClusterService mockClusterService(Map<String, EnrichPolicy> policies) {",
  "logs_path": "auggie/sonnet4.5/a9463435/elastic_elasticsearch_pr114938/logs.jsonl",
  "errors": [],
  "edit_run_id": "a9463435",
  "test_label": "v0"
}