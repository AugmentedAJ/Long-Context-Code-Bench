{
  "repo_url": "https://github.com/elastic/elasticsearch.git",
  "pr_number": 114872,
  "base_commit": "52587d6abfc8768b5930fe313c6241d9b9f25334",
  "runner": "claude-code",
  "model": "claude-sonnet-4-5",
  "timeout_s": 1200,
  "status": "success",
  "elapsed_ms": 287670,
  "patch_unified": "diff --git a/modules/ingest-geoip/src/main/java/org/elasticsearch/ingest/geoip/EnterpriseGeoIpDownloader.java b/modules/ingest-geoip/src/main/java/org/elasticsearch/ingest/geoip/EnterpriseGeoIpDownloader.java\nindex 3bbb0539..52c0966f 100644\n--- a/modules/ingest-geoip/src/main/java/org/elasticsearch/ingest/geoip/EnterpriseGeoIpDownloader.java\n+++ b/modules/ingest-geoip/src/main/java/org/elasticsearch/ingest/geoip/EnterpriseGeoIpDownloader.java\n@@ -57,6 +57,7 @@ import java.util.function.Supplier;\n import java.util.regex.Pattern;\n import java.util.stream.Collectors;\n \n+import static org.elasticsearch.ingest.geoip.EnterpriseGeoIpDownloaderTaskExecutor.IPINFO_SETTINGS_PREFIX;\n import static org.elasticsearch.ingest.geoip.EnterpriseGeoIpDownloaderTaskExecutor.MAXMIND_SETTINGS_PREFIX;\n \n /**\n@@ -80,6 +81,11 @@ public class EnterpriseGeoIpDownloader extends AllocatedPersistentTask {\n     // n.b. a future enhancement might be to allow for a MAXMIND_ENDPOINT_SETTING, but\n     // at the moment this is an unsupported system property for use in tests (only)\n \n+    static String DEFAULT_IPINFO_ENDPOINT = System.getProperty(\n+        IPINFO_SETTINGS_PREFIX + \"endpoint.default\",\n+        \"https://ipinfo.io\"\n+    );\n+\n     static final String DATABASES_INDEX = \".geoip_databases\";\n     static final int MAX_CHUNK_SIZE = 1024 * 1024;\n \n@@ -449,8 +455,7 @@ public class EnterpriseGeoIpDownloader extends AllocatedPersistentTask {\n         if (database.provider() instanceof DatabaseConfiguration.Maxmind) {\n             return new MaxmindDownload(database.name(), (DatabaseConfiguration.Maxmind) database.provider());\n         } else if (database.provider() instanceof DatabaseConfiguration.Ipinfo) {\n-            // as a temporary implementation detail, null here means 'not actually supported *just yet*'\n-            return null;\n+            return new IpinfoDownload(database.name(), (DatabaseConfiguration.Ipinfo) database.provider());\n         } else {\n             assert false : \"Attempted to use database downloader with unsupported provider type [\" + database.provider().getClass() + \"]\";\n             return null;\n@@ -533,6 +538,78 @@ public class EnterpriseGeoIpDownloader extends AllocatedPersistentTask {\n         }\n     }\n \n+    class IpinfoDownload implements ProviderDownload {\n+\n+        final String name;\n+        final DatabaseConfiguration.Ipinfo ipinfo;\n+        HttpClient.PasswordAuthenticationHolder auth;\n+\n+        IpinfoDownload(String name, DatabaseConfiguration.Ipinfo ipinfo) {\n+            this.name = name;\n+            this.ipinfo = ipinfo;\n+            this.auth = buildCredentials();\n+        }\n+\n+        @Override\n+        public HttpClient.PasswordAuthenticationHolder buildCredentials() {\n+            // IPinfo uses token-based authentication\n+            // the token is passed as the password with a dummy username\n+            final char[] tokenChars = tokenProvider.apply(\"ipinfo\");\n+            if (tokenChars == null || tokenChars.length == 0) {\n+                return null;\n+            }\n+\n+            // IPinfo API uses token authentication - the token can be used as a password with any username\n+            return new HttpClient.PasswordAuthenticationHolder(\"token\", tokenChars);\n+        }\n+\n+        @Override\n+        public boolean validCredentials() {\n+            return auth.get() != null;\n+        }\n+\n+        @Override\n+        public String url(String suffix) {\n+            String endpointPattern = DEFAULT_IPINFO_ENDPOINT;\n+            if (endpointPattern.contains(\"%\")) {\n+                throw new IllegalArgumentException(\"Invalid endpoint [\" + endpointPattern + \"]\");\n+            }\n+            if (endpointPattern.endsWith(\"/\") == false) {\n+                endpointPattern += \"/\";\n+            }\n+            endpointPattern += \"data/%s?%s\";\n+\n+            // at this point the pattern looks like this (in the default case):\n+            // https://ipinfo.io/data/%s?%s\n+\n+            return Strings.format(endpointPattern, name, suffix);\n+        }\n+\n+        @Override\n+        public Checksum checksum() throws IOException {\n+            final String sha256Url = this.url(\"checksum=sha256\");\n+            var result = new String(httpClient.getBytes(auth.get(), sha256Url), StandardCharsets.UTF_8).trim();\n+            var matcher = SHA256_CHECKSUM_PATTERN.matcher(result);\n+            boolean match = matcher.matches();\n+            if (match == false) {\n+                throw new RuntimeException(\"Unexpected sha256 response from [\" + sha256Url + \"]\");\n+            }\n+            final String sha256 = matcher.group(1);\n+            return Checksum.sha256(sha256);\n+        }\n+\n+        @Override\n+        public CheckedSupplier<InputStream, IOException> download() {\n+            final String downloadUrl = this.url(\"\");\n+            return () -> httpClient.get(auth.get(), downloadUrl);\n+        }\n+\n+        @Override\n+        public void close() throws IOException {\n+            auth.close();\n+        }\n+    }\n+\n     interface ProviderDownload extends Closeable {\n         // note: buildCredentials and url are inherently just implementation details of checksum() and download(),\n         // but it's useful to have unit tests for this logic and to keep it separate\ndiff --git a/modules/ingest-geoip/src/main/java/org/elasticsearch/ingest/geoip/EnterpriseGeoIpDownloaderTaskExecutor.java b/modules/ingest-geoip/src/main/java/org/elasticsearch/ingest/geoip/EnterpriseGeoIpDownloaderTaskExecutor.java\nindex 5214c0e4..c4a1c1a3 100644\n--- a/modules/ingest-geoip/src/main/java/org/elasticsearch/ingest/geoip/EnterpriseGeoIpDownloaderTaskExecutor.java\n+++ b/modules/ingest-geoip/src/main/java/org/elasticsearch/ingest/geoip/EnterpriseGeoIpDownloaderTaskExecutor.java\n@@ -53,12 +53,18 @@ public class EnterpriseGeoIpDownloaderTaskExecutor extends PersistentTasksExecut\n     private static final Logger logger = LogManager.getLogger(EnterpriseGeoIpDownloader.class);\n \n     static final String MAXMIND_SETTINGS_PREFIX = \"ingest.geoip.downloader.maxmind.\";\n+    static final String IPINFO_SETTINGS_PREFIX = \"ingest.geoip.downloader.ipinfo.\";\n \n     public static final Setting<SecureString> MAXMIND_LICENSE_KEY_SETTING = SecureSetting.secureString(\n         MAXMIND_SETTINGS_PREFIX + \"license_key\",\n         null\n     );\n \n+    public static final Setting<SecureString> IPINFO_TOKEN_SETTING = SecureSetting.secureString(\n+        IPINFO_SETTINGS_PREFIX + \"token\",\n+        null\n+    );\n+\n     private final Client client;\n     private final HttpClient httpClient;\n     private final ClusterService clusterService;\n@@ -106,6 +112,10 @@ public class EnterpriseGeoIpDownloaderTaskExecutor extends PersistentTasksExecut\n             if (cachedSecureSettings.getSettingNames().contains(MAXMIND_LICENSE_KEY_SETTING.getKey())) {\n                 token = cachedSecureSettings.getString(MAXMIND_LICENSE_KEY_SETTING.getKey()).getChars();\n             }\n+        } else if (type.equals(\"ipinfo\")) {\n+            if (cachedSecureSettings.getSettingNames().contains(IPINFO_TOKEN_SETTING.getKey())) {\n+                token = cachedSecureSettings.getString(IPINFO_TOKEN_SETTING.getKey()).getChars();\n+            }\n         }\n         return token;\n     }\ndiff --git a/modules/ingest-geoip/src/main/java/org/elasticsearch/ingest/geoip/IngestGeoIpPlugin.java b/modules/ingest-geoip/src/main/java/org/elasticsearch/ingest/geoip/IngestGeoIpPlugin.java\nindex cc0bec58..3107f0be 100644\n--- a/modules/ingest-geoip/src/main/java/org/elasticsearch/ingest/geoip/IngestGeoIpPlugin.java\n+++ b/modules/ingest-geoip/src/main/java/org/elasticsearch/ingest/geoip/IngestGeoIpPlugin.java\n@@ -112,7 +112,8 @@ public class IngestGeoIpPlugin extends Plugin\n             GeoIpDownloaderTaskExecutor.ENABLED_SETTING,\n             GeoIpDownloader.ENDPOINT_SETTING,\n             GeoIpDownloaderTaskExecutor.POLL_INTERVAL_SETTING,\n-            EnterpriseGeoIpDownloaderTaskExecutor.MAXMIND_LICENSE_KEY_SETTING\n+            EnterpriseGeoIpDownloaderTaskExecutor.MAXMIND_LICENSE_KEY_SETTING,\n+            EnterpriseGeoIpDownloaderTaskExecutor.IPINFO_TOKEN_SETTING\n         );\n     }\n ",
  "logs_path": "claude-code/claude-sonnet-4-5/c7a3f90a/elastic_elasticsearch_pr114872/logs.jsonl",
  "errors": [],
  "edit_run_id": "c7a3f90a",
  "test_label": "v0"
}