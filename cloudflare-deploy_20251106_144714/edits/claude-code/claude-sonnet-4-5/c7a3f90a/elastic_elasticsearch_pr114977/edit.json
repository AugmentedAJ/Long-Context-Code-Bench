{
  "repo_url": "https://github.com/elastic/elasticsearch.git",
  "pr_number": 114977,
  "base_commit": "91e1e02edcd877e7b347156f5f9ef39e62bce211",
  "runner": "claude-code",
  "model": "claude-sonnet-4-5",
  "timeout_s": 1200,
  "status": "success",
  "elapsed_ms": 341508,
  "patch_unified": "diff --git a/x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/MachineLearning.java b/x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/MachineLearning.java\nindex 6d21654f..7dadcd1f 100644\n--- a/x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/MachineLearning.java\n+++ b/x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/MachineLearning.java\n@@ -51,6 +51,7 @@ import org.elasticsearch.index.analysis.CharFilterFactory;\n import org.elasticsearch.index.analysis.TokenizerFactory;\n import org.elasticsearch.index.query.QueryBuilder;\n import org.elasticsearch.indices.AssociatedIndexDescriptor;\n+import org.elasticsearch.indices.SystemIndices;\n import org.elasticsearch.indices.SystemIndexDescriptor;\n import org.elasticsearch.indices.analysis.AnalysisModule.AnalysisProvider;\n import org.elasticsearch.indices.breaker.BreakerSettings;\n@@ -2008,6 +2009,57 @@ public class MachineLearning extends Plugin\n             .build();\n     }\n \n+    /**\n+     * Returns system index descriptors excluding the inference index.\n+     * This is used during feature reset to temporarily ignore the inference index.\n+     * TODO: Remove this workaround once we figure out where the inference index is being created in tests.\n+     * Relates to https://github.com/elastic/elasticsearch/issues/114748\n+     */\n+    private Collection<SystemIndexDescriptor> getSystemIndexDescriptorsForFeatureReset(Settings settings) {\n+        return List.of(\n+            SystemIndexDescriptor.builder()\n+                .setIndexPattern(MlMetaIndex.indexName() + \"*\")\n+                .setPrimaryIndex(MlMetaIndex.indexName())\n+                .setDescription(\"Contains scheduling and anomaly tracking metadata\")\n+                .setMappings(MlMetaIndex.mapping())\n+                .setSettings(MlMetaIndex.settings())\n+                .setVersionMetaKey(\"version\")\n+                .setOrigin(ML_ORIGIN)\n+                .build(),\n+            SystemIndexDescriptor.builder()\n+                .setIndexPattern(MlConfigIndex.indexName() + \"*\")\n+                .setPrimaryIndex(MlConfigIndex.indexName())\n+                .setDescription(\"Contains ML configuration data\")\n+                .setMappings(MlConfigIndex.mapping())\n+                .setSettings(MlConfigIndex.settings())\n+                .setVersionMetaKey(\"version\")\n+                .setOrigin(ML_ORIGIN)\n+                .build()\n+            // Temporarily excluding inference index descriptor\n+        );\n+    }\n+\n+    /**\n+     * Performs cleanup of ML system indices, excluding the inference index.\n+     * This is a workaround to temporarily ignore the inference index during feature reset.\n+     * TODO: Remove this workaround once we figure out where the inference index is being created in tests.\n+     * Relates to https://github.com/elastic/elasticsearch/issues/114748\n+     */\n+    private void cleanUpFeatureExcludingInferenceIndex(\n+        ClusterService clusterService,\n+        Client client,\n+        ActionListener<ResetFeatureStateResponse.ResetFeatureStateStatus> listener\n+    ) {\n+        SystemIndices.Feature.cleanUpFeature(\n+            getSystemIndexDescriptorsForFeatureReset(clusterService.getSettings()),\n+            getAssociatedIndexDescriptors(),\n+            getFeatureName(),\n+            clusterService,\n+            client,\n+            listener\n+        );\n+    }\n+\n     @Override\n     public void prepareForIndicesMigration(ClusterService clusterService, Client client, ActionListener<Map<String, Object>> listener) {\n         boolean isAlreadyInUpgradeMode = MlMetadata.getMlMetadata(clusterService.state()).isUpgradeMode();\n@@ -2106,8 +2158,8 @@ public class MachineLearning extends Plugin\n     ) {\n         if (this.enabled == false) {\n             // if ML is disabled, the custom cleanup can fail, but we can still clean up indices\n-            // by calling the superclass cleanup method\n-            SystemIndexPlugin.super.cleanUpFeature(clusterService, unwrappedClient, finalListener);\n+            // by calling the cleanup method that excludes the inference index\n+            cleanUpFeatureExcludingInferenceIndex(clusterService, unwrappedClient, finalListener);\n             return;\n         }\n         logger.info(\"Starting machine learning feature reset\");\n@@ -2154,20 +2206,20 @@ public class MachineLearning extends Plugin\n                         memoryTracker.get()\n                             .awaitAndClear(\n                                 ActionListener.wrap(\n-                                    cacheCleared -> SystemIndexPlugin.super.cleanUpFeature(clusterService, client, delegate),\n+                                    cacheCleared -> cleanUpFeatureExcludingInferenceIndex(clusterService, client, delegate),\n                                     clearFailed -> {\n                                         logger.error(\n                                             \"failed to clear memory tracker cache via machine learning reset feature API\",\n                                             clearFailed\n                                         );\n-                                        SystemIndexPlugin.super.cleanUpFeature(clusterService, client, delegate);\n+                                        cleanUpFeatureExcludingInferenceIndex(clusterService, client, delegate);\n                                     }\n                                 )\n                             );\n                         return;\n                     }\n                     // Call into the original listener to clean up the indices and then clear ml memory cache\n-                    SystemIndexPlugin.super.cleanUpFeature(clusterService, client, delegate);\n+                    cleanUpFeatureExcludingInferenceIndex(clusterService, client, delegate);\n                 } else {\n                     final List<String> failedComponents = results.entrySet()\n                         .stream()",
  "logs_path": "claude-code/claude-sonnet-4-5/c7a3f90a/elastic_elasticsearch_pr114977/logs.jsonl",
  "errors": [],
  "edit_run_id": "c7a3f90a",
  "test_label": "v0"
}