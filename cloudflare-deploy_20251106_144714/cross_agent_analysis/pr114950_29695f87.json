{
  "repo_url": "https://github.com/elastic/elasticsearch.git",
  "pr_number": 114950,
  "base_commit": "0648ab8920bba04ae691fa1a74c73a1981c9a14d",
  "head_commit": "89ef29e8f13982b8ea3009156ee76bc73a444943",
  "task_instructions": "You are working on a codebase. Your task is to make the necessary code changes to accomplish the following:\n\n[8.x] Adding deprecation warnings for rank and sub_searches (#114854)\n\nBackports the following commits to 8.x:\n - Adding deprecation warnings for rank and sub_searches (#114854)\n\nPlease make all necessary code changes to complete this task.",
  "ground_truth_diff": "diff --git a/docs/changelog/114854.yaml b/docs/changelog/114854.yaml\nnew file mode 100644\nindex 000000000000..144a10ba8504\n--- /dev/null\n+++ b/docs/changelog/114854.yaml\n@@ -0,0 +1,10 @@\n+pr: 114854\n+summary: Adding deprecation warnings for rrf using rank and `sub_searches`\n+area: Search\n+type: deprecation\n+issues: []\n+deprecation:\n+  title: Adding deprecation warnings for rrf using rank and `sub_searches`\n+  area: REST API\n+  details: Search API parameter `sub_searches` will no longer be a supported and will be removed in future releases. Similarly, `rrf` can only be used through the specified `retriever` and no longer though the `rank` parameter\n+  impact: Requests specifying rrf through `rank` and/or `sub_searches` elements will be disallowed in a future version. Users should instead utilize the new `retriever` parameter.\ndiff --git a/modules/reindex/src/test/java/org/elasticsearch/reindex/BulkByScrollParallelizationHelperTests.java b/modules/reindex/src/test/java/org/elasticsearch/reindex/BulkByScrollParallelizationHelperTests.java\nindex a6e28477f858..ebb4471566fb 100644\n--- a/modules/reindex/src/test/java/org/elasticsearch/reindex/BulkByScrollParallelizationHelperTests.java\n+++ b/modules/reindex/src/test/java/org/elasticsearch/reindex/BulkByScrollParallelizationHelperTests.java\n@@ -15,8 +15,8 @@ import org.elasticsearch.search.builder.SearchSourceBuilder;\n import org.elasticsearch.test.ESTestCase;\n \n import java.io.IOException;\n+import java.util.Collections;\n \n-import static java.util.Collections.emptyList;\n import static org.elasticsearch.reindex.BulkByScrollParallelizationHelper.sliceIntoSubRequests;\n import static org.elasticsearch.search.RandomSearchRequestGenerator.randomSearchRequest;\n import static org.elasticsearch.search.RandomSearchRequestGenerator.randomSearchSourceBuilder;\n@@ -24,7 +24,7 @@ import static org.elasticsearch.search.RandomSearchRequestGenerator.randomSearch\n public class BulkByScrollParallelizationHelperTests extends ESTestCase {\n     public void testSliceIntoSubRequests() throws IOException {\n         SearchRequest searchRequest = randomSearchRequest(\n-            () -> randomSearchSourceBuilder(() -> null, () -> null, () -> null, () -> null, () -> emptyList(), () -> null, () -> null)\n+            () -> randomSearchSourceBuilder(() -> null, () -> null, () -> null, Collections::emptyList, () -> null, () -> null)\n         );\n         if (searchRequest.source() != null) {\n             // Clear the slice builder if there is one set. We can't call sliceIntoSubRequests if it is.\ndiff --git a/server/src/main/java/org/elasticsearch/search/builder/SearchSourceBuilder.java b/server/src/main/java/org/elasticsearch/search/builder/SearchSourceBuilder.java\nindex cce4e0b592ba..2d76d76466c1 100644\n--- a/server/src/main/java/org/elasticsearch/search/builder/SearchSourceBuilder.java\n+++ b/server/src/main/java/org/elasticsearch/search/builder/SearchSourceBuilder.java\n@@ -99,10 +99,10 @@ public final class SearchSourceBuilder implements Writeable, ToXContentObject, R\n     public static final ParseField TIMEOUT_FIELD = new ParseField(\"timeout\");\n     public static final ParseField TERMINATE_AFTER_FIELD = new ParseField(\"terminate_after\");\n     public static final ParseField QUERY_FIELD = new ParseField(\"query\");\n-    public static final ParseField SUB_SEARCHES_FIELD = new ParseField(\"sub_searches\");\n+    public static final ParseField SUB_SEARCHES_FIELD = new ParseField(\"sub_searches\").withAllDeprecated(\"retriever\");\n+    public static final ParseField RANK_FIELD = new ParseField(\"rank\").withAllDeprecated(\"retriever\");\n     public static final ParseField POST_FILTER_FIELD = new ParseField(\"post_filter\");\n     public static final ParseField KNN_FIELD = new ParseField(\"knn\");\n-    public static final ParseField RANK_FIELD = new ParseField(\"rank\");\n     public static final ParseField MIN_SCORE_FIELD = new ParseField(\"min_score\");\n     public static final ParseField VERSION_FIELD = new ParseField(\"version\");\n     public static final ParseField SEQ_NO_PRIMARY_TERM_FIELD = new ParseField(\"seq_no_primary_term\");\ndiff --git a/server/src/test/java/org/elasticsearch/search/AbstractSearchTestCase.java b/server/src/test/java/org/elasticsearch/search/AbstractSearchTestCase.java\nindex b716f11b5fff..88c83df3e20f 100644\n--- a/server/src/test/java/org/elasticsearch/search/AbstractSearchTestCase.java\n+++ b/server/src/test/java/org/elasticsearch/search/AbstractSearchTestCase.java\n@@ -89,7 +89,6 @@ public abstract class AbstractSearchTestCase extends ESTestCase {\n         return RandomSearchRequestGenerator.randomSearchSourceBuilder(\n             HighlightBuilderTests::randomHighlighterBuilder,\n             SuggestBuilderTests::randomSuggestBuilder,\n-            TestRankBuilder::randomRankBuilder,\n             QueryRescorerBuilderTests::randomRescoreBuilder,\n             randomExtBuilders,\n             CollapseBuilderTests::randomCollapseBuilder,\ndiff --git a/server/src/test/java/org/elasticsearch/search/vectors/KnnSearchRequestParserTests.java b/server/src/test/java/org/elasticsearch/search/vectors/KnnSearchRequestParserTests.java\nindex d9fe421bafb4..4e4d2158a957 100644\n--- a/server/src/test/java/org/elasticsearch/search/vectors/KnnSearchRequestParserTests.java\n+++ b/server/src/test/java/org/elasticsearch/search/vectors/KnnSearchRequestParserTests.java\n@@ -74,7 +74,6 @@ public class KnnSearchRequestParserTests extends ESTestCase {\n             () -> null,\n             () -> null,\n             () -> null,\n-            () -> null,\n             Collections::emptyList,\n             () -> null,\n             () -> null\ndiff --git a/test/framework/src/main/java/org/elasticsearch/search/RandomSearchRequestGenerator.java b/test/framework/src/main/java/org/elasticsearch/search/RandomSearchRequestGenerator.java\nindex b59f1a5e5f02..363d34ca3ff8 100644\n--- a/test/framework/src/main/java/org/elasticsearch/search/RandomSearchRequestGenerator.java\n+++ b/test/framework/src/main/java/org/elasticsearch/search/RandomSearchRequestGenerator.java\n@@ -23,13 +23,11 @@ import org.elasticsearch.script.ScriptType;\n import org.elasticsearch.search.aggregations.AggregationBuilders;\n import org.elasticsearch.search.builder.PointInTimeBuilder;\n import org.elasticsearch.search.builder.SearchSourceBuilder;\n-import org.elasticsearch.search.builder.SubSearchSourceBuilder;\n import org.elasticsearch.search.collapse.CollapseBuilder;\n import org.elasticsearch.search.fetch.subphase.FetchSourceContext;\n import org.elasticsearch.search.fetch.subphase.FieldAndFormat;\n import org.elasticsearch.search.fetch.subphase.highlight.HighlightBuilder;\n import org.elasticsearch.search.internal.SearchContext;\n-import org.elasticsearch.search.rank.RankBuilder;\n import org.elasticsearch.search.rescore.RescorerBuilder;\n import org.elasticsearch.search.searchafter.SearchAfterBuilder;\n import org.elasticsearch.search.slice.SliceBuilder;\n@@ -122,7 +120,6 @@ public class RandomSearchRequestGenerator {\n     public static SearchSourceBuilder randomSearchSourceBuilder(\n         Supplier<HighlightBuilder> randomHighlightBuilder,\n         Supplier<SuggestBuilder> randomSuggestBuilder,\n-        Supplier<RankBuilder> rankContextBuilderSupplier,\n         Supplier<RescorerBuilder<?>> randomRescoreBuilder,\n         Supplier<List<SearchExtBuilder>> randomExtBuilders,\n         Supplier<CollapseBuilder> randomCollapseBuilder,\n@@ -250,17 +247,6 @@ public class RandomSearchRequestGenerator {\n         }\n         if (randomBoolean()) {\n             builder.query(QueryBuilders.termQuery(randomAlphaOfLengthBetween(5, 20), randomAlphaOfLengthBetween(5, 20)));\n-        } else if (randomBoolean()) {\n-            builder.subSearches(\n-                List.of(\n-                    new SubSearchSourceBuilder(\n-                        QueryBuilders.termQuery(randomAlphaOfLengthBetween(5, 20), randomAlphaOfLengthBetween(5, 20))\n-                    ),\n-                    new SubSearchSourceBuilder(\n-                        QueryBuilders.termQuery(randomAlphaOfLengthBetween(5, 20), randomAlphaOfLengthBetween(5, 20))\n-                    )\n-                )\n-            );\n         }\n         if (randomBoolean()) {\n             builder.postFilter(QueryBuilders.termQuery(randomAlphaOfLengthBetween(5, 20), randomAlphaOfLengthBetween(5, 20)));\n@@ -354,9 +340,6 @@ public class RandomSearchRequestGenerator {\n         if (randomBoolean()) {\n             builder.suggest(randomSuggestBuilder.get());\n         }\n-        if (randomBoolean()) {\n-            builder.rankBuilder(rankContextBuilderSupplier.get());\n-        }\n         if (randomBoolean()) {\n             int numRescores = randomIntBetween(1, 5);\n             for (int i = 0; i < numRescores; i++) {\ndiff --git a/x-pack/plugin/rank-rrf/src/main/java/org/elasticsearch/xpack/rank/rrf/RRFRankBuilder.java b/x-pack/plugin/rank-rrf/src/main/java/org/elasticsearch/xpack/rank/rrf/RRFRankBuilder.java\nindex 10aff2f4d68c..fb20f834937d 100644\n--- a/x-pack/plugin/rank-rrf/src/main/java/org/elasticsearch/xpack/rank/rrf/RRFRankBuilder.java\n+++ b/x-pack/plugin/rank-rrf/src/main/java/org/elasticsearch/xpack/rank/rrf/RRFRankBuilder.java\n@@ -36,16 +36,17 @@ import static org.elasticsearch.xcontent.ConstructingObjectParser.optionalConstr\n \n /**\n  * The builder to support RRF. Adds user-defined parameters for window size and rank constant.\n+ *\n+ * @deprecated RRF support is provided through the retriever framework. Please use {@link RRFRetrieverBuilder instead}\n  */\n+@Deprecated\n public class RRFRankBuilder extends RankBuilder {\n \n-    public static final int DEFAULT_RANK_CONSTANT = 60;\n-\n     public static final ParseField RANK_CONSTANT_FIELD = new ParseField(\"rank_constant\");\n \n     static final ConstructingObjectParser<RRFRankBuilder, Void> PARSER = new ConstructingObjectParser<>(RRFRankPlugin.NAME, args -> {\n         int windowSize = args[0] == null ? DEFAULT_RANK_WINDOW_SIZE : (int) args[0];\n-        int rankConstant = args[1] == null ? DEFAULT_RANK_CONSTANT : (int) args[1];\n+        int rankConstant = args[1] == null ? RRFRetrieverBuilder.DEFAULT_RANK_CONSTANT : (int) args[1];\n         return new RRFRankBuilder(windowSize, rankConstant);\n     });\n \ndiff --git a/x-pack/plugin/rank-rrf/src/main/java/org/elasticsearch/xpack/rank/rrf/RRFRankDoc.java b/x-pack/plugin/rank-rrf/src/main/java/org/elasticsearch/xpack/rank/rrf/RRFRankDoc.java\nindex 272df248e53e..4cd10801b298 100644\n--- a/x-pack/plugin/rank-rrf/src/main/java/org/elasticsearch/xpack/rank/rrf/RRFRankDoc.java\n+++ b/x-pack/plugin/rank-rrf/src/main/java/org/elasticsearch/xpack/rank/rrf/RRFRankDoc.java\n@@ -19,7 +19,7 @@ import java.io.IOException;\n import java.util.Arrays;\n import java.util.Objects;\n \n-import static org.elasticsearch.xpack.rank.rrf.RRFRankBuilder.DEFAULT_RANK_CONSTANT;\n+import static org.elasticsearch.xpack.rank.rrf.RRFRetrieverBuilder.DEFAULT_RANK_CONSTANT;\n \n /**\n  * {@code RRFRankDoc} supports additional ranking information\ndiff --git a/x-pack/plugin/rank-rrf/src/main/java/org/elasticsearch/xpack/rank/rrf/RRFRetrieverBuilder.java b/x-pack/plugin/rank-rrf/src/main/java/org/elasticsearch/xpack/rank/rrf/RRFRetrieverBuilder.java\nindex 12c43a2f169f..c3c9f19cde6e 100644\n--- a/x-pack/plugin/rank-rrf/src/main/java/org/elasticsearch/xpack/rank/rrf/RRFRetrieverBuilder.java\n+++ b/x-pack/plugin/rank-rrf/src/main/java/org/elasticsearch/xpack/rank/rrf/RRFRetrieverBuilder.java\n@@ -12,6 +12,7 @@ import org.elasticsearch.common.ParsingException;\n import org.elasticsearch.common.util.Maps;\n import org.elasticsearch.features.NodeFeature;\n import org.elasticsearch.license.LicenseUtils;\n+import org.elasticsearch.search.rank.RankBuilder;\n import org.elasticsearch.search.rank.RankDoc;\n import org.elasticsearch.search.retriever.CompoundRetrieverBuilder;\n import org.elasticsearch.search.retriever.RetrieverBuilder;\n@@ -31,7 +32,6 @@ import java.util.Objects;\n \n import static org.elasticsearch.xcontent.ConstructingObjectParser.constructorArg;\n import static org.elasticsearch.xcontent.ConstructingObjectParser.optionalConstructorArg;\n-import static org.elasticsearch.xpack.rank.rrf.RRFRankPlugin.NAME;\n \n /**\n  * An rrf retriever is used to represent an rrf rank element, but\n@@ -50,6 +50,7 @@ public final class RRFRetrieverBuilder extends CompoundRetrieverBuilder<RRFRetri\n     public static final ParseField RANK_WINDOW_SIZE_FIELD = new ParseField(\"rank_window_size\");\n     public static final ParseField RANK_CONSTANT_FIELD = new ParseField(\"rank_constant\");\n \n+    public static final int DEFAULT_RANK_CONSTANT = 60;\n     @SuppressWarnings(\"unchecked\")\n     static final ConstructingObjectParser<RRFRetrieverBuilder, RetrieverParserContext> PARSER = new ConstructingObjectParser<>(\n         NAME,\n@@ -57,8 +58,8 @@ public final class RRFRetrieverBuilder extends CompoundRetrieverBuilder<RRFRetri\n         args -> {\n             List<RetrieverBuilder> childRetrievers = (List<RetrieverBuilder>) args[0];\n             List<RetrieverSource> innerRetrievers = childRetrievers.stream().map(r -> new RetrieverSource(r, null)).toList();\n-            int rankWindowSize = args[1] == null ? RRFRankBuilder.DEFAULT_RANK_WINDOW_SIZE : (int) args[1];\n-            int rankConstant = args[2] == null ? RRFRankBuilder.DEFAULT_RANK_CONSTANT : (int) args[2];\n+            int rankWindowSize = args[1] == null ? RankBuilder.DEFAULT_RANK_WINDOW_SIZE : (int) args[1];\n+            int rankConstant = args[2] == null ? DEFAULT_RANK_CONSTANT : (int) args[2];\n             return new RRFRetrieverBuilder(innerRetrievers, rankWindowSize, rankConstant);\n         }\n     );\ndiff --git a/x-pack/plugin/rank-rrf/src/test/java/org/elasticsearch/xpack/rank/rrf/RRFRetrieverBuilderParsingTests.java b/x-pack/plugin/rank-rrf/src/test/java/org/elasticsearch/xpack/rank/rrf/RRFRetrieverBuilderParsingTests.java\nindex d324effe41c2..cae758457a2a 100644\n--- a/x-pack/plugin/rank-rrf/src/test/java/org/elasticsearch/xpack/rank/rrf/RRFRetrieverBuilderParsingTests.java\n+++ b/x-pack/plugin/rank-rrf/src/test/java/org/elasticsearch/xpack/rank/rrf/RRFRetrieverBuilderParsingTests.java\n@@ -41,7 +41,7 @@ public class RRFRetrieverBuilderParsingTests extends AbstractXContentTestCase<RR\n         if (randomBoolean()) {\n             rankWindowSize = randomIntBetween(1, 10000);\n         }\n-        int rankConstant = RRFRankBuilder.DEFAULT_RANK_CONSTANT;\n+        int rankConstant = RRFRetrieverBuilder.DEFAULT_RANK_CONSTANT;\n         if (randomBoolean()) {\n             rankConstant = randomIntBetween(1, 1000000);\n         }\ndiff --git a/x-pack/plugin/rank-rrf/src/yamlRestTest/resources/rest-api-spec/test/rrf/100_rank_rrf.yml b/x-pack/plugin/rank-rrf/src/yamlRestTest/resources/rest-api-spec/test/rrf/100_rank_rrf.yml\nindex 647540644ce9..a5c346b38699 100644\n--- a/x-pack/plugin/rank-rrf/src/yamlRestTest/resources/rest-api-spec/test/rrf/100_rank_rrf.yml\n+++ b/x-pack/plugin/rank-rrf/src/yamlRestTest/resources/rest-api-spec/test/rrf/100_rank_rrf.yml\n@@ -2,6 +2,8 @@ setup:\n   - requires:\n       cluster_features: \"gte_v8.8.0\"\n       reason: 'rank added in 8.8'\n+  - skip:\n+      features: \"warnings\"\n \n   - do:\n       indices.create:\n@@ -59,7 +61,14 @@ setup:\n ---\n \"Simple rank with bm25 search and kNN search\":\n \n+  - requires:\n+      cluster_features: [\"gte_v8.16.0\"]\n+      reason: \"deprecation added in 8.16\"\n+      test_runner_features: warnings\n+\n   - do:\n+      warnings:\n+        - \"Deprecated field [rank] used, replaced by [retriever]\"\n       search:\n         index: test\n         body:\n@@ -94,7 +103,15 @@ setup:\n ---\n \"Simple rank with multiple bm25 sub searches\":\n \n+  - requires:\n+      cluster_features: [\"gte_v8.16.0\"]\n+      reason: \"deprecation added in 8.16\"\n+      test_runner_features: warnings\n+\n   - do:\n+      warnings:\n+        - \"Deprecated field [rank] used, replaced by [retriever]\"\n+        - Deprecated field [sub_searches] used, replaced by [retriever]\n       search:\n         index: test\n         body:\n@@ -135,7 +152,15 @@ setup:\n ---\n \"Simple rank with multiple bm25 sub_searches and a knn search\":\n \n+  - requires:\n+      cluster_features: [\"gte_v8.16.0\"]\n+      reason: \"deprecation added in 8.16\"\n+      test_runner_features: warnings\n+\n   - do:\n+      warnings:\n+        - \"Deprecated field [rank] used, replaced by [retriever]\"\n+        - Deprecated field [sub_searches] used, replaced by [retriever]\n       search:\n         index: test\n         body:\ndiff --git a/x-pack/plugin/rank-rrf/src/yamlRestTest/resources/rest-api-spec/test/rrf/150_rank_rrf_pagination.yml b/x-pack/plugin/rank-rrf/src/yamlRestTest/resources/rest-api-spec/test/rrf/150_rank_rrf_pagination.yml\nindex b4893bfec084..94a1457a7acc 100644\n--- a/x-pack/plugin/rank-rrf/src/yamlRestTest/resources/rest-api-spec/test/rrf/150_rank_rrf_pagination.yml\n+++ b/x-pack/plugin/rank-rrf/src/yamlRestTest/resources/rest-api-spec/test/rrf/150_rank_rrf_pagination.yml\n@@ -63,7 +63,15 @@ setup:\n ---\n \"Standard pagination within rank_window_size\":\n   # this test retrieves the same results from two queries, and applies a simple pagination skipping the first result\n+  - requires:\n+      cluster_features: [ \"gte_v8.16.0\" ]\n+      reason: \"deprecation added in 8.16\"\n+      test_runner_features: warnings\n+\n   - do:\n+      warnings:\n+        - \"Deprecated field [rank] used, replaced by [retriever]\"\n+        - Deprecated field [sub_searches] used, replaced by [retriever]\n       search:\n         index: test\n         body:\n@@ -170,7 +178,15 @@ setup:\n ---\n \"Standard pagination outside rank_window_size\":\n   # in this example, from starts *after* rank_window_size so, we expect 0 results to be returned\n+  - requires:\n+      cluster_features: [ \"gte_v8.16.0\" ]\n+      reason: \"deprecation added in 8.16\"\n+      test_runner_features: warnings\n+\n   - do:\n+      warnings:\n+        - \"Deprecated field [rank] used, replaced by [retriever]\"\n+        - Deprecated field [sub_searches] used, replaced by [retriever]\n       search:\n         index: test\n         body:\n@@ -274,7 +290,15 @@ setup:\n ---\n \"Standard pagination partially outside rank_window_size\":\n   # in this example we have that from starts *within* rank_window_size, but \"from + size\" goes over\n+  - requires:\n+      cluster_features: [ \"gte_v8.16.0\" ]\n+      reason: \"deprecation added in 8.16\"\n+      test_runner_features: warnings\n+\n   - do:\n+      warnings:\n+        - \"Deprecated field [rank] used, replaced by [retriever]\"\n+        - Deprecated field [sub_searches] used, replaced by [retriever]\n       search:\n         index: test\n         body:\n@@ -384,7 +408,15 @@ setup:\n   # queryA has a result set of [1, 2, 3, 4] and\n   # queryB has a result set of [4, 3, 1, 2]\n   # so for rank_constant=10, the expected order is [1, 4, 3, 2]\n+  - requires:\n+      cluster_features: [\"gte_v8.16.0\"]\n+      reason: \"deprecation added in 8.16\"\n+      test_runner_features: warnings\n+\n   - do:\n+      warnings:\n+        - \"Deprecated field [rank] used, replaced by [retriever]\"\n+        - Deprecated field [sub_searches] used, replaced by [retriever]\n       search:\n         index: test\n         body:\n@@ -488,6 +520,9 @@ setup:\n   - match: { hits.hits.1._id: \"4\" }\n \n   - do:\n+      warnings:\n+        - \"Deprecated field [rank] used, replaced by [retriever]\"\n+        - Deprecated field [sub_searches] used, replaced by [retriever]\n       search:\n         index: test\n         body:\n@@ -597,7 +632,15 @@ setup:\n   # queryA has a result set of [5, 1] and\n   # queryB has a result set of [4, 3, 1, 2]\n   # so for rank_constant=10, the expected order is [1, 5, 4, 3, 2]\n+  - requires:\n+      cluster_features: [\"gte_v8.16.0\"]\n+      reason: \"deprecation added in 8.16\"\n+      test_runner_features: warnings\n+\n   - do:\n+      warnings:\n+        - \"Deprecated field [rank] used, replaced by [retriever]\"\n+        - Deprecated field [sub_searches] used, replaced by [retriever]\n       search:\n         index: test\n         body:\n@@ -685,6 +728,9 @@ setup:\n   - match: { hits.hits.1._id: \"5\" }\n \n   - do:\n+      warnings:\n+        - \"Deprecated field [rank] used, replaced by [retriever]\"\n+        - Deprecated field [sub_searches] used, replaced by [retriever]\n       search:\n         index: test\n         body:\n@@ -772,6 +818,9 @@ setup:\n   - match: { hits.hits.1._id: \"3\" }\n \n   - do:\n+      warnings:\n+        - \"Deprecated field [rank] used, replaced by [retriever]\"\n+        - Deprecated field [sub_searches] used, replaced by [retriever]\n       search:\n         index: test\n         body:\n@@ -867,7 +916,15 @@ setup:\n   # queryB has a result set of [4, 3]\n   # so for rank_constant=10, the expected order is [5, 4, 1, 3],\n   # and the rank_window_size-sized result set that we'd paginate over is [5, 4]\n+  - requires:\n+      cluster_features: [\"gte_v8.16.0\"]\n+      reason: \"deprecation added in 8.16\"\n+      test_runner_features: warnings\n+\n   - do:\n+      warnings:\n+        - \"Deprecated field [rank] used, replaced by [retriever]\"\n+        - Deprecated field [sub_searches] used, replaced by [retriever]\n       search:\n         index: test\n         body:\n@@ -955,6 +1012,10 @@ setup:\n   - match: { hits.hits.1._id: \"4\" }\n \n   - do:\n+      warnings:\n+        - \"Deprecated field [rank] used, replaced by [retriever]\"\n+        - Deprecated field [sub_searches] used, replaced by [retriever]\n+\n       search:\n         index: test\n         body:\ndiff --git a/x-pack/plugin/rank-rrf/src/yamlRestTest/resources/rest-api-spec/test/rrf/200_rank_rrf_script.yml b/x-pack/plugin/rank-rrf/src/yamlRestTest/resources/rest-api-spec/test/rrf/200_rank_rrf_script.yml\nindex bca39dea4ae5..36e70581f39f 100644\n--- a/x-pack/plugin/rank-rrf/src/yamlRestTest/resources/rest-api-spec/test/rrf/200_rank_rrf_script.yml\n+++ b/x-pack/plugin/rank-rrf/src/yamlRestTest/resources/rest-api-spec/test/rrf/200_rank_rrf_script.yml\n@@ -67,7 +67,14 @@ setup:\n ---\n \"RRF using single knn and single BM25 with a scripted metric aggregation\":\n \n+  - requires:\n+      cluster_features: [\"gte_v8.16.0\"]\n+      reason: \"deprecation added in 8.16\"\n+      test_runner_features: warnings\n+\n   - do:\n+      warnings:\n+        - \"Deprecated field [rank] used, replaced by [retriever]\"\n       search:\n         index: test\n         body:\n@@ -140,7 +147,14 @@ setup:\n ---\n \"RRF using multi-knn only with a scripted metric aggregation\":\n \n+  - requires:\n+      cluster_features: [\"gte_v8.16.0\"]\n+      reason: \"deprecation added in 8.16\"\n+      test_runner_features: warnings\n+\n   - do:\n+      warnings:\n+        - \"Deprecated field [rank] used, replaced by [retriever]\"\n       search:\n         index: test\n         body:\n@@ -195,7 +209,14 @@ setup:\n ---\n \"RRF using multi-knn and single BM25 with a scripted metric aggregation\":\n \n+  - requires:\n+      cluster_features: [\"gte_v8.16.0\"]\n+      reason: \"deprecation added in 8.16\"\n+      test_runner_features: warnings\n+\n   - do:\n+      warnings:\n+        - \"Deprecated field [rank] used, replaced by [retriever]\"\n       search:\n         index: test\n         body:\ndiff --git a/x-pack/plugin/rank-rrf/src/yamlRestTest/resources/rest-api-spec/test/rrf/550_rrf_sub_searches_explain.yml b/x-pack/plugin/rank-rrf/src/yamlRestTest/resources/rest-api-spec/test/rrf/550_rrf_sub_searches_explain.yml\nindex 5718cd345552..1b74ffee62a1 100644\n--- a/x-pack/plugin/rank-rrf/src/yamlRestTest/resources/rest-api-spec/test/rrf/550_rrf_sub_searches_explain.yml\n+++ b/x-pack/plugin/rank-rrf/src/yamlRestTest/resources/rest-api-spec/test/rrf/550_rrf_sub_searches_explain.yml\n@@ -75,7 +75,14 @@ setup:\n ---\n \"using a top level knn and query\":\n \n+  - requires:\n+      cluster_features: [\"gte_v8.16.0\"]\n+      reason: \"deprecation added in 8.16\"\n+      test_runner_features: warnings\n+\n   - do:\n+      warnings:\n+        - \"Deprecated field [rank] used, replaced by [retriever]\"\n       search:\n         index: test\n         body:\n@@ -129,7 +136,15 @@ setup:\n ---\n \"using sub_searches\":\n \n+  - requires:\n+      cluster_features: [ \"gte_v8.16.0\" ]\n+      reason: \"deprecation added in 8.16\"\n+      test_runner_features: warnings\n+\n   - do:\n+      warnings:\n+        - \"Deprecated field [rank] used, replaced by [retriever]\"\n+        - Deprecated field [sub_searches] used, replaced by [retriever]\n       search:\n         index: test\n         body:\n@@ -194,7 +209,14 @@ setup:\n ---\n \"using named top level knn and query\":\n \n+  - requires:\n+      cluster_features: [\"gte_v8.16.0\"]\n+      reason: \"deprecation added in 8.16\"\n+      test_runner_features: warnings\n+\n   - do:\n+      warnings:\n+        - \"Deprecated field [rank] used, replaced by [retriever]\"\n       search:\n         index: test\n         body:\n@@ -251,7 +273,15 @@ setup:\n ---\n \"using named sub_searches\":\n \n+  - requires:\n+      cluster_features: [\"gte_v8.16.0\"]\n+      reason: \"deprecation added in 8.16\"\n+      test_runner_features: warnings\n+\n   - do:\n+      warnings:\n+        - \"Deprecated field [rank] used, replaced by [retriever]\"\n+        - Deprecated field [sub_searches] used, replaced by [retriever]\n       search:\n         index: test\n         body:\n@@ -320,7 +350,15 @@ setup:\n ---\n \"using a mix of named and unnamed queries\":\n \n+  - requires:\n+      cluster_features: [\"gte_v8.16.0\"]\n+      reason: \"deprecation added in 8.16\"\n+      test_runner_features: warnings\n+\n   - do:\n+      warnings:\n+        - \"Deprecated field [rank] used, replaced by [retriever]\"\n+        - Deprecated field [sub_searches] used, replaced by [retriever]\n       search:\n         index: test\n         body:\ndiff --git a/x-pack/plugin/rank-rrf/src/yamlRestTest/resources/rest-api-spec/test/rrf/600_rrf_retriever_profile.yml b/x-pack/plugin/rank-rrf/src/yamlRestTest/resources/rest-api-spec/test/rrf/600_rrf_retriever_profile.yml\nindex e34885419c7f..a9ddb4f90292 100644\n--- a/x-pack/plugin/rank-rrf/src/yamlRestTest/resources/rest-api-spec/test/rrf/600_rrf_retriever_profile.yml\n+++ b/x-pack/plugin/rank-rrf/src/yamlRestTest/resources/rest-api-spec/test/rrf/600_rrf_retriever_profile.yml\n@@ -172,7 +172,14 @@ setup:\n ---\n \"using query and dfs knn search\":\n \n+  - requires:\n+      cluster_features: [\"gte_v8.16.0\"]\n+      reason: \"deprecation added in 8.16\"\n+      test_runner_features: warnings\n+\n   - do:\n+      warnings:\n+        - \"Deprecated field [rank] used, replaced by [retriever]\"\n       search:\n         index: test\n         body:",
  "judge_mode": "comparative",
  "judge_model": "openai/claude-sonnet-4-5-20250929",
  "test_label": "v0",
  "agent_results": [
    {
      "runner": "auggie",
      "model": "sonnet4.5",
      "edit_run_id": "a9463435",
      "status": "success",
      "elapsed_ms": 848143,
      "patch_unified": "diff --git a/modules/reindex/src/test/java/org/elasticsearch/reindex/BulkByScrollParallelizationHelperTests.java b/modules/reindex/src/test/java/org/elasticsearch/reindex/BulkByScrollParallelizationHelperTests.java\nindex a6e28477..888fe64b 100644\n--- a/modules/reindex/src/test/java/org/elasticsearch/reindex/BulkByScrollParallelizationHelperTests.java\n+++ b/modules/reindex/src/test/java/org/elasticsearch/reindex/BulkByScrollParallelizationHelperTests.java\n@@ -24,7 +24,7 @@ import static org.elasticsearch.search.RandomSearchRequestGenerator.randomSearch\n public class BulkByScrollParallelizationHelperTests extends ESTestCase {\n     public void testSliceIntoSubRequests() throws IOException {\n         SearchRequest searchRequest = randomSearchRequest(\n-            () -> randomSearchSourceBuilder(() -> null, () -> null, () -> null, () -> null, () -> emptyList(), () -> null, () -> null)\n+            () -> randomSearchSourceBuilder(() -> null, () -> null, () -> null, () -> emptyList(), () -> null, () -> null)\n         );\n         if (searchRequest.source() != null) {\n             // Clear the slice builder if there is one set. We can't call sliceIntoSubRequests if it is.\ndiff --git a/server/src/main/java/org/elasticsearch/search/builder/SearchSourceBuilder.java b/server/src/main/java/org/elasticsearch/search/builder/SearchSourceBuilder.java\nindex cce4e0b5..2d76d764 100644\n--- a/server/src/main/java/org/elasticsearch/search/builder/SearchSourceBuilder.java\n+++ b/server/src/main/java/org/elasticsearch/search/builder/SearchSourceBuilder.java\n@@ -99,10 +99,10 @@ public final class SearchSourceBuilder implements Writeable, ToXContentObject, R\n     public static final ParseField TIMEOUT_FIELD = new ParseField(\"timeout\");\n     public static final ParseField TERMINATE_AFTER_FIELD = new ParseField(\"terminate_after\");\n     public static final ParseField QUERY_FIELD = new ParseField(\"query\");\n-    public static final ParseField SUB_SEARCHES_FIELD = new ParseField(\"sub_searches\");\n+    public static final ParseField SUB_SEARCHES_FIELD = new ParseField(\"sub_searches\").withAllDeprecated(\"retriever\");\n+    public static final ParseField RANK_FIELD = new ParseField(\"rank\").withAllDeprecated(\"retriever\");\n     public static final ParseField POST_FILTER_FIELD = new ParseField(\"post_filter\");\n     public static final ParseField KNN_FIELD = new ParseField(\"knn\");\n-    public static final ParseField RANK_FIELD = new ParseField(\"rank\");\n     public static final ParseField MIN_SCORE_FIELD = new ParseField(\"min_score\");\n     public static final ParseField VERSION_FIELD = new ParseField(\"version\");\n     public static final ParseField SEQ_NO_PRIMARY_TERM_FIELD = new ParseField(\"seq_no_primary_term\");\ndiff --git a/server/src/test/java/org/elasticsearch/search/AbstractSearchTestCase.java b/server/src/test/java/org/elasticsearch/search/AbstractSearchTestCase.java\nindex b716f11b..88c83df3 100644\n--- a/server/src/test/java/org/elasticsearch/search/AbstractSearchTestCase.java\n+++ b/server/src/test/java/org/elasticsearch/search/AbstractSearchTestCase.java\n@@ -89,7 +89,6 @@ public abstract class AbstractSearchTestCase extends ESTestCase {\n         return RandomSearchRequestGenerator.randomSearchSourceBuilder(\n             HighlightBuilderTests::randomHighlighterBuilder,\n             SuggestBuilderTests::randomSuggestBuilder,\n-            TestRankBuilder::randomRankBuilder,\n             QueryRescorerBuilderTests::randomRescoreBuilder,\n             randomExtBuilders,\n             CollapseBuilderTests::randomCollapseBuilder,\ndiff --git a/server/src/test/java/org/elasticsearch/search/vectors/KnnSearchRequestParserTests.java b/server/src/test/java/org/elasticsearch/search/vectors/KnnSearchRequestParserTests.java\nindex d9fe421b..4e4d2158 100644\n--- a/server/src/test/java/org/elasticsearch/search/vectors/KnnSearchRequestParserTests.java\n+++ b/server/src/test/java/org/elasticsearch/search/vectors/KnnSearchRequestParserTests.java\n@@ -74,7 +74,6 @@ public class KnnSearchRequestParserTests extends ESTestCase {\n             () -> null,\n             () -> null,\n             () -> null,\n-            () -> null,\n             Collections::emptyList,\n             () -> null,\n             () -> null\ndiff --git a/test/framework/src/main/java/org/elasticsearch/search/RandomSearchRequestGenerator.java b/test/framework/src/main/java/org/elasticsearch/search/RandomSearchRequestGenerator.java\nindex b59f1a5e..76b50533 100644\n--- a/test/framework/src/main/java/org/elasticsearch/search/RandomSearchRequestGenerator.java\n+++ b/test/framework/src/main/java/org/elasticsearch/search/RandomSearchRequestGenerator.java\n@@ -29,7 +29,6 @@ import org.elasticsearch.search.fetch.subphase.FetchSourceContext;\n import org.elasticsearch.search.fetch.subphase.FieldAndFormat;\n import org.elasticsearch.search.fetch.subphase.highlight.HighlightBuilder;\n import org.elasticsearch.search.internal.SearchContext;\n-import org.elasticsearch.search.rank.RankBuilder;\n import org.elasticsearch.search.rescore.RescorerBuilder;\n import org.elasticsearch.search.searchafter.SearchAfterBuilder;\n import org.elasticsearch.search.slice.SliceBuilder;\n@@ -122,7 +121,6 @@ public class RandomSearchRequestGenerator {\n     public static SearchSourceBuilder randomSearchSourceBuilder(\n         Supplier<HighlightBuilder> randomHighlightBuilder,\n         Supplier<SuggestBuilder> randomSuggestBuilder,\n-        Supplier<RankBuilder> rankContextBuilderSupplier,\n         Supplier<RescorerBuilder<?>> randomRescoreBuilder,\n         Supplier<List<SearchExtBuilder>> randomExtBuilders,\n         Supplier<CollapseBuilder> randomCollapseBuilder,\n@@ -354,9 +352,6 @@ public class RandomSearchRequestGenerator {\n         if (randomBoolean()) {\n             builder.suggest(randomSuggestBuilder.get());\n         }\n-        if (randomBoolean()) {\n-            builder.rankBuilder(rankContextBuilderSupplier.get());\n-        }\n         if (randomBoolean()) {\n             int numRescores = randomIntBetween(1, 5);\n             for (int i = 0; i < numRescores; i++) {\ndiff --git a/x-pack/plugin/rank-rrf/src/yamlRestTest/resources/rest-api-spec/test/rrf/100_rank_rrf.yml b/x-pack/plugin/rank-rrf/src/yamlRestTest/resources/rest-api-spec/test/rrf/100_rank_rrf.yml\nindex 64754064..3092b00a 100644\n--- a/x-pack/plugin/rank-rrf/src/yamlRestTest/resources/rest-api-spec/test/rrf/100_rank_rrf.yml\n+++ b/x-pack/plugin/rank-rrf/src/yamlRestTest/resources/rest-api-spec/test/rrf/100_rank_rrf.yml\n@@ -2,6 +2,8 @@ setup:\n   - requires:\n       cluster_features: \"gte_v8.8.0\"\n       reason: 'rank added in 8.8'\n+  - skip:\n+      features: \"warnings\"\n \n   - do:\n       indices.create:\n@@ -59,7 +61,14 @@ setup:\n ---\n \"Simple rank with bm25 search and kNN search\":\n \n+  - requires:\n+      cluster_features: [\"gte_v8.16.0\"]\n+      reason: \"deprecation added in 8.16\"\n+      test_runner_features: warnings\n+\n   - do:\n+      warnings:\n+        - \"Deprecated field [rank] used, replaced by [retriever]\"\n       search:\n         index: test\n         body:\n@@ -94,7 +103,15 @@ setup:\n ---\n \"Simple rank with multiple bm25 sub searches\":\n \n+  - requires:\n+      cluster_features: [\"gte_v8.16.0\"]\n+      reason: \"deprecation added in 8.16\"\n+      test_runner_features: warnings\n+\n   - do:\n+      warnings:\n+        - \"Deprecated field [rank] used, replaced by [retriever]\"\n+        - \"Deprecated field [sub_searches] used, replaced by [retriever]\"\n       search:\n         index: test\n         body:\n@@ -135,7 +152,15 @@ setup:\n ---\n \"Simple rank with multiple bm25 sub_searches and a knn search\":\n \n+  - requires:\n+      cluster_features: [\"gte_v8.16.0\"]\n+      reason: \"deprecation added in 8.16\"\n+      test_runner_features: warnings\n+\n   - do:\n+      warnings:\n+        - \"Deprecated field [rank] used, replaced by [retriever]\"\n+        - \"Deprecated field [sub_searches] used, replaced by [retriever]\"\n       search:\n         index: test\n         body:\ndiff --git a/x-pack/plugin/rank-rrf/src/yamlRestTest/resources/rest-api-spec/test/rrf/150_rank_rrf_pagination.yml b/x-pack/plugin/rank-rrf/src/yamlRestTest/resources/rest-api-spec/test/rrf/150_rank_rrf_pagination.yml\nindex b4893bfe..2516ed88 100644\n--- a/x-pack/plugin/rank-rrf/src/yamlRestTest/resources/rest-api-spec/test/rrf/150_rank_rrf_pagination.yml\n+++ b/x-pack/plugin/rank-rrf/src/yamlRestTest/resources/rest-api-spec/test/rrf/150_rank_rrf_pagination.yml\n@@ -63,7 +63,15 @@ setup:\n ---\n \"Standard pagination within rank_window_size\":\n   # this test retrieves the same results from two queries, and applies a simple pagination skipping the first result\n+  - requires:\n+      cluster_features: [\"gte_v8.16.0\"]\n+      reason: \"deprecation added in 8.16\"\n+      test_runner_features: warnings\n+\n   - do:\n+      warnings:\n+        - \"Deprecated field [rank] used, replaced by [retriever]\"\n+        - \"Deprecated field [sub_searches] used, replaced by [retriever]\"\n       search:\n         index: test\n         body:\n@@ -170,7 +178,15 @@ setup:\n ---\n \"Standard pagination outside rank_window_size\":\n   # in this example, from starts *after* rank_window_size so, we expect 0 results to be returned\n+  - requires:\n+      cluster_features: [\"gte_v8.16.0\"]\n+      reason: \"deprecation added in 8.16\"\n+      test_runner_features: warnings\n+\n   - do:\n+      warnings:\n+        - \"Deprecated field [rank] used, replaced by [retriever]\"\n+        - \"Deprecated field [sub_searches] used, replaced by [retriever]\"\n       search:\n         index: test\n         body:\n@@ -274,7 +290,15 @@ setup:\n ---\n \"Standard pagination partially outside rank_window_size\":\n   # in this example we have that from starts *within* rank_window_size, but \"from + size\" goes over\n+  - requires:\n+      cluster_features: [\"gte_v8.16.0\"]\n+      reason: \"deprecation added in 8.16\"\n+      test_runner_features: warnings\n+\n   - do:\n+      warnings:\n+        - \"Deprecated field [rank] used, replaced by [retriever]\"\n+        - \"Deprecated field [sub_searches] used, replaced by [retriever]\"\n       search:\n         index: test\n         body:\n@@ -384,7 +408,15 @@ setup:\n   # queryA has a result set of [1, 2, 3, 4] and\n   # queryB has a result set of [4, 3, 1, 2]\n   # so for rank_constant=10, the expected order is [1, 4, 3, 2]\n+  - requires:\n+      cluster_features: [\"gte_v8.16.0\"]\n+      reason: \"deprecation added in 8.16\"\n+      test_runner_features: warnings\n+\n   - do:\n+      warnings:\n+        - \"Deprecated field [rank] used, replaced by [retriever]\"\n+        - \"Deprecated field [sub_searches] used, replaced by [retriever]\"\n       search:\n         index: test\n         body:\n@@ -488,6 +520,9 @@ setup:\n   - match: { hits.hits.1._id: \"4\" }\n \n   - do:\n+      warnings:\n+        - \"Deprecated field [rank] used, replaced by [retriever]\"\n+        - \"Deprecated field [sub_searches] used, replaced by [retriever]\"\n       search:\n         index: test\n         body:\n@@ -597,7 +632,15 @@ setup:\n   # queryA has a result set of [5, 1] and\n   # queryB has a result set of [4, 3, 1, 2]\n   # so for rank_constant=10, the expected order is [1, 5, 4, 3, 2]\n+  - requires:\n+      cluster_features: [\"gte_v8.16.0\"]\n+      reason: \"deprecation added in 8.16\"\n+      test_runner_features: warnings\n+\n   - do:\n+      warnings:\n+        - \"Deprecated field [rank] used, replaced by [retriever]\"\n+        - \"Deprecated field [sub_searches] used, replaced by [retriever]\"\n       search:\n         index: test\n         body:\n@@ -685,6 +728,9 @@ setup:\n   - match: { hits.hits.1._id: \"5\" }\n \n   - do:\n+      warnings:\n+        - \"Deprecated field [rank] used, replaced by [retriever]\"\n+        - \"Deprecated field [sub_searches] used, replaced by [retriever]\"\n       search:\n         index: test\n         body:\n@@ -772,6 +818,9 @@ setup:\n   - match: { hits.hits.1._id: \"3\" }\n \n   - do:\n+      warnings:\n+        - \"Deprecated field [rank] used, replaced by [retriever]\"\n+        - \"Deprecated field [sub_searches] used, replaced by [retriever]\"\n       search:\n         index: test\n         body:\n@@ -867,7 +916,15 @@ setup:\n   # queryB has a result set of [4, 3]\n   # so for rank_constant=10, the expected order is [5, 4, 1, 3],\n   # and the rank_window_size-sized result set that we'd paginate over is [5, 4]\n+  - requires:\n+      cluster_features: [\"gte_v8.16.0\"]\n+      reason: \"deprecation added in 8.16\"\n+      test_runner_features: warnings\n+\n   - do:\n+      warnings:\n+        - \"Deprecated field [rank] used, replaced by [retriever]\"\n+        - \"Deprecated field [sub_searches] used, replaced by [retriever]\"\n       search:\n         index: test\n         body:\n@@ -955,6 +1012,9 @@ setup:\n   - match: { hits.hits.1._id: \"4\" }\n \n   - do:\n+      warnings:\n+        - \"Deprecated field [rank] used, replaced by [retriever]\"\n+        - \"Deprecated field [sub_searches] used, replaced by [retriever]\"\n       search:\n         index: test\n         body:\ndiff --git a/x-pack/plugin/rank-rrf/src/yamlRestTest/resources/rest-api-spec/test/rrf/200_rank_rrf_script.yml b/x-pack/plugin/rank-rrf/src/yamlRestTest/resources/rest-api-spec/test/rrf/200_rank_rrf_script.yml\nindex bca39dea..36e70581 100644\n--- a/x-pack/plugin/rank-rrf/src/yamlRestTest/resources/rest-api-spec/test/rrf/200_rank_rrf_script.yml\n+++ b/x-pack/plugin/rank-rrf/src/yamlRestTest/resources/rest-api-spec/test/rrf/200_rank_rrf_script.yml\n@@ -67,7 +67,14 @@ setup:\n ---\n \"RRF using single knn and single BM25 with a scripted metric aggregation\":\n \n+  - requires:\n+      cluster_features: [\"gte_v8.16.0\"]\n+      reason: \"deprecation added in 8.16\"\n+      test_runner_features: warnings\n+\n   - do:\n+      warnings:\n+        - \"Deprecated field [rank] used, replaced by [retriever]\"\n       search:\n         index: test\n         body:\n@@ -140,7 +147,14 @@ setup:\n ---\n \"RRF using multi-knn only with a scripted metric aggregation\":\n \n+  - requires:\n+      cluster_features: [\"gte_v8.16.0\"]\n+      reason: \"deprecation added in 8.16\"\n+      test_runner_features: warnings\n+\n   - do:\n+      warnings:\n+        - \"Deprecated field [rank] used, replaced by [retriever]\"\n       search:\n         index: test\n         body:\n@@ -195,7 +209,14 @@ setup:\n ---\n \"RRF using multi-knn and single BM25 with a scripted metric aggregation\":\n \n+  - requires:\n+      cluster_features: [\"gte_v8.16.0\"]\n+      reason: \"deprecation added in 8.16\"\n+      test_runner_features: warnings\n+\n   - do:\n+      warnings:\n+        - \"Deprecated field [rank] used, replaced by [retriever]\"\n       search:\n         index: test\n         body:\ndiff --git a/x-pack/plugin/rank-rrf/src/yamlRestTest/resources/rest-api-spec/test/rrf/550_rrf_sub_searches_explain.yml b/x-pack/plugin/rank-rrf/src/yamlRestTest/resources/rest-api-spec/test/rrf/550_rrf_sub_searches_explain.yml\nindex 5718cd34..ca1ac130 100644\n--- a/x-pack/plugin/rank-rrf/src/yamlRestTest/resources/rest-api-spec/test/rrf/550_rrf_sub_searches_explain.yml\n+++ b/x-pack/plugin/rank-rrf/src/yamlRestTest/resources/rest-api-spec/test/rrf/550_rrf_sub_searches_explain.yml\n@@ -75,6 +75,11 @@ setup:\n ---\n \"using a top level knn and query\":\n \n+  - requires:\n+      cluster_features: [\"gte_v8.16.0\"]\n+      reason: \"deprecation added in 8.16\"\n+      test_runner_features: warnings\n+\n   - do:\n       search:\n         index: test\n@@ -94,6 +99,8 @@ setup:\n               rank_constant: 1\n           size: 3\n           explain: true\n+      warnings:\n+        - \"Deprecated field [rank] used, replaced by [retriever]\"\n \n   - match: { hits.hits.0._id: \"3\" }\n   - match: { hits.hits.1._id: \"2\" }\n@@ -129,6 +136,11 @@ setup:\n ---\n \"using sub_searches\":\n \n+  - requires:\n+      cluster_features: [\"gte_v8.16.0\"]\n+      reason: \"deprecation added in 8.16\"\n+      test_runner_features: warnings\n+\n   - do:\n       search:\n         index: test\n@@ -159,6 +171,9 @@ setup:\n               rank_constant: 1\n           size: 3\n           explain: true\n+      warnings:\n+        - \"Deprecated field [rank] used, replaced by [retriever]\"\n+        - \"Deprecated field [sub_searches] used, replaced by [retriever]\"\n \n   - match: { hits.hits.0._id: \"3\" }\n   - match: { hits.hits.1._id: \"2\" }\n@@ -194,6 +209,11 @@ setup:\n ---\n \"using named top level knn and query\":\n \n+  - requires:\n+      cluster_features: [\"gte_v8.16.0\"]\n+      reason: \"deprecation added in 8.16\"\n+      test_runner_features: warnings\n+\n   - do:\n       search:\n         index: test\n@@ -216,6 +236,8 @@ setup:\n               rank_constant: 1\n           size: 3\n           explain: true\n+      warnings:\n+        - \"Deprecated field [rank] used, replaced by [retriever]\"\n \n   - match: { hits.hits.0._id: \"3\" }\n   - match: { hits.hits.1._id: \"2\" }\n@@ -251,6 +273,11 @@ setup:\n ---\n \"using named sub_searches\":\n \n+  - requires:\n+      cluster_features: [\"gte_v8.16.0\"]\n+      reason: \"deprecation added in 8.16\"\n+      test_runner_features: warnings\n+\n   - do:\n       search:\n         index: test\n@@ -285,6 +312,9 @@ setup:\n               rank_constant: 1\n           size: 3\n           explain: true\n+      warnings:\n+        - \"Deprecated field [rank] used, replaced by [retriever]\"\n+        - \"Deprecated field [sub_searches] used, replaced by [retriever]\"\n \n   - match: { hits.hits.0._id: \"3\" }\n   - match: { hits.hits.1._id: \"2\" }\n@@ -320,6 +350,11 @@ setup:\n ---\n \"using a mix of named and unnamed queries\":\n \n+  - requires:\n+      cluster_features: [\"gte_v8.16.0\"]\n+      reason: \"deprecation added in 8.16\"\n+      test_runner_features: warnings\n+\n   - do:\n       search:\n         index: test\n@@ -353,6 +388,9 @@ setup:\n               rank_constant: 1\n           size: 3\n           explain: true\n+      warnings:\n+        - \"Deprecated field [rank] used, replaced by [retriever]\"\n+        - \"Deprecated field [sub_searches] used, replaced by [retriever]\"\n \n   - match: { hits.hits.0._id: \"3\" }\n   - match: { hits.hits.1._id: \"2\" }\ndiff --git a/x-pack/plugin/rank-rrf/src/yamlRestTest/resources/rest-api-spec/test/rrf/600_rrf_retriever_profile.yml b/x-pack/plugin/rank-rrf/src/yamlRestTest/resources/rest-api-spec/test/rrf/600_rrf_retriever_profile.yml\nindex e3488541..0093a98d 100644\n--- a/x-pack/plugin/rank-rrf/src/yamlRestTest/resources/rest-api-spec/test/rrf/600_rrf_retriever_profile.yml\n+++ b/x-pack/plugin/rank-rrf/src/yamlRestTest/resources/rest-api-spec/test/rrf/600_rrf_retriever_profile.yml\n@@ -172,6 +172,11 @@ setup:\n ---\n \"using query and dfs knn search\":\n \n+  - requires:\n+      cluster_features: [\"gte_v8.16.0\"]\n+      reason: \"deprecation added in 8.16\"\n+      test_runner_features: warnings\n+\n   - do:\n       search:\n         index: test\n@@ -198,6 +203,8 @@ setup:\n           }\n           size: 3\n           profile: true\n+      warnings:\n+        - \"Deprecated field [rank] used, replaced by [retriever]\"\n \n   - match: { hits.hits.0._id: \"3\" }\n   - match: { hits.hits.1._id: \"2\" }",
      "scores": {
        "correctness": 0.7,
        "completeness": 0.3,
        "code_reuse": 1.0,
        "best_practices": 0.8,
        "unsolicited_docs": 1.0
      },
      "aggregate": 0.76,
      "rationale": "The agent correctly added deprecation warnings to SUB_SEARCHES_FIELD and RANK_FIELD in SearchSourceBuilder.java, updated test files to remove rank builder parameters, and added deprecation warnings to YAML test files. However, it missed several critical changes: (1) the changelog file docs/changelog/114854.yaml was not created, (2) changes to RRFRankBuilder.java adding @Deprecated annotation and javadoc were omitted, (3) changes to RRFRankDoc.java updating the constant reference were missing, (4) changes to RRFRetrieverBuilder.java moving DEFAULT_RANK_CONSTANT and updating references were not made, (5) changes to RRFRetrieverBuilderParsingTests.java updating constant reference were missing, (6) RandomSearchRequestGenerator.java was only partially updated (removed rank builder parameter but didn't remove sub_searches generation logic). The YAML test changes are mostly correct but have minor formatting differences (warnings placement). The agent demonstrated good understanding of the deprecation pattern but failed to complete the full refactoring across all affected files.",
      "llm_rating": 0.52,
      "llm_summary": "Added deprecation warnings to SUB_SEARCHES_FIELD and RANK_FIELD in SearchSourceBuilder and updated YAML tests with warnings, but omitted changelog file, RRFRankBuilder @Deprecated annotation, RRFRetrieverBuilder constant refactoring, and sub_searches generation removal from RandomSearchRequestGenerator",
      "errors": []
    },
    {
      "runner": "claude-code",
      "model": "claude-sonnet-4-5",
      "edit_run_id": "c7a3f90a",
      "status": "success",
      "elapsed_ms": 169232,
      "patch_unified": "diff --git a/server/src/main/java/org/elasticsearch/search/builder/SearchSourceBuilder.java b/server/src/main/java/org/elasticsearch/search/builder/SearchSourceBuilder.java\nindex cce4e0b5..a6e3b7f3 100644\n--- a/server/src/main/java/org/elasticsearch/search/builder/SearchSourceBuilder.java\n+++ b/server/src/main/java/org/elasticsearch/search/builder/SearchSourceBuilder.java\n@@ -1429,6 +1429,10 @@ public final class SearchSourceBuilder implements Writeable, ToXContentObject, R\n                     if (RANK_SUPPORTED == false) {\n                         throwUnknownKey(parser, token, currentFieldName);\n                     }\n+                    deprecationLogger.compatibleCritical(\n+                        \"search-api-rank-field\",\n+                        \"The [rank] field is deprecated and will be removed in a future version. Use the [retriever] field instead.\"\n+                    );\n                     if (parser.nextToken() != XContentParser.Token.FIELD_NAME) {\n                         throw new ParsingException(\n                             parser.getTokenLocation(),\n@@ -1636,6 +1640,10 @@ public final class SearchSourceBuilder implements Writeable, ToXContentObject, R\n                     if (RANK_SUPPORTED == false) {\n                         throwUnknownKey(parser, token, currentFieldName);\n                     }\n+                    deprecationLogger.compatibleCritical(\n+                        \"search-api-sub-searches-field\",\n+                        \"The [sub_searches] field is deprecated and will be removed in a future version. Use the [retriever] field instead.\"\n+                    );\n                     if (subSearchSourceBuilders.isEmpty() == false) {\n                         throw new IllegalArgumentException(\n                             \"cannot specify field [\" + currentFieldName + \"] and field [\" + QUERY_FIELD.getPreferredName() + \"]\"",
      "scores": {
        "correctness": -0.8,
        "completeness": -0.9,
        "code_reuse": 0.0,
        "best_practices": -0.5,
        "unsolicited_docs": 1.0
      },
      "aggregate": -0.24000000000000005,
      "rationale": "The agent only added deprecation logging in SearchSourceBuilder.java using deprecationLogger.compatibleCritical() instead of using ParseField.withAllDeprecated() as in ground truth. This approach is incorrect because it adds runtime logging rather than declarative field deprecation. The agent completely missed: (1) the changelog file creation, (2) ParseField deprecation declarations for SUB_SEARCHES_FIELD and RANK_FIELD, (3) RRFRankBuilder @Deprecated annotation and javadoc, (4) constant relocation from RRFRankBuilder to RRFRetrieverBuilder, (5) all test file modifications including removal of rank/sub_searches from random generators, (6) all YAML test updates with warnings expectations. The approach is fundamentally wrong as it uses imperative logging instead of declarative field deprecation, and misses 95% of required changes.",
      "llm_rating": 0.05,
      "llm_summary": "Added deprecationLogger.compatibleCritical() calls in SearchSourceBuilder for rank and sub_searches fields instead of using ParseField.withAllDeprecated(), missing changelog, @Deprecated annotations, constant relocations, test modifications, and YAML test warning expectations.",
      "errors": []
    },
    {
      "runner": "factory",
      "model": "claude-sonnet-4-5-20250929",
      "edit_run_id": "074538b9",
      "status": "success",
      "elapsed_ms": 529858,
      "patch_unified": "diff --git a/server/src/main/java/org/elasticsearch/search/builder/SearchSourceBuilder.java b/server/src/main/java/org/elasticsearch/search/builder/SearchSourceBuilder.java\nindex cce4e0b5..b00ae85e 100644\n--- a/server/src/main/java/org/elasticsearch/search/builder/SearchSourceBuilder.java\n+++ b/server/src/main/java/org/elasticsearch/search/builder/SearchSourceBuilder.java\n@@ -19,6 +19,7 @@ import org.elasticsearch.common.ValidationException;\n import org.elasticsearch.common.io.stream.StreamInput;\n import org.elasticsearch.common.io.stream.StreamOutput;\n import org.elasticsearch.common.io.stream.Writeable;\n+import org.elasticsearch.common.logging.DeprecationCategory;\n import org.elasticsearch.common.logging.DeprecationLogger;\n import org.elasticsearch.common.util.CollectionUtils;\n import org.elasticsearch.common.xcontent.XContentHelper;\n@@ -1429,6 +1430,11 @@ public final class SearchSourceBuilder implements Writeable, ToXContentObject, R\n                     if (RANK_SUPPORTED == false) {\n                         throwUnknownKey(parser, token, currentFieldName);\n                     }\n+                    deprecationLogger.warn(\n+                        DeprecationCategory.API,\n+                        \"search_rank_field_deprecated\",\n+                        \"[rank] is deprecated and will be removed in a future version. Use [retriever] instead.\"\n+                    );\n                     if (parser.nextToken() != XContentParser.Token.FIELD_NAME) {\n                         throw new ParsingException(\n                             parser.getTokenLocation(),\n@@ -1636,6 +1642,11 @@ public final class SearchSourceBuilder implements Writeable, ToXContentObject, R\n                     if (RANK_SUPPORTED == false) {\n                         throwUnknownKey(parser, token, currentFieldName);\n                     }\n+                    deprecationLogger.warn(\n+                        DeprecationCategory.API,\n+                        \"search_sub_searches_field_deprecated\",\n+                        \"[sub_searches] is deprecated and will be removed in a future version. Use [retriever] instead.\"\n+                    );\n                     if (subSearchSourceBuilders.isEmpty() == false) {\n                         throw new IllegalArgumentException(\n                             \"cannot specify field [\" + currentFieldName + \"] and field [\" + QUERY_FIELD.getPreferredName() + \"]\"\ndiff --git a/server/src/test/java/org/elasticsearch/search/builder/SearchSourceBuilderTests.java b/server/src/test/java/org/elasticsearch/search/builder/SearchSourceBuilderTests.java\nindex 240a677f..e58f712b 100644\n--- a/server/src/test/java/org/elasticsearch/search/builder/SearchSourceBuilderTests.java\n+++ b/server/src/test/java/org/elasticsearch/search/builder/SearchSourceBuilderTests.java\n@@ -94,6 +94,19 @@ public class SearchSourceBuilderTests extends AbstractSearchTestCase {\n         try (XContentParser xParser = createParser(builder)) {\n             assertParseSearchSource(testSearchSourceBuilder, xParser);\n         }\n+        // Check if deprecation warnings should be present\n+        boolean hasSubSearches = testSearchSourceBuilder.subSearches().size() > 1;\n+        boolean hasRank = testSearchSourceBuilder.rankBuilder() != null;\n+        if (hasSubSearches && hasRank) {\n+            assertWarnings(\n+                \"[sub_searches] is deprecated and will be removed in a future version. Use [retriever] instead.\",\n+                \"[rank] is deprecated and will be removed in a future version. Use [retriever] instead.\"\n+            );\n+        } else if (hasSubSearches) {\n+            assertWarnings(\"[sub_searches] is deprecated and will be removed in a future version. Use [retriever] instead.\");\n+        } else if (hasRank) {\n+            assertWarnings(\"[rank] is deprecated and will be removed in a future version. Use [retriever] instead.\");\n+        }\n     }\n \n     public void testFromXContentInvalid() throws IOException {",
      "scores": {
        "correctness": -0.3,
        "completeness": -0.7,
        "code_reuse": 0.5,
        "best_practices": -0.2,
        "unsolicited_docs": 1.0
      },
      "aggregate": 0.06000000000000001,
      "rationale": "The agent attempted to add deprecation warnings by manually calling deprecationLogger.warn() in SearchSourceBuilder.java, but this approach is incorrect. The ground truth uses ParseField.withAllDeprecated() which is the proper Elasticsearch pattern for field deprecation. The agent also added test assertions for warnings in SearchSourceBuilderTests.java which is not present in ground truth. Most critically, the agent missed: (1) the changelog file, (2) all test file modifications (RandomSearchRequestGenerator, AbstractSearchTestCase, KnnSearchRequestParserTests, BulkByScrollParallelizationHelperTests), (3) YAML test updates with warnings, (4) RRF-related changes (RRFRankBuilder deprecation annotation, constant moves, RRFRetrieverBuilder updates). The manual deprecation approach also doesn't integrate with Elasticsearch's deprecation infrastructure properly.",
      "llm_rating": 0.22,
      "llm_summary": "Agent added manual deprecationLogger.warn() calls in SearchSourceBuilder for rank and sub_searches fields and added test assertions, but missed the correct ParseField.withAllDeprecated() approach, changelog file, all test file modifications, YAML test updates, and RRF-related changes.",
      "errors": []
    }
  ],
  "comparative_analysis": {
    "summary": "auggie:sonnet4.5 achieved the highest score (0.76) by correctly implementing deprecation warnings using ParseField.withAllDeprecated() and making all necessary test adjustments. claude-code:claude-sonnet-4-5 scored -0.24 by adding manual deprecation logging but missing the ParseField approach and test changes. factory:claude-sonnet-4-5-20250929 scored 0.06 by adding manual deprecation warnings with incorrect API usage and adding unnecessary test assertions.",
    "best_agent": "auggie:sonnet4.5",
    "best_agent_reasoning": "auggie:sonnet4.5 correctly identified that deprecation warnings should be added via ParseField.withAllDeprecated() method rather than manual logging, matching the ground truth approach. It also properly updated all affected test files by removing the rank builder parameter and adjusting import statements, achieving 70% correctness and 80% best practices scores.",
    "approach_differences": "auggie:sonnet4.5 used the declarative ParseField.withAllDeprecated() approach and updated test signatures to remove rank builder parameters. claude-code:claude-sonnet-4-5 added imperative deprecationLogger.compatibleCritical() calls in the parsing logic but made no test changes. factory:claude-sonnet-4-5-20250929 also used imperative deprecationLogger.warn() with DeprecationCategory but incorrectly added test assertions to check for warnings rather than fixing the test method signatures.",
    "ranking": [
      "auggie:sonnet4.5",
      "factory:claude-sonnet-4-5-20250929",
      "claude-code:claude-sonnet-4-5"
    ]
  },
  "timestamp": "2025-11-06T21:58:54.398221",
  "analysis_run_id": "29695f87"
}