{
  "repo_url": "https://github.com/elastic/elasticsearch.git",
  "pr_number": 114854,
  "base_commit": "9770ab7ac2da950b916743507abf8f9e73e084c7",
  "head_commit": "2615cf8c1ec14c44a3e7d2a76836a61670a7fcfb",
  "task_instructions": "You are working on a codebase. Your task is to make the necessary code changes to accomplish the following:\n\nAdding deprecation warnings for rank and sub_searches\n\nAdding deprecation warning for using the `rank` and `sub_searches` elements in Search API. \r\nAll doc references have already been removed, so here we just add the necessary headers.\n\nPlease make all necessary code changes to complete this task.",
  "ground_truth_diff": "diff --git a/docs/changelog/114854.yaml b/docs/changelog/114854.yaml\nnew file mode 100644\nindex 000000000000..144a10ba8504\n--- /dev/null\n+++ b/docs/changelog/114854.yaml\n@@ -0,0 +1,10 @@\n+pr: 114854\n+summary: Adding deprecation warnings for rrf using rank and `sub_searches`\n+area: Search\n+type: deprecation\n+issues: []\n+deprecation:\n+  title: Adding deprecation warnings for rrf using rank and `sub_searches`\n+  area: REST API\n+  details: Search API parameter `sub_searches` will no longer be a supported and will be removed in future releases. Similarly, `rrf` can only be used through the specified `retriever` and no longer though the `rank` parameter\n+  impact: Requests specifying rrf through `rank` and/or `sub_searches` elements will be disallowed in a future version. Users should instead utilize the new `retriever` parameter.\ndiff --git a/modules/reindex/src/test/java/org/elasticsearch/reindex/BulkByScrollParallelizationHelperTests.java b/modules/reindex/src/test/java/org/elasticsearch/reindex/BulkByScrollParallelizationHelperTests.java\nindex a6e28477f858..ebb4471566fb 100644\n--- a/modules/reindex/src/test/java/org/elasticsearch/reindex/BulkByScrollParallelizationHelperTests.java\n+++ b/modules/reindex/src/test/java/org/elasticsearch/reindex/BulkByScrollParallelizationHelperTests.java\n@@ -15,8 +15,8 @@ import org.elasticsearch.search.builder.SearchSourceBuilder;\n import org.elasticsearch.test.ESTestCase;\n \n import java.io.IOException;\n+import java.util.Collections;\n \n-import static java.util.Collections.emptyList;\n import static org.elasticsearch.reindex.BulkByScrollParallelizationHelper.sliceIntoSubRequests;\n import static org.elasticsearch.search.RandomSearchRequestGenerator.randomSearchRequest;\n import static org.elasticsearch.search.RandomSearchRequestGenerator.randomSearchSourceBuilder;\n@@ -24,7 +24,7 @@ import static org.elasticsearch.search.RandomSearchRequestGenerator.randomSearch\n public class BulkByScrollParallelizationHelperTests extends ESTestCase {\n     public void testSliceIntoSubRequests() throws IOException {\n         SearchRequest searchRequest = randomSearchRequest(\n-            () -> randomSearchSourceBuilder(() -> null, () -> null, () -> null, () -> null, () -> emptyList(), () -> null, () -> null)\n+            () -> randomSearchSourceBuilder(() -> null, () -> null, () -> null, Collections::emptyList, () -> null, () -> null)\n         );\n         if (searchRequest.source() != null) {\n             // Clear the slice builder if there is one set. We can't call sliceIntoSubRequests if it is.\ndiff --git a/server/src/main/java/org/elasticsearch/search/builder/SearchSourceBuilder.java b/server/src/main/java/org/elasticsearch/search/builder/SearchSourceBuilder.java\nindex 6d427aace51d..6ceb02f0e797 100644\n--- a/server/src/main/java/org/elasticsearch/search/builder/SearchSourceBuilder.java\n+++ b/server/src/main/java/org/elasticsearch/search/builder/SearchSourceBuilder.java\n@@ -25,6 +25,7 @@ import org.elasticsearch.common.xcontent.XContentHelper;\n import org.elasticsearch.core.Booleans;\n import org.elasticsearch.core.Nullable;\n import org.elasticsearch.core.TimeValue;\n+import org.elasticsearch.core.UpdateForV10;\n import org.elasticsearch.features.NodeFeature;\n import org.elasticsearch.index.query.BoolQueryBuilder;\n import org.elasticsearch.index.query.QueryBuilder;\n@@ -98,10 +99,11 @@ public final class SearchSourceBuilder implements Writeable, ToXContentObject, R\n     public static final ParseField TIMEOUT_FIELD = new ParseField(\"timeout\");\n     public static final ParseField TERMINATE_AFTER_FIELD = new ParseField(\"terminate_after\");\n     public static final ParseField QUERY_FIELD = new ParseField(\"query\");\n-    public static final ParseField SUB_SEARCHES_FIELD = new ParseField(\"sub_searches\");\n+    @UpdateForV10(owner = UpdateForV10.Owner.SEARCH_RELEVANCE) // remove [sub_searches] and [rank] support in 10.0\n+    public static final ParseField SUB_SEARCHES_FIELD = new ParseField(\"sub_searches\").withAllDeprecated(\"retriever\");\n+    public static final ParseField RANK_FIELD = new ParseField(\"rank\").withAllDeprecated(\"retriever\");\n     public static final ParseField POST_FILTER_FIELD = new ParseField(\"post_filter\");\n     public static final ParseField KNN_FIELD = new ParseField(\"knn\");\n-    public static final ParseField RANK_FIELD = new ParseField(\"rank\");\n     public static final ParseField MIN_SCORE_FIELD = new ParseField(\"min_score\");\n     public static final ParseField VERSION_FIELD = new ParseField(\"version\");\n     public static final ParseField SEQ_NO_PRIMARY_TERM_FIELD = new ParseField(\"seq_no_primary_term\");\ndiff --git a/server/src/test/java/org/elasticsearch/search/AbstractSearchTestCase.java b/server/src/test/java/org/elasticsearch/search/AbstractSearchTestCase.java\nindex b716f11b5fff..88c83df3e20f 100644\n--- a/server/src/test/java/org/elasticsearch/search/AbstractSearchTestCase.java\n+++ b/server/src/test/java/org/elasticsearch/search/AbstractSearchTestCase.java\n@@ -89,7 +89,6 @@ public abstract class AbstractSearchTestCase extends ESTestCase {\n         return RandomSearchRequestGenerator.randomSearchSourceBuilder(\n             HighlightBuilderTests::randomHighlighterBuilder,\n             SuggestBuilderTests::randomSuggestBuilder,\n-            TestRankBuilder::randomRankBuilder,\n             QueryRescorerBuilderTests::randomRescoreBuilder,\n             randomExtBuilders,\n             CollapseBuilderTests::randomCollapseBuilder,\ndiff --git a/server/src/test/java/org/elasticsearch/search/vectors/KnnSearchRequestParserTests.java b/server/src/test/java/org/elasticsearch/search/vectors/KnnSearchRequestParserTests.java\nindex d9fe421bafb4..4e4d2158a957 100644\n--- a/server/src/test/java/org/elasticsearch/search/vectors/KnnSearchRequestParserTests.java\n+++ b/server/src/test/java/org/elasticsearch/search/vectors/KnnSearchRequestParserTests.java\n@@ -74,7 +74,6 @@ public class KnnSearchRequestParserTests extends ESTestCase {\n             () -> null,\n             () -> null,\n             () -> null,\n-            () -> null,\n             Collections::emptyList,\n             () -> null,\n             () -> null\ndiff --git a/test/framework/src/main/java/org/elasticsearch/search/RandomSearchRequestGenerator.java b/test/framework/src/main/java/org/elasticsearch/search/RandomSearchRequestGenerator.java\nindex b59f1a5e5f02..363d34ca3ff8 100644\n--- a/test/framework/src/main/java/org/elasticsearch/search/RandomSearchRequestGenerator.java\n+++ b/test/framework/src/main/java/org/elasticsearch/search/RandomSearchRequestGenerator.java\n@@ -23,13 +23,11 @@ import org.elasticsearch.script.ScriptType;\n import org.elasticsearch.search.aggregations.AggregationBuilders;\n import org.elasticsearch.search.builder.PointInTimeBuilder;\n import org.elasticsearch.search.builder.SearchSourceBuilder;\n-import org.elasticsearch.search.builder.SubSearchSourceBuilder;\n import org.elasticsearch.search.collapse.CollapseBuilder;\n import org.elasticsearch.search.fetch.subphase.FetchSourceContext;\n import org.elasticsearch.search.fetch.subphase.FieldAndFormat;\n import org.elasticsearch.search.fetch.subphase.highlight.HighlightBuilder;\n import org.elasticsearch.search.internal.SearchContext;\n-import org.elasticsearch.search.rank.RankBuilder;\n import org.elasticsearch.search.rescore.RescorerBuilder;\n import org.elasticsearch.search.searchafter.SearchAfterBuilder;\n import org.elasticsearch.search.slice.SliceBuilder;\n@@ -122,7 +120,6 @@ public class RandomSearchRequestGenerator {\n     public static SearchSourceBuilder randomSearchSourceBuilder(\n         Supplier<HighlightBuilder> randomHighlightBuilder,\n         Supplier<SuggestBuilder> randomSuggestBuilder,\n-        Supplier<RankBuilder> rankContextBuilderSupplier,\n         Supplier<RescorerBuilder<?>> randomRescoreBuilder,\n         Supplier<List<SearchExtBuilder>> randomExtBuilders,\n         Supplier<CollapseBuilder> randomCollapseBuilder,\n@@ -250,17 +247,6 @@ public class RandomSearchRequestGenerator {\n         }\n         if (randomBoolean()) {\n             builder.query(QueryBuilders.termQuery(randomAlphaOfLengthBetween(5, 20), randomAlphaOfLengthBetween(5, 20)));\n-        } else if (randomBoolean()) {\n-            builder.subSearches(\n-                List.of(\n-                    new SubSearchSourceBuilder(\n-                        QueryBuilders.termQuery(randomAlphaOfLengthBetween(5, 20), randomAlphaOfLengthBetween(5, 20))\n-                    ),\n-                    new SubSearchSourceBuilder(\n-                        QueryBuilders.termQuery(randomAlphaOfLengthBetween(5, 20), randomAlphaOfLengthBetween(5, 20))\n-                    )\n-                )\n-            );\n         }\n         if (randomBoolean()) {\n             builder.postFilter(QueryBuilders.termQuery(randomAlphaOfLengthBetween(5, 20), randomAlphaOfLengthBetween(5, 20)));\n@@ -354,9 +340,6 @@ public class RandomSearchRequestGenerator {\n         if (randomBoolean()) {\n             builder.suggest(randomSuggestBuilder.get());\n         }\n-        if (randomBoolean()) {\n-            builder.rankBuilder(rankContextBuilderSupplier.get());\n-        }\n         if (randomBoolean()) {\n             int numRescores = randomIntBetween(1, 5);\n             for (int i = 0; i < numRescores; i++) {\ndiff --git a/x-pack/plugin/rank-rrf/src/main/java/org/elasticsearch/xpack/rank/rrf/RRFRankBuilder.java b/x-pack/plugin/rank-rrf/src/main/java/org/elasticsearch/xpack/rank/rrf/RRFRankBuilder.java\nindex 10aff2f4d68c..fb20f834937d 100644\n--- a/x-pack/plugin/rank-rrf/src/main/java/org/elasticsearch/xpack/rank/rrf/RRFRankBuilder.java\n+++ b/x-pack/plugin/rank-rrf/src/main/java/org/elasticsearch/xpack/rank/rrf/RRFRankBuilder.java\n@@ -36,16 +36,17 @@ import static org.elasticsearch.xcontent.ConstructingObjectParser.optionalConstr\n \n /**\n  * The builder to support RRF. Adds user-defined parameters for window size and rank constant.\n+ *\n+ * @deprecated RRF support is provided through the retriever framework. Please use {@link RRFRetrieverBuilder instead}\n  */\n+@Deprecated\n public class RRFRankBuilder extends RankBuilder {\n \n-    public static final int DEFAULT_RANK_CONSTANT = 60;\n-\n     public static final ParseField RANK_CONSTANT_FIELD = new ParseField(\"rank_constant\");\n \n     static final ConstructingObjectParser<RRFRankBuilder, Void> PARSER = new ConstructingObjectParser<>(RRFRankPlugin.NAME, args -> {\n         int windowSize = args[0] == null ? DEFAULT_RANK_WINDOW_SIZE : (int) args[0];\n-        int rankConstant = args[1] == null ? DEFAULT_RANK_CONSTANT : (int) args[1];\n+        int rankConstant = args[1] == null ? RRFRetrieverBuilder.DEFAULT_RANK_CONSTANT : (int) args[1];\n         return new RRFRankBuilder(windowSize, rankConstant);\n     });\n \ndiff --git a/x-pack/plugin/rank-rrf/src/main/java/org/elasticsearch/xpack/rank/rrf/RRFRankDoc.java b/x-pack/plugin/rank-rrf/src/main/java/org/elasticsearch/xpack/rank/rrf/RRFRankDoc.java\nindex 272df248e53e..4cd10801b298 100644\n--- a/x-pack/plugin/rank-rrf/src/main/java/org/elasticsearch/xpack/rank/rrf/RRFRankDoc.java\n+++ b/x-pack/plugin/rank-rrf/src/main/java/org/elasticsearch/xpack/rank/rrf/RRFRankDoc.java\n@@ -19,7 +19,7 @@ import java.io.IOException;\n import java.util.Arrays;\n import java.util.Objects;\n \n-import static org.elasticsearch.xpack.rank.rrf.RRFRankBuilder.DEFAULT_RANK_CONSTANT;\n+import static org.elasticsearch.xpack.rank.rrf.RRFRetrieverBuilder.DEFAULT_RANK_CONSTANT;\n \n /**\n  * {@code RRFRankDoc} supports additional ranking information\ndiff --git a/x-pack/plugin/rank-rrf/src/main/java/org/elasticsearch/xpack/rank/rrf/RRFRetrieverBuilder.java b/x-pack/plugin/rank-rrf/src/main/java/org/elasticsearch/xpack/rank/rrf/RRFRetrieverBuilder.java\nindex 12c43a2f169f..c3c9f19cde6e 100644\n--- a/x-pack/plugin/rank-rrf/src/main/java/org/elasticsearch/xpack/rank/rrf/RRFRetrieverBuilder.java\n+++ b/x-pack/plugin/rank-rrf/src/main/java/org/elasticsearch/xpack/rank/rrf/RRFRetrieverBuilder.java\n@@ -12,6 +12,7 @@ import org.elasticsearch.common.ParsingException;\n import org.elasticsearch.common.util.Maps;\n import org.elasticsearch.features.NodeFeature;\n import org.elasticsearch.license.LicenseUtils;\n+import org.elasticsearch.search.rank.RankBuilder;\n import org.elasticsearch.search.rank.RankDoc;\n import org.elasticsearch.search.retriever.CompoundRetrieverBuilder;\n import org.elasticsearch.search.retriever.RetrieverBuilder;\n@@ -31,7 +32,6 @@ import java.util.Objects;\n \n import static org.elasticsearch.xcontent.ConstructingObjectParser.constructorArg;\n import static org.elasticsearch.xcontent.ConstructingObjectParser.optionalConstructorArg;\n-import static org.elasticsearch.xpack.rank.rrf.RRFRankPlugin.NAME;\n \n /**\n  * An rrf retriever is used to represent an rrf rank element, but\n@@ -50,6 +50,7 @@ public final class RRFRetrieverBuilder extends CompoundRetrieverBuilder<RRFRetri\n     public static final ParseField RANK_WINDOW_SIZE_FIELD = new ParseField(\"rank_window_size\");\n     public static final ParseField RANK_CONSTANT_FIELD = new ParseField(\"rank_constant\");\n \n+    public static final int DEFAULT_RANK_CONSTANT = 60;\n     @SuppressWarnings(\"unchecked\")\n     static final ConstructingObjectParser<RRFRetrieverBuilder, RetrieverParserContext> PARSER = new ConstructingObjectParser<>(\n         NAME,\n@@ -57,8 +58,8 @@ public final class RRFRetrieverBuilder extends CompoundRetrieverBuilder<RRFRetri\n         args -> {\n             List<RetrieverBuilder> childRetrievers = (List<RetrieverBuilder>) args[0];\n             List<RetrieverSource> innerRetrievers = childRetrievers.stream().map(r -> new RetrieverSource(r, null)).toList();\n-            int rankWindowSize = args[1] == null ? RRFRankBuilder.DEFAULT_RANK_WINDOW_SIZE : (int) args[1];\n-            int rankConstant = args[2] == null ? RRFRankBuilder.DEFAULT_RANK_CONSTANT : (int) args[2];\n+            int rankWindowSize = args[1] == null ? RankBuilder.DEFAULT_RANK_WINDOW_SIZE : (int) args[1];\n+            int rankConstant = args[2] == null ? DEFAULT_RANK_CONSTANT : (int) args[2];\n             return new RRFRetrieverBuilder(innerRetrievers, rankWindowSize, rankConstant);\n         }\n     );\ndiff --git a/x-pack/plugin/rank-rrf/src/test/java/org/elasticsearch/xpack/rank/rrf/RRFRetrieverBuilderParsingTests.java b/x-pack/plugin/rank-rrf/src/test/java/org/elasticsearch/xpack/rank/rrf/RRFRetrieverBuilderParsingTests.java\nindex d324effe41c2..cae758457a2a 100644\n--- a/x-pack/plugin/rank-rrf/src/test/java/org/elasticsearch/xpack/rank/rrf/RRFRetrieverBuilderParsingTests.java\n+++ b/x-pack/plugin/rank-rrf/src/test/java/org/elasticsearch/xpack/rank/rrf/RRFRetrieverBuilderParsingTests.java\n@@ -41,7 +41,7 @@ public class RRFRetrieverBuilderParsingTests extends AbstractXContentTestCase<RR\n         if (randomBoolean()) {\n             rankWindowSize = randomIntBetween(1, 10000);\n         }\n-        int rankConstant = RRFRankBuilder.DEFAULT_RANK_CONSTANT;\n+        int rankConstant = RRFRetrieverBuilder.DEFAULT_RANK_CONSTANT;\n         if (randomBoolean()) {\n             rankConstant = randomIntBetween(1, 1000000);\n         }\ndiff --git a/x-pack/plugin/rank-rrf/src/yamlRestTest/resources/rest-api-spec/test/rrf/100_rank_rrf.yml b/x-pack/plugin/rank-rrf/src/yamlRestTest/resources/rest-api-spec/test/rrf/100_rank_rrf.yml\nindex 647540644ce9..a5c346b38699 100644\n--- a/x-pack/plugin/rank-rrf/src/yamlRestTest/resources/rest-api-spec/test/rrf/100_rank_rrf.yml\n+++ b/x-pack/plugin/rank-rrf/src/yamlRestTest/resources/rest-api-spec/test/rrf/100_rank_rrf.yml\n@@ -2,6 +2,8 @@ setup:\n   - requires:\n       cluster_features: \"gte_v8.8.0\"\n       reason: 'rank added in 8.8'\n+  - skip:\n+      features: \"warnings\"\n \n   - do:\n       indices.create:\n@@ -59,7 +61,14 @@ setup:\n ---\n \"Simple rank with bm25 search and kNN search\":\n \n+  - requires:\n+      cluster_features: [\"gte_v8.16.0\"]\n+      reason: \"deprecation added in 8.16\"\n+      test_runner_features: warnings\n+\n   - do:\n+      warnings:\n+        - \"Deprecated field [rank] used, replaced by [retriever]\"\n       search:\n         index: test\n         body:\n@@ -94,7 +103,15 @@ setup:\n ---\n \"Simple rank with multiple bm25 sub searches\":\n \n+  - requires:\n+      cluster_features: [\"gte_v8.16.0\"]\n+      reason: \"deprecation added in 8.16\"\n+      test_runner_features: warnings\n+\n   - do:\n+      warnings:\n+        - \"Deprecated field [rank] used, replaced by [retriever]\"\n+        - Deprecated field [sub_searches] used, replaced by [retriever]\n       search:\n         index: test\n         body:\n@@ -135,7 +152,15 @@ setup:\n ---\n \"Simple rank with multiple bm25 sub_searches and a knn search\":\n \n+  - requires:\n+      cluster_features: [\"gte_v8.16.0\"]\n+      reason: \"deprecation added in 8.16\"\n+      test_runner_features: warnings\n+\n   - do:\n+      warnings:\n+        - \"Deprecated field [rank] used, replaced by [retriever]\"\n+        - Deprecated field [sub_searches] used, replaced by [retriever]\n       search:\n         index: test\n         body:\ndiff --git a/x-pack/plugin/rank-rrf/src/yamlRestTest/resources/rest-api-spec/test/rrf/150_rank_rrf_pagination.yml b/x-pack/plugin/rank-rrf/src/yamlRestTest/resources/rest-api-spec/test/rrf/150_rank_rrf_pagination.yml\nindex b4893bfec084..94a1457a7acc 100644\n--- a/x-pack/plugin/rank-rrf/src/yamlRestTest/resources/rest-api-spec/test/rrf/150_rank_rrf_pagination.yml\n+++ b/x-pack/plugin/rank-rrf/src/yamlRestTest/resources/rest-api-spec/test/rrf/150_rank_rrf_pagination.yml\n@@ -63,7 +63,15 @@ setup:\n ---\n \"Standard pagination within rank_window_size\":\n   # this test retrieves the same results from two queries, and applies a simple pagination skipping the first result\n+  - requires:\n+      cluster_features: [ \"gte_v8.16.0\" ]\n+      reason: \"deprecation added in 8.16\"\n+      test_runner_features: warnings\n+\n   - do:\n+      warnings:\n+        - \"Deprecated field [rank] used, replaced by [retriever]\"\n+        - Deprecated field [sub_searches] used, replaced by [retriever]\n       search:\n         index: test\n         body:\n@@ -170,7 +178,15 @@ setup:\n ---\n \"Standard pagination outside rank_window_size\":\n   # in this example, from starts *after* rank_window_size so, we expect 0 results to be returned\n+  - requires:\n+      cluster_features: [ \"gte_v8.16.0\" ]\n+      reason: \"deprecation added in 8.16\"\n+      test_runner_features: warnings\n+\n   - do:\n+      warnings:\n+        - \"Deprecated field [rank] used, replaced by [retriever]\"\n+        - Deprecated field [sub_searches] used, replaced by [retriever]\n       search:\n         index: test\n         body:\n@@ -274,7 +290,15 @@ setup:\n ---\n \"Standard pagination partially outside rank_window_size\":\n   # in this example we have that from starts *within* rank_window_size, but \"from + size\" goes over\n+  - requires:\n+      cluster_features: [ \"gte_v8.16.0\" ]\n+      reason: \"deprecation added in 8.16\"\n+      test_runner_features: warnings\n+\n   - do:\n+      warnings:\n+        - \"Deprecated field [rank] used, replaced by [retriever]\"\n+        - Deprecated field [sub_searches] used, replaced by [retriever]\n       search:\n         index: test\n         body:\n@@ -384,7 +408,15 @@ setup:\n   # queryA has a result set of [1, 2, 3, 4] and\n   # queryB has a result set of [4, 3, 1, 2]\n   # so for rank_constant=10, the expected order is [1, 4, 3, 2]\n+  - requires:\n+      cluster_features: [\"gte_v8.16.0\"]\n+      reason: \"deprecation added in 8.16\"\n+      test_runner_features: warnings\n+\n   - do:\n+      warnings:\n+        - \"Deprecated field [rank] used, replaced by [retriever]\"\n+        - Deprecated field [sub_searches] used, replaced by [retriever]\n       search:\n         index: test\n         body:\n@@ -488,6 +520,9 @@ setup:\n   - match: { hits.hits.1._id: \"4\" }\n \n   - do:\n+      warnings:\n+        - \"Deprecated field [rank] used, replaced by [retriever]\"\n+        - Deprecated field [sub_searches] used, replaced by [retriever]\n       search:\n         index: test\n         body:\n@@ -597,7 +632,15 @@ setup:\n   # queryA has a result set of [5, 1] and\n   # queryB has a result set of [4, 3, 1, 2]\n   # so for rank_constant=10, the expected order is [1, 5, 4, 3, 2]\n+  - requires:\n+      cluster_features: [\"gte_v8.16.0\"]\n+      reason: \"deprecation added in 8.16\"\n+      test_runner_features: warnings\n+\n   - do:\n+      warnings:\n+        - \"Deprecated field [rank] used, replaced by [retriever]\"\n+        - Deprecated field [sub_searches] used, replaced by [retriever]\n       search:\n         index: test\n         body:\n@@ -685,6 +728,9 @@ setup:\n   - match: { hits.hits.1._id: \"5\" }\n \n   - do:\n+      warnings:\n+        - \"Deprecated field [rank] used, replaced by [retriever]\"\n+        - Deprecated field [sub_searches] used, replaced by [retriever]\n       search:\n         index: test\n         body:\n@@ -772,6 +818,9 @@ setup:\n   - match: { hits.hits.1._id: \"3\" }\n \n   - do:\n+      warnings:\n+        - \"Deprecated field [rank] used, replaced by [retriever]\"\n+        - Deprecated field [sub_searches] used, replaced by [retriever]\n       search:\n         index: test\n         body:\n@@ -867,7 +916,15 @@ setup:\n   # queryB has a result set of [4, 3]\n   # so for rank_constant=10, the expected order is [5, 4, 1, 3],\n   # and the rank_window_size-sized result set that we'd paginate over is [5, 4]\n+  - requires:\n+      cluster_features: [\"gte_v8.16.0\"]\n+      reason: \"deprecation added in 8.16\"\n+      test_runner_features: warnings\n+\n   - do:\n+      warnings:\n+        - \"Deprecated field [rank] used, replaced by [retriever]\"\n+        - Deprecated field [sub_searches] used, replaced by [retriever]\n       search:\n         index: test\n         body:\n@@ -955,6 +1012,10 @@ setup:\n   - match: { hits.hits.1._id: \"4\" }\n \n   - do:\n+      warnings:\n+        - \"Deprecated field [rank] used, replaced by [retriever]\"\n+        - Deprecated field [sub_searches] used, replaced by [retriever]\n+\n       search:\n         index: test\n         body:\ndiff --git a/x-pack/plugin/rank-rrf/src/yamlRestTest/resources/rest-api-spec/test/rrf/200_rank_rrf_script.yml b/x-pack/plugin/rank-rrf/src/yamlRestTest/resources/rest-api-spec/test/rrf/200_rank_rrf_script.yml\nindex bca39dea4ae5..36e70581f39f 100644\n--- a/x-pack/plugin/rank-rrf/src/yamlRestTest/resources/rest-api-spec/test/rrf/200_rank_rrf_script.yml\n+++ b/x-pack/plugin/rank-rrf/src/yamlRestTest/resources/rest-api-spec/test/rrf/200_rank_rrf_script.yml\n@@ -67,7 +67,14 @@ setup:\n ---\n \"RRF using single knn and single BM25 with a scripted metric aggregation\":\n \n+  - requires:\n+      cluster_features: [\"gte_v8.16.0\"]\n+      reason: \"deprecation added in 8.16\"\n+      test_runner_features: warnings\n+\n   - do:\n+      warnings:\n+        - \"Deprecated field [rank] used, replaced by [retriever]\"\n       search:\n         index: test\n         body:\n@@ -140,7 +147,14 @@ setup:\n ---\n \"RRF using multi-knn only with a scripted metric aggregation\":\n \n+  - requires:\n+      cluster_features: [\"gte_v8.16.0\"]\n+      reason: \"deprecation added in 8.16\"\n+      test_runner_features: warnings\n+\n   - do:\n+      warnings:\n+        - \"Deprecated field [rank] used, replaced by [retriever]\"\n       search:\n         index: test\n         body:\n@@ -195,7 +209,14 @@ setup:\n ---\n \"RRF using multi-knn and single BM25 with a scripted metric aggregation\":\n \n+  - requires:\n+      cluster_features: [\"gte_v8.16.0\"]\n+      reason: \"deprecation added in 8.16\"\n+      test_runner_features: warnings\n+\n   - do:\n+      warnings:\n+        - \"Deprecated field [rank] used, replaced by [retriever]\"\n       search:\n         index: test\n         body:\ndiff --git a/x-pack/plugin/rank-rrf/src/yamlRestTest/resources/rest-api-spec/test/rrf/550_rrf_sub_searches_explain.yml b/x-pack/plugin/rank-rrf/src/yamlRestTest/resources/rest-api-spec/test/rrf/550_rrf_sub_searches_explain.yml\nindex 5718cd345552..1b74ffee62a1 100644\n--- a/x-pack/plugin/rank-rrf/src/yamlRestTest/resources/rest-api-spec/test/rrf/550_rrf_sub_searches_explain.yml\n+++ b/x-pack/plugin/rank-rrf/src/yamlRestTest/resources/rest-api-spec/test/rrf/550_rrf_sub_searches_explain.yml\n@@ -75,7 +75,14 @@ setup:\n ---\n \"using a top level knn and query\":\n \n+  - requires:\n+      cluster_features: [\"gte_v8.16.0\"]\n+      reason: \"deprecation added in 8.16\"\n+      test_runner_features: warnings\n+\n   - do:\n+      warnings:\n+        - \"Deprecated field [rank] used, replaced by [retriever]\"\n       search:\n         index: test\n         body:\n@@ -129,7 +136,15 @@ setup:\n ---\n \"using sub_searches\":\n \n+  - requires:\n+      cluster_features: [ \"gte_v8.16.0\" ]\n+      reason: \"deprecation added in 8.16\"\n+      test_runner_features: warnings\n+\n   - do:\n+      warnings:\n+        - \"Deprecated field [rank] used, replaced by [retriever]\"\n+        - Deprecated field [sub_searches] used, replaced by [retriever]\n       search:\n         index: test\n         body:\n@@ -194,7 +209,14 @@ setup:\n ---\n \"using named top level knn and query\":\n \n+  - requires:\n+      cluster_features: [\"gte_v8.16.0\"]\n+      reason: \"deprecation added in 8.16\"\n+      test_runner_features: warnings\n+\n   - do:\n+      warnings:\n+        - \"Deprecated field [rank] used, replaced by [retriever]\"\n       search:\n         index: test\n         body:\n@@ -251,7 +273,15 @@ setup:\n ---\n \"using named sub_searches\":\n \n+  - requires:\n+      cluster_features: [\"gte_v8.16.0\"]\n+      reason: \"deprecation added in 8.16\"\n+      test_runner_features: warnings\n+\n   - do:\n+      warnings:\n+        - \"Deprecated field [rank] used, replaced by [retriever]\"\n+        - Deprecated field [sub_searches] used, replaced by [retriever]\n       search:\n         index: test\n         body:\n@@ -320,7 +350,15 @@ setup:\n ---\n \"using a mix of named and unnamed queries\":\n \n+  - requires:\n+      cluster_features: [\"gte_v8.16.0\"]\n+      reason: \"deprecation added in 8.16\"\n+      test_runner_features: warnings\n+\n   - do:\n+      warnings:\n+        - \"Deprecated field [rank] used, replaced by [retriever]\"\n+        - Deprecated field [sub_searches] used, replaced by [retriever]\n       search:\n         index: test\n         body:\ndiff --git a/x-pack/plugin/rank-rrf/src/yamlRestTest/resources/rest-api-spec/test/rrf/600_rrf_retriever_profile.yml b/x-pack/plugin/rank-rrf/src/yamlRestTest/resources/rest-api-spec/test/rrf/600_rrf_retriever_profile.yml\nindex e34885419c7f..a9ddb4f90292 100644\n--- a/x-pack/plugin/rank-rrf/src/yamlRestTest/resources/rest-api-spec/test/rrf/600_rrf_retriever_profile.yml\n+++ b/x-pack/plugin/rank-rrf/src/yamlRestTest/resources/rest-api-spec/test/rrf/600_rrf_retriever_profile.yml\n@@ -172,7 +172,14 @@ setup:\n ---\n \"using query and dfs knn search\":\n \n+  - requires:\n+      cluster_features: [\"gte_v8.16.0\"]\n+      reason: \"deprecation added in 8.16\"\n+      test_runner_features: warnings\n+\n   - do:\n+      warnings:\n+        - \"Deprecated field [rank] used, replaced by [retriever]\"\n       search:\n         index: test\n         body:",
  "judge_mode": "comparative",
  "judge_model": "openai/claude-sonnet-4-5-20250929",
  "test_label": "v0",
  "agent_results": [
    {
      "runner": "auggie",
      "model": "sonnet4.5",
      "edit_run_id": "a9463435",
      "status": "success",
      "elapsed_ms": 802668,
      "patch_unified": "diff --git a/server/src/main/java/org/elasticsearch/search/builder/SearchSourceBuilder.java b/server/src/main/java/org/elasticsearch/search/builder/SearchSourceBuilder.java\nindex 6d427aac..57fe6f0e 100644\n--- a/server/src/main/java/org/elasticsearch/search/builder/SearchSourceBuilder.java\n+++ b/server/src/main/java/org/elasticsearch/search/builder/SearchSourceBuilder.java\n@@ -19,6 +19,7 @@ import org.elasticsearch.common.ValidationException;\n import org.elasticsearch.common.io.stream.StreamInput;\n import org.elasticsearch.common.io.stream.StreamOutput;\n import org.elasticsearch.common.io.stream.Writeable;\n+import org.elasticsearch.common.logging.DeprecationCategory;\n import org.elasticsearch.common.logging.DeprecationLogger;\n import org.elasticsearch.common.util.CollectionUtils;\n import org.elasticsearch.common.xcontent.XContentHelper;\n@@ -1418,6 +1419,11 @@ public final class SearchSourceBuilder implements Writeable, ToXContentObject, R\n                     if (RANK_SUPPORTED == false) {\n                         throwUnknownKey(parser, token, currentFieldName);\n                     }\n+                    deprecationLogger.warn(\n+                        DeprecationCategory.API,\n+                        \"search_rank_field\",\n+                        \"The [rank] field in the search API is deprecated and will be removed in a future version\"\n+                    );\n                     if (parser.nextToken() != XContentParser.Token.FIELD_NAME) {\n                         throw new ParsingException(\n                             parser.getTokenLocation(),\n@@ -1605,6 +1611,11 @@ public final class SearchSourceBuilder implements Writeable, ToXContentObject, R\n                     if (RANK_SUPPORTED == false) {\n                         throwUnknownKey(parser, token, currentFieldName);\n                     }\n+                    deprecationLogger.warn(\n+                        DeprecationCategory.API,\n+                        \"search_sub_searches_field\",\n+                        \"The [sub_searches] field in the search API is deprecated and will be removed in a future version\"\n+                    );\n                     if (subSearchSourceBuilders.isEmpty() == false) {\n                         throw new IllegalArgumentException(\n                             \"cannot specify field [\" + currentFieldName + \"] and field [\" + QUERY_FIELD.getPreferredName() + \"]\"",
      "scores": {
        "correctness": -0.8,
        "completeness": -0.9,
        "code_reuse": 0.3,
        "best_practices": -0.5,
        "unsolicited_docs": 1.0
      },
      "aggregate": -0.18000000000000002,
      "rationale": "The agent only modified SearchSourceBuilder.java to add manual deprecation warnings using DeprecationLogger, but completely missed the ground truth approach which uses ParseField.withAllDeprecated() for declarative deprecation. The ground truth makes extensive changes across 15+ files including: (1) updating ParseField declarations with withAllDeprecated(), (2) adding changelog YAML, (3) updating test files to remove rank/sub_searches usage, (4) adding deprecation warnings to YAML tests, (5) refactoring constants between RRFRankBuilder and RRFRetrieverBuilder, and (6) adding @Deprecated and @UpdateForV10 annotations. The agent's manual logging approach is less idiomatic than the declarative ParseField approach and misses all test updates, changelog, constant refactoring, and annotations. The manual warnings also won't integrate with Elasticsearch's standard deprecation infrastructure as well as withAllDeprecated().",
      "llm_rating": 0.12,
      "llm_summary": "Added manual DeprecationLogger warnings in SearchSourceBuilder for rank and sub_searches fields but missed the ground truth's declarative ParseField.withAllDeprecated() approach, changelog YAML, test file updates across 8 files, constant refactoring between RRFRankBuilder and RRFRetrieverBuilder, and deprecation annotations.",
      "errors": []
    },
    {
      "runner": "claude-code",
      "model": "claude-sonnet-4-5",
      "edit_run_id": "c7a3f90a",
      "status": "success",
      "elapsed_ms": 178935,
      "patch_unified": "diff --git a/server/src/main/java/org/elasticsearch/search/builder/SearchSourceBuilder.java b/server/src/main/java/org/elasticsearch/search/builder/SearchSourceBuilder.java\nindex 6d427aac..708b025e 100644\n--- a/server/src/main/java/org/elasticsearch/search/builder/SearchSourceBuilder.java\n+++ b/server/src/main/java/org/elasticsearch/search/builder/SearchSourceBuilder.java\n@@ -429,6 +429,12 @@ public final class SearchSourceBuilder implements Writeable, ToXContentObject, R\n      * Sets the sub searches for this request.\n      */\n     public SearchSourceBuilder subSearches(List<SubSearchSourceBuilder> subSearchSourceBuilders) {\n+        deprecationLogger.critical(\n+            DeprecationCategory.API,\n+            \"search_api_sub_searches_field\",\n+            \"The [sub_searches] field in the search request body is deprecated and will be removed in a future version. \"\n+                + \"Use the [retriever] field instead.\"\n+        );\n         Objects.requireNonNull(subSearchSourceBuilders);\n         this.subSearchSourceBuilders = subSearchSourceBuilders;\n         return this;\n@@ -475,6 +481,12 @@ public final class SearchSourceBuilder implements Writeable, ToXContentObject, R\n     }\n \n     public SearchSourceBuilder rankBuilder(RankBuilder rankBuilder) {\n+        deprecationLogger.critical(\n+            DeprecationCategory.API,\n+            \"search_api_rank_field\",\n+            \"The [rank] field in the search request body is deprecated and will be removed in a future version. \"\n+                + \"Use the [retriever] field instead.\"\n+        );\n         this.rankBuilder = rankBuilder;\n         return this;\n     }\n@@ -1418,6 +1430,12 @@ public final class SearchSourceBuilder implements Writeable, ToXContentObject, R\n                     if (RANK_SUPPORTED == false) {\n                         throwUnknownKey(parser, token, currentFieldName);\n                     }\n+                    deprecationLogger.critical(\n+                        DeprecationCategory.API,\n+                        \"search_api_rank_field\",\n+                        \"The [rank] field in the search request body is deprecated and will be removed in a future version. \"\n+                            + \"Use the [retriever] field instead.\"\n+                    );\n                     if (parser.nextToken() != XContentParser.Token.FIELD_NAME) {\n                         throw new ParsingException(\n                             parser.getTokenLocation(),\n@@ -1605,6 +1623,12 @@ public final class SearchSourceBuilder implements Writeable, ToXContentObject, R\n                     if (RANK_SUPPORTED == false) {\n                         throwUnknownKey(parser, token, currentFieldName);\n                     }\n+                    deprecationLogger.critical(\n+                        DeprecationCategory.API,\n+                        \"search_api_sub_searches_field\",\n+                        \"The [sub_searches] field in the search request body is deprecated and will be removed in a future version. \"\n+                            + \"Use the [retriever] field instead.\"\n+                    );\n                     if (subSearchSourceBuilders.isEmpty() == false) {\n                         throw new IllegalArgumentException(\n                             \"cannot specify field [\" + currentFieldName + \"] and field [\" + QUERY_FIELD.getPreferredName() + \"]\"",
      "scores": {
        "correctness": -0.8,
        "completeness": -0.9,
        "code_reuse": 0.3,
        "best_practices": -0.6,
        "unsolicited_docs": 1.0
      },
      "aggregate": -0.2,
      "rationale": "The agent attempted to add deprecation warnings by inserting deprecationLogger calls in SearchSourceBuilder.java, but this approach is fundamentally incorrect. The ground truth uses ParseField.withAllDeprecated() to mark fields as deprecated at the parsing level, which automatically generates proper deprecation headers. The agent's approach: (1) adds runtime logging instead of parse-time warnings, (2) misses the critical ParseField deprecation markers, (3) omits the entire changelog file, (4) removes test code changes that eliminate deprecated API usage, (5) misses updates to RRFRankBuilder deprecation annotation and constant refactoring, (6) omits all YAML test updates with deprecation warnings. The agent only modified 1 file when 11 files needed changes, and used an incorrect deprecation mechanism that won't generate proper HTTP headers.",
      "llm_rating": 0.08,
      "llm_summary": "Added deprecationLogger.critical() calls in SearchSourceBuilder setter and parser methods instead of using ParseField.withAllDeprecated() markers, missing changelog creation, test updates across 10 files, and RRFRankBuilder deprecation annotation.",
      "errors": []
    },
    {
      "runner": "factory",
      "model": "claude-sonnet-4-5-20250929",
      "edit_run_id": "074538b9",
      "status": "success",
      "elapsed_ms": 359307,
      "patch_unified": "diff --git a/server/src/main/java/org/elasticsearch/search/builder/SearchSourceBuilder.java b/server/src/main/java/org/elasticsearch/search/builder/SearchSourceBuilder.java\nindex 6d427aac..f30d773d 100644\n--- a/server/src/main/java/org/elasticsearch/search/builder/SearchSourceBuilder.java\n+++ b/server/src/main/java/org/elasticsearch/search/builder/SearchSourceBuilder.java\n@@ -19,6 +19,7 @@ import org.elasticsearch.common.ValidationException;\n import org.elasticsearch.common.io.stream.StreamInput;\n import org.elasticsearch.common.io.stream.StreamOutput;\n import org.elasticsearch.common.io.stream.Writeable;\n+import org.elasticsearch.common.logging.DeprecationCategory;\n import org.elasticsearch.common.logging.DeprecationLogger;\n import org.elasticsearch.common.util.CollectionUtils;\n import org.elasticsearch.common.xcontent.XContentHelper;\n@@ -1418,6 +1419,12 @@ public final class SearchSourceBuilder implements Writeable, ToXContentObject, R\n                     if (RANK_SUPPORTED == false) {\n                         throwUnknownKey(parser, token, currentFieldName);\n                     }\n+                    deprecationLogger.critical(\n+                        DeprecationCategory.API,\n+                        \"search_rank_field_deprecated\",\n+                        \"The [rank] field in search requests is deprecated and will be removed in a future version. \"\n+                            + \"Please use the [retriever] field instead.\"\n+                    );\n                     if (parser.nextToken() != XContentParser.Token.FIELD_NAME) {\n                         throw new ParsingException(\n                             parser.getTokenLocation(),\n@@ -1605,6 +1612,12 @@ public final class SearchSourceBuilder implements Writeable, ToXContentObject, R\n                     if (RANK_SUPPORTED == false) {\n                         throwUnknownKey(parser, token, currentFieldName);\n                     }\n+                    deprecationLogger.critical(\n+                        DeprecationCategory.API,\n+                        \"search_sub_searches_field_deprecated\",\n+                        \"The [sub_searches] field in search requests is deprecated and will be removed in a future version. \"\n+                            + \"Please use the [retriever] field instead.\"\n+                    );\n                     if (subSearchSourceBuilders.isEmpty() == false) {\n                         throw new IllegalArgumentException(\n                             \"cannot specify field [\" + currentFieldName + \"] and field [\" + QUERY_FIELD.getPreferredName() + \"]\"",
      "scores": {
        "correctness": -0.8,
        "completeness": -0.9,
        "code_reuse": 0.3,
        "best_practices": -0.5,
        "unsolicited_docs": 1.0
      },
      "aggregate": -0.18000000000000002,
      "rationale": "The agent only added manual deprecation logging in SearchSourceBuilder.java instead of using ParseField.withAllDeprecated() as shown in ground truth. This approach is incorrect because: 1) It doesn't leverage Elasticsearch's built-in deprecation mechanism via ParseField, 2) It misses all the test updates needed to handle deprecation warnings (missing 'warnings' sections in YAML tests), 3) It doesn't add the changelog file, 4) It doesn't update test helper methods that were modified in ground truth to remove rank/sub_searches generation, 5) It doesn't add @Deprecated annotation to RRFRankBuilder, 6) It doesn't update constant references from RRFRankBuilder to RRFRetrieverBuilder. The manual logging approach also violates best practices by not using the framework's deprecation system and would not properly integrate with Elasticsearch's deprecation warning infrastructure.",
      "llm_rating": 0.12,
      "llm_summary": "Added manual deprecation logging calls in SearchSourceBuilder.java for rank and sub_searches fields instead of using ParseField.withAllDeprecated() mechanism, missing all test updates, changelog, constant refactoring, and @Deprecated annotation on RRFRankBuilder",
      "errors": []
    }
  ],
  "comparative_analysis": {
    "summary": "All three agents (auggie:sonnet4.5, claude-code:claude-sonnet-4-5, and factory:claude-sonnet-4-5-20250929) took nearly identical approaches, adding deprecation warnings in the parsing logic but missing the critical ParseField deprecation declarations and changelog file. The ground truth solution uses ParseField.withAllDeprecated() for declarative deprecation handling, while all agents manually added deprecationLogger calls in multiple locations.",
    "best_agent": "auggie:sonnet4.5",
    "best_agent_reasoning": "auggie:sonnet4.5 scores marginally better (aggregate -0.18 vs -0.20) due to slightly better best practices score (-0.50 vs -0.60). While all three agents produced functionally similar solutions with the same fundamental issues, auggie:sonnet4.5 used deprecationLogger.warn() instead of deprecationLogger.critical(), which is more appropriate for deprecation warnings. However, all agents missed the core requirement of using ParseField.withAllDeprecated() and failed to create the changelog file.",
    "approach_differences": "The agents showed minimal variation in approach. auggie:sonnet4.5 used deprecationLogger.warn() with DeprecationCategory.API, while both claude-code:claude-sonnet-4-5 and factory:claude-sonnet-4-5-20250929 used deprecationLogger.critical(). All three added deprecation warnings only in the parsing methods (fromXContent), missing the declarative ParseField approach used in the ground truth. None of the agents created the required changelog file (docs/changelog/114854.yaml), added the @UpdateForV10 annotation, or modified the test files. The ground truth solution demonstrates a more maintainable approach using ParseField.withAllDeprecated() that automatically handles deprecation warnings across all usages.",
    "ranking": [
      "auggie:sonnet4.5",
      "factory:claude-sonnet-4-5-20250929",
      "claude-code:claude-sonnet-4-5"
    ]
  },
  "timestamp": "2025-11-06T21:36:33.573797",
  "analysis_run_id": "8428e5d5"
}