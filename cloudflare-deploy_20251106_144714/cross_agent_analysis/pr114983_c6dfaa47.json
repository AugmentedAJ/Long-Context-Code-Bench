{
  "repo_url": "https://github.com/elastic/elasticsearch.git",
  "pr_number": 114983,
  "base_commit": "8e26d18029b66de8e6fa65b6fa1de350ac6ed498",
  "head_commit": "3fe8a7b099f34b651bbf1089f09b6bf901d41518",
  "task_instructions": "You are working on a codebase. Your task is to make the necessary code changes to accomplish the following:\n\nAdd prefilters only once in the compound and text similarity retrievers\n\nThis change ensures that the pre filters are propagated in the downstream retrievers only once. It also removes the ability to extends `explainQuery` in the compound retriever. This is not needed as the rank docs are now responsible for the explanation.\n\nPlease make all necessary code changes to complete this task.",
  "ground_truth_diff": "diff --git a/.buildkite/scripts/dra-workflow.sh b/.buildkite/scripts/dra-workflow.sh\nindex 81b8225e443a..ecfb8088072a 100755\n--- a/.buildkite/scripts/dra-workflow.sh\n+++ b/.buildkite/scripts/dra-workflow.sh\n@@ -22,7 +22,6 @@ if [[ \"$BRANCH\" == \"main\" ]]; then\n fi\n \n ES_VERSION=$(grep elasticsearch build-tools-internal/version.properties | sed \"s/elasticsearch *= *//g\")\n-echo \"ES_VERSION=$ES_VERSION\"\n \n VERSION_SUFFIX=\"\"\n if [[ \"$WORKFLOW\" == \"snapshot\" ]]; then\n@@ -30,10 +29,7 @@ if [[ \"$WORKFLOW\" == \"snapshot\" ]]; then\n fi\n \n BEATS_BUILD_ID=\"$(./.ci/scripts/resolve-dra-manifest.sh beats \"$RM_BRANCH\" \"$ES_VERSION\" \"$WORKFLOW\")\"\n-echo \"BEATS_BUILD_ID=$BEATS_BUILD_ID\"\n-\n ML_CPP_BUILD_ID=\"$(./.ci/scripts/resolve-dra-manifest.sh ml-cpp \"$RM_BRANCH\" \"$ES_VERSION\" \"$WORKFLOW\")\"\n-echo \"ML_CPP_BUILD_ID=$ML_CPP_BUILD_ID\"\n \n LICENSE_KEY_ARG=\"\"\n BUILD_SNAPSHOT_ARG=\"\"\ndiff --git a/docs/reference/inference/inference-apis.asciidoc b/docs/reference/inference/inference-apis.asciidoc\nindex 5cb03d950f68..8fdf8aecc2ae 100644\n--- a/docs/reference/inference/inference-apis.asciidoc\n+++ b/docs/reference/inference/inference-apis.asciidoc\n@@ -21,7 +21,6 @@ the following APIs to manage {infer} models and perform {infer}:\n * <<get-inference-api>>\n * <<post-inference-api>>\n * <<put-inference-api>>\n-* <<update-inference-api>>\n \n [[inference-landscape]]\n .A representation of the Elastic inference landscape\n@@ -40,7 +39,6 @@ include::delete-inference.asciidoc[]\n include::get-inference.asciidoc[]\n include::post-inference.asciidoc[]\n include::put-inference.asciidoc[]\n-include::update-inference.asciidoc[]\n include::service-alibabacloud-ai-search.asciidoc[]\n include::service-amazon-bedrock.asciidoc[]\n include::service-anthropic.asciidoc[]\ndiff --git a/docs/reference/inference/update-inference.asciidoc b/docs/reference/inference/update-inference.asciidoc\ndeleted file mode 100644\nindex 166b002ea45f..000000000000\n--- a/docs/reference/inference/update-inference.asciidoc\n+++ /dev/null\n@@ -1,87 +0,0 @@\n-[role=\"xpack\"]\n-[[update-inference-api]]\n-=== Update inference API\n-\n-experimental[]\n-\n-Updates an {infer} endpoint.\n-\n-IMPORTANT: The {infer} APIs enable you to use certain services, such as built-in {ml} models (ELSER, E5), models uploaded through Eland, Cohere, OpenAI, Azure, Google AI Studio, Google Vertex AI or Hugging Face.\n-For built-in models and models uploaded through Eland, the {infer} APIs offer an alternative way to use and manage trained models.\n-However, if you do not plan to use the {infer} APIs to use these models or if you want to use non-NLP models, use the <<ml-df-trained-models-apis>>.\n-\n-\n-[discrete]\n-[[update-inference-api-request]]\n-==== {api-request-title}\n-\n-`POST _inference/<inference_id>/_update`\n-\n-`POST _inference/<task_type>/<inference_id>/_update`\n-\n-\n-[discrete]\n-[[update-inference-api-prereqs]]\n-==== {api-prereq-title}\n-\n-* Requires the `manage_inference` <<privileges-list-cluster,cluster privilege>> (the built-in inference_admin role grants this privilege)\n-* Requires an existing {infer} endpoint, created by using the <<put-inference-api>>\n-\n-\n-[discrete]\n-[[update-inference-api-desc]]\n-==== {api-description-title}\n-\n-The update inference API enables you to update the task_settings, secrets, and/or num_allocations of an existing {infer} endpoint.\n-\n-To use the update API, you can modify `task_settings`, secrets (within `service_settings`), or `num_allocations`, depending on the specific endpoint service and task_type you've created.\n-To view the updatable `task_settings`, the field names of secrets (specific to each service), and the services where `num_allocations` is applicable (only for the `elasticsearch` service), refer to the following list of services available through the {infer} API.\n-You will find the available task types next to each service name.\n-Click the links to review the service configuration details:\n-\n-* <<infer-service-alibabacloud-ai-search,AlibabaCloud AI Search>> (`completion`, `rerank`, `sparse_embedding`, `text_embedding`)\n-* <<infer-service-amazon-bedrock,Amazon Bedrock>> (`completion`, `text_embedding`)\n-* <<infer-service-anthropic,Anthropic>> (`completion`)\n-* <<infer-service-azure-ai-studio,Azure AI Studio>> (`completion`, `text_embedding`)\n-* <<infer-service-azure-openai,Azure OpenAI>> (`completion`, `text_embedding`)\n-* <<infer-service-cohere,Cohere>> (`completion`, `rerank`, `text_embedding`)\n-* <<infer-service-elasticsearch,Elasticsearch>> (`rerank`, `sparse_embedding`, `text_embedding` - this service is for built-in models and models uploaded through Eland)\n-* <<infer-service-elser,ELSER>> (`sparse_embedding`)\n-* <<infer-service-google-ai-studio,Google AI Studio>> (`completion`, `text_embedding`)\n-* <<infer-service-google-vertex-ai,Google Vertex AI>> (`rerank`, `text_embedding`) \n-* <<infer-service-hugging-face,Hugging Face>> (`text_embedding`)\n-* <<infer-service-mistral,Mistral>> (`text_embedding`)\n-* <<infer-service-openai,OpenAI>> (`completion`, `text_embedding`)\n-\n-\n-[discrete]\n-[[update-inference-api-path-params]]\n-==== {api-path-parms-title}\n-\n-`<inference_id>`::\n-(Required, string)\n-The unique identifier of the {infer} endpoint.\n-\n-\n-`<task_type>`::\n-(Optional, string)\n-The type of {infer} task that the model performs.\n-Refer to the service list in the <<put-inference-api-desc,API description section>> for the available task types.\n-\n-\n-[discrete]\n-[[update-inference-api-example]]\n-==== {api-examples-title}\n-\n-The following example shows how to update an API key of an {infer} endpoint called `my-inference-endpoint`:\n-\n-[source,console]\n-------------------------------------------------------------\n-POST _inference/my-inference-endpoint/_update\n-{\n- \"service_settings\": {\n-   \"api_key\": \"<API_KEY>\"\n- }\n-}\n-------------------------------------------------------------\n-// TEST[skip:TBD]\ndiff --git a/muted-tests.yml b/muted-tests.yml\nindex 4cabd2a91251..2e623fa94e06 100644\n--- a/muted-tests.yml\n+++ b/muted-tests.yml\n@@ -306,18 +306,57 @@ tests:\n - class: org.elasticsearch.smoketest.DocsClientYamlTestSuiteIT\n   method: test {yaml=reference/rest-api/usage/line_38}\n   issue: https://github.com/elastic/elasticsearch/issues/113694\n+- class: org.elasticsearch.xpack.enrich.EnrichRestIT\n+  method: test {p0=enrich/10_basic/Test using the deprecated elasticsearch_version field results in a warning}\n+  issue: https://github.com/elastic/elasticsearch/issues/114748\n - class: org.elasticsearch.xpack.eql.EqlRestIT\n   method: testIndexWildcardPatterns\n   issue: https://github.com/elastic/elasticsearch/issues/114749\n+- class: org.elasticsearch.xpack.eql.EqlRestIT\n+  method: testBadRequests\n+  issue: https://github.com/elastic/elasticsearch/issues/114752\n+- class: org.elasticsearch.xpack.enrich.EnrichRestIT\n+  method: test {p0=enrich/20_standard_index/enrich stats REST response structure}\n+  issue: https://github.com/elastic/elasticsearch/issues/114753\n+- class: org.elasticsearch.xpack.enrich.EnrichRestIT\n+  method: test {p0=enrich/30_tsdb_index/enrich documents over _bulk}\n+  issue: https://github.com/elastic/elasticsearch/issues/114761\n+- class: org.elasticsearch.xpack.enrich.EnrichRestIT\n+  method: test {p0=enrich/20_standard_index/enrich documents over _bulk via an alias}\n+  issue: https://github.com/elastic/elasticsearch/issues/114763\n+- class: org.elasticsearch.xpack.enrich.EnrichRestIT\n+  method: test {p0=enrich/10_basic/Test enrich crud apis}\n+  issue: https://github.com/elastic/elasticsearch/issues/114766\n+- class: org.elasticsearch.xpack.enrich.EnrichRestIT\n+  method: test {p0=enrich/20_standard_index/enrich documents over _bulk}\n+  issue: https://github.com/elastic/elasticsearch/issues/114768\n+- class: org.elasticsearch.xpack.enrich.EnrichRestIT\n+  method: test {p0=enrich/50_data_stream/enrich documents over _bulk via a data stream}\n+  issue: https://github.com/elastic/elasticsearch/issues/114769\n+- class: org.elasticsearch.xpack.eql.EqlRestValidationIT\n+  method: testDefaultIndicesOptions\n+  issue: https://github.com/elastic/elasticsearch/issues/114771\n - class: org.elasticsearch.xpack.enrich.EnrichIT\n   method: testEnrichSpecialTypes\n   issue: https://github.com/elastic/elasticsearch/issues/114773\n - class: org.elasticsearch.xpack.security.operator.OperatorPrivilegesIT\n   method: testEveryActionIsEitherOperatorOnlyOrNonOperator\n   issue: https://github.com/elastic/elasticsearch/issues/102992\n+- class: org.elasticsearch.xpack.enrich.EnrichIT\n+  method: testDeleteExistingPipeline\n+  issue: https://github.com/elastic/elasticsearch/issues/114775\n - class: org.elasticsearch.xpack.inference.rest.ServerSentEventsRestActionListenerTests\n   method: testNoStream\n   issue: https://github.com/elastic/elasticsearch/issues/114788\n+- class: org.elasticsearch.xpack.eql.EqlRestValidationIT\n+  method: testAllowNoIndicesOption\n+  issue: https://github.com/elastic/elasticsearch/issues/114789\n+- class: org.elasticsearch.xpack.eql.EqlStatsIT\n+  method: testEqlRestUsage\n+  issue: https://github.com/elastic/elasticsearch/issues/114790\n+- class: org.elasticsearch.xpack.eql.EqlRestIT\n+  method: testUnicodeChars\n+  issue: https://github.com/elastic/elasticsearch/issues/114791\n - class: org.elasticsearch.ingest.geoip.HttpClientTests\n   issue: https://github.com/elastic/elasticsearch/issues/112618\n - class: org.elasticsearch.xpack.remotecluster.RemoteClusterSecurityWithApmTracingRestIT\ndiff --git a/server/src/main/java/org/elasticsearch/index/IndexSettings.java b/server/src/main/java/org/elasticsearch/index/IndexSettings.java\nindex 25e9c1e3701f..347b44a22e7c 100644\n--- a/server/src/main/java/org/elasticsearch/index/IndexSettings.java\n+++ b/server/src/main/java/org/elasticsearch/index/IndexSettings.java\n@@ -30,7 +30,6 @@ import org.elasticsearch.index.mapper.IgnoredSourceFieldMapper;\n import org.elasticsearch.index.mapper.Mapper;\n import org.elasticsearch.index.mapper.SourceFieldMapper;\n import org.elasticsearch.index.translog.Translog;\n-import org.elasticsearch.indices.recovery.RecoverySettings;\n import org.elasticsearch.ingest.IngestService;\n import org.elasticsearch.node.Node;\n \n@@ -831,7 +830,6 @@ public final class IndexSettings {\n     private volatile boolean skipIgnoredSourceRead;\n     private volatile boolean syntheticSourceSecondDocParsingPassEnabled;\n     private final SourceFieldMapper.Mode indexMappingSourceMode;\n-    private final boolean recoverySourceEnabled;\n \n     /**\n      * The maximum number of refresh listeners allows on this shard.\n@@ -994,7 +992,6 @@ public final class IndexSettings {\n         skipIgnoredSourceRead = scopedSettings.get(IgnoredSourceFieldMapper.SKIP_IGNORED_SOURCE_READ_SETTING);\n         syntheticSourceSecondDocParsingPassEnabled = scopedSettings.get(SYNTHETIC_SOURCE_SECOND_DOC_PARSING_PASS_SETTING);\n         indexMappingSourceMode = scopedSettings.get(SourceFieldMapper.INDEX_MAPPER_SOURCE_MODE_SETTING);\n-        recoverySourceEnabled = RecoverySettings.INDICES_RECOVERY_SOURCE_ENABLED_SETTING.get(nodeSettings);\n \n         scopedSettings.addSettingsUpdateConsumer(\n             MergePolicyConfig.INDEX_COMPOUND_FORMAT_SETTING,\n@@ -1690,14 +1687,6 @@ public final class IndexSettings {\n         return indexMappingSourceMode;\n     }\n \n-    /**\n-     * @return Whether recovery source should be enabled if needed.\n-     *         Note that this is a node setting, and this setting is not sourced from index settings.\n-     */\n-    public boolean isRecoverySourceEnabled() {\n-        return recoverySourceEnabled;\n-    }\n-\n     /**\n      * The bounds for {@code @timestamp} on this index or\n      * {@code null} if there are no bounds.\ndiff --git a/server/src/main/java/org/elasticsearch/index/mapper/SourceFieldMapper.java b/server/src/main/java/org/elasticsearch/index/mapper/SourceFieldMapper.java\nindex dd09dc6ea0c5..ea1ffdb7c019 100644\n--- a/server/src/main/java/org/elasticsearch/index/mapper/SourceFieldMapper.java\n+++ b/server/src/main/java/org/elasticsearch/index/mapper/SourceFieldMapper.java\n@@ -39,6 +39,8 @@ import java.util.Collections;\n import java.util.List;\n import java.util.Locale;\n \n+import static org.elasticsearch.indices.recovery.RecoverySettings.INDICES_RECOVERY_SOURCE_ENABLED_SETTING;\n+\n public class SourceFieldMapper extends MetadataFieldMapper {\n     public static final NodeFeature SYNTHETIC_SOURCE_FALLBACK = new NodeFeature(\"mapper.source.synthetic_source_fallback\");\n     public static final NodeFeature SYNTHETIC_SOURCE_STORED_FIELDS_ADVANCE_FIX = new NodeFeature(\n@@ -82,7 +84,8 @@ public class SourceFieldMapper extends MetadataFieldMapper {\n         Explicit.IMPLICIT_TRUE,\n         Strings.EMPTY_ARRAY,\n         Strings.EMPTY_ARRAY,\n-        null\n+        null,\n+        true\n     );\n \n     private static final SourceFieldMapper DEFAULT_DISABLED = new SourceFieldMapper(\n@@ -90,7 +93,17 @@ public class SourceFieldMapper extends MetadataFieldMapper {\n         Explicit.IMPLICIT_TRUE,\n         Strings.EMPTY_ARRAY,\n         Strings.EMPTY_ARRAY,\n-        null\n+        null,\n+        true\n+    );\n+\n+    private static final SourceFieldMapper DEFAULT_DISABLED_NO_RECOVERY_SOURCE = new SourceFieldMapper(\n+        Mode.DISABLED,\n+        Explicit.IMPLICIT_TRUE,\n+        Strings.EMPTY_ARRAY,\n+        Strings.EMPTY_ARRAY,\n+        null,\n+        false\n     );\n \n     private static final SourceFieldMapper DEFAULT_SYNTHETIC = new SourceFieldMapper(\n@@ -98,7 +111,26 @@ public class SourceFieldMapper extends MetadataFieldMapper {\n         Explicit.IMPLICIT_TRUE,\n         Strings.EMPTY_ARRAY,\n         Strings.EMPTY_ARRAY,\n-        null\n+        null,\n+        true\n+    );\n+\n+    private static final SourceFieldMapper DEFAULT_SYNTHETIC_NO_RECOVERY_SOURCE = new SourceFieldMapper(\n+        Mode.SYNTHETIC,\n+        Explicit.IMPLICIT_TRUE,\n+        Strings.EMPTY_ARRAY,\n+        Strings.EMPTY_ARRAY,\n+        null,\n+        false\n+    );\n+\n+    private static final SourceFieldMapper DEFAULT_NO_RECOVERY_SOURCE = new SourceFieldMapper(\n+        null,\n+        Explicit.IMPLICIT_TRUE,\n+        Strings.EMPTY_ARRAY,\n+        Strings.EMPTY_ARRAY,\n+        null,\n+        false\n     );\n \n     private static final SourceFieldMapper TSDB_DEFAULT = new SourceFieldMapper(\n@@ -106,7 +138,8 @@ public class SourceFieldMapper extends MetadataFieldMapper {\n         Explicit.IMPLICIT_TRUE,\n         Strings.EMPTY_ARRAY,\n         Strings.EMPTY_ARRAY,\n-        IndexMode.TIME_SERIES\n+        IndexMode.TIME_SERIES,\n+        true\n     );\n \n     private static final SourceFieldMapper TSDB_DEFAULT_STORED = new SourceFieldMapper(\n@@ -114,7 +147,26 @@ public class SourceFieldMapper extends MetadataFieldMapper {\n         Explicit.IMPLICIT_TRUE,\n         Strings.EMPTY_ARRAY,\n         Strings.EMPTY_ARRAY,\n-        IndexMode.TIME_SERIES\n+        IndexMode.TIME_SERIES,\n+        true\n+    );\n+\n+    private static final SourceFieldMapper TSDB_DEFAULT_NO_RECOVERY_SOURCE = new SourceFieldMapper(\n+        Mode.SYNTHETIC,\n+        Explicit.IMPLICIT_TRUE,\n+        Strings.EMPTY_ARRAY,\n+        Strings.EMPTY_ARRAY,\n+        IndexMode.TIME_SERIES,\n+        false\n+    );\n+\n+    private static final SourceFieldMapper TSDB_DEFAULT_NO_RECOVERY_SOURCE_STORED = new SourceFieldMapper(\n+        Mode.STORED,\n+        Explicit.IMPLICIT_TRUE,\n+        Strings.EMPTY_ARRAY,\n+        Strings.EMPTY_ARRAY,\n+        IndexMode.TIME_SERIES,\n+        false\n     );\n \n     private static final SourceFieldMapper LOGSDB_DEFAULT = new SourceFieldMapper(\n@@ -122,7 +174,8 @@ public class SourceFieldMapper extends MetadataFieldMapper {\n         Explicit.IMPLICIT_TRUE,\n         Strings.EMPTY_ARRAY,\n         Strings.EMPTY_ARRAY,\n-        IndexMode.LOGSDB\n+        IndexMode.LOGSDB,\n+        true\n     );\n \n     private static final SourceFieldMapper LOGSDB_DEFAULT_STORED = new SourceFieldMapper(\n@@ -130,7 +183,26 @@ public class SourceFieldMapper extends MetadataFieldMapper {\n         Explicit.IMPLICIT_TRUE,\n         Strings.EMPTY_ARRAY,\n         Strings.EMPTY_ARRAY,\n-        IndexMode.LOGSDB\n+        IndexMode.LOGSDB,\n+        true\n+    );\n+\n+    private static final SourceFieldMapper LOGSDB_DEFAULT_NO_RECOVERY_SOURCE = new SourceFieldMapper(\n+        Mode.SYNTHETIC,\n+        Explicit.IMPLICIT_TRUE,\n+        Strings.EMPTY_ARRAY,\n+        Strings.EMPTY_ARRAY,\n+        IndexMode.LOGSDB,\n+        false\n+    );\n+\n+    private static final SourceFieldMapper LOGSDB_DEFAULT_NO_RECOVERY_SOURCE_STORED = new SourceFieldMapper(\n+        Mode.STORED,\n+        Explicit.IMPLICIT_TRUE,\n+        Strings.EMPTY_ARRAY,\n+        Strings.EMPTY_ARRAY,\n+        IndexMode.LOGSDB,\n+        false\n     );\n \n     /*\n@@ -142,7 +214,17 @@ public class SourceFieldMapper extends MetadataFieldMapper {\n         Explicit.IMPLICIT_TRUE,\n         Strings.EMPTY_ARRAY,\n         Strings.EMPTY_ARRAY,\n-        IndexMode.TIME_SERIES\n+        IndexMode.TIME_SERIES,\n+        true\n+    );\n+\n+    private static final SourceFieldMapper TSDB_LEGACY_DEFAULT_NO_RECOVERY_SOURCE = new SourceFieldMapper(\n+        null,\n+        Explicit.IMPLICIT_TRUE,\n+        Strings.EMPTY_ARRAY,\n+        Strings.EMPTY_ARRAY,\n+        IndexMode.TIME_SERIES,\n+        false\n     );\n \n     public static class Defaults {\n@@ -203,12 +285,20 @@ public class SourceFieldMapper extends MetadataFieldMapper {\n \n         private final boolean supportsNonDefaultParameterValues;\n \n-        public Builder(IndexMode indexMode, final Settings settings, boolean supportsCheckForNonDefaultParams) {\n+        private final boolean enableRecoverySource;\n+\n+        public Builder(\n+            IndexMode indexMode,\n+            final Settings settings,\n+            boolean supportsCheckForNonDefaultParams,\n+            boolean enableRecoverySource\n+        ) {\n             super(Defaults.NAME);\n             this.settings = settings;\n             this.indexMode = indexMode;\n             this.supportsNonDefaultParameterValues = supportsCheckForNonDefaultParams == false\n                 || settings.getAsBoolean(LOSSY_PARAMETERS_ALLOWED_SETTING_NAME, true);\n+            this.enableRecoverySource = enableRecoverySource;\n         }\n \n         public Builder setSynthetic() {\n@@ -243,7 +333,7 @@ public class SourceFieldMapper extends MetadataFieldMapper {\n                 ? INDEX_MAPPER_SOURCE_MODE_SETTING.get(settings)\n                 : mode.get();\n             if (isDefault(sourceMode)) {\n-                return resolveSourceMode(indexMode, sourceMode == null ? Mode.STORED : sourceMode);\n+                return resolveSourceMode(indexMode, sourceMode == null ? Mode.STORED : sourceMode, enableRecoverySource);\n \n             }\n             if (supportsNonDefaultParameterValues == false) {\n@@ -274,7 +364,8 @@ public class SourceFieldMapper extends MetadataFieldMapper {\n                 enabled.get(),\n                 includes.getValue().toArray(Strings.EMPTY_ARRAY),\n                 excludes.getValue().toArray(Strings.EMPTY_ARRAY),\n-                indexMode\n+                indexMode,\n+                enableRecoverySource\n             );\n             if (indexMode != null) {\n                 indexMode.validateSourceFieldMapper(sourceFieldMapper);\n@@ -284,16 +375,16 @@ public class SourceFieldMapper extends MetadataFieldMapper {\n \n     }\n \n-    private static SourceFieldMapper resolveSourceMode(final IndexMode indexMode, final Mode sourceMode) {\n+    private static SourceFieldMapper resolveSourceMode(final IndexMode indexMode, final Mode sourceMode, boolean enableRecoverySource) {\n         switch (indexMode) {\n             case STANDARD:\n                 switch (sourceMode) {\n                     case SYNTHETIC:\n-                        return DEFAULT_SYNTHETIC;\n+                        return enableRecoverySource ? DEFAULT_SYNTHETIC : DEFAULT_SYNTHETIC_NO_RECOVERY_SOURCE;\n                     case STORED:\n-                        return DEFAULT;\n+                        return enableRecoverySource ? DEFAULT : DEFAULT_NO_RECOVERY_SOURCE;\n                     case DISABLED:\n-                        return DEFAULT_DISABLED;\n+                        return enableRecoverySource ? DEFAULT_DISABLED : DEFAULT_DISABLED_NO_RECOVERY_SOURCE;\n                     default:\n                         throw new IllegalArgumentException(\"Unsupported source mode: \" + sourceMode);\n                 }\n@@ -301,9 +392,15 @@ public class SourceFieldMapper extends MetadataFieldMapper {\n             case LOGSDB:\n                 switch (sourceMode) {\n                     case SYNTHETIC:\n-                        return indexMode == IndexMode.TIME_SERIES ? TSDB_DEFAULT : LOGSDB_DEFAULT;\n+                        return enableRecoverySource\n+                            ? (indexMode == IndexMode.TIME_SERIES ? TSDB_DEFAULT : LOGSDB_DEFAULT)\n+                            : (indexMode == IndexMode.TIME_SERIES ? TSDB_DEFAULT_NO_RECOVERY_SOURCE : LOGSDB_DEFAULT_NO_RECOVERY_SOURCE);\n                     case STORED:\n-                        return indexMode == IndexMode.TIME_SERIES ? TSDB_DEFAULT_STORED : LOGSDB_DEFAULT_STORED;\n+                        return enableRecoverySource\n+                            ? (indexMode == IndexMode.TIME_SERIES ? TSDB_DEFAULT_STORED : LOGSDB_DEFAULT_STORED)\n+                            : (indexMode == IndexMode.TIME_SERIES\n+                                ? TSDB_DEFAULT_NO_RECOVERY_SOURCE_STORED\n+                                : LOGSDB_DEFAULT_NO_RECOVERY_SOURCE_STORED);\n                     case DISABLED:\n                         throw new IllegalArgumentException(\"_source can not be disabled in index using [\" + indexMode + \"] index mode\");\n                     default:\n@@ -316,19 +413,21 @@ public class SourceFieldMapper extends MetadataFieldMapper {\n \n     public static final TypeParser PARSER = new ConfigurableTypeParser(c -> {\n         final IndexMode indexMode = c.getIndexSettings().getMode();\n+        boolean enableRecoverySource = INDICES_RECOVERY_SOURCE_ENABLED_SETTING.get(c.getSettings());\n         final Mode settingSourceMode = INDEX_MAPPER_SOURCE_MODE_SETTING.get(c.getSettings());\n \n         if (indexMode.isSyntheticSourceEnabled()) {\n             if (indexMode == IndexMode.TIME_SERIES && c.getIndexSettings().getIndexVersionCreated().before(IndexVersions.V_8_7_0)) {\n-                return TSDB_LEGACY_DEFAULT;\n+                return enableRecoverySource ? TSDB_LEGACY_DEFAULT : TSDB_LEGACY_DEFAULT_NO_RECOVERY_SOURCE;\n             }\n         }\n-        return resolveSourceMode(indexMode, settingSourceMode == null ? Mode.STORED : settingSourceMode);\n+        return resolveSourceMode(indexMode, settingSourceMode == null ? Mode.STORED : settingSourceMode, enableRecoverySource);\n     },\n         c -> new Builder(\n             c.getIndexSettings().getMode(),\n             c.getSettings(),\n-            c.indexVersionCreated().onOrAfter(IndexVersions.SOURCE_MAPPER_LOSSY_PARAMS_CHECK)\n+            c.indexVersionCreated().onOrAfter(IndexVersions.SOURCE_MAPPER_LOSSY_PARAMS_CHECK),\n+            INDICES_RECOVERY_SOURCE_ENABLED_SETTING.get(c.getSettings())\n         )\n     );\n \n@@ -381,8 +480,16 @@ public class SourceFieldMapper extends MetadataFieldMapper {\n     private final SourceFilter sourceFilter;\n \n     private final IndexMode indexMode;\n-\n-    private SourceFieldMapper(Mode mode, Explicit<Boolean> enabled, String[] includes, String[] excludes, IndexMode indexMode) {\n+    private final boolean enableRecoverySource;\n+\n+    private SourceFieldMapper(\n+        Mode mode,\n+        Explicit<Boolean> enabled,\n+        String[] includes,\n+        String[] excludes,\n+        IndexMode indexMode,\n+        boolean enableRecoverySource\n+    ) {\n         super(new SourceFieldType((enabled.explicit() && enabled.value()) || (enabled.explicit() == false && mode != Mode.DISABLED)));\n         assert enabled.explicit() == false || mode == null;\n         this.mode = mode;\n@@ -395,6 +502,7 @@ public class SourceFieldMapper extends MetadataFieldMapper {\n         }\n         this.complete = stored() && sourceFilter == null;\n         this.indexMode = indexMode;\n+        this.enableRecoverySource = enableRecoverySource;\n     }\n \n     private static SourceFilter buildSourceFilter(String[] includes, String[] excludes) {\n@@ -439,7 +547,6 @@ public class SourceFieldMapper extends MetadataFieldMapper {\n             context.doc().add(new StoredField(fieldType().name(), ref.bytes, ref.offset, ref.length));\n         }\n \n-        boolean enableRecoverySource = context.indexSettings().isRecoverySourceEnabled();\n         if (enableRecoverySource && originalSource != null && adaptedSource != originalSource) {\n             // if we omitted source or modified it we add the _recovery_source to ensure we have it for ops based recovery\n             BytesRef ref = originalSource.toBytesRef();\n@@ -468,7 +575,7 @@ public class SourceFieldMapper extends MetadataFieldMapper {\n \n     @Override\n     public FieldMapper.Builder getMergeBuilder() {\n-        return new Builder(indexMode, Settings.EMPTY, false).init(this);\n+        return new Builder(indexMode, Settings.EMPTY, false, enableRecoverySource).init(this);\n     }\n \n     /**\ndiff --git a/server/src/main/java/org/elasticsearch/search/retriever/CompoundRetrieverBuilder.java b/server/src/main/java/org/elasticsearch/search/retriever/CompoundRetrieverBuilder.java\nindex e994c55e4345..85dabf6eb646 100644\n--- a/server/src/main/java/org/elasticsearch/search/retriever/CompoundRetrieverBuilder.java\n+++ b/server/src/main/java/org/elasticsearch/search/retriever/CompoundRetrieverBuilder.java\n@@ -18,7 +18,6 @@ import org.elasticsearch.action.search.MultiSearchResponse;\n import org.elasticsearch.action.search.SearchRequest;\n import org.elasticsearch.action.search.SearchResponse;\n import org.elasticsearch.action.search.TransportMultiSearchAction;\n-import org.elasticsearch.index.query.BoolQueryBuilder;\n import org.elasticsearch.index.query.QueryBuilder;\n import org.elasticsearch.index.query.QueryRewriteContext;\n import org.elasticsearch.search.builder.PointInTimeBuilder;\n@@ -163,6 +162,11 @@ public abstract class CompoundRetrieverBuilder<T extends CompoundRetrieverBuilde\n         throw new IllegalStateException(\"Should not be called, missing a rewrite?\");\n     }\n \n+    @Override\n+    public final QueryBuilder explainQuery() {\n+        throw new IllegalStateException(\"Should not be called, missing a rewrite?\");\n+    }\n+\n     @Override\n     public final void extractToSearchSourceBuilder(SearchSourceBuilder searchSourceBuilder, boolean compoundUsed) {\n         throw new IllegalStateException(\"Should not be called, missing a rewrite?\");\n@@ -216,22 +220,12 @@ public abstract class CompoundRetrieverBuilder<T extends CompoundRetrieverBuilde\n             .trackTotalHits(false)\n             .storedFields(new StoredFieldsContext(false))\n             .size(rankWindowSize);\n+        // apply the pre-filters downstream once\n         if (preFilterQueryBuilders.isEmpty() == false) {\n             retrieverBuilder.getPreFilterQueryBuilders().addAll(preFilterQueryBuilders);\n         }\n         retrieverBuilder.extractToSearchSourceBuilder(sourceBuilder, true);\n \n-        // apply the pre-filters\n-        if (preFilterQueryBuilders.size() > 0) {\n-            QueryBuilder query = sourceBuilder.query();\n-            BoolQueryBuilder newQuery = new BoolQueryBuilder();\n-            if (query != null) {\n-                newQuery.must(query);\n-            }\n-            preFilterQueryBuilders.forEach(newQuery::filter);\n-            sourceBuilder.query(newQuery);\n-        }\n-\n         // Record the shard id in the sort result\n         List<SortBuilder<?>> sortBuilders = sourceBuilder.sorts() != null ? new ArrayList<>(sourceBuilder.sorts()) : new ArrayList<>();\n         if (sortBuilders.isEmpty()) {\ndiff --git a/server/src/test/java/org/elasticsearch/index/mapper/DynamicFieldsBuilderTests.java b/server/src/test/java/org/elasticsearch/index/mapper/DynamicFieldsBuilderTests.java\nindex 399740e6200e..358ad0766487 100644\n--- a/server/src/test/java/org/elasticsearch/index/mapper/DynamicFieldsBuilderTests.java\n+++ b/server/src/test/java/org/elasticsearch/index/mapper/DynamicFieldsBuilderTests.java\n@@ -69,7 +69,7 @@ public class DynamicFieldsBuilderTests extends ESTestCase {\n         XContentParser parser = createParser(JsonXContent.jsonXContent, source);\n         SourceToParse sourceToParse = new SourceToParse(\"test\", new BytesArray(source), XContentType.JSON);\n \n-        SourceFieldMapper sourceMapper = new SourceFieldMapper.Builder(null, Settings.EMPTY, false).setSynthetic().build();\n+        SourceFieldMapper sourceMapper = new SourceFieldMapper.Builder(null, Settings.EMPTY, false, true).setSynthetic().build();\n         RootObjectMapper root = new RootObjectMapper.Builder(\"_doc\", Optional.empty()).add(\n             new PassThroughObjectMapper.Builder(\"labels\").setPriority(0).setContainsDimensions().dynamic(ObjectMapper.Dynamic.TRUE)\n         ).build(MapperBuilderContext.root(false, false));\ndiff --git a/server/src/test/java/org/elasticsearch/index/query/SearchExecutionContextTests.java b/server/src/test/java/org/elasticsearch/index/query/SearchExecutionContextTests.java\nindex fdc18264e229..658176b1d31d 100644\n--- a/server/src/test/java/org/elasticsearch/index/query/SearchExecutionContextTests.java\n+++ b/server/src/test/java/org/elasticsearch/index/query/SearchExecutionContextTests.java\n@@ -384,7 +384,7 @@ public class SearchExecutionContextTests extends ESTestCase {\n \n     public void testSyntheticSourceSearchLookup() throws IOException {\n         // Build a mapping using synthetic source\n-        SourceFieldMapper sourceMapper = new SourceFieldMapper.Builder(null, Settings.EMPTY, false).setSynthetic().build();\n+        SourceFieldMapper sourceMapper = new SourceFieldMapper.Builder(null, Settings.EMPTY, false, true).setSynthetic().build();\n         RootObjectMapper root = new RootObjectMapper.Builder(\"_doc\", Optional.empty()).add(\n             new KeywordFieldMapper.Builder(\"cat\", IndexVersion.current()).ignoreAbove(100)\n         ).build(MapperBuilderContext.root(true, false));\ndiff --git a/test/framework/src/main/java/org/elasticsearch/test/rest/ESRestTestCase.java b/test/framework/src/main/java/org/elasticsearch/test/rest/ESRestTestCase.java\nindex e5b23158d4fd..d17016f85030 100644\n--- a/test/framework/src/main/java/org/elasticsearch/test/rest/ESRestTestCase.java\n+++ b/test/framework/src/main/java/org/elasticsearch/test/rest/ESRestTestCase.java\n@@ -1121,8 +1121,6 @@ public abstract class ESRestTestCase extends ESTestCase {\n             if (preserveSecurityIndices) {\n                 indexPatterns.add(\"-.security-*\");\n             }\n-            // always preserve inference index\n-            indexPatterns.add(\"-.inference\");\n             final Request deleteRequest = new Request(\"DELETE\", Strings.collectionToCommaDelimitedString(indexPatterns));\n             deleteRequest.addParameter(\"expand_wildcards\", \"open,closed,hidden\");\n             final Response response = adminClient().performRequest(deleteRequest);\ndiff --git a/x-pack/plugin/inference/src/main/java/org/elasticsearch/xpack/inference/rank/textsimilarity/TextSimilarityRankRetrieverBuilder.java b/x-pack/plugin/inference/src/main/java/org/elasticsearch/xpack/inference/rank/textsimilarity/TextSimilarityRankRetrieverBuilder.java\nindex 8bccf6e7d102..342199dc51db 100644\n--- a/x-pack/plugin/inference/src/main/java/org/elasticsearch/xpack/inference/rank/textsimilarity/TextSimilarityRankRetrieverBuilder.java\n+++ b/x-pack/plugin/inference/src/main/java/org/elasticsearch/xpack/inference/rank/textsimilarity/TextSimilarityRankRetrieverBuilder.java\n@@ -10,7 +10,6 @@ package org.elasticsearch.xpack.inference.rank.textsimilarity;\n import org.apache.lucene.search.ScoreDoc;\n import org.elasticsearch.common.ParsingException;\n import org.elasticsearch.features.NodeFeature;\n-import org.elasticsearch.index.query.BoolQueryBuilder;\n import org.elasticsearch.index.query.QueryBuilder;\n import org.elasticsearch.license.LicenseUtils;\n import org.elasticsearch.search.builder.PointInTimeBuilder;\n@@ -20,7 +19,6 @@ import org.elasticsearch.search.rank.RankDoc;\n import org.elasticsearch.search.retriever.CompoundRetrieverBuilder;\n import org.elasticsearch.search.retriever.RetrieverBuilder;\n import org.elasticsearch.search.retriever.RetrieverParserContext;\n-import org.elasticsearch.search.retriever.rankdoc.RankDocsQueryBuilder;\n import org.elasticsearch.xcontent.ConstructingObjectParser;\n import org.elasticsearch.xcontent.ParseField;\n import org.elasticsearch.xcontent.XContentBuilder;\n@@ -158,33 +156,18 @@ public class TextSimilarityRankRetrieverBuilder extends CompoundRetrieverBuilder\n         return textSimilarityRankDocs;\n     }\n \n-    @Override\n-    public QueryBuilder explainQuery() {\n-        // the original matching set of the TextSimilarityRank retriever is specified by its nested retriever\n-        return new RankDocsQueryBuilder(rankDocs, new QueryBuilder[] { innerRetrievers.getFirst().retriever().explainQuery() }, true);\n-    }\n-\n     @Override\n     protected SearchSourceBuilder createSearchSourceBuilder(PointInTimeBuilder pit, RetrieverBuilder retrieverBuilder) {\n         var sourceBuilder = new SearchSourceBuilder().pointInTimeBuilder(pit)\n             .trackTotalHits(false)\n             .storedFields(new StoredFieldsContext(false))\n             .size(rankWindowSize);\n+        // apply the pre-filters downstream once\n         if (preFilterQueryBuilders.isEmpty() == false) {\n             retrieverBuilder.getPreFilterQueryBuilders().addAll(preFilterQueryBuilders);\n         }\n         retrieverBuilder.extractToSearchSourceBuilder(sourceBuilder, true);\n \n-        // apply the pre-filters\n-        if (preFilterQueryBuilders.size() > 0) {\n-            QueryBuilder query = sourceBuilder.query();\n-            BoolQueryBuilder newQuery = new BoolQueryBuilder();\n-            if (query != null) {\n-                newQuery.must(query);\n-            }\n-            preFilterQueryBuilders.forEach(newQuery::filter);\n-            sourceBuilder.query(newQuery);\n-        }\n         sourceBuilder.rankBuilder(\n             new TextSimilarityRankBuilder(this.field, this.inferenceId, this.inferenceText, this.rankWindowSize, this.minScore)\n         );",
  "judge_mode": "comparative",
  "judge_model": "openai/claude-sonnet-4-5-20250929",
  "test_label": "v0",
  "agent_results": [
    {
      "runner": "auggie",
      "model": "sonnet4.5",
      "edit_run_id": "a9463435",
      "status": "success",
      "elapsed_ms": 636915,
      "patch_unified": "diff --git a/server/src/main/java/org/elasticsearch/search/retriever/CompoundRetrieverBuilder.java b/server/src/main/java/org/elasticsearch/search/retriever/CompoundRetrieverBuilder.java\nindex e994c55e..a6cd6315 100644\n--- a/server/src/main/java/org/elasticsearch/search/retriever/CompoundRetrieverBuilder.java\n+++ b/server/src/main/java/org/elasticsearch/search/retriever/CompoundRetrieverBuilder.java\n@@ -216,9 +216,6 @@ public abstract class CompoundRetrieverBuilder<T extends CompoundRetrieverBuilde\n             .trackTotalHits(false)\n             .storedFields(new StoredFieldsContext(false))\n             .size(rankWindowSize);\n-        if (preFilterQueryBuilders.isEmpty() == false) {\n-            retrieverBuilder.getPreFilterQueryBuilders().addAll(preFilterQueryBuilders);\n-        }\n         retrieverBuilder.extractToSearchSourceBuilder(sourceBuilder, true);\n \n         // apply the pre-filters\ndiff --git a/x-pack/plugin/inference/src/main/java/org/elasticsearch/xpack/inference/rank/textsimilarity/TextSimilarityRankRetrieverBuilder.java b/x-pack/plugin/inference/src/main/java/org/elasticsearch/xpack/inference/rank/textsimilarity/TextSimilarityRankRetrieverBuilder.java\nindex 8bccf6e7..5f2d5c4e 100644\n--- a/x-pack/plugin/inference/src/main/java/org/elasticsearch/xpack/inference/rank/textsimilarity/TextSimilarityRankRetrieverBuilder.java\n+++ b/x-pack/plugin/inference/src/main/java/org/elasticsearch/xpack/inference/rank/textsimilarity/TextSimilarityRankRetrieverBuilder.java\n@@ -20,7 +20,6 @@ import org.elasticsearch.search.rank.RankDoc;\n import org.elasticsearch.search.retriever.CompoundRetrieverBuilder;\n import org.elasticsearch.search.retriever.RetrieverBuilder;\n import org.elasticsearch.search.retriever.RetrieverParserContext;\n-import org.elasticsearch.search.retriever.rankdoc.RankDocsQueryBuilder;\n import org.elasticsearch.xcontent.ConstructingObjectParser;\n import org.elasticsearch.xcontent.ParseField;\n import org.elasticsearch.xcontent.XContentBuilder;\n@@ -158,21 +157,12 @@ public class TextSimilarityRankRetrieverBuilder extends CompoundRetrieverBuilder\n         return textSimilarityRankDocs;\n     }\n \n-    @Override\n-    public QueryBuilder explainQuery() {\n-        // the original matching set of the TextSimilarityRank retriever is specified by its nested retriever\n-        return new RankDocsQueryBuilder(rankDocs, new QueryBuilder[] { innerRetrievers.getFirst().retriever().explainQuery() }, true);\n-    }\n-\n     @Override\n     protected SearchSourceBuilder createSearchSourceBuilder(PointInTimeBuilder pit, RetrieverBuilder retrieverBuilder) {\n         var sourceBuilder = new SearchSourceBuilder().pointInTimeBuilder(pit)\n             .trackTotalHits(false)\n             .storedFields(new StoredFieldsContext(false))\n             .size(rankWindowSize);\n-        if (preFilterQueryBuilders.isEmpty() == false) {\n-            retrieverBuilder.getPreFilterQueryBuilders().addAll(preFilterQueryBuilders);\n-        }\n         retrieverBuilder.extractToSearchSourceBuilder(sourceBuilder, true);\n \n         // apply the pre-filters",
      "scores": {
        "correctness": -0.8,
        "completeness": -0.9,
        "code_reuse": 0.0,
        "best_practices": -0.5,
        "unsolicited_docs": 1.0
      },
      "aggregate": -0.24000000000000005,
      "rationale": "The agent made critical errors by removing the prefilter propagation logic instead of ensuring it happens only once. In CompoundRetrieverBuilder.java, the agent removed the line that adds preFilterQueryBuilders to the retriever (line 219-221), which is the opposite of what was needed. The ground truth shows this line should be moved to after retrieverBuilder.extractToSearchSourceBuilder() and the duplicate application in the 'apply the pre-filters' section should be removed. The agent also removed the explainQuery() override in TextSimilarityRankRetrieverBuilder.java but failed to add the final modifier and throw statement in CompoundRetrieverBuilder.java's explainQuery() method as shown in the ground truth. The agent completely missed all other changes in the ground truth diff (buildkite scripts, docs, muted-tests.yml, IndexSettings.java, SourceFieldMapper.java, test files, ESRestTestCase.java). The changes made actually break functionality by preventing prefilters from being propagated at all.",
      "llm_rating": 0.05,
      "llm_summary": "Removed prefilter propagation logic from CompoundRetrieverBuilder.createSearchSourceBuilder and explainQuery override from TextSimilarityRankRetrieverBuilder but failed to add final modifier to CompoundRetrieverBuilder.explainQuery, missed all non-retriever related changes, and critically broke prefilter functionality by removing propagation instead of deduplicating it",
      "errors": []
    },
    {
      "runner": "claude-code",
      "model": "claude-sonnet-4-5",
      "edit_run_id": "c7a3f90a",
      "status": "success",
      "elapsed_ms": 117817,
      "patch_unified": "diff --git a/server/src/main/java/org/elasticsearch/search/retriever/CompoundRetrieverBuilder.java b/server/src/main/java/org/elasticsearch/search/retriever/CompoundRetrieverBuilder.java\nindex e994c55e..a6cd6315 100644\n--- a/server/src/main/java/org/elasticsearch/search/retriever/CompoundRetrieverBuilder.java\n+++ b/server/src/main/java/org/elasticsearch/search/retriever/CompoundRetrieverBuilder.java\n@@ -216,9 +216,6 @@ public abstract class CompoundRetrieverBuilder<T extends CompoundRetrieverBuilde\n             .trackTotalHits(false)\n             .storedFields(new StoredFieldsContext(false))\n             .size(rankWindowSize);\n-        if (preFilterQueryBuilders.isEmpty() == false) {\n-            retrieverBuilder.getPreFilterQueryBuilders().addAll(preFilterQueryBuilders);\n-        }\n         retrieverBuilder.extractToSearchSourceBuilder(sourceBuilder, true);\n \n         // apply the pre-filters\ndiff --git a/x-pack/plugin/inference/src/main/java/org/elasticsearch/xpack/inference/rank/textsimilarity/TextSimilarityRankRetrieverBuilder.java b/x-pack/plugin/inference/src/main/java/org/elasticsearch/xpack/inference/rank/textsimilarity/TextSimilarityRankRetrieverBuilder.java\nindex 8bccf6e7..4d2132dc 100644\n--- a/x-pack/plugin/inference/src/main/java/org/elasticsearch/xpack/inference/rank/textsimilarity/TextSimilarityRankRetrieverBuilder.java\n+++ b/x-pack/plugin/inference/src/main/java/org/elasticsearch/xpack/inference/rank/textsimilarity/TextSimilarityRankRetrieverBuilder.java\n@@ -158,33 +158,9 @@ public class TextSimilarityRankRetrieverBuilder extends CompoundRetrieverBuilder\n         return textSimilarityRankDocs;\n     }\n \n-    @Override\n-    public QueryBuilder explainQuery() {\n-        // the original matching set of the TextSimilarityRank retriever is specified by its nested retriever\n-        return new RankDocsQueryBuilder(rankDocs, new QueryBuilder[] { innerRetrievers.getFirst().retriever().explainQuery() }, true);\n-    }\n-\n     @Override\n     protected SearchSourceBuilder createSearchSourceBuilder(PointInTimeBuilder pit, RetrieverBuilder retrieverBuilder) {\n-        var sourceBuilder = new SearchSourceBuilder().pointInTimeBuilder(pit)\n-            .trackTotalHits(false)\n-            .storedFields(new StoredFieldsContext(false))\n-            .size(rankWindowSize);\n-        if (preFilterQueryBuilders.isEmpty() == false) {\n-            retrieverBuilder.getPreFilterQueryBuilders().addAll(preFilterQueryBuilders);\n-        }\n-        retrieverBuilder.extractToSearchSourceBuilder(sourceBuilder, true);\n-\n-        // apply the pre-filters\n-        if (preFilterQueryBuilders.size() > 0) {\n-            QueryBuilder query = sourceBuilder.query();\n-            BoolQueryBuilder newQuery = new BoolQueryBuilder();\n-            if (query != null) {\n-                newQuery.must(query);\n-            }\n-            preFilterQueryBuilders.forEach(newQuery::filter);\n-            sourceBuilder.query(newQuery);\n-        }\n+        var sourceBuilder = super.createSearchSourceBuilder(pit, retrieverBuilder);\n         sourceBuilder.rankBuilder(\n             new TextSimilarityRankBuilder(this.field, this.inferenceId, this.inferenceText, this.rankWindowSize, this.minScore)\n         );",
      "scores": {
        "correctness": 0.3,
        "completeness": -0.4,
        "code_reuse": 0.8,
        "best_practices": 0.5,
        "unsolicited_docs": 1.0
      },
      "aggregate": 0.44000000000000006,
      "rationale": "The agent correctly identified the need to modify CompoundRetrieverBuilder and TextSimilarityRankRetrieverBuilder to prevent duplicate prefilter propagation. However, it made a critical error by removing the prefilter propagation line from CompoundRetrieverBuilder.createSearchSourceBuilder() without adding it elsewhere, which would break prefilter functionality entirely. The ground truth shows prefilters should still be propagated once (line 224-226 in CompoundRetrieverBuilder), but the agent removed this entirely. The agent also correctly removed the explainQuery() override in TextSimilarityRankRetrieverBuilder and simplified createSearchSourceBuilder() to call super, showing good code reuse. However, it completely missed the requirement to make explainQuery() final and throw an exception in CompoundRetrieverBuilder (ground truth lines 166-169). The agent also ignored all non-retriever changes in the ground truth (build scripts, documentation, muted tests, IndexSettings, SourceFieldMapper, test framework), though these may have been unrelated to the stated task.",
      "llm_rating": 0.32,
      "llm_summary": "Removed prefilter propagation from CompoundRetrieverBuilder.createSearchSourceBuilder() and simplified TextSimilarityRankRetrieverBuilder to call super, but failed to add final explainQuery() method throwing IllegalStateException in CompoundRetrieverBuilder and completely removed prefilter propagation instead of ensuring it happens only once",
      "errors": []
    },
    {
      "runner": "factory",
      "model": "claude-sonnet-4-5-20250929",
      "edit_run_id": "074538b9",
      "status": "success",
      "elapsed_ms": 267016,
      "patch_unified": "diff --git a/server/src/main/java/org/elasticsearch/search/retriever/CompoundRetrieverBuilder.java b/server/src/main/java/org/elasticsearch/search/retriever/CompoundRetrieverBuilder.java\nindex e994c55e..a6cd6315 100644\n--- a/server/src/main/java/org/elasticsearch/search/retriever/CompoundRetrieverBuilder.java\n+++ b/server/src/main/java/org/elasticsearch/search/retriever/CompoundRetrieverBuilder.java\n@@ -216,9 +216,6 @@ public abstract class CompoundRetrieverBuilder<T extends CompoundRetrieverBuilde\n             .trackTotalHits(false)\n             .storedFields(new StoredFieldsContext(false))\n             .size(rankWindowSize);\n-        if (preFilterQueryBuilders.isEmpty() == false) {\n-            retrieverBuilder.getPreFilterQueryBuilders().addAll(preFilterQueryBuilders);\n-        }\n         retrieverBuilder.extractToSearchSourceBuilder(sourceBuilder, true);\n \n         // apply the pre-filters\ndiff --git a/x-pack/plugin/inference/src/main/java/org/elasticsearch/xpack/inference/rank/textsimilarity/TextSimilarityRankRetrieverBuilder.java b/x-pack/plugin/inference/src/main/java/org/elasticsearch/xpack/inference/rank/textsimilarity/TextSimilarityRankRetrieverBuilder.java\nindex 8bccf6e7..5f2d5c4e 100644\n--- a/x-pack/plugin/inference/src/main/java/org/elasticsearch/xpack/inference/rank/textsimilarity/TextSimilarityRankRetrieverBuilder.java\n+++ b/x-pack/plugin/inference/src/main/java/org/elasticsearch/xpack/inference/rank/textsimilarity/TextSimilarityRankRetrieverBuilder.java\n@@ -20,7 +20,6 @@ import org.elasticsearch.search.rank.RankDoc;\n import org.elasticsearch.search.retriever.CompoundRetrieverBuilder;\n import org.elasticsearch.search.retriever.RetrieverBuilder;\n import org.elasticsearch.search.retriever.RetrieverParserContext;\n-import org.elasticsearch.search.retriever.rankdoc.RankDocsQueryBuilder;\n import org.elasticsearch.xcontent.ConstructingObjectParser;\n import org.elasticsearch.xcontent.ParseField;\n import org.elasticsearch.xcontent.XContentBuilder;\n@@ -158,21 +157,12 @@ public class TextSimilarityRankRetrieverBuilder extends CompoundRetrieverBuilder\n         return textSimilarityRankDocs;\n     }\n \n-    @Override\n-    public QueryBuilder explainQuery() {\n-        // the original matching set of the TextSimilarityRank retriever is specified by its nested retriever\n-        return new RankDocsQueryBuilder(rankDocs, new QueryBuilder[] { innerRetrievers.getFirst().retriever().explainQuery() }, true);\n-    }\n-\n     @Override\n     protected SearchSourceBuilder createSearchSourceBuilder(PointInTimeBuilder pit, RetrieverBuilder retrieverBuilder) {\n         var sourceBuilder = new SearchSourceBuilder().pointInTimeBuilder(pit)\n             .trackTotalHits(false)\n             .storedFields(new StoredFieldsContext(false))\n             .size(rankWindowSize);\n-        if (preFilterQueryBuilders.isEmpty() == false) {\n-            retrieverBuilder.getPreFilterQueryBuilders().addAll(preFilterQueryBuilders);\n-        }\n         retrieverBuilder.extractToSearchSourceBuilder(sourceBuilder, true);\n \n         // apply the pre-filters",
      "scores": {
        "correctness": -0.8,
        "completeness": -0.7,
        "code_reuse": 0.0,
        "best_practices": -0.5,
        "unsolicited_docs": 1.0
      },
      "aggregate": -0.2,
      "rationale": "The agent made changes in the correct files (CompoundRetrieverBuilder.java and TextSimilarityRankRetrieverBuilder.java) but implemented them incorrectly. The ground truth shows that preFilterQueryBuilders should be added to retrieverBuilder BEFORE extractToSearchSourceBuilder is called, and the manual application of pre-filters should be removed. The agent did the opposite: removed the line that adds preFilterQueryBuilders to the retriever (which should stay) while keeping the manual filter application code (which should be removed). This breaks the intended functionality of propagating pre-filters downstream only once. Additionally, the agent removed the explainQuery() override in TextSimilarityRankRetrieverBuilder, which is correct, but failed to add the final explainQuery() method to CompoundRetrieverBuilder that throws IllegalStateException. The agent also completely missed removing the unused import for RankDocsQueryBuilder. The changes are fundamentally backwards from what was required.",
      "llm_rating": 0.15,
      "llm_summary": "Removed preFilterQueryBuilders propagation line in CompoundRetrieverBuilder and TextSimilarityRankRetrieverBuilder while keeping manual filter application code, which is the opposite of the ground truth requirement to add filters once downstream and remove manual application.",
      "errors": []
    }
  ],
  "comparative_analysis": {
    "summary": "All three agents correctly removed the prefilter propagation code from CompoundRetrieverBuilder and the explainQuery override from TextSimilarityRankRetrieverBuilder. However, claude-code:claude-sonnet-4-5 distinguished itself by refactoring the createSearchSourceBuilder method to call super instead of duplicating code, while auggie:sonnet4.5 and factory:claude-sonnet-4-5-20250929 left the duplicated implementation intact.",
    "best_agent": "claude-code:claude-sonnet-4-5",
    "best_agent_reasoning": "claude-code:claude-sonnet-4-5 achieved the best code reuse score (0.80) by recognizing that after removing the prefilter propagation, the TextSimilarityRankRetrieverBuilder's createSearchSourceBuilder method was duplicating logic from its parent class. By refactoring to call super.createSearchSourceBuilder(), this agent eliminated code duplication while maintaining all required functionality, demonstrating superior understanding of object-oriented design principles.",
    "approach_differences": "The key difference lies in how agents handled the TextSimilarityRankRetrieverBuilder's createSearchSourceBuilder method. claude-code:claude-sonnet-4-5 refactored it to call the parent implementation and only add the rank builder, eliminating duplication. In contrast, auggie:sonnet4.5 and factory:claude-sonnet-4-5-20250929 both removed the prefilter propagation line but left the entire method implementation duplicating parent class logic. All three agents correctly removed the explainQuery override and the unused RankDocsQueryBuilder import, but only claude-code:claude-sonnet-4-5 optimized for code reuse.",
    "ranking": [
      "claude-code:claude-sonnet-4-5",
      "factory:claude-sonnet-4-5-20250929",
      "auggie:sonnet4.5"
    ]
  },
  "timestamp": "2025-11-06T22:05:02.832186",
  "analysis_run_id": "c6dfaa47"
}