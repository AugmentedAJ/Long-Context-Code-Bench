{
  "repo_url": "https://github.com/elastic/elasticsearch.git",
  "pr_number": 114899,
  "base_commit": "6f608803302230a24c2d81fc9c4b863eb3513cb8",
  "head_commit": "ab71dfe22a7ac71bfcc7d21f8cace7f3d12d9b4c",
  "task_instructions": "You are working on a codebase. Your task is to make the necessary code changes to accomplish the following:\n\nES|QL: Fix stats by constant expression\n\nFixes: https://github.com/elastic/elasticsearch/issues/114714\r\n\r\nDo not consider implicit aliases in `Aggregate.computeReferences()`. \r\nThese aliases could be misleading for the field_caps to compute involved indices.\n\nPlease make all necessary code changes to complete this task.",
  "ground_truth_diff": "diff --git a/docs/changelog/114899.yaml b/docs/changelog/114899.yaml\nnew file mode 100644\nindex 000000000000..399aa5cf3540\n--- /dev/null\n+++ b/docs/changelog/114899.yaml\n@@ -0,0 +1,5 @@\n+pr: 114899\n+summary: \"ES|QL: Fix stats by constant expression\"\n+area: ES|QL\n+type: bug\n+issues: []\ndiff --git a/x-pack/plugin/esql/qa/testFixtures/src/main/resources/stats.csv-spec b/x-pack/plugin/esql/qa/testFixtures/src/main/resources/stats.csv-spec\nindex 496a747fd9c2..ac4351413129 100644\n--- a/x-pack/plugin/esql/qa/testFixtures/src/main/resources/stats.csv-spec\n+++ b/x-pack/plugin/esql/qa/testFixtures/src/main/resources/stats.csv-spec\n@@ -2473,3 +2473,32 @@ c2:l |c2_f:l |m2:i |m2_f:i |c:l\n 1    |0      |2    |2      |19\n 1    |1      |5    |5      |21\n ;\n+\n+\n+statsByConstantExpressionNoAggs\n+required_capability: fix_stats_by_foldable_expression\n+FROM employees | eval x = [1,2,3], y = 5 + 6 | stats by y+1\n+;\n+\n+y+1:integer\n+12\n+;\n+\n+\n+statsByConstantExpressionNoAggsWithAlias\n+required_capability: fix_stats_by_foldable_expression\n+FROM employees | eval x = [1,2,3], y = 5 + 6 | stats by yy = y+1\n+;\n+\n+yy:integer\n+12\n+;\n+\n+statsByConstantExpression\n+required_capability: fix_stats_by_foldable_expression\n+FROM employees | eval x = [1,2,3], y = 5 + 6 | stats m = max(y) by y+1\n+;\n+\n+m:integer | y+1:integer\n+11        | 12\n+;\ndiff --git a/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/action/EsqlCapabilities.java b/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/action/EsqlCapabilities.java\nindex c94791964fb9..b31fc005a0a5 100644\n--- a/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/action/EsqlCapabilities.java\n+++ b/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/action/EsqlCapabilities.java\n@@ -385,7 +385,12 @@ public class EsqlCapabilities {\n         /**\n          * Allow filter per individual aggregation.\n          */\n-        PER_AGG_FILTERING;\n+        PER_AGG_FILTERING,\n+\n+        /**\n+         * Fix for https://github.com/elastic/elasticsearch/issues/114714\n+         */\n+        FIX_STATS_BY_FOLDABLE_EXPRESSION;\n \n         private final boolean snapshotOnly;\n         private final FeatureFlag featureFlag;\ndiff --git a/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/plan/logical/Aggregate.java b/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/plan/logical/Aggregate.java\nindex b2f314a0e829..e1632db4f79a 100644\n--- a/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/plan/logical/Aggregate.java\n+++ b/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/plan/logical/Aggregate.java\n@@ -11,6 +11,7 @@ import org.elasticsearch.common.io.stream.NamedWriteableRegistry;\n import org.elasticsearch.common.io.stream.StreamInput;\n import org.elasticsearch.common.io.stream.StreamOutput;\n import org.elasticsearch.xpack.esql.core.capabilities.Resolvables;\n+import org.elasticsearch.xpack.esql.core.expression.Alias;\n import org.elasticsearch.xpack.esql.core.expression.Attribute;\n import org.elasticsearch.xpack.esql.core.expression.AttributeSet;\n import org.elasticsearch.xpack.esql.core.expression.Expression;\n@@ -157,7 +158,13 @@ public class Aggregate extends UnaryPlan implements Stats {\n     }\n \n     public static AttributeSet computeReferences(List<? extends NamedExpression> aggregates, List<? extends Expression> groupings) {\n-        return Expressions.references(groupings).combine(Expressions.references(aggregates));\n+        AttributeSet result = Expressions.references(groupings).combine(Expressions.references(aggregates));\n+        for (Expression grouping : groupings) {\n+            if (grouping instanceof Alias) {\n+                result.remove(((Alias) grouping).toAttribute());\n+            }\n+        }\n+        return result;\n     }\n \n     @Override",
  "judge_mode": "comparative",
  "judge_model": "openai/claude-sonnet-4-5-20250929",
  "test_label": "v0",
  "agent_results": [
    {
      "runner": "auggie",
      "model": "sonnet4.5",
      "edit_run_id": "a9463435",
      "status": "success",
      "elapsed_ms": 460082,
      "patch_unified": "diff --git a/x-pack/plugin/esql/qa/testFixtures/src/main/resources/stats.csv-spec b/x-pack/plugin/esql/qa/testFixtures/src/main/resources/stats.csv-spec\nindex 496a747f..5fa36a57 100644\n--- a/x-pack/plugin/esql/qa/testFixtures/src/main/resources/stats.csv-spec\n+++ b/x-pack/plugin/esql/qa/testFixtures/src/main/resources/stats.csv-spec\n@@ -2291,6 +2291,16 @@ m:integer |a:double |x:integer\n 74999     |48249.0  |0\n ;\n \n+statsByConstantExpressionFromEval\n+from employees\n+| eval x = [1,2,3], y = 5 + 6\n+| stats m = max(salary), a = round(avg(salary)) by y + 1\n+;\n+\n+m:integer |a:double |y + 1:integer\n+74999     |48249.0  |12\n+;\n+\n \n statsWithFiltering\n required_capability: per_agg_filtering\ndiff --git a/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/plan/logical/Aggregate.java b/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/plan/logical/Aggregate.java\nindex b2f314a0..fe7fc239 100644\n--- a/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/plan/logical/Aggregate.java\n+++ b/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/plan/logical/Aggregate.java\n@@ -157,7 +157,16 @@ public class Aggregate extends UnaryPlan implements Stats {\n     }\n \n     public static AttributeSet computeReferences(List<? extends NamedExpression> aggregates, List<? extends Expression> groupings) {\n-        return Expressions.references(groupings).combine(Expressions.references(aggregates));\n+        // Collect grouping names to identify implicit aliases\n+        var groupingNames = Expressions.names(groupings);\n+\n+        // Filter out implicit aliases from aggregates - these are Attributes that match grouping names\n+        // These implicit aliases are added in LogicalPlanBuilder.stats() and should not contribute to field references\n+        var aggregatesWithoutImplicitAliases = aggregates.stream()\n+            .filter(agg -> agg instanceof Attribute == false || groupingNames.contains(agg.name()) == false)\n+            .toList();\n+\n+        return Expressions.references(groupings).combine(Expressions.references(aggregatesWithoutImplicitAliases));\n     }\n \n     @Override\ndiff --git a/x-pack/plugin/esql/src/test/java/org/elasticsearch/xpack/esql/session/IndexResolverFieldNamesTests.java b/x-pack/plugin/esql/src/test/java/org/elasticsearch/xpack/esql/session/IndexResolverFieldNamesTests.java\nindex 5425f770..0f2bffad 100644\n--- a/x-pack/plugin/esql/src/test/java/org/elasticsearch/xpack/esql/session/IndexResolverFieldNamesTests.java\n+++ b/x-pack/plugin/esql/src/test/java/org/elasticsearch/xpack/esql/session/IndexResolverFieldNamesTests.java\n@@ -81,6 +81,15 @@ public class IndexResolverFieldNamesTests extends ESTestCase {\n         );\n     }\n \n+    public void testStatsByConstantExpressionFromEval() {\n+        // Test for https://github.com/elastic/elasticsearch/issues/114714\n+        // STATS BY expression using only constants from EVAL should not require those fields from the index\n+        assertFieldNames(\n+            \"from employees | eval x = [1,2,3], y = 5 + 6 | stats m = max(salary) by y + 1\",\n+            Set.of(\"salary\", \"salary.*\")\n+        );\n+    }\n+\n     public void testIn1() {\n         assertFieldNames(\n             \"from employees | keep emp_no, is_rehired, still_hired \"",
      "scores": {
        "correctness": 0.3,
        "completeness": -0.3,
        "code_reuse": 0.7,
        "best_practices": 0.5,
        "unsolicited_docs": 0.8
      },
      "aggregate": 0.4,
      "rationale": "The agent's approach differs significantly from ground truth. Ground truth removes implicit Alias attributes from the result set by checking if groupings are Alias instances and removing their toAttribute(). The agent instead filters aggregates by checking if they're Attributes matching grouping names. This is semantically different and may not handle all cases correctly. The agent is missing: 1) the changelog file (114899.yaml), 2) the EsqlCapabilities enum entry (FIX_STATS_BY_FOLDABLE_EXPRESSION), 3) two of three test cases (statsByConstantExpressionNoAggs and statsByConstantExpressionNoAggsWithAlias), and 4) the required_capability annotations on tests. The agent added one test case and a unit test which weren't in ground truth. The core fix logic is fundamentally different - ground truth modifies the result after combining references, while agent filters before combining. This could lead to different behavior with complex grouping expressions.",
      "llm_rating": 0.34,
      "llm_summary": "Modified Aggregate.computeReferences() to filter aggregates by name matching instead of removing Alias toAttribute() references, added one test case to stats.csv-spec and a unit test in IndexResolverFieldNamesTests, but omitted changelog, capability enum, and two required test cases with capability annotations.",
      "errors": []
    },
    {
      "runner": "claude-code",
      "model": "claude-sonnet-4-5",
      "edit_run_id": "c7a3f90a",
      "status": "success",
      "elapsed_ms": 281696,
      "patch_unified": "diff --git a/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/plan/logical/Aggregate.java b/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/plan/logical/Aggregate.java\nindex b2f314a0..24646eb6 100644\n--- a/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/plan/logical/Aggregate.java\n+++ b/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/plan/logical/Aggregate.java\n@@ -11,6 +11,7 @@ import org.elasticsearch.common.io.stream.NamedWriteableRegistry;\n import org.elasticsearch.common.io.stream.StreamInput;\n import org.elasticsearch.common.io.stream.StreamOutput;\n import org.elasticsearch.xpack.esql.core.capabilities.Resolvables;\n+import org.elasticsearch.xpack.esql.core.expression.Alias;\n import org.elasticsearch.xpack.esql.core.expression.Attribute;\n import org.elasticsearch.xpack.esql.core.expression.AttributeSet;\n import org.elasticsearch.xpack.esql.core.expression.Expression;\n@@ -157,7 +158,30 @@ public class Aggregate extends UnaryPlan implements Stats {\n     }\n \n     public static AttributeSet computeReferences(List<? extends NamedExpression> aggregates, List<? extends Expression> groupings) {\n-        return Expressions.references(groupings).combine(Expressions.references(aggregates));\n+        // Collect references from groupings - use the original grouping expressions, not their aliases\n+        AttributeSet groupingRefs = Expressions.references(groupings);\n+\n+        // Collect references from aggregates, but exclude implicit aliases from groupings\n+        // Implicit aliases are created for constant expressions in groupings and should not be considered as field references\n+        AttributeSet aggregateRefs = new AttributeSet();\n+        for (NamedExpression agg : aggregates) {\n+            // Skip if this is an implicit alias wrapping a constant expression from groupings\n+            boolean isImplicitGroupingAlias = false;\n+            for (Expression grouping : groupings) {\n+                if (grouping instanceof Alias alias\n+                    && alias.child().foldable()\n+                    && agg instanceof Attribute attr\n+                    && attr.name().equals(alias.name())) {\n+                    isImplicitGroupingAlias = true;\n+                    break;\n+                }\n+            }\n+            if (isImplicitGroupingAlias == false) {\n+                aggregateRefs.addAll(agg.references());\n+            }\n+        }\n+\n+        return groupingRefs.combine(aggregateRefs);\n     }\n \n     @Override",
      "scores": {
        "correctness": -0.3,
        "completeness": -0.6,
        "code_reuse": 0.5,
        "best_practices": 0.3,
        "unsolicited_docs": 1.0
      },
      "aggregate": 0.18000000000000002,
      "rationale": "The agent modified Aggregate.computeReferences() to handle implicit aliases but implemented a fundamentally different and incorrect approach. Ground truth removes implicit alias attributes from the result set after computing references (simple 5-line addition), while the agent created complex logic that tries to filter aggregates based on matching names with foldable grouping aliases. This approach is semantically incorrect because it filters the wrong set (aggregates instead of grouping-generated aliases) and uses name matching which is fragile. The agent completely missed the changelog file (docs/changelog/114899.yaml), test cases (stats.csv-spec with 3 new tests), and capability flag (EsqlCapabilities.java), making it only 40% complete. The code does reuse existing AttributeSet and Expressions utilities reasonably well, and follows basic Java conventions, though the logic is overly complex. No unsolicited documentation was added.",
      "llm_rating": 0.23,
      "llm_summary": "Modified Aggregate.computeReferences() to filter aggregates by name-matching with foldable grouping aliases instead of removing implicit alias attributes from the result set, and omitted changelog, test cases, and capability flag additions.",
      "errors": []
    },
    {
      "runner": "factory",
      "model": "claude-sonnet-4-5-20250929",
      "edit_run_id": "074538b9",
      "status": "success",
      "elapsed_ms": 233136,
      "patch_unified": "diff --git a/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/plan/logical/Aggregate.java b/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/plan/logical/Aggregate.java\nindex b2f314a0..a18f6e20 100644\n--- a/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/plan/logical/Aggregate.java\n+++ b/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/plan/logical/Aggregate.java\n@@ -157,7 +157,27 @@ public class Aggregate extends UnaryPlan implements Stats {\n     }\n \n     public static AttributeSet computeReferences(List<? extends NamedExpression> aggregates, List<? extends Expression> groupings) {\n-        return Expressions.references(groupings).combine(Expressions.references(aggregates));\n+        // Collect grouping attributes to exclude them from aggregate references\n+        // These are implicit aliases added by the parser and should not be considered for field_caps\n+        AttributeSet groupingAttributes = new AttributeSet();\n+        for (Expression grouping : groupings) {\n+            Attribute attr = Expressions.attribute(grouping);\n+            if (attr != null) {\n+                groupingAttributes.add(attr);\n+            }\n+        }\n+        \n+        // Collect references from aggregates, excluding the implicit grouping aliases\n+        AttributeSet aggRefs = new AttributeSet();\n+        for (NamedExpression agg : aggregates) {\n+            // Skip aggregates that are just references to grouping expressions (implicit aliases)\n+            if (agg instanceof Attribute attr && groupingAttributes.contains(attr)) {\n+                continue;\n+            }\n+            aggRefs.addAll(agg.references());\n+        }\n+        \n+        return Expressions.references(groupings).combine(aggRefs);\n     }\n \n     @Override",
      "scores": {
        "correctness": -0.3,
        "completeness": -0.7,
        "code_reuse": -0.2,
        "best_practices": 0.0,
        "unsolicited_docs": 1.0
      },
      "aggregate": -0.039999999999999994,
      "rationale": "The agent's implementation has significant issues. Ground truth removes implicit Alias attributes from groupings (checking `grouping instanceof Alias` and removing `toAttribute()`), while the agent incorrectly tries to filter aggregates based on grouping attributes, which misunderstands the problem. The agent is missing all test files (stats.csv-spec), the changelog entry (114899.yaml), and the capability flag (FIX_STATS_BY_FOLDABLE_EXPRESSION in EsqlCapabilities.java). The logic is fundamentally wrong: it collects grouping attributes and tries to exclude them from aggregates, but the actual issue is about removing implicit aliases from the references computation. The agent also introduces unnecessary complexity with manual AttributeSet construction instead of the simple 3-line solution in ground truth.",
      "llm_rating": 0.18,
      "llm_summary": "Modified Aggregate.computeReferences() with incorrect logic that filters aggregates based on grouping attributes instead of removing implicit Alias attributes from groupings, and omitted all test files, changelog, and capability flag additions.",
      "errors": []
    }
  ],
  "comparative_analysis": {
    "summary": "All three agents attempted to fix the issue by modifying the computeReferences() method in Aggregate.java to exclude implicit aliases from grouping expressions. However, auggie:sonnet4.5 achieved the highest score (0.40) by filtering out Attributes matching grouping names, while claude-code:claude-sonnet-4-5 (0.18) and factory:claude-sonnet-4-5-20250929 (-0.04) used more complex approaches that checked for foldable expressions and Alias types but missed key implementation details.",
    "best_agent": "auggie:sonnet4.5",
    "best_agent_reasoning": "auggie:sonnet4.5 scored highest (0.40) with strong code reuse (0.70) and unsolicited docs (0.80). While it had lower correctness (0.30) and negative completeness (-0.30), it provided a cleaner solution by filtering aggregates based on grouping names and added a relevant test case. The approach was simpler and more maintainable than the other agents, though it missed the changelog and capability additions from the ground truth.",
    "approach_differences": "auggie:sonnet4.5 filtered aggregates by checking if they are Attributes matching grouping names, using Expressions.names() for comparison. claude-code:claude-sonnet-4-5 checked for Alias instances with foldable children matching grouping aliases, iterating through both lists. factory:claude-sonnet-4-5-20250929 used Expressions.attribute() to extract grouping attributes and excluded them from aggregate references. The ground truth solution differs by removing Alias.toAttribute() from the result set after computing references, which none of the agents implemented correctly.",
    "ranking": [
      "auggie:sonnet4.5",
      "claude-code:claude-sonnet-4-5",
      "factory:claude-sonnet-4-5-20250929"
    ]
  },
  "timestamp": "2025-11-06T21:48:32.519285",
  "analysis_run_id": "907b1de9"
}