{
  "repo_url": "https://github.com/elastic/elasticsearch.git",
  "pr_number": 114914,
  "base_commit": "041022944e7df963d4a3269dfa6ec7791247251e",
  "head_commit": "1d7194ca29bff718ec3a780de04b95fb420bee16",
  "task_instructions": "You are working on a codebase. Your task is to make the necessary code changes to accomplish the following:\n\nAdding chunking settings to IbmWatsonxService\n\nIssue - https://github.com/elastic/elasticsearch/issues/117188\r\n\r\n## Description\r\nThis change introduces:\r\n- Chunking settings as a new setting to provide when creating embedding inference endpoints for the IbmWatsonxService\r\n\r\nNote: Chunking currently only runs when large documents are ingested to an index with an inference field.\r\n\r\n## Testing\r\n- Ran unit tests and ensured that all succeed\r\n- Tested the following cases with each service with the feature flag enabled:\r\n  - Creating an embedding endpoint with no `chunking_settings` provided generates a model with default chunking settings (keeps existing sentence based chunking strategy with default configurations).\r\n  - Creating an embedding endpoint with `chunking_settings` for a word based chunking strategy provided generates a model that uses the word based chunking strategy.\r\n  - Creating an embedding endpoint with `chunking_settings` for a sentence based chunking strategy provided generates a model that uses the sentence based chunking strategy.\n\nPlease make all necessary code changes to complete this task.",
  "ground_truth_diff": "diff --git a/docs/changelog/114914.yaml b/docs/changelog/114914.yaml\nnew file mode 100644\nindex 000000000000..bad13e26682d\n--- /dev/null\n+++ b/docs/changelog/114914.yaml\n@@ -0,0 +1,5 @@\n+pr: 114914\n+summary: Adding chunking settings to `IbmWatsonxService`\n+area: Machine Learning\n+type: enhancement\n+issues: []\ndiff --git a/x-pack/plugin/inference/src/main/java/org/elasticsearch/xpack/inference/services/ibmwatsonx/IbmWatsonxService.java b/x-pack/plugin/inference/src/main/java/org/elasticsearch/xpack/inference/services/ibmwatsonx/IbmWatsonxService.java\nindex e960b0b777f2..f4f4605c667c 100644\n--- a/x-pack/plugin/inference/src/main/java/org/elasticsearch/xpack/inference/services/ibmwatsonx/IbmWatsonxService.java\n+++ b/x-pack/plugin/inference/src/main/java/org/elasticsearch/xpack/inference/services/ibmwatsonx/IbmWatsonxService.java\n@@ -16,6 +16,7 @@ import org.elasticsearch.core.Nullable;\n import org.elasticsearch.core.TimeValue;\n import org.elasticsearch.inference.ChunkedInferenceServiceResults;\n import org.elasticsearch.inference.ChunkingOptions;\n+import org.elasticsearch.inference.ChunkingSettings;\n import org.elasticsearch.inference.EmptySettingsConfiguration;\n import org.elasticsearch.inference.InferenceServiceConfiguration;\n import org.elasticsearch.inference.InferenceServiceResults;\n@@ -30,6 +31,7 @@ import org.elasticsearch.inference.TaskType;\n import org.elasticsearch.inference.configuration.SettingsConfigurationDisplayType;\n import org.elasticsearch.inference.configuration.SettingsConfigurationFieldType;\n import org.elasticsearch.rest.RestStatus;\n+import org.elasticsearch.xpack.inference.chunking.ChunkingSettingsBuilder;\n import org.elasticsearch.xpack.inference.chunking.EmbeddingRequestChunker;\n import org.elasticsearch.xpack.inference.external.action.ibmwatsonx.IbmWatsonxActionCreator;\n import org.elasticsearch.xpack.inference.external.http.sender.DocumentsOnlyInput;\n@@ -86,11 +88,19 @@ public class IbmWatsonxService extends SenderService {\n             Map<String, Object> serviceSettingsMap = removeFromMapOrThrowIfNull(config, ModelConfigurations.SERVICE_SETTINGS);\n             Map<String, Object> taskSettingsMap = removeFromMapOrDefaultEmpty(config, ModelConfigurations.TASK_SETTINGS);\n \n+            ChunkingSettings chunkingSettings = null;\n+            if (TaskType.TEXT_EMBEDDING.equals(taskType)) {\n+                chunkingSettings = ChunkingSettingsBuilder.fromMap(\n+                    removeFromMapOrDefaultEmpty(config, ModelConfigurations.CHUNKING_SETTINGS)\n+                );\n+            }\n+\n             IbmWatsonxModel model = createModel(\n                 inferenceEntityId,\n                 taskType,\n                 serviceSettingsMap,\n                 taskSettingsMap,\n+                chunkingSettings,\n                 serviceSettingsMap,\n                 TaskType.unsupportedTaskTypeErrorMsg(taskType, NAME),\n                 ConfigurationParseContext.REQUEST\n@@ -112,6 +122,7 @@ public class IbmWatsonxService extends SenderService {\n         TaskType taskType,\n         Map<String, Object> serviceSettings,\n         Map<String, Object> taskSettings,\n+        ChunkingSettings chunkingSettings,\n         @Nullable Map<String, Object> secretSettings,\n         String failureMessage,\n         ConfigurationParseContext context\n@@ -123,6 +134,7 @@ public class IbmWatsonxService extends SenderService {\n                 NAME,\n                 serviceSettings,\n                 taskSettings,\n+                chunkingSettings,\n                 secretSettings,\n                 context\n             );\n@@ -141,11 +153,17 @@ public class IbmWatsonxService extends SenderService {\n         Map<String, Object> taskSettingsMap = removeFromMapOrDefaultEmpty(config, ModelConfigurations.TASK_SETTINGS);\n         Map<String, Object> secretSettingsMap = removeFromMapOrDefaultEmpty(secrets, ModelSecrets.SECRET_SETTINGS);\n \n+        ChunkingSettings chunkingSettings = null;\n+        if (TaskType.TEXT_EMBEDDING.equals(taskType)) {\n+            chunkingSettings = ChunkingSettingsBuilder.fromMap(removeFromMapOrDefaultEmpty(config, ModelConfigurations.CHUNKING_SETTINGS));\n+        }\n+\n         return createModelFromPersistent(\n             inferenceEntityId,\n             taskType,\n             serviceSettingsMap,\n             taskSettingsMap,\n+            chunkingSettings,\n             secretSettingsMap,\n             parsePersistedConfigErrorMsg(inferenceEntityId, NAME)\n         );\n@@ -166,6 +184,7 @@ public class IbmWatsonxService extends SenderService {\n         TaskType taskType,\n         Map<String, Object> serviceSettings,\n         Map<String, Object> taskSettings,\n+        ChunkingSettings chunkingSettings,\n         Map<String, Object> secretSettings,\n         String failureMessage\n     ) {\n@@ -174,6 +193,7 @@ public class IbmWatsonxService extends SenderService {\n             taskType,\n             serviceSettings,\n             taskSettings,\n+            chunkingSettings,\n             secretSettings,\n             failureMessage,\n             ConfigurationParseContext.PERSISTENT\n@@ -185,11 +205,17 @@ public class IbmWatsonxService extends SenderService {\n         Map<String, Object> serviceSettingsMap = removeFromMapOrThrowIfNull(config, ModelConfigurations.SERVICE_SETTINGS);\n         Map<String, Object> taskSettingsMap = removeFromMapOrDefaultEmpty(config, ModelConfigurations.TASK_SETTINGS);\n \n+        ChunkingSettings chunkingSettings = null;\n+        if (TaskType.TEXT_EMBEDDING.equals(taskType)) {\n+            chunkingSettings = ChunkingSettingsBuilder.fromMap(removeFromMapOrDefaultEmpty(config, ModelConfigurations.CHUNKING_SETTINGS));\n+        }\n+\n         return createModelFromPersistent(\n             inferenceEntityId,\n             taskType,\n             serviceSettingsMap,\n             taskSettingsMap,\n+            chunkingSettings,\n             null,\n             parsePersistedConfigErrorMsg(inferenceEntityId, NAME)\n         );\n@@ -266,7 +292,8 @@ public class IbmWatsonxService extends SenderService {\n         var batchedRequests = new EmbeddingRequestChunker(\n             input.getInputs(),\n             EMBEDDING_MAX_BATCH_SIZE,\n-            EmbeddingRequestChunker.EmbeddingType.FLOAT\n+            EmbeddingRequestChunker.EmbeddingType.FLOAT,\n+            model.getConfigurations().getChunkingSettings()\n         ).batchRequestsWithListeners(listener);\n         for (var request : batchedRequests) {\n             var action = ibmWatsonxModel.accept(getActionCreator(getSender(), getServiceComponents()), taskSettings, inputType);\ndiff --git a/x-pack/plugin/inference/src/main/java/org/elasticsearch/xpack/inference/services/ibmwatsonx/embeddings/IbmWatsonxEmbeddingsModel.java b/x-pack/plugin/inference/src/main/java/org/elasticsearch/xpack/inference/services/ibmwatsonx/embeddings/IbmWatsonxEmbeddingsModel.java\nindex d60e31b5d41c..6b20e07ecc0a 100644\n--- a/x-pack/plugin/inference/src/main/java/org/elasticsearch/xpack/inference/services/ibmwatsonx/embeddings/IbmWatsonxEmbeddingsModel.java\n+++ b/x-pack/plugin/inference/src/main/java/org/elasticsearch/xpack/inference/services/ibmwatsonx/embeddings/IbmWatsonxEmbeddingsModel.java\n@@ -9,6 +9,7 @@ package org.elasticsearch.xpack.inference.services.ibmwatsonx.embeddings;\n \n import org.apache.http.client.utils.URIBuilder;\n import org.elasticsearch.core.Nullable;\n+import org.elasticsearch.inference.ChunkingSettings;\n import org.elasticsearch.inference.EmptyTaskSettings;\n import org.elasticsearch.inference.InputType;\n import org.elasticsearch.inference.ModelConfigurations;\n@@ -40,6 +41,7 @@ public class IbmWatsonxEmbeddingsModel extends IbmWatsonxModel {\n         String service,\n         Map<String, Object> serviceSettings,\n         Map<String, Object> taskSettings,\n+        ChunkingSettings chunkingSettings,\n         Map<String, Object> secrets,\n         ConfigurationParseContext context\n     ) {\n@@ -49,6 +51,7 @@ public class IbmWatsonxEmbeddingsModel extends IbmWatsonxModel {\n             service,\n             IbmWatsonxEmbeddingsServiceSettings.fromMap(serviceSettings, context),\n             EmptyTaskSettings.INSTANCE,\n+            chunkingSettings,\n             DefaultSecretSettings.fromMap(secrets)\n         );\n     }\n@@ -64,10 +67,11 @@ public class IbmWatsonxEmbeddingsModel extends IbmWatsonxModel {\n         String service,\n         IbmWatsonxEmbeddingsServiceSettings serviceSettings,\n         TaskSettings taskSettings,\n+        ChunkingSettings chunkingsettings,\n         @Nullable DefaultSecretSettings secrets\n     ) {\n         super(\n-            new ModelConfigurations(inferenceEntityId, taskType, service, serviceSettings, taskSettings),\n+            new ModelConfigurations(inferenceEntityId, taskType, service, serviceSettings, taskSettings, chunkingsettings),\n             new ModelSecrets(secrets),\n             serviceSettings\n         );\ndiff --git a/x-pack/plugin/inference/src/test/java/org/elasticsearch/xpack/inference/services/ibmwatsonx/IbmWatsonxServiceTests.java b/x-pack/plugin/inference/src/test/java/org/elasticsearch/xpack/inference/services/ibmwatsonx/IbmWatsonxServiceTests.java\nindex d6c491f2b7ce..f7f37c5bcd15 100644\n--- a/x-pack/plugin/inference/src/test/java/org/elasticsearch/xpack/inference/services/ibmwatsonx/IbmWatsonxServiceTests.java\n+++ b/x-pack/plugin/inference/src/test/java/org/elasticsearch/xpack/inference/services/ibmwatsonx/IbmWatsonxServiceTests.java\n@@ -20,6 +20,7 @@ import org.elasticsearch.common.xcontent.XContentHelper;\n import org.elasticsearch.core.TimeValue;\n import org.elasticsearch.inference.ChunkedInferenceServiceResults;\n import org.elasticsearch.inference.ChunkingOptions;\n+import org.elasticsearch.inference.ChunkingSettings;\n import org.elasticsearch.inference.EmptyTaskSettings;\n import org.elasticsearch.inference.InferenceServiceConfiguration;\n import org.elasticsearch.inference.InferenceServiceResults;\n@@ -69,6 +70,8 @@ import static org.elasticsearch.xpack.inference.Utils.getInvalidModel;\n import static org.elasticsearch.xpack.inference.Utils.getPersistedConfigMap;\n import static org.elasticsearch.xpack.inference.Utils.inferenceUtilityPool;\n import static org.elasticsearch.xpack.inference.Utils.mockClusterServiceEmpty;\n+import static org.elasticsearch.xpack.inference.chunking.ChunkingSettingsTests.createRandomChunkingSettings;\n+import static org.elasticsearch.xpack.inference.chunking.ChunkingSettingsTests.createRandomChunkingSettingsMap;\n import static org.elasticsearch.xpack.inference.external.http.Utils.entityAsMap;\n import static org.elasticsearch.xpack.inference.external.http.Utils.getUrl;\n import static org.elasticsearch.xpack.inference.results.TextEmbeddingResultsTests.buildExpectationFloat;\n@@ -124,6 +127,7 @@ public class IbmWatsonxServiceTests extends ESTestCase {\n                 assertThat(embeddingsModel.getServiceSettings().url(), is(URI.create(url)));\n                 assertThat(embeddingsModel.getServiceSettings().apiVersion(), is(apiVersion));\n                 assertThat(embeddingsModel.getSecretSettings().apiKey().toString(), is(apiKey));\n+                assertThat(embeddingsModel.getConfigurations().getChunkingSettings(), instanceOf(ChunkingSettings.class));\n             }, e -> fail(\"Model parsing should have succeeded, but failed: \" + e.getMessage()));\n \n             service.parseRequestConfig(\n@@ -150,6 +154,45 @@ public class IbmWatsonxServiceTests extends ESTestCase {\n         }\n     }\n \n+    public void testParseRequestConfig_CreatesAIbmWatsonxEmbeddingsModelWhenChunkingSettingsProvided() throws IOException {\n+        try (var service = createIbmWatsonxService()) {\n+            ActionListener<Model> modelListener = ActionListener.wrap(model -> {\n+                assertThat(model, instanceOf(IbmWatsonxEmbeddingsModel.class));\n+\n+                var embeddingsModel = (IbmWatsonxEmbeddingsModel) model;\n+                assertThat(embeddingsModel.getServiceSettings().modelId(), is(modelId));\n+                assertThat(embeddingsModel.getServiceSettings().projectId(), is(projectId));\n+                assertThat(embeddingsModel.getServiceSettings().url(), is(URI.create(url)));\n+                assertThat(embeddingsModel.getServiceSettings().apiVersion(), is(apiVersion));\n+                assertThat(embeddingsModel.getSecretSettings().apiKey().toString(), is(apiKey));\n+                assertThat(embeddingsModel.getConfigurations().getChunkingSettings(), instanceOf(ChunkingSettings.class));\n+            }, e -> fail(\"Model parsing should have succeeded, but failed: \" + e.getMessage()));\n+\n+            service.parseRequestConfig(\n+                \"id\",\n+                TaskType.TEXT_EMBEDDING,\n+                getRequestConfigMap(\n+                    new HashMap<>(\n+                        Map.of(\n+                            ServiceFields.MODEL_ID,\n+                            modelId,\n+                            IbmWatsonxServiceFields.PROJECT_ID,\n+                            projectId,\n+                            ServiceFields.URL,\n+                            url,\n+                            IbmWatsonxServiceFields.API_VERSION,\n+                            apiVersion\n+                        )\n+                    ),\n+                    new HashMap<>(Map.of()),\n+                    createRandomChunkingSettingsMap(),\n+                    getSecretSettingsMap(apiKey)\n+                ),\n+                modelListener\n+            );\n+        }\n+    }\n+\n     public void testParseRequestConfig_ThrowsUnsupportedModelType() throws IOException {\n         try (var service = createIbmWatsonxService()) {\n             var failureListener = getModelListenerForException(\n@@ -235,6 +278,47 @@ public class IbmWatsonxServiceTests extends ESTestCase {\n             assertThat(embeddingsModel.getServiceSettings().apiVersion(), is(apiVersion));\n             assertThat(embeddingsModel.getTaskSettings(), is(EmptyTaskSettings.INSTANCE));\n             assertThat(embeddingsModel.getSecretSettings().apiKey().toString(), is(apiKey));\n+            assertThat(embeddingsModel.getConfigurations().getChunkingSettings(), instanceOf(ChunkingSettings.class));\n+        }\n+    }\n+\n+    public void testParsePersistedConfigWithSecrets_CreatesAIbmWatsonxEmbeddingsModelWhenChunkingSettingsProvided() throws IOException {\n+        try (var service = createIbmWatsonxService()) {\n+            var persistedConfig = getPersistedConfigMap(\n+                new HashMap<>(\n+                    Map.of(\n+                        ServiceFields.MODEL_ID,\n+                        modelId,\n+                        IbmWatsonxServiceFields.PROJECT_ID,\n+                        projectId,\n+                        ServiceFields.URL,\n+                        url,\n+                        IbmWatsonxServiceFields.API_VERSION,\n+                        apiVersion\n+                    )\n+                ),\n+                getTaskSettingsMapEmpty(),\n+                createRandomChunkingSettingsMap(),\n+                getSecretSettingsMap(apiKey)\n+            );\n+\n+            var model = service.parsePersistedConfigWithSecrets(\n+                \"id\",\n+                TaskType.TEXT_EMBEDDING,\n+                persistedConfig.config(),\n+                persistedConfig.secrets()\n+            );\n+\n+            assertThat(model, instanceOf(IbmWatsonxEmbeddingsModel.class));\n+\n+            var embeddingsModel = (IbmWatsonxEmbeddingsModel) model;\n+            assertThat(embeddingsModel.getServiceSettings().modelId(), is(modelId));\n+            assertThat(embeddingsModel.getServiceSettings().projectId(), is(projectId));\n+            assertThat(embeddingsModel.getServiceSettings().url(), is(URI.create(url)));\n+            assertThat(embeddingsModel.getServiceSettings().apiVersion(), is(apiVersion));\n+            assertThat(embeddingsModel.getTaskSettings(), is(EmptyTaskSettings.INSTANCE));\n+            assertThat(embeddingsModel.getSecretSettings().apiKey().toString(), is(apiKey));\n+            assertThat(embeddingsModel.getConfigurations().getChunkingSettings(), instanceOf(ChunkingSettings.class));\n         }\n     }\n \n@@ -399,6 +483,73 @@ public class IbmWatsonxServiceTests extends ESTestCase {\n         }\n     }\n \n+    public void testParsePersistedConfig_CreatesAIbmWatsonxEmbeddingsModelWhenChunkingSettingsNotProvided() throws IOException {\n+        try (var service = createIbmWatsonxService()) {\n+            var persistedConfig = getPersistedConfigMap(\n+                new HashMap<>(\n+                    Map.of(\n+                        ServiceFields.MODEL_ID,\n+                        modelId,\n+                        IbmWatsonxServiceFields.PROJECT_ID,\n+                        projectId,\n+                        ServiceFields.URL,\n+                        url,\n+                        IbmWatsonxServiceFields.API_VERSION,\n+                        apiVersion\n+                    )\n+                ),\n+                getTaskSettingsMapEmpty(),\n+                null\n+            );\n+\n+            var model = service.parsePersistedConfig(\"id\", TaskType.TEXT_EMBEDDING, persistedConfig.config());\n+\n+            assertThat(model, instanceOf(IbmWatsonxEmbeddingsModel.class));\n+\n+            var embeddingsModel = (IbmWatsonxEmbeddingsModel) model;\n+            assertThat(embeddingsModel.getServiceSettings().modelId(), is(modelId));\n+            assertThat(embeddingsModel.getServiceSettings().projectId(), is(projectId));\n+            assertThat(embeddingsModel.getServiceSettings().url(), is(URI.create(url)));\n+            assertThat(embeddingsModel.getServiceSettings().apiVersion(), is(apiVersion));\n+            assertThat(embeddingsModel.getTaskSettings(), is(EmptyTaskSettings.INSTANCE));\n+            assertThat(embeddingsModel.getConfigurations().getChunkingSettings(), instanceOf(ChunkingSettings.class));\n+        }\n+    }\n+\n+    public void testParsePersistedConfig_CreatesAIbmWatsonxEmbeddingsModelWhenChunkingSettingsProvided() throws IOException {\n+        try (var service = createIbmWatsonxService()) {\n+            var persistedConfig = getPersistedConfigMap(\n+                new HashMap<>(\n+                    Map.of(\n+                        ServiceFields.MODEL_ID,\n+                        modelId,\n+                        IbmWatsonxServiceFields.PROJECT_ID,\n+                        projectId,\n+                        ServiceFields.URL,\n+                        url,\n+                        IbmWatsonxServiceFields.API_VERSION,\n+                        apiVersion\n+                    )\n+                ),\n+                getTaskSettingsMapEmpty(),\n+                createRandomChunkingSettingsMap(),\n+                null\n+            );\n+\n+            var model = service.parsePersistedConfig(\"id\", TaskType.TEXT_EMBEDDING, persistedConfig.config());\n+\n+            assertThat(model, instanceOf(IbmWatsonxEmbeddingsModel.class));\n+\n+            var embeddingsModel = (IbmWatsonxEmbeddingsModel) model;\n+            assertThat(embeddingsModel.getServiceSettings().modelId(), is(modelId));\n+            assertThat(embeddingsModel.getServiceSettings().projectId(), is(projectId));\n+            assertThat(embeddingsModel.getServiceSettings().url(), is(URI.create(url)));\n+            assertThat(embeddingsModel.getServiceSettings().apiVersion(), is(apiVersion));\n+            assertThat(embeddingsModel.getTaskSettings(), is(EmptyTaskSettings.INSTANCE));\n+            assertThat(embeddingsModel.getConfigurations().getChunkingSettings(), instanceOf(ChunkingSettings.class));\n+        }\n+    }\n+\n     public void testInfer_ThrowsErrorWhenModelIsNotIbmWatsonxModel() throws IOException {\n         var sender = mock(Sender.class);\n \n@@ -488,7 +639,15 @@ public class IbmWatsonxServiceTests extends ESTestCase {\n         }\n     }\n \n-    public void testChunkedInfer_Batches() throws IOException {\n+    public void testChunkedInfer_ChunkingSettingsNotSet() throws IOException {\n+        testChunkedInfer_Batches(null);\n+    }\n+\n+    public void testChunkedInfer_ChunkingSettingsSet() throws IOException {\n+        testChunkedInfer_Batches(createRandomChunkingSettings());\n+    }\n+\n+    private void testChunkedInfer_Batches(ChunkingSettings chunkingSettings) throws IOException {\n         var input = List.of(\"foo\", \"bar\");\n \n         var senderFactory = HttpRequestSenderTests.createSenderFactory(threadPool, clientManager);\n@@ -878,6 +1037,18 @@ public class IbmWatsonxServiceTests extends ESTestCase {\n         });\n     }\n \n+    private Map<String, Object> getRequestConfigMap(\n+        Map<String, Object> serviceSettings,\n+        Map<String, Object> taskSettings,\n+        Map<String, Object> chunkingSettings,\n+        Map<String, Object> secretSettings\n+    ) {\n+        var requestConfigMap = getRequestConfigMap(serviceSettings, taskSettings, secretSettings);\n+        requestConfigMap.put(ModelConfigurations.CHUNKING_SETTINGS, chunkingSettings);\n+\n+        return requestConfigMap;\n+    }\n+\n     private Map<String, Object> getRequestConfigMap(\n         Map<String, Object> serviceSettings,\n         Map<String, Object> taskSettings,\ndiff --git a/x-pack/plugin/inference/src/test/java/org/elasticsearch/xpack/inference/services/ibmwatsonx/embeddings/IbmWatsonxEmbeddingsModelTests.java b/x-pack/plugin/inference/src/test/java/org/elasticsearch/xpack/inference/services/ibmwatsonx/embeddings/IbmWatsonxEmbeddingsModelTests.java\nindex 93fd7e402a0d..33fcd752fbf3 100644\n--- a/x-pack/plugin/inference/src/test/java/org/elasticsearch/xpack/inference/services/ibmwatsonx/embeddings/IbmWatsonxEmbeddingsModelTests.java\n+++ b/x-pack/plugin/inference/src/test/java/org/elasticsearch/xpack/inference/services/ibmwatsonx/embeddings/IbmWatsonxEmbeddingsModelTests.java\n@@ -82,6 +82,7 @@ public class IbmWatsonxEmbeddingsModelTests extends ESTestCase {\n                 null\n             ),\n             EmptyTaskSettings.INSTANCE,\n+            null,\n             new DefaultSecretSettings(new SecureString(apiKey.toCharArray()))\n         );\n     }",
  "judge_mode": "comparative",
  "judge_model": "openai/claude-sonnet-4-5-20250929",
  "test_label": "v0",
  "agent_results": [
    {
      "runner": "auggie",
      "model": "sonnet4.5",
      "edit_run_id": "a9463435",
      "status": "success",
      "elapsed_ms": 838407,
      "patch_unified": "diff --git a/x-pack/plugin/inference/src/main/java/org/elasticsearch/xpack/inference/services/ibmwatsonx/IbmWatsonxService.java b/x-pack/plugin/inference/src/main/java/org/elasticsearch/xpack/inference/services/ibmwatsonx/IbmWatsonxService.java\nindex e960b0b7..0971aa2e 100644\n--- a/x-pack/plugin/inference/src/main/java/org/elasticsearch/xpack/inference/services/ibmwatsonx/IbmWatsonxService.java\n+++ b/x-pack/plugin/inference/src/main/java/org/elasticsearch/xpack/inference/services/ibmwatsonx/IbmWatsonxService.java\n@@ -16,6 +16,7 @@ import org.elasticsearch.core.Nullable;\n import org.elasticsearch.core.TimeValue;\n import org.elasticsearch.inference.ChunkedInferenceServiceResults;\n import org.elasticsearch.inference.ChunkingOptions;\n+import org.elasticsearch.inference.ChunkingSettings;\n import org.elasticsearch.inference.EmptySettingsConfiguration;\n import org.elasticsearch.inference.InferenceServiceConfiguration;\n import org.elasticsearch.inference.InferenceServiceResults;\n@@ -30,6 +31,7 @@ import org.elasticsearch.inference.TaskType;\n import org.elasticsearch.inference.configuration.SettingsConfigurationDisplayType;\n import org.elasticsearch.inference.configuration.SettingsConfigurationFieldType;\n import org.elasticsearch.rest.RestStatus;\n+import org.elasticsearch.xpack.inference.chunking.ChunkingSettingsBuilder;\n import org.elasticsearch.xpack.inference.chunking.EmbeddingRequestChunker;\n import org.elasticsearch.xpack.inference.external.action.ibmwatsonx.IbmWatsonxActionCreator;\n import org.elasticsearch.xpack.inference.external.http.sender.DocumentsOnlyInput;\n@@ -86,11 +88,19 @@ public class IbmWatsonxService extends SenderService {\n             Map<String, Object> serviceSettingsMap = removeFromMapOrThrowIfNull(config, ModelConfigurations.SERVICE_SETTINGS);\n             Map<String, Object> taskSettingsMap = removeFromMapOrDefaultEmpty(config, ModelConfigurations.TASK_SETTINGS);\n \n+            ChunkingSettings chunkingSettings = null;\n+            if (TaskType.TEXT_EMBEDDING.equals(taskType)) {\n+                chunkingSettings = ChunkingSettingsBuilder.fromMap(\n+                    removeFromMapOrDefaultEmpty(config, ModelConfigurations.CHUNKING_SETTINGS)\n+                );\n+            }\n+\n             IbmWatsonxModel model = createModel(\n                 inferenceEntityId,\n                 taskType,\n                 serviceSettingsMap,\n                 taskSettingsMap,\n+                chunkingSettings,\n                 serviceSettingsMap,\n                 TaskType.unsupportedTaskTypeErrorMsg(taskType, NAME),\n                 ConfigurationParseContext.REQUEST\n@@ -112,6 +122,7 @@ public class IbmWatsonxService extends SenderService {\n         TaskType taskType,\n         Map<String, Object> serviceSettings,\n         Map<String, Object> taskSettings,\n+        @Nullable ChunkingSettings chunkingSettings,\n         @Nullable Map<String, Object> secretSettings,\n         String failureMessage,\n         ConfigurationParseContext context\n@@ -123,6 +134,7 @@ public class IbmWatsonxService extends SenderService {\n                 NAME,\n                 serviceSettings,\n                 taskSettings,\n+                chunkingSettings,\n                 secretSettings,\n                 context\n             );\n@@ -141,11 +153,19 @@ public class IbmWatsonxService extends SenderService {\n         Map<String, Object> taskSettingsMap = removeFromMapOrDefaultEmpty(config, ModelConfigurations.TASK_SETTINGS);\n         Map<String, Object> secretSettingsMap = removeFromMapOrDefaultEmpty(secrets, ModelSecrets.SECRET_SETTINGS);\n \n+        ChunkingSettings chunkingSettings = null;\n+        if (TaskType.TEXT_EMBEDDING.equals(taskType)) {\n+            chunkingSettings = ChunkingSettingsBuilder.fromMap(\n+                ServiceUtils.removeFromMap(config, ModelConfigurations.CHUNKING_SETTINGS)\n+            );\n+        }\n+\n         return createModelFromPersistent(\n             inferenceEntityId,\n             taskType,\n             serviceSettingsMap,\n             taskSettingsMap,\n+            chunkingSettings,\n             secretSettingsMap,\n             parsePersistedConfigErrorMsg(inferenceEntityId, NAME)\n         );\n@@ -166,6 +186,7 @@ public class IbmWatsonxService extends SenderService {\n         TaskType taskType,\n         Map<String, Object> serviceSettings,\n         Map<String, Object> taskSettings,\n+        @Nullable ChunkingSettings chunkingSettings,\n         Map<String, Object> secretSettings,\n         String failureMessage\n     ) {\n@@ -174,6 +195,7 @@ public class IbmWatsonxService extends SenderService {\n             taskType,\n             serviceSettings,\n             taskSettings,\n+            chunkingSettings,\n             secretSettings,\n             failureMessage,\n             ConfigurationParseContext.PERSISTENT\n@@ -185,11 +207,19 @@ public class IbmWatsonxService extends SenderService {\n         Map<String, Object> serviceSettingsMap = removeFromMapOrThrowIfNull(config, ModelConfigurations.SERVICE_SETTINGS);\n         Map<String, Object> taskSettingsMap = removeFromMapOrDefaultEmpty(config, ModelConfigurations.TASK_SETTINGS);\n \n+        ChunkingSettings chunkingSettings = null;\n+        if (TaskType.TEXT_EMBEDDING.equals(taskType)) {\n+            chunkingSettings = ChunkingSettingsBuilder.fromMap(\n+                ServiceUtils.removeFromMap(config, ModelConfigurations.CHUNKING_SETTINGS)\n+            );\n+        }\n+\n         return createModelFromPersistent(\n             inferenceEntityId,\n             taskType,\n             serviceSettingsMap,\n             taskSettingsMap,\n+            chunkingSettings,\n             null,\n             parsePersistedConfigErrorMsg(inferenceEntityId, NAME)\n         );\n@@ -266,7 +296,8 @@ public class IbmWatsonxService extends SenderService {\n         var batchedRequests = new EmbeddingRequestChunker(\n             input.getInputs(),\n             EMBEDDING_MAX_BATCH_SIZE,\n-            EmbeddingRequestChunker.EmbeddingType.FLOAT\n+            EmbeddingRequestChunker.EmbeddingType.FLOAT,\n+            ibmWatsonxModel.getConfigurations().getChunkingSettings()\n         ).batchRequestsWithListeners(listener);\n         for (var request : batchedRequests) {\n             var action = ibmWatsonxModel.accept(getActionCreator(getSender(), getServiceComponents()), taskSettings, inputType);\ndiff --git a/x-pack/plugin/inference/src/main/java/org/elasticsearch/xpack/inference/services/ibmwatsonx/embeddings/IbmWatsonxEmbeddingsModel.java b/x-pack/plugin/inference/src/main/java/org/elasticsearch/xpack/inference/services/ibmwatsonx/embeddings/IbmWatsonxEmbeddingsModel.java\nindex d60e31b5..99209425 100644\n--- a/x-pack/plugin/inference/src/main/java/org/elasticsearch/xpack/inference/services/ibmwatsonx/embeddings/IbmWatsonxEmbeddingsModel.java\n+++ b/x-pack/plugin/inference/src/main/java/org/elasticsearch/xpack/inference/services/ibmwatsonx/embeddings/IbmWatsonxEmbeddingsModel.java\n@@ -9,6 +9,7 @@ package org.elasticsearch.xpack.inference.services.ibmwatsonx.embeddings;\n \n import org.apache.http.client.utils.URIBuilder;\n import org.elasticsearch.core.Nullable;\n+import org.elasticsearch.inference.ChunkingSettings;\n import org.elasticsearch.inference.EmptyTaskSettings;\n import org.elasticsearch.inference.InputType;\n import org.elasticsearch.inference.ModelConfigurations;\n@@ -40,6 +41,7 @@ public class IbmWatsonxEmbeddingsModel extends IbmWatsonxModel {\n         String service,\n         Map<String, Object> serviceSettings,\n         Map<String, Object> taskSettings,\n+        @Nullable ChunkingSettings chunkingSettings,\n         Map<String, Object> secrets,\n         ConfigurationParseContext context\n     ) {\n@@ -49,6 +51,7 @@ public class IbmWatsonxEmbeddingsModel extends IbmWatsonxModel {\n             service,\n             IbmWatsonxEmbeddingsServiceSettings.fromMap(serviceSettings, context),\n             EmptyTaskSettings.INSTANCE,\n+            chunkingSettings,\n             DefaultSecretSettings.fromMap(secrets)\n         );\n     }\n@@ -64,10 +67,11 @@ public class IbmWatsonxEmbeddingsModel extends IbmWatsonxModel {\n         String service,\n         IbmWatsonxEmbeddingsServiceSettings serviceSettings,\n         TaskSettings taskSettings,\n+        @Nullable ChunkingSettings chunkingSettings,\n         @Nullable DefaultSecretSettings secrets\n     ) {\n         super(\n-            new ModelConfigurations(inferenceEntityId, taskType, service, serviceSettings, taskSettings),\n+            new ModelConfigurations(inferenceEntityId, taskType, service, serviceSettings, taskSettings, chunkingSettings),\n             new ModelSecrets(secrets),\n             serviceSettings\n         );\n@@ -86,10 +90,11 @@ public class IbmWatsonxEmbeddingsModel extends IbmWatsonxModel {\n         String uri,\n         IbmWatsonxEmbeddingsServiceSettings serviceSettings,\n         TaskSettings taskSettings,\n+        @Nullable ChunkingSettings chunkingSettings,\n         @Nullable DefaultSecretSettings secrets\n     ) {\n         super(\n-            new ModelConfigurations(inferenceEntityId, taskType, service, serviceSettings, taskSettings),\n+            new ModelConfigurations(inferenceEntityId, taskType, service, serviceSettings, taskSettings, chunkingSettings),\n             new ModelSecrets(secrets),\n             serviceSettings\n         );\ndiff --git a/x-pack/plugin/inference/src/test/java/org/elasticsearch/xpack/inference/services/ibmwatsonx/embeddings/IbmWatsonxEmbeddingsModelTests.java b/x-pack/plugin/inference/src/test/java/org/elasticsearch/xpack/inference/services/ibmwatsonx/embeddings/IbmWatsonxEmbeddingsModelTests.java\nindex 93fd7e40..0d0b29bb 100644\n--- a/x-pack/plugin/inference/src/test/java/org/elasticsearch/xpack/inference/services/ibmwatsonx/embeddings/IbmWatsonxEmbeddingsModelTests.java\n+++ b/x-pack/plugin/inference/src/test/java/org/elasticsearch/xpack/inference/services/ibmwatsonx/embeddings/IbmWatsonxEmbeddingsModelTests.java\n@@ -33,6 +33,7 @@ public class IbmWatsonxEmbeddingsModelTests extends ESTestCase {\n             url,\n             new IbmWatsonxEmbeddingsServiceSettings(model, projectId, uri, apiVersion, null, null, SimilarityMeasure.DOT_PRODUCT, null),\n             EmptyTaskSettings.INSTANCE,\n+            null,\n             new DefaultSecretSettings(new SecureString(apiKey.toCharArray()))\n         );\n     }\n@@ -54,6 +55,7 @@ public class IbmWatsonxEmbeddingsModelTests extends ESTestCase {\n             url,\n             new IbmWatsonxEmbeddingsServiceSettings(model, projectId, uri, apiVersion, null, dimensions, similarityMeasure, null),\n             EmptyTaskSettings.INSTANCE,\n+            null,\n             new DefaultSecretSettings(new SecureString(apiKey.toCharArray()))\n         );\n     }\n@@ -82,6 +84,7 @@ public class IbmWatsonxEmbeddingsModelTests extends ESTestCase {\n                 null\n             ),\n             EmptyTaskSettings.INSTANCE,\n+            null,\n             new DefaultSecretSettings(new SecureString(apiKey.toCharArray()))\n         );\n     }",
      "scores": {
        "correctness": 0.7,
        "completeness": 0.3,
        "code_reuse": 1.0,
        "best_practices": 0.8,
        "unsolicited_docs": 1.0
      },
      "aggregate": 0.76,
      "rationale": "The agent correctly implements chunking settings support in IbmWatsonxService and IbmWatsonxEmbeddingsModel with proper parameter threading and ChunkingSettingsBuilder usage. However, it has critical differences: uses ServiceUtils.removeFromMap instead of removeFromMapOrDefaultEmpty in parsePersistedConfigWithSecrets and parsePersistedConfig methods, adds @Nullable annotations not present in ground truth, and completely omits the changelog file (docs/changelog/114914.yaml) and all test file changes (IbmWatsonxServiceTests.java with 6 new test methods). The core functionality is present but the implementation differs in helper method usage and lacks comprehensive test coverage.",
      "llm_rating": 0.52,
      "llm_summary": "Added chunking settings support to IbmWatsonxService and IbmWatsonxEmbeddingsModel with ChunkingSettingsBuilder integration but used ServiceUtils.removeFromMap instead of removeFromMapOrDefaultEmpty in two methods, added extra @Nullable annotations, and omitted the changelog file and all test additions from IbmWatsonxServiceTests.",
      "errors": []
    },
    {
      "runner": "claude-code",
      "model": "claude-sonnet-4-5",
      "edit_run_id": "c7a3f90a",
      "status": "success",
      "elapsed_ms": 367018,
      "patch_unified": "diff --git a/x-pack/plugin/inference/src/main/java/org/elasticsearch/xpack/inference/services/ibmwatsonx/IbmWatsonxService.java b/x-pack/plugin/inference/src/main/java/org/elasticsearch/xpack/inference/services/ibmwatsonx/IbmWatsonxService.java\nindex e960b0b7..71f1f2ae 100644\n--- a/x-pack/plugin/inference/src/main/java/org/elasticsearch/xpack/inference/services/ibmwatsonx/IbmWatsonxService.java\n+++ b/x-pack/plugin/inference/src/main/java/org/elasticsearch/xpack/inference/services/ibmwatsonx/IbmWatsonxService.java\n@@ -16,6 +16,7 @@ import org.elasticsearch.core.Nullable;\n import org.elasticsearch.core.TimeValue;\n import org.elasticsearch.inference.ChunkedInferenceServiceResults;\n import org.elasticsearch.inference.ChunkingOptions;\n+import org.elasticsearch.inference.ChunkingSettings;\n import org.elasticsearch.inference.EmptySettingsConfiguration;\n import org.elasticsearch.inference.InferenceServiceConfiguration;\n import org.elasticsearch.inference.InferenceServiceResults;\n@@ -30,6 +31,7 @@ import org.elasticsearch.inference.TaskType;\n import org.elasticsearch.inference.configuration.SettingsConfigurationDisplayType;\n import org.elasticsearch.inference.configuration.SettingsConfigurationFieldType;\n import org.elasticsearch.rest.RestStatus;\n+import org.elasticsearch.xpack.inference.chunking.ChunkingSettingsBuilder;\n import org.elasticsearch.xpack.inference.chunking.EmbeddingRequestChunker;\n import org.elasticsearch.xpack.inference.external.action.ibmwatsonx.IbmWatsonxActionCreator;\n import org.elasticsearch.xpack.inference.external.http.sender.DocumentsOnlyInput;\n@@ -86,11 +88,19 @@ public class IbmWatsonxService extends SenderService {\n             Map<String, Object> serviceSettingsMap = removeFromMapOrThrowIfNull(config, ModelConfigurations.SERVICE_SETTINGS);\n             Map<String, Object> taskSettingsMap = removeFromMapOrDefaultEmpty(config, ModelConfigurations.TASK_SETTINGS);\n \n+            ChunkingSettings chunkingSettings = null;\n+            if (TaskType.TEXT_EMBEDDING.equals(taskType)) {\n+                chunkingSettings = ChunkingSettingsBuilder.fromMap(\n+                    removeFromMapOrDefaultEmpty(config, ModelConfigurations.CHUNKING_SETTINGS)\n+                );\n+            }\n+\n             IbmWatsonxModel model = createModel(\n                 inferenceEntityId,\n                 taskType,\n                 serviceSettingsMap,\n                 taskSettingsMap,\n+                chunkingSettings,\n                 serviceSettingsMap,\n                 TaskType.unsupportedTaskTypeErrorMsg(taskType, NAME),\n                 ConfigurationParseContext.REQUEST\n@@ -112,6 +122,7 @@ public class IbmWatsonxService extends SenderService {\n         TaskType taskType,\n         Map<String, Object> serviceSettings,\n         Map<String, Object> taskSettings,\n+        ChunkingSettings chunkingSettings,\n         @Nullable Map<String, Object> secretSettings,\n         String failureMessage,\n         ConfigurationParseContext context\n@@ -123,6 +134,7 @@ public class IbmWatsonxService extends SenderService {\n                 NAME,\n                 serviceSettings,\n                 taskSettings,\n+                chunkingSettings,\n                 secretSettings,\n                 context\n             );\n@@ -141,11 +153,19 @@ public class IbmWatsonxService extends SenderService {\n         Map<String, Object> taskSettingsMap = removeFromMapOrDefaultEmpty(config, ModelConfigurations.TASK_SETTINGS);\n         Map<String, Object> secretSettingsMap = removeFromMapOrDefaultEmpty(secrets, ModelSecrets.SECRET_SETTINGS);\n \n+        ChunkingSettings chunkingSettings = null;\n+        if (TaskType.TEXT_EMBEDDING.equals(taskType)) {\n+            chunkingSettings = ChunkingSettingsBuilder.fromMap(\n+                ServiceUtils.removeFromMap(config, ModelConfigurations.CHUNKING_SETTINGS)\n+            );\n+        }\n+\n         return createModelFromPersistent(\n             inferenceEntityId,\n             taskType,\n             serviceSettingsMap,\n             taskSettingsMap,\n+            chunkingSettings,\n             secretSettingsMap,\n             parsePersistedConfigErrorMsg(inferenceEntityId, NAME)\n         );\n@@ -166,6 +186,7 @@ public class IbmWatsonxService extends SenderService {\n         TaskType taskType,\n         Map<String, Object> serviceSettings,\n         Map<String, Object> taskSettings,\n+        ChunkingSettings chunkingSettings,\n         Map<String, Object> secretSettings,\n         String failureMessage\n     ) {\n@@ -174,6 +195,7 @@ public class IbmWatsonxService extends SenderService {\n             taskType,\n             serviceSettings,\n             taskSettings,\n+            chunkingSettings,\n             secretSettings,\n             failureMessage,\n             ConfigurationParseContext.PERSISTENT\n@@ -185,11 +207,19 @@ public class IbmWatsonxService extends SenderService {\n         Map<String, Object> serviceSettingsMap = removeFromMapOrThrowIfNull(config, ModelConfigurations.SERVICE_SETTINGS);\n         Map<String, Object> taskSettingsMap = removeFromMapOrDefaultEmpty(config, ModelConfigurations.TASK_SETTINGS);\n \n+        ChunkingSettings chunkingSettings = null;\n+        if (TaskType.TEXT_EMBEDDING.equals(taskType)) {\n+            chunkingSettings = ChunkingSettingsBuilder.fromMap(\n+                ServiceUtils.removeFromMap(config, ModelConfigurations.CHUNKING_SETTINGS)\n+            );\n+        }\n+\n         return createModelFromPersistent(\n             inferenceEntityId,\n             taskType,\n             serviceSettingsMap,\n             taskSettingsMap,\n+            chunkingSettings,\n             null,\n             parsePersistedConfigErrorMsg(inferenceEntityId, NAME)\n         );\ndiff --git a/x-pack/plugin/inference/src/main/java/org/elasticsearch/xpack/inference/services/ibmwatsonx/embeddings/IbmWatsonxEmbeddingsModel.java b/x-pack/plugin/inference/src/main/java/org/elasticsearch/xpack/inference/services/ibmwatsonx/embeddings/IbmWatsonxEmbeddingsModel.java\nindex d60e31b5..a826c7ff 100644\n--- a/x-pack/plugin/inference/src/main/java/org/elasticsearch/xpack/inference/services/ibmwatsonx/embeddings/IbmWatsonxEmbeddingsModel.java\n+++ b/x-pack/plugin/inference/src/main/java/org/elasticsearch/xpack/inference/services/ibmwatsonx/embeddings/IbmWatsonxEmbeddingsModel.java\n@@ -9,6 +9,7 @@ package org.elasticsearch.xpack.inference.services.ibmwatsonx.embeddings;\n \n import org.apache.http.client.utils.URIBuilder;\n import org.elasticsearch.core.Nullable;\n+import org.elasticsearch.inference.ChunkingSettings;\n import org.elasticsearch.inference.EmptyTaskSettings;\n import org.elasticsearch.inference.InputType;\n import org.elasticsearch.inference.ModelConfigurations;\n@@ -40,6 +41,7 @@ public class IbmWatsonxEmbeddingsModel extends IbmWatsonxModel {\n         String service,\n         Map<String, Object> serviceSettings,\n         Map<String, Object> taskSettings,\n+        ChunkingSettings chunkingSettings,\n         Map<String, Object> secrets,\n         ConfigurationParseContext context\n     ) {\n@@ -49,6 +51,7 @@ public class IbmWatsonxEmbeddingsModel extends IbmWatsonxModel {\n             service,\n             IbmWatsonxEmbeddingsServiceSettings.fromMap(serviceSettings, context),\n             EmptyTaskSettings.INSTANCE,\n+            chunkingSettings,\n             DefaultSecretSettings.fromMap(secrets)\n         );\n     }\n@@ -64,10 +67,11 @@ public class IbmWatsonxEmbeddingsModel extends IbmWatsonxModel {\n         String service,\n         IbmWatsonxEmbeddingsServiceSettings serviceSettings,\n         TaskSettings taskSettings,\n+        ChunkingSettings chunkingSettings,\n         @Nullable DefaultSecretSettings secrets\n     ) {\n         super(\n-            new ModelConfigurations(inferenceEntityId, taskType, service, serviceSettings, taskSettings),\n+            new ModelConfigurations(inferenceEntityId, taskType, service, serviceSettings, taskSettings, chunkingSettings),\n             new ModelSecrets(secrets),\n             serviceSettings\n         );\n@@ -86,10 +90,11 @@ public class IbmWatsonxEmbeddingsModel extends IbmWatsonxModel {\n         String uri,\n         IbmWatsonxEmbeddingsServiceSettings serviceSettings,\n         TaskSettings taskSettings,\n+        ChunkingSettings chunkingSettings,\n         @Nullable DefaultSecretSettings secrets\n     ) {\n         super(\n-            new ModelConfigurations(inferenceEntityId, taskType, service, serviceSettings, taskSettings),\n+            new ModelConfigurations(inferenceEntityId, taskType, service, serviceSettings, taskSettings, chunkingSettings),\n             new ModelSecrets(secrets),\n             serviceSettings\n         );\ndiff --git a/x-pack/plugin/inference/src/test/java/org/elasticsearch/xpack/inference/services/ibmwatsonx/embeddings/IbmWatsonxEmbeddingsModelTests.java b/x-pack/plugin/inference/src/test/java/org/elasticsearch/xpack/inference/services/ibmwatsonx/embeddings/IbmWatsonxEmbeddingsModelTests.java\nindex 93fd7e40..0d0b29bb 100644\n--- a/x-pack/plugin/inference/src/test/java/org/elasticsearch/xpack/inference/services/ibmwatsonx/embeddings/IbmWatsonxEmbeddingsModelTests.java\n+++ b/x-pack/plugin/inference/src/test/java/org/elasticsearch/xpack/inference/services/ibmwatsonx/embeddings/IbmWatsonxEmbeddingsModelTests.java\n@@ -33,6 +33,7 @@ public class IbmWatsonxEmbeddingsModelTests extends ESTestCase {\n             url,\n             new IbmWatsonxEmbeddingsServiceSettings(model, projectId, uri, apiVersion, null, null, SimilarityMeasure.DOT_PRODUCT, null),\n             EmptyTaskSettings.INSTANCE,\n+            null,\n             new DefaultSecretSettings(new SecureString(apiKey.toCharArray()))\n         );\n     }\n@@ -54,6 +55,7 @@ public class IbmWatsonxEmbeddingsModelTests extends ESTestCase {\n             url,\n             new IbmWatsonxEmbeddingsServiceSettings(model, projectId, uri, apiVersion, null, dimensions, similarityMeasure, null),\n             EmptyTaskSettings.INSTANCE,\n+            null,\n             new DefaultSecretSettings(new SecureString(apiKey.toCharArray()))\n         );\n     }\n@@ -82,6 +84,7 @@ public class IbmWatsonxEmbeddingsModelTests extends ESTestCase {\n                 null\n             ),\n             EmptyTaskSettings.INSTANCE,\n+            null,\n             new DefaultSecretSettings(new SecureString(apiKey.toCharArray()))\n         );\n     }",
      "scores": {
        "correctness": 0.6,
        "completeness": 0.4,
        "code_reuse": 0.8,
        "best_practices": 0.4,
        "unsolicited_docs": 1.0
      },
      "aggregate": 0.64,
      "rationale": "The agent correctly added ChunkingSettings parameters to IbmWatsonxService and IbmWatsonxEmbeddingsModel constructors, matching most of the ground truth implementation. However, it has critical issues: (1) uses ServiceUtils.removeFromMap instead of removeFromMapOrDefaultEmpty in parsePersistedConfigWithSecrets and parsePersistedConfig methods, which could cause null pointer exceptions when chunking_settings is absent; (2) completely missing the update to EmbeddingRequestChunker instantiation in the infer method to pass chunkingSettings; (3) missing all test file changes that verify the functionality works correctly; (4) missing the changelog file. The ServiceUtils.removeFromMap usage is particularly problematic as it doesn't provide a default empty map like the ground truth's removeFromMapOrDefaultEmpty, potentially breaking backward compatibility.",
      "llm_rating": 0.42,
      "llm_summary": "Added ChunkingSettings parameters to IbmWatsonxService and IbmWatsonxEmbeddingsModel constructors but used ServiceUtils.removeFromMap instead of removeFromMapOrDefaultEmpty in two methods, omitted EmbeddingRequestChunker update, and excluded all test changes and changelog.",
      "errors": []
    },
    {
      "runner": "factory",
      "model": "claude-sonnet-4-5-20250929",
      "edit_run_id": "074538b9",
      "status": "success",
      "elapsed_ms": 748354,
      "patch_unified": "diff --git a/docs/reference/inference/service-watsonx-ai.asciidoc b/docs/reference/inference/service-watsonx-ai.asciidoc\nindex 597afc27..800678bc 100644\n--- a/docs/reference/inference/service-watsonx-ai.asciidoc\n+++ b/docs/reference/inference/service-watsonx-ai.asciidoc\n@@ -35,6 +35,10 @@ Available task types:\n [[infer-service-watsonx-ai-api-request-body]]\n ==== {api-request-body-title}\n \n+`chunking_settings`::\n+(Optional, object)\n+include::inference-shared.asciidoc[tag=chunking-settings]\n+\n `service`::\n (Required, string)\n The type of service supported for the specified task type. In this case, \ndiff --git a/x-pack/plugin/inference/src/main/java/org/elasticsearch/xpack/inference/services/ibmwatsonx/IbmWatsonxService.java b/x-pack/plugin/inference/src/main/java/org/elasticsearch/xpack/inference/services/ibmwatsonx/IbmWatsonxService.java\nindex e960b0b7..6ff8f846 100644\n--- a/x-pack/plugin/inference/src/main/java/org/elasticsearch/xpack/inference/services/ibmwatsonx/IbmWatsonxService.java\n+++ b/x-pack/plugin/inference/src/main/java/org/elasticsearch/xpack/inference/services/ibmwatsonx/IbmWatsonxService.java\n@@ -16,6 +16,7 @@ import org.elasticsearch.core.Nullable;\n import org.elasticsearch.core.TimeValue;\n import org.elasticsearch.inference.ChunkedInferenceServiceResults;\n import org.elasticsearch.inference.ChunkingOptions;\n+import org.elasticsearch.inference.ChunkingSettings;\n import org.elasticsearch.inference.EmptySettingsConfiguration;\n import org.elasticsearch.inference.InferenceServiceConfiguration;\n import org.elasticsearch.inference.InferenceServiceResults;\n@@ -30,6 +31,7 @@ import org.elasticsearch.inference.TaskType;\n import org.elasticsearch.inference.configuration.SettingsConfigurationDisplayType;\n import org.elasticsearch.inference.configuration.SettingsConfigurationFieldType;\n import org.elasticsearch.rest.RestStatus;\n+import org.elasticsearch.xpack.inference.chunking.ChunkingSettingsBuilder;\n import org.elasticsearch.xpack.inference.chunking.EmbeddingRequestChunker;\n import org.elasticsearch.xpack.inference.external.action.ibmwatsonx.IbmWatsonxActionCreator;\n import org.elasticsearch.xpack.inference.external.http.sender.DocumentsOnlyInput;\n@@ -86,11 +88,19 @@ public class IbmWatsonxService extends SenderService {\n             Map<String, Object> serviceSettingsMap = removeFromMapOrThrowIfNull(config, ModelConfigurations.SERVICE_SETTINGS);\n             Map<String, Object> taskSettingsMap = removeFromMapOrDefaultEmpty(config, ModelConfigurations.TASK_SETTINGS);\n \n+            ChunkingSettings chunkingSettings = null;\n+            if (TaskType.TEXT_EMBEDDING.equals(taskType)) {\n+                chunkingSettings = ChunkingSettingsBuilder.fromMap(\n+                    removeFromMapOrDefaultEmpty(config, ModelConfigurations.CHUNKING_SETTINGS)\n+                );\n+            }\n+\n             IbmWatsonxModel model = createModel(\n                 inferenceEntityId,\n                 taskType,\n                 serviceSettingsMap,\n                 taskSettingsMap,\n+                chunkingSettings,\n                 serviceSettingsMap,\n                 TaskType.unsupportedTaskTypeErrorMsg(taskType, NAME),\n                 ConfigurationParseContext.REQUEST\n@@ -112,6 +122,7 @@ public class IbmWatsonxService extends SenderService {\n         TaskType taskType,\n         Map<String, Object> serviceSettings,\n         Map<String, Object> taskSettings,\n+        ChunkingSettings chunkingSettings,\n         @Nullable Map<String, Object> secretSettings,\n         String failureMessage,\n         ConfigurationParseContext context\n@@ -123,6 +134,7 @@ public class IbmWatsonxService extends SenderService {\n                 NAME,\n                 serviceSettings,\n                 taskSettings,\n+                chunkingSettings,\n                 secretSettings,\n                 context\n             );\n@@ -141,11 +153,19 @@ public class IbmWatsonxService extends SenderService {\n         Map<String, Object> taskSettingsMap = removeFromMapOrDefaultEmpty(config, ModelConfigurations.TASK_SETTINGS);\n         Map<String, Object> secretSettingsMap = removeFromMapOrDefaultEmpty(secrets, ModelSecrets.SECRET_SETTINGS);\n \n+        ChunkingSettings chunkingSettings = null;\n+        if (TaskType.TEXT_EMBEDDING.equals(taskType)) {\n+            chunkingSettings = ChunkingSettingsBuilder.fromMap(\n+                removeFromMapOrDefaultEmpty(config, ModelConfigurations.CHUNKING_SETTINGS)\n+            );\n+        }\n+\n         return createModelFromPersistent(\n             inferenceEntityId,\n             taskType,\n             serviceSettingsMap,\n             taskSettingsMap,\n+            chunkingSettings,\n             secretSettingsMap,\n             parsePersistedConfigErrorMsg(inferenceEntityId, NAME)\n         );\n@@ -166,6 +186,7 @@ public class IbmWatsonxService extends SenderService {\n         TaskType taskType,\n         Map<String, Object> serviceSettings,\n         Map<String, Object> taskSettings,\n+        ChunkingSettings chunkingSettings,\n         Map<String, Object> secretSettings,\n         String failureMessage\n     ) {\n@@ -174,6 +195,7 @@ public class IbmWatsonxService extends SenderService {\n             taskType,\n             serviceSettings,\n             taskSettings,\n+            chunkingSettings,\n             secretSettings,\n             failureMessage,\n             ConfigurationParseContext.PERSISTENT\n@@ -185,11 +207,19 @@ public class IbmWatsonxService extends SenderService {\n         Map<String, Object> serviceSettingsMap = removeFromMapOrThrowIfNull(config, ModelConfigurations.SERVICE_SETTINGS);\n         Map<String, Object> taskSettingsMap = removeFromMapOrDefaultEmpty(config, ModelConfigurations.TASK_SETTINGS);\n \n+        ChunkingSettings chunkingSettings = null;\n+        if (TaskType.TEXT_EMBEDDING.equals(taskType)) {\n+            chunkingSettings = ChunkingSettingsBuilder.fromMap(\n+                removeFromMapOrDefaultEmpty(config, ModelConfigurations.CHUNKING_SETTINGS)\n+            );\n+        }\n+\n         return createModelFromPersistent(\n             inferenceEntityId,\n             taskType,\n             serviceSettingsMap,\n             taskSettingsMap,\n+            chunkingSettings,\n             null,\n             parsePersistedConfigErrorMsg(inferenceEntityId, NAME)\n         );\ndiff --git a/x-pack/plugin/inference/src/main/java/org/elasticsearch/xpack/inference/services/ibmwatsonx/embeddings/IbmWatsonxEmbeddingsModel.java b/x-pack/plugin/inference/src/main/java/org/elasticsearch/xpack/inference/services/ibmwatsonx/embeddings/IbmWatsonxEmbeddingsModel.java\nindex d60e31b5..a826c7ff 100644\n--- a/x-pack/plugin/inference/src/main/java/org/elasticsearch/xpack/inference/services/ibmwatsonx/embeddings/IbmWatsonxEmbeddingsModel.java\n+++ b/x-pack/plugin/inference/src/main/java/org/elasticsearch/xpack/inference/services/ibmwatsonx/embeddings/IbmWatsonxEmbeddingsModel.java\n@@ -9,6 +9,7 @@ package org.elasticsearch.xpack.inference.services.ibmwatsonx.embeddings;\n \n import org.apache.http.client.utils.URIBuilder;\n import org.elasticsearch.core.Nullable;\n+import org.elasticsearch.inference.ChunkingSettings;\n import org.elasticsearch.inference.EmptyTaskSettings;\n import org.elasticsearch.inference.InputType;\n import org.elasticsearch.inference.ModelConfigurations;\n@@ -40,6 +41,7 @@ public class IbmWatsonxEmbeddingsModel extends IbmWatsonxModel {\n         String service,\n         Map<String, Object> serviceSettings,\n         Map<String, Object> taskSettings,\n+        ChunkingSettings chunkingSettings,\n         Map<String, Object> secrets,\n         ConfigurationParseContext context\n     ) {\n@@ -49,6 +51,7 @@ public class IbmWatsonxEmbeddingsModel extends IbmWatsonxModel {\n             service,\n             IbmWatsonxEmbeddingsServiceSettings.fromMap(serviceSettings, context),\n             EmptyTaskSettings.INSTANCE,\n+            chunkingSettings,\n             DefaultSecretSettings.fromMap(secrets)\n         );\n     }\n@@ -64,10 +67,11 @@ public class IbmWatsonxEmbeddingsModel extends IbmWatsonxModel {\n         String service,\n         IbmWatsonxEmbeddingsServiceSettings serviceSettings,\n         TaskSettings taskSettings,\n+        ChunkingSettings chunkingSettings,\n         @Nullable DefaultSecretSettings secrets\n     ) {\n         super(\n-            new ModelConfigurations(inferenceEntityId, taskType, service, serviceSettings, taskSettings),\n+            new ModelConfigurations(inferenceEntityId, taskType, service, serviceSettings, taskSettings, chunkingSettings),\n             new ModelSecrets(secrets),\n             serviceSettings\n         );\n@@ -86,10 +90,11 @@ public class IbmWatsonxEmbeddingsModel extends IbmWatsonxModel {\n         String uri,\n         IbmWatsonxEmbeddingsServiceSettings serviceSettings,\n         TaskSettings taskSettings,\n+        ChunkingSettings chunkingSettings,\n         @Nullable DefaultSecretSettings secrets\n     ) {\n         super(\n-            new ModelConfigurations(inferenceEntityId, taskType, service, serviceSettings, taskSettings),\n+            new ModelConfigurations(inferenceEntityId, taskType, service, serviceSettings, taskSettings, chunkingSettings),\n             new ModelSecrets(secrets),\n             serviceSettings\n         );\ndiff --git a/x-pack/plugin/inference/src/test/java/org/elasticsearch/xpack/inference/services/ibmwatsonx/IbmWatsonxServiceTests.java b/x-pack/plugin/inference/src/test/java/org/elasticsearch/xpack/inference/services/ibmwatsonx/IbmWatsonxServiceTests.java\nindex d6c491f2..aee5d833 100644\n--- a/x-pack/plugin/inference/src/test/java/org/elasticsearch/xpack/inference/services/ibmwatsonx/IbmWatsonxServiceTests.java\n+++ b/x-pack/plugin/inference/src/test/java/org/elasticsearch/xpack/inference/services/ibmwatsonx/IbmWatsonxServiceTests.java\n@@ -20,6 +20,7 @@ import org.elasticsearch.common.xcontent.XContentHelper;\n import org.elasticsearch.core.TimeValue;\n import org.elasticsearch.inference.ChunkedInferenceServiceResults;\n import org.elasticsearch.inference.ChunkingOptions;\n+import org.elasticsearch.inference.ChunkingSettings;\n import org.elasticsearch.inference.EmptyTaskSettings;\n import org.elasticsearch.inference.InferenceServiceConfiguration;\n import org.elasticsearch.inference.InferenceServiceResults;\n@@ -69,6 +70,7 @@ import static org.elasticsearch.xpack.inference.Utils.getInvalidModel;\n import static org.elasticsearch.xpack.inference.Utils.getPersistedConfigMap;\n import static org.elasticsearch.xpack.inference.Utils.inferenceUtilityPool;\n import static org.elasticsearch.xpack.inference.Utils.mockClusterServiceEmpty;\n+import static org.elasticsearch.xpack.inference.chunking.ChunkingSettingsTests.createRandomChunkingSettingsMap;\n import static org.elasticsearch.xpack.inference.external.http.Utils.entityAsMap;\n import static org.elasticsearch.xpack.inference.external.http.Utils.getUrl;\n import static org.elasticsearch.xpack.inference.results.TextEmbeddingResultsTests.buildExpectationFloat;\n@@ -150,6 +152,83 @@ public class IbmWatsonxServiceTests extends ESTestCase {\n         }\n     }\n \n+    public void testParseRequestConfig_CreatesAIbmWatsonxEmbeddingsModelWhenChunkingSettingsProvided() throws IOException {\n+        try (var service = createIbmWatsonxService()) {\n+            ActionListener<Model> modelListener = ActionListener.wrap(model -> {\n+                assertThat(model, instanceOf(IbmWatsonxEmbeddingsModel.class));\n+\n+                var embeddingsModel = (IbmWatsonxEmbeddingsModel) model;\n+                assertThat(embeddingsModel.getServiceSettings().modelId(), is(modelId));\n+                assertThat(embeddingsModel.getServiceSettings().projectId(), is(projectId));\n+                assertThat(embeddingsModel.getServiceSettings().url(), is(URI.create(url)));\n+                assertThat(embeddingsModel.getServiceSettings().apiVersion(), is(apiVersion));\n+                assertThat(embeddingsModel.getConfigurations().getChunkingSettings(), instanceOf(ChunkingSettings.class));\n+                assertThat(embeddingsModel.getSecretSettings().apiKey().toString(), is(apiKey));\n+            }, e -> fail(\"Model parsing should have succeeded, but failed: \" + e.getMessage()));\n+\n+            service.parseRequestConfig(\n+                \"id\",\n+                TaskType.TEXT_EMBEDDING,\n+                getRequestConfigMap(\n+                    new HashMap<>(\n+                        Map.of(\n+                            ServiceFields.MODEL_ID,\n+                            modelId,\n+                            IbmWatsonxServiceFields.PROJECT_ID,\n+                            projectId,\n+                            ServiceFields.URL,\n+                            url,\n+                            IbmWatsonxServiceFields.API_VERSION,\n+                            apiVersion\n+                        )\n+                    ),\n+                    new HashMap<>(Map.of()),\n+                    createRandomChunkingSettingsMap(),\n+                    getSecretSettingsMap(apiKey)\n+                ),\n+                modelListener\n+            );\n+        }\n+    }\n+\n+    public void testParseRequestConfig_CreatesAIbmWatsonxEmbeddingsModelWhenChunkingSettingsNotProvided() throws IOException {\n+        try (var service = createIbmWatsonxService()) {\n+            ActionListener<Model> modelListener = ActionListener.wrap(model -> {\n+                assertThat(model, instanceOf(IbmWatsonxEmbeddingsModel.class));\n+\n+                var embeddingsModel = (IbmWatsonxEmbeddingsModel) model;\n+                assertThat(embeddingsModel.getServiceSettings().modelId(), is(modelId));\n+                assertThat(embeddingsModel.getServiceSettings().projectId(), is(projectId));\n+                assertThat(embeddingsModel.getServiceSettings().url(), is(URI.create(url)));\n+                assertThat(embeddingsModel.getServiceSettings().apiVersion(), is(apiVersion));\n+                assertThat(embeddingsModel.getConfigurations().getChunkingSettings(), instanceOf(ChunkingSettings.class));\n+                assertThat(embeddingsModel.getSecretSettings().apiKey().toString(), is(apiKey));\n+            }, e -> fail(\"Model parsing should have succeeded, but failed: \" + e.getMessage()));\n+\n+            service.parseRequestConfig(\n+                \"id\",\n+                TaskType.TEXT_EMBEDDING,\n+                getRequestConfigMap(\n+                    new HashMap<>(\n+                        Map.of(\n+                            ServiceFields.MODEL_ID,\n+                            modelId,\n+                            IbmWatsonxServiceFields.PROJECT_ID,\n+                            projectId,\n+                            ServiceFields.URL,\n+                            url,\n+                            IbmWatsonxServiceFields.API_VERSION,\n+                            apiVersion\n+                        )\n+                    ),\n+                    new HashMap<>(Map.of()),\n+                    getSecretSettingsMap(apiKey)\n+                ),\n+                modelListener\n+            );\n+        }\n+    }\n+\n     public void testParseRequestConfig_ThrowsUnsupportedModelType() throws IOException {\n         try (var service = createIbmWatsonxService()) {\n             var failureListener = getModelListenerForException(\ndiff --git a/x-pack/plugin/inference/src/test/java/org/elasticsearch/xpack/inference/services/ibmwatsonx/embeddings/IbmWatsonxEmbeddingsModelTests.java b/x-pack/plugin/inference/src/test/java/org/elasticsearch/xpack/inference/services/ibmwatsonx/embeddings/IbmWatsonxEmbeddingsModelTests.java\nindex 93fd7e40..0d0b29bb 100644\n--- a/x-pack/plugin/inference/src/test/java/org/elasticsearch/xpack/inference/services/ibmwatsonx/embeddings/IbmWatsonxEmbeddingsModelTests.java\n+++ b/x-pack/plugin/inference/src/test/java/org/elasticsearch/xpack/inference/services/ibmwatsonx/embeddings/IbmWatsonxEmbeddingsModelTests.java\n@@ -33,6 +33,7 @@ public class IbmWatsonxEmbeddingsModelTests extends ESTestCase {\n             url,\n             new IbmWatsonxEmbeddingsServiceSettings(model, projectId, uri, apiVersion, null, null, SimilarityMeasure.DOT_PRODUCT, null),\n             EmptyTaskSettings.INSTANCE,\n+            null,\n             new DefaultSecretSettings(new SecureString(apiKey.toCharArray()))\n         );\n     }\n@@ -54,6 +55,7 @@ public class IbmWatsonxEmbeddingsModelTests extends ESTestCase {\n             url,\n             new IbmWatsonxEmbeddingsServiceSettings(model, projectId, uri, apiVersion, null, dimensions, similarityMeasure, null),\n             EmptyTaskSettings.INSTANCE,\n+            null,\n             new DefaultSecretSettings(new SecureString(apiKey.toCharArray()))\n         );\n     }\n@@ -82,6 +84,7 @@ public class IbmWatsonxEmbeddingsModelTests extends ESTestCase {\n                 null\n             ),\n             EmptyTaskSettings.INSTANCE,\n+            null,\n             new DefaultSecretSettings(new SecureString(apiKey.toCharArray()))\n         );\n     }",
      "scores": {
        "correctness": 0.7,
        "completeness": 0.5,
        "code_reuse": 1.0,
        "best_practices": 0.8,
        "unsolicited_docs": -0.3
      },
      "aggregate": 0.54,
      "rationale": "The agent correctly implements chunking settings support in IbmWatsonxService and IbmWatsonxEmbeddingsModel, adding ChunkingSettings parameters to all necessary methods and constructors. However, it misses several critical elements: (1) the changelog file (docs/changelog/114914.yaml), (2) the crucial update to EmbeddingRequestChunker instantiation in the infer method to pass chunkingSettings, (3) several test methods including testParsePersistedConfigWithSecrets variants and testChunkedInfer tests. The agent adds unsolicited documentation in service-watsonx-ai.asciidoc which was not in the ground truth. The code that is present follows good patterns and correctly uses ChunkingSettingsBuilder.fromMap, but the missing EmbeddingRequestChunker update means chunking won't actually work at runtime despite the settings being stored.",
      "llm_rating": 0.52,
      "llm_summary": "Added ChunkingSettings parameters to IbmWatsonxService and IbmWatsonxEmbeddingsModel constructors with proper parsing logic but missed the critical EmbeddingRequestChunker instantiation update in the infer method, several test methods, the changelog file, and added unsolicited documentation to service-watsonx-ai.asciidoc",
      "errors": []
    }
  ],
  "comparative_analysis": {
    "summary": "All three agents successfully implemented chunking settings for IbmWatsonxService with similar core approaches, but differed in completeness and annotation choices. auggie:sonnet4.5 achieved the highest aggregate score (0.76) with proper @Nullable annotations and consistent implementation. factory:claude-sonnet-4-5-20250929 added unsolicited documentation changes that reduced its score despite otherwise solid implementation, while claude-code:claude-sonnet-4-5 had the fastest execution time but lower completeness scores.",
    "best_agent": "auggie:sonnet4.5",
    "best_agent_reasoning": "auggie:sonnet4.5 achieved the highest aggregate score (0.76) by implementing all required changes with proper @Nullable annotations on the ChunkingSettings parameters, maintaining consistency across all method signatures. While it didn't include the changelog file (affecting completeness), it demonstrated superior code quality with appropriate nullability annotations and clean implementation that closely matched the ground truth pattern.",
    "approach_differences": "The key difference lies in annotation choices and scope: auggie:sonnet4.5 added @Nullable annotations to ChunkingSettings parameters in method signatures, claude-code:claude-sonnet-4-5 omitted these annotations entirely, and factory:claude-sonnet-4-5-20250929 matched auggie's annotation approach but added unsolicited documentation changes to service-watsonx-ai.asciidoc. All three agents used identical logic for extracting chunking settings (ChunkingSettingsBuilder.fromMap with TaskType.TEXT_EMBEDDING checks), but differed in their use of removeFromMapOrDefaultEmpty versus ServiceUtils.removeFromMap in the parsePersistedConfig method, with auggie and factory using removeFromMapOrDefaultEmpty while claude-code used ServiceUtils.removeFromMap.",
    "ranking": [
      "auggie:sonnet4.5",
      "claude-code:claude-sonnet-4-5",
      "factory:claude-sonnet-4-5-20250929"
    ]
  },
  "timestamp": "2025-11-06T21:51:40.659558",
  "analysis_run_id": "f4eb631e"
}